<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 9. Systems, Databases and Distributed Algorithms – The Little Book of Algorithms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../books/en-us/list-10.html" rel="next">
<link href="../../books/en-us/list-8.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-27c261d06b905028a18691de25d09dde.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../books/en-us/list-9.html"><span class="chapter-title">Chapter 9. Systems, Databases and Distributed Algorithms</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">The Little Book of Algorithms</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Content</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/cheatsheet.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">The Cheatsheet</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/book.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">The Book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/plan.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">The Plan</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-1.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 1. Foundations of Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-2.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 2. Sorting and searching</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-3.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 3. Data Structure in Action</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-4.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 4. Graph Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-5.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 5. Dynamic Programming</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-6.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 6. Mathematics for Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-7.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 7. Strings and Text Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-8.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 8. Geometry, Graphics and Spatial Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-9.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Chapter 9. Systems, Databases and Distributed Algorithms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../books/en-us/list-10.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Chapter 10. AI, ML and Optimization</span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section-81.-concurrency-control" id="toc-section-81.-concurrency-control" class="nav-link active" data-scroll-target="#section-81.-concurrency-control">Section 81. Concurrency Control</a>
  <ul class="collapse">
  <li><a href="#two-phase-locking-2pl" id="toc-two-phase-locking-2pl" class="nav-link" data-scroll-target="#two-phase-locking-2pl">801 Two-Phase Locking (2PL)</a></li>
  <li><a href="#strict-two-phase-locking-strict-2pl" id="toc-strict-two-phase-locking-strict-2pl" class="nav-link" data-scroll-target="#strict-two-phase-locking-strict-2pl">802 Strict Two-Phase Locking (Strict 2PL)</a></li>
  <li><a href="#conservative-two-phase-locking-c2pl" id="toc-conservative-two-phase-locking-c2pl" class="nav-link" data-scroll-target="#conservative-two-phase-locking-c2pl">803 Conservative Two-Phase Locking (C2PL)</a></li>
  <li><a href="#timestamp-ordering-to" id="toc-timestamp-ordering-to" class="nav-link" data-scroll-target="#timestamp-ordering-to">804 Timestamp Ordering (TO)</a></li>
  <li><a href="#multiversion-concurrency-control-mvcc" id="toc-multiversion-concurrency-control-mvcc" class="nav-link" data-scroll-target="#multiversion-concurrency-control-mvcc">805 Multiversion Concurrency Control (MVCC)</a></li>
  <li><a href="#optimistic-concurrency-control-occ" id="toc-optimistic-concurrency-control-occ" class="nav-link" data-scroll-target="#optimistic-concurrency-control-occ">806 Optimistic Concurrency Control (OCC)</a></li>
  <li><a href="#serializable-snapshot-isolation-ssi" id="toc-serializable-snapshot-isolation-ssi" class="nav-link" data-scroll-target="#serializable-snapshot-isolation-ssi">807 Serializable Snapshot Isolation (SSI)</a></li>
  <li><a href="#lock-free-algorithm" id="toc-lock-free-algorithm" class="nav-link" data-scroll-target="#lock-free-algorithm">808 Lock-Free Algorithm</a></li>
  <li><a href="#wait-die-wound-wait" id="toc-wait-die-wound-wait" class="nav-link" data-scroll-target="#wait-die-wound-wait">809 Wait-Die / Wound-Wait</a></li>
  <li><a href="#deadlock-detection-wait-for-graph" id="toc-deadlock-detection-wait-for-graph" class="nav-link" data-scroll-target="#deadlock-detection-wait-for-graph">810 Deadlock Detection (Wait-for Graph)</a></li>
  </ul></li>
  <li><a href="#section-82.-logging-recovery-and-commit-protocols" id="toc-section-82.-logging-recovery-and-commit-protocols" class="nav-link" data-scroll-target="#section-82.-logging-recovery-and-commit-protocols">Section 82. Logging, Recovery, and Commit Protocols</a>
  <ul class="collapse">
  <li><a href="#write-ahead-logging-wal" id="toc-write-ahead-logging-wal" class="nav-link" data-scroll-target="#write-ahead-logging-wal">811 Write-Ahead Logging (WAL)</a></li>
  <li><a href="#aries-recovery-algorithms-for-recovery-and-isolation-exploiting-semantics" id="toc-aries-recovery-algorithms-for-recovery-and-isolation-exploiting-semantics" class="nav-link" data-scroll-target="#aries-recovery-algorithms-for-recovery-and-isolation-exploiting-semantics">812 ARIES Recovery (Algorithms for Recovery and Isolation Exploiting Semantics)</a></li>
  <li><a href="#shadow-paging" id="toc-shadow-paging" class="nav-link" data-scroll-target="#shadow-paging">813 Shadow Paging</a></li>
  <li><a href="#two-phase-commit-2pc" id="toc-two-phase-commit-2pc" class="nav-link" data-scroll-target="#two-phase-commit-2pc">814 Two-Phase Commit (2PC)</a></li>
  <li><a href="#three-phase-commit-3pc" id="toc-three-phase-commit-3pc" class="nav-link" data-scroll-target="#three-phase-commit-3pc">815 Three-Phase Commit (3PC)</a></li>
  <li><a href="#checkpointing" id="toc-checkpointing" class="nav-link" data-scroll-target="#checkpointing">816 Checkpointing</a></li>
  <li><a href="#undo-logging" id="toc-undo-logging" class="nav-link" data-scroll-target="#undo-logging">817 Undo Logging</a></li>
  <li><a href="#redo-logging" id="toc-redo-logging" class="nav-link" data-scroll-target="#redo-logging">818 Redo Logging</a></li>
  <li><a href="#quorum-commit" id="toc-quorum-commit" class="nav-link" data-scroll-target="#quorum-commit">819 Quorum Commit</a></li>
  <li><a href="#consensus-commit" id="toc-consensus-commit" class="nav-link" data-scroll-target="#consensus-commit">820 Consensus Commit</a></li>
  </ul></li>
  <li><a href="#section-83.-scheduling" id="toc-section-83.-scheduling" class="nav-link" data-scroll-target="#section-83.-scheduling">Section 83. Scheduling</a>
  <ul class="collapse">
  <li><a href="#first-come-first-served-fcfs" id="toc-first-come-first-served-fcfs" class="nav-link" data-scroll-target="#first-come-first-served-fcfs">821 First-Come First-Served (FCFS)</a></li>
  <li><a href="#shortest-job-first-sjf" id="toc-shortest-job-first-sjf" class="nav-link" data-scroll-target="#shortest-job-first-sjf">822 Shortest Job First (SJF)</a></li>
  <li><a href="#priority-scheduling" id="toc-priority-scheduling" class="nav-link" data-scroll-target="#priority-scheduling">824 Priority Scheduling</a></li>
  <li><a href="#multilevel-queue-scheduling" id="toc-multilevel-queue-scheduling" class="nav-link" data-scroll-target="#multilevel-queue-scheduling">825 Multilevel Queue Scheduling</a></li>
  <li><a href="#earliest-deadline-first-edf" id="toc-earliest-deadline-first-edf" class="nav-link" data-scroll-target="#earliest-deadline-first-edf">826 Earliest Deadline First (EDF)</a></li>
  <li><a href="#rate-monotonic-scheduling-rms" id="toc-rate-monotonic-scheduling-rms" class="nav-link" data-scroll-target="#rate-monotonic-scheduling-rms">827 Rate Monotonic Scheduling (RMS)</a></li>
  <li><a href="#lottery-scheduling" id="toc-lottery-scheduling" class="nav-link" data-scroll-target="#lottery-scheduling">828 Lottery Scheduling</a></li>
  <li><a href="#multilevel-feedback-queue-mlfq" id="toc-multilevel-feedback-queue-mlfq" class="nav-link" data-scroll-target="#multilevel-feedback-queue-mlfq">829 Multilevel Feedback Queue (MLFQ)</a></li>
  <li><a href="#fair-queuing-fq" id="toc-fair-queuing-fq" class="nav-link" data-scroll-target="#fair-queuing-fq">830 Fair Queuing (FQ)</a></li>
  </ul></li>
  <li><a href="#section-84.-caching-and-replacement" id="toc-section-84.-caching-and-replacement" class="nav-link" data-scroll-target="#section-84.-caching-and-replacement">Section 84. Caching and Replacement</a>
  <ul class="collapse">
  <li><a href="#lru-least-recently-used" id="toc-lru-least-recently-used" class="nav-link" data-scroll-target="#lru-least-recently-used">831 LRU (Least Recently Used)</a></li>
  <li><a href="#lfu-least-frequently-used" id="toc-lfu-least-frequently-used" class="nav-link" data-scroll-target="#lfu-least-frequently-used">832 LFU (Least Frequently Used)</a></li>
  <li><a href="#fifo-cache-first-in-first-out" id="toc-fifo-cache-first-in-first-out" class="nav-link" data-scroll-target="#fifo-cache-first-in-first-out">833 FIFO Cache (First-In, First-Out)</a></li>
  <li><a href="#clock-algorithm" id="toc-clock-algorithm" class="nav-link" data-scroll-target="#clock-algorithm">834 CLOCK Algorithm</a></li>
  <li><a href="#arc-adaptive-replacement-cache" id="toc-arc-adaptive-replacement-cache" class="nav-link" data-scroll-target="#arc-adaptive-replacement-cache">835 ARC (Adaptive Replacement Cache)</a></li>
  <li><a href="#two-queue-2q" id="toc-two-queue-2q" class="nav-link" data-scroll-target="#two-queue-2q">836 Two-Queue (2Q)</a></li>
  <li><a href="#lirs-low-inter-reference-recency-set" id="toc-lirs-low-inter-reference-recency-set" class="nav-link" data-scroll-target="#lirs-low-inter-reference-recency-set">837 LIRS (Low Inter-reference Recency Set)</a></li>
  <li><a href="#tinylfu-tiny-least-frequently-used" id="toc-tinylfu-tiny-least-frequently-used" class="nav-link" data-scroll-target="#tinylfu-tiny-least-frequently-used">838 TinyLFU (Tiny Least Frequently Used)</a></li>
  <li><a href="#random-replacement" id="toc-random-replacement" class="nav-link" data-scroll-target="#random-replacement">839 Random Replacement</a></li>
  <li><a href="#beladys-optimal-algorithm-opt" id="toc-beladys-optimal-algorithm-opt" class="nav-link" data-scroll-target="#beladys-optimal-algorithm-opt">840 Belady’s Optimal Algorithm (OPT)</a></li>
  </ul></li>
  <li><a href="#section-85.-networking" id="toc-section-85.-networking" class="nav-link" data-scroll-target="#section-85.-networking">Section 85. Networking</a>
  <ul class="collapse">
  <li><a href="#dijkstras-routing-algorithm" id="toc-dijkstras-routing-algorithm" class="nav-link" data-scroll-target="#dijkstras-routing-algorithm">841 Dijkstra’s Routing Algorithm</a></li>
  <li><a href="#bellmanford-routing-algorithm" id="toc-bellmanford-routing-algorithm" class="nav-link" data-scroll-target="#bellmanford-routing-algorithm">842 Bellman–Ford Routing Algorithm</a></li>
  <li><a href="#link-state-routing-ospf" id="toc-link-state-routing-ospf" class="nav-link" data-scroll-target="#link-state-routing-ospf">843 Link-State Routing (OSPF)</a></li>
  <li><a href="#distance-vector-routing-rip" id="toc-distance-vector-routing-rip" class="nav-link" data-scroll-target="#distance-vector-routing-rip">844 Distance-Vector Routing (RIP)</a></li>
  <li><a href="#path-vector-routing-bgp" id="toc-path-vector-routing-bgp" class="nav-link" data-scroll-target="#path-vector-routing-bgp">845 Path Vector Routing (BGP)</a></li>
  <li><a href="#flooding-algorithm" id="toc-flooding-algorithm" class="nav-link" data-scroll-target="#flooding-algorithm">846 Flooding Algorithm</a></li>
  <li><a href="#spanning-tree-protocol-stp" id="toc-spanning-tree-protocol-stp" class="nav-link" data-scroll-target="#spanning-tree-protocol-stp">847 Spanning Tree Protocol (STP)</a></li>
  <li><a href="#congestion-control-aimd" id="toc-congestion-control-aimd" class="nav-link" data-scroll-target="#congestion-control-aimd">848 Congestion Control (AIMD)</a></li>
  <li><a href="#random-early-detection-red" id="toc-random-early-detection-red" class="nav-link" data-scroll-target="#random-early-detection-red">849 Random Early Detection (RED)</a></li>
  <li><a href="#explicit-congestion-notification-ecn" id="toc-explicit-congestion-notification-ecn" class="nav-link" data-scroll-target="#explicit-congestion-notification-ecn">850 Explicit Congestion Notification (ECN)</a></li>
  </ul></li>
  <li><a href="#section-86.-distributed-consensus" id="toc-section-86.-distributed-consensus" class="nav-link" data-scroll-target="#section-86.-distributed-consensus">Section 86. Distributed Consensus</a>
  <ul class="collapse">
  <li><a href="#basic-paxos" id="toc-basic-paxos" class="nav-link" data-scroll-target="#basic-paxos">851 Basic Paxos</a></li>
  <li><a href="#multi-paxos" id="toc-multi-paxos" class="nav-link" data-scroll-target="#multi-paxos">852 Multi-Paxos</a></li>
  <li><a href="#raft" id="toc-raft" class="nav-link" data-scroll-target="#raft">853 Raft</a></li>
  <li><a href="#viewstamped-replication-vr" id="toc-viewstamped-replication-vr" class="nav-link" data-scroll-target="#viewstamped-replication-vr">854 Viewstamped Replication (VR)</a></li>
  <li><a href="#practical-byzantine-fault-tolerance-pbft" id="toc-practical-byzantine-fault-tolerance-pbft" class="nav-link" data-scroll-target="#practical-byzantine-fault-tolerance-pbft">855 Practical Byzantine Fault Tolerance (PBFT)</a></li>
  <li><a href="#zab-zookeeper-atomic-broadcast" id="toc-zab-zookeeper-atomic-broadcast" class="nav-link" data-scroll-target="#zab-zookeeper-atomic-broadcast">856 Zab (Zookeeper Atomic Broadcast)</a></li>
  <li><a href="#epaxos-egalitarian-paxos" id="toc-epaxos-egalitarian-paxos" class="nav-link" data-scroll-target="#epaxos-egalitarian-paxos">857 EPaxos (Egalitarian Paxos)</a></li>
  <li><a href="#vrr-virtual-ring-replication" id="toc-vrr-virtual-ring-replication" class="nav-link" data-scroll-target="#vrr-virtual-ring-replication">858 VRR (Virtual Ring Replication)</a></li>
  <li><a href="#two-phase-commit-with-consensus" id="toc-two-phase-commit-with-consensus" class="nav-link" data-scroll-target="#two-phase-commit-with-consensus">859 Two-Phase Commit with Consensus</a></li>
  <li><a href="#chain-replication" id="toc-chain-replication" class="nav-link" data-scroll-target="#chain-replication">860 Chain Replication</a></li>
  </ul></li>
  <li><a href="#section-87.-load-balancing-and-rate-limiting" id="toc-section-87.-load-balancing-and-rate-limiting" class="nav-link" data-scroll-target="#section-87.-load-balancing-and-rate-limiting">Section 87. Load Balancing and Rate Limiting</a>
  <ul class="collapse">
  <li><a href="#round-robin-load-balancing" id="toc-round-robin-load-balancing" class="nav-link" data-scroll-target="#round-robin-load-balancing">861 Round Robin Load Balancing</a></li>
  <li><a href="#weighted-round-robin" id="toc-weighted-round-robin" class="nav-link" data-scroll-target="#weighted-round-robin">862 Weighted Round Robin</a></li>
  <li><a href="#least-connections" id="toc-least-connections" class="nav-link" data-scroll-target="#least-connections">863 Least Connections</a></li>
  <li><a href="#consistent-hashing" id="toc-consistent-hashing" class="nav-link" data-scroll-target="#consistent-hashing">864 Consistent Hashing</a></li>
  <li><a href="#power-of-two-choices" id="toc-power-of-two-choices" class="nav-link" data-scroll-target="#power-of-two-choices">865 Power of Two Choices</a></li>
  <li><a href="#random-load-balancing" id="toc-random-load-balancing" class="nav-link" data-scroll-target="#random-load-balancing">866 Random Load Balancing</a></li>
  <li><a href="#token-bucket" id="toc-token-bucket" class="nav-link" data-scroll-target="#token-bucket">867 Token Bucket</a></li>
  <li><a href="#leaky-bucket" id="toc-leaky-bucket" class="nav-link" data-scroll-target="#leaky-bucket">868 Leaky Bucket</a></li>
  <li><a href="#sliding-window-counter" id="toc-sliding-window-counter" class="nav-link" data-scroll-target="#sliding-window-counter">869 Sliding Window Counter</a></li>
  <li><a href="#fixed-window-counter" id="toc-fixed-window-counter" class="nav-link" data-scroll-target="#fixed-window-counter">870 Fixed Window Counter</a></li>
  </ul></li>
  <li><a href="#section-88.-search-and-indexing" id="toc-section-88.-search-and-indexing" class="nav-link" data-scroll-target="#section-88.-search-and-indexing">Section 88. Search and Indexing</a>
  <ul class="collapse">
  <li><a href="#inverted-index-construction" id="toc-inverted-index-construction" class="nav-link" data-scroll-target="#inverted-index-construction">871 Inverted Index Construction</a></li>
  <li><a href="#positional-index-build" id="toc-positional-index-build" class="nav-link" data-scroll-target="#positional-index-build">872 Positional Index Build</a></li>
  <li><a href="#tfidf-scoring" id="toc-tfidf-scoring" class="nav-link" data-scroll-target="#tfidf-scoring">873 TF–IDF Scoring</a></li>
  <li><a href="#bm25-ranking" id="toc-bm25-ranking" class="nav-link" data-scroll-target="#bm25-ranking">874 BM25 Ranking</a></li>
  <li><a href="#boolean-retrieval" id="toc-boolean-retrieval" class="nav-link" data-scroll-target="#boolean-retrieval">875 Boolean Retrieval</a></li>
  <li><a href="#wand-algorithm" id="toc-wand-algorithm" class="nav-link" data-scroll-target="#wand-algorithm">876 WAND Algorithm</a></li>
  <li><a href="#block-max-wand-bmw" id="toc-block-max-wand-bmw" class="nav-link" data-scroll-target="#block-max-wand-bmw">877 Block-Max WAND (BMW)</a></li>
  <li><a href="#impact-ordered-indexing" id="toc-impact-ordered-indexing" class="nav-link" data-scroll-target="#impact-ordered-indexing">878 Impact-Ordered Indexing</a></li>
  <li><a href="#tiered-indexing" id="toc-tiered-indexing" class="nav-link" data-scroll-target="#tiered-indexing">879 Tiered Indexing</a></li>
  <li><a href="#daat-vs-saat-evaluation" id="toc-daat-vs-saat-evaluation" class="nav-link" data-scroll-target="#daat-vs-saat-evaluation">880 DAAT vs SAAT Evaluation</a></li>
  </ul></li>
  <li><a href="#section-89.-compression-and-encoding-in-system" id="toc-section-89.-compression-and-encoding-in-system" class="nav-link" data-scroll-target="#section-89.-compression-and-encoding-in-system">Section 89. Compression and Encoding in System</a>
  <ul class="collapse">
  <li><a href="#run-length-encoding-rle" id="toc-run-length-encoding-rle" class="nav-link" data-scroll-target="#run-length-encoding-rle">881 Run-Length Encoding (RLE)</a></li>
  <li><a href="#huffman-coding" id="toc-huffman-coding" class="nav-link" data-scroll-target="#huffman-coding">882 Huffman Coding</a></li>
  <li><a href="#arithmetic-coding" id="toc-arithmetic-coding" class="nav-link" data-scroll-target="#arithmetic-coding">883 Arithmetic Coding</a></li>
  <li><a href="#delta-encoding" id="toc-delta-encoding" class="nav-link" data-scroll-target="#delta-encoding">884 Delta Encoding</a></li>
  <li><a href="#variable-byte-encoding" id="toc-variable-byte-encoding" class="nav-link" data-scroll-target="#variable-byte-encoding">885 Variable Byte Encoding</a></li>
  <li><a href="#elias-gamma-coding" id="toc-elias-gamma-coding" class="nav-link" data-scroll-target="#elias-gamma-coding">886 Elias Gamma Coding</a></li>
  <li><a href="#rice-coding" id="toc-rice-coding" class="nav-link" data-scroll-target="#rice-coding">887 Rice Coding</a></li>
  <li><a href="#snappy-compression" id="toc-snappy-compression" class="nav-link" data-scroll-target="#snappy-compression">888 Snappy Compression</a></li>
  <li><a href="#zstandard-zstd" id="toc-zstandard-zstd" class="nav-link" data-scroll-target="#zstandard-zstd">889 Zstandard (Zstd)</a></li>
  <li><a href="#lz4-compression" id="toc-lz4-compression" class="nav-link" data-scroll-target="#lz4-compression">890 LZ4 Compression</a></li>
  </ul></li>
  <li><a href="#section-90.-fault-tolenrance-and-replication" id="toc-section-90.-fault-tolenrance-and-replication" class="nav-link" data-scroll-target="#section-90.-fault-tolenrance-and-replication">Section 90. Fault tolenrance and Replication</a>
  <ul class="collapse">
  <li><a href="#primarybackup-replication" id="toc-primarybackup-replication" class="nav-link" data-scroll-target="#primarybackup-replication">891 Primary–Backup Replication</a></li>
  <li><a href="#quorum-replication" id="toc-quorum-replication" class="nav-link" data-scroll-target="#quorum-replication">892 Quorum Replication</a></li>
  <li><a href="#chain-replication-1" id="toc-chain-replication-1" class="nav-link" data-scroll-target="#chain-replication-1">893 Chain Replication</a></li>
  <li><a href="#gossip-protocol" id="toc-gossip-protocol" class="nav-link" data-scroll-target="#gossip-protocol">894 Gossip Protocol</a></li>
  <li><a href="#anti-entropy-repair" id="toc-anti-entropy-repair" class="nav-link" data-scroll-target="#anti-entropy-repair">895 Anti-Entropy Repair</a></li>
  <li><a href="#erasure-coding" id="toc-erasure-coding" class="nav-link" data-scroll-target="#erasure-coding">896 Erasure Coding</a></li>
  <li><a href="#checksum-verification" id="toc-checksum-verification" class="nav-link" data-scroll-target="#checksum-verification">897 Checksum Verification</a></li>
  <li><a href="#heartbeat-monitoring" id="toc-heartbeat-monitoring" class="nav-link" data-scroll-target="#heartbeat-monitoring">898 Heartbeat Monitoring</a></li>
  <li><a href="#leader-election-bully-algorithm" id="toc-leader-election-bully-algorithm" class="nav-link" data-scroll-target="#leader-election-bully-algorithm">899 Leader Election (Bully Algorithm)</a></li>
  <li><a href="#leader-election-ring-algorithm" id="toc-leader-election-ring-algorithm" class="nav-link" data-scroll-target="#leader-election-ring-algorithm">900 Leader Election (Ring Algorithm)</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">Chapter 9. Systems, Databases and Distributed Algorithms</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="section-81.-concurrency-control" class="level1">
<h1>Section 81. Concurrency Control</h1>
<section id="two-phase-locking-2pl" class="level3">
<h3 class="anchored" data-anchor-id="two-phase-locking-2pl">801 Two-Phase Locking (2PL)</h3>
<p>Two-Phase Locking (2PL) is the cornerstone of concurrency control in databases. It ensures that multiple transactions can run safely together without violating consistency. The core idea is simple: a transaction first acquires all the locks it needs, then releases them only after it’s done. Once it starts unlocking, it can’t lock anything new again, that’s what gives it two distinct “phases.”</p>
<section id="what-problem-are-we-solving" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving">What Problem Are We Solving?</h4>
<p>In a database, transactions often run in parallel. Without coordination, they can interfere with each other:</p>
<ul>
<li>One transaction reads stale data</li>
<li>Another overwrites uncommitted changes</li>
<li>Or two transactions deadlock trying to grab each other’s locks</li>
</ul>
<p>We need a way to serialize concurrent transactions, ensuring results are the same as if they had run one after another.</p>
<p>That’s where 2PL comes in. It guarantees conflict-serializable schedules, meaning no race conditions or interleaving chaos.</p>
</section>
<section id="how-does-it-work-plain-language" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language">How Does It Work (Plain Language)?</h4>
<p>Imagine a transaction as a careful shopper:</p>
<ol type="1">
<li>Growing Phase – Grab all the items (locks) you’ll need.</li>
<li>Shrinking Phase – Once you start putting items back (releasing locks), you can’t grab any more.</li>
</ol>
<p>This two-phase rule ensures order, no transaction can “sneak in” between lock changes to break serializability.</p>
<p>Let’s walk through an example:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 28%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction A</th>
<th>Transaction B</th>
<th>Locks Held</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Lock(X)</td>
<td>–</td>
<td>A:X</td>
<td>A starts growing</td>
</tr>
<tr class="even">
<td>2</td>
<td>–</td>
<td>Lock(Y)</td>
<td>A:X, B:Y</td>
<td>B starts growing</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Lock(Y)</td>
<td>–</td>
<td>A:X,Y, B:Y</td>
<td>Conflict, wait</td>
</tr>
<tr class="even">
<td>4</td>
<td>Unlock(X), Unlock(Y)</td>
<td>–</td>
<td>–</td>
<td>A finishes (shrinking)</td>
</tr>
<tr class="odd">
<td>5</td>
<td>–</td>
<td>Lock(X)</td>
<td>B:X,Y</td>
<td>B continues</td>
</tr>
</tbody>
</table>
<p>Once A starts unlocking, it can’t lock again. That’s the “two phases”: acquire, then release.</p>
</section>
<section id="tiny-code-easy-version" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-easy-version">Tiny Code (Easy Version)</h4>
<p>C (Conceptual Simulation)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> growing<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> shrinking<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Transaction<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> lock<span class="op">(</span>Transaction <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t<span class="op">-&gt;</span>shrinking<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Cannot acquire lock after release phase!</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>growing <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Lock acquired.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> unlock<span class="op">(</span>Transaction <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>shrinking <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Lock released.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    Transaction T <span class="op">=</span> <span class="op">{</span><span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">};</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    lock<span class="op">(&amp;</span>T<span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    unlock<span class="op">(&amp;</span>T<span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    lock<span class="op">(&amp;</span>T<span class="op">);</span> <span class="co">// Illegal in 2PL</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Lock acquired.
Lock released.
Cannot acquire lock after release phase!</code></pre>
</section>
<section id="why-it-matters" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters">Why It Matters</h4>
<ul>
<li>Ensures Serializability: All schedules are equivalent to some serial order</li>
<li>Foundational Principle: Basis for stricter variants like Strict 2PL and Conservative 2PL</li>
<li>Prevents Dirty Reads/Writes: Guarantees consistency under concurrency</li>
<li>Widely Used: Core in relational databases (MySQL, PostgreSQL)</li>
</ul>
</section>
<section id="types-of-2pl" class="level4">
<h4 class="anchored" data-anchor-id="types-of-2pl">Types of 2PL</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Variant</th>
<th>Rule</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Basic 2PL</td>
<td>Acquire then release</td>
<td>Serializability</td>
</tr>
<tr class="even">
<td>Strict 2PL</td>
<td>Hold locks until commit</td>
<td>Avoids cascading aborts</td>
</tr>
<tr class="odd">
<td>Conservative 2PL</td>
<td>Lock all at once</td>
<td>Deadlock-free</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself">Try It Yourself</h4>
<ol type="1">
<li>Simulate two transactions with overlapping data (X, Y) and apply 2PL.</li>
<li>Draw a lock timeline: when each transaction acquires/releases locks.</li>
<li>Compare results if locks were not used.</li>
<li>Add Strict 2PL: hold locks until commit, what changes?</li>
</ol>
</section>
<section id="test-cases" class="level4">
<h4 class="anchored" data-anchor-id="test-cases">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 29%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Locking Sequence</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1 locks X → T2 locks Y → T1 locks Y</td>
<td>Deadlock (waits for Y)</td>
<td>Conflict</td>
</tr>
<tr class="even">
<td>T1 locks X, Y → releases → T2 locks X</td>
<td>OK</td>
<td>Serializable</td>
</tr>
<tr class="odd">
<td>T1 unlocks X, then locks Y</td>
<td>Invalid (violates 2PL)</td>
<td>Error</td>
</tr>
<tr class="even">
<td>All locks held until commit (Strict 2PL)</td>
<td>Safe</td>
<td>Serializable</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity" class="level4">
<h4 class="anchored" data-anchor-id="complexity">Complexity</h4>
<ul>
<li>Time: O(n) per transaction (lock/unlock operations)</li>
<li>Space: O(#locks) for lock table</li>
</ul>
<p>Two-Phase Locking is your guardrail for concurrency, it keeps transactions from trampling over each other, ensuring every result is consistent, predictable, and correct.</p>
</section>
</section>
<section id="strict-two-phase-locking-strict-2pl" class="level3">
<h3 class="anchored" data-anchor-id="strict-two-phase-locking-strict-2pl">802 Strict Two-Phase Locking (Strict 2PL)</h3>
<p>Strict Two-Phase Locking (Strict 2PL) is a stronger version of 2PL designed to simplify recovery and prevent cascading aborts. It follows the same two-phase rule, grow, then shrink, but with one important twist: no locks are released until the transaction commits or aborts.</p>
<section id="what-problem-are-we-solving-1" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-1">What Problem Are We Solving?</h4>
<p>Basic 2PL ensures serializability, but it still allows a subtle problem: If one transaction reads data written by another uncommitted transaction, and that first one later aborts, we’re left with dirty reads. Other transactions might have built on data that never should have existed.</p>
<p>Strict 2PL solves this by delaying all unlocks until the transaction ends. That way, no other transaction can read or write a value that’s not fully committed.</p>
</section>
<section id="how-does-it-work-plain-language-1" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-1">How Does It Work (Plain Language)?</h4>
<p>Picture a cautious chef preparing a dish:</p>
<ul>
<li>During the growing phase, the chef grabs all the ingredients (locks).</li>
<li>In the shrinking phase, they release everything, but only after serving (commit or abort).</li>
</ul>
<p>This ensures no one tastes (reads) or borrows (writes) from a half-finished meal.</p>
<p>Let’s compare behaviors:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 14%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>Transaction</th>
<th>Step</th>
<th>Action</th>
<th>Lock Held</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1</td>
<td>1</td>
<td>Lock(X)</td>
<td>X</td>
<td>Acquires lock</td>
</tr>
<tr class="even">
<td>T2</td>
<td>2</td>
<td>Lock(X)</td>
<td>Wait</td>
<td>Must wait for T1</td>
</tr>
<tr class="odd">
<td>T1</td>
<td>3</td>
<td>Write(X), Commit</td>
<td>X</td>
<td>Still holds lock</td>
</tr>
<tr class="even">
<td>T1</td>
<td>4</td>
<td>Unlock(X)</td>
<td>–</td>
<td>Unlocks only at commit</td>
</tr>
<tr class="odd">
<td>T2</td>
<td>5</td>
<td>Lock(X), Read(X)</td>
<td>X</td>
<td>Reads committed value</td>
</tr>
</tbody>
</table>
<p>No transaction can see uncommitted data, guaranteeing safety even if a crash happens mid-run.</p>
</section>
<section id="tiny-code-easy-version-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-easy-version-1">Tiny Code (Easy Version)</h4>
<p>C (Lock Manager Simulation)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> locked<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> committed<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Lock<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> acquire<span class="op">(</span>Lock <span class="op">*</span>l<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>l<span class="op">-&gt;</span>locked<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Wait: lock is held.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    l<span class="op">-&gt;</span>locked <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Lock acquired.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> release<span class="op">(</span>Lock <span class="op">*</span>l<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>l<span class="op">-&gt;</span>committed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Cannot release before commit (Strict 2PL)</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    l<span class="op">-&gt;</span>locked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Lock released.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> commit<span class="op">(</span>Lock <span class="op">*</span>l<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    l<span class="op">-&gt;</span>committed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Transaction committed.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    release<span class="op">(</span>l<span class="op">);</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    Lock x <span class="op">=</span> <span class="op">{</span><span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">};</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    acquire<span class="op">(&amp;</span>x<span class="op">);</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    commit<span class="op">(&amp;</span>x<span class="op">);</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-1" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-1">Why It Matters</h4>
<ul>
<li>Prevents Cascading Aborts, uncommitted data is never read.</li>
<li>Simplifies Recovery, rollback only affects the failed transaction.</li>
<li>Ensures Strict Schedules, all reads/writes follow commit order.</li>
<li>Industry Standard, used in major DBMS engines for ACID safety.</li>
</ul>
</section>
<section id="example-timeline" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline">Example Timeline</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 28%">
<col style="width: 13%">
<col style="width: 22%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Time</th>
<th>T1 Action</th>
<th>T2 Action</th>
<th>Shared Data</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Lock(X), Write(X=5)</td>
<td>–</td>
<td>X=5 (locked)</td>
<td>T1 owns X</td>
</tr>
<tr class="even">
<td>2</td>
<td>–</td>
<td>Read(X)?</td>
<td>Wait</td>
<td>T2 must wait</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Commit</td>
<td>–</td>
<td>X=5 (committed)</td>
<td>Safe</td>
</tr>
<tr class="even">
<td>4</td>
<td>Unlock(X)</td>
<td>–</td>
<td>–</td>
<td>Lock freed</td>
</tr>
<tr class="odd">
<td>5</td>
<td>–</td>
<td>Read(X=5)</td>
<td>OK</td>
<td>T2 reads clean data</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-1" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-1">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate T1 writing X=10 and T2 reading X before T1 commits.</p>
<ul>
<li>Show that Strict 2PL blocks T2.</li>
</ul></li>
<li><p>Add a rollback before commit, confirm T2 never reads dirty data.</p></li>
<li><p>Visualize the lock table (resource → owner).</p></li>
<li><p>Compare with basic 2PL, what happens if T1 releases early?</p></li>
</ol>
</section>
<section id="test-cases-1" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-1">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 47%">
<col style="width: 22%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Strict 2PL Behavior</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1 writes X, T2 reads X before commit</td>
<td>T2 waits</td>
<td>No dirty read</td>
</tr>
<tr class="even">
<td>T1 aborts after T2 reads</td>
<td>Impossible</td>
<td>Safe</td>
</tr>
<tr class="odd">
<td>T1 unlocks before commit (violating rule)</td>
<td>Error</td>
<td>Inconsistent</td>
</tr>
<tr class="even">
<td>All locks released on commit</td>
<td>OK</td>
<td>Serializable + Recoverable</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-1" class="level4">
<h4 class="anchored" data-anchor-id="complexity-1">Complexity</h4>
<ul>
<li>Time: O(n) (per lock/unlock)</li>
<li>Space: O(#locked items)</li>
</ul>
<p>Strict 2PL trades a bit of concurrency for guaranteed safety. It’s the gold standard for ACID compliance, all reads are clean, all writes durable, all schedules strict.</p>
</section>
</section>
<section id="conservative-two-phase-locking-c2pl" class="level3">
<h3 class="anchored" data-anchor-id="conservative-two-phase-locking-c2pl">803 Conservative Two-Phase Locking (C2PL)</h3>
<p>Conservative Two-Phase Locking (C2PL) takes the 2PL principle one step further, it prevents deadlocks entirely by forcing a transaction to lock everything it needs at the very start, before doing any work. If even one lock isn’t available, the transaction waits instead of partially locking and risking circular waits.</p>
<section id="what-problem-are-we-solving-2" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-2">What Problem Are We Solving?</h4>
<p>In basic 2PL, transactions grab locks as they go. That flexibility is convenient but risky, if two transactions grab resources in different orders, they can deadlock (each waiting on the other forever).</p>
<p>Example deadlock:</p>
<ul>
<li>T1 locks X, wants Y</li>
<li>T2 locks Y, wants X</li>
</ul>
<p>Both wait forever, a classic standoff.</p>
<p>Conservative 2PL avoids this mess by planning ahead. It says: “If you can’t get all your locks now, don’t start.” This waits early, not late, trading throughput for certainty.</p>
</section>
<section id="how-does-it-work-plain-language-2" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-2">How Does It Work (Plain Language)?</h4>
<p>Think of it like a chess game: before you move, you must claim all the pieces you’ll touch this turn. If any piece is taken, you sit out and try again later.</p>
<p>Steps:</p>
<ol type="1">
<li>Declare all locks needed (e.g., {X, Y}).</li>
<li>Request them all at once.</li>
<li>If all granted, run the transaction.</li>
<li>If any denied, release and wait.</li>
<li>Release all locks only after commit or abort.</li>
</ol>
<p>This “all-or-nothing” lock acquisition ensures no circular wait because no transaction partially holds anything.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 33%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Action</th>
<th>Lock Table</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T1 requests {X, Y}</td>
<td>Granted</td>
<td>X:T1, Y:T1</td>
<td>T1 can proceed</td>
</tr>
<tr class="even">
<td>2</td>
<td>T2 requests {Y, Z}</td>
<td>Waits</td>
<td>Y locked</td>
<td>Avoids partial lock</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T1 commits, releases</td>
<td>Free</td>
<td>–</td>
<td>Locks cleared</td>
</tr>
<tr class="even">
<td>4</td>
<td>T2 retries {Y, Z}</td>
<td>Granted</td>
<td>Y:T2, Z:T2</td>
<td>Safe</td>
</tr>
</tbody>
</table>
<p>No deadlock is possible, every transaction either gets everything or nothing.</p>
</section>
<section id="tiny-code-conceptual-simulation" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation">Tiny Code (Conceptual Simulation)</h4>
<p>C (Predeclare Lock Set)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> X<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> Y<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LockTable<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> acquire_all<span class="op">(</span>LockTable <span class="op">*</span>table<span class="op">,</span> <span class="dt">bool</span> needX<span class="op">,</span> <span class="dt">bool</span> needY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>needX <span class="op">&amp;&amp;</span> table<span class="op">-&gt;</span>X<span class="op">)</span> <span class="op">||</span> <span class="op">(</span>needY <span class="op">&amp;&amp;</span> table<span class="op">-&gt;</span>Y<span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Cannot acquire all locks now, waiting...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>needX<span class="op">)</span> table<span class="op">-&gt;</span>X <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>needY<span class="op">)</span> table<span class="op">-&gt;</span>Y <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"All locks acquired.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> release_all<span class="op">(</span>LockTable <span class="op">*</span>table<span class="op">,</span> <span class="dt">bool</span> needX<span class="op">,</span> <span class="dt">bool</span> needY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>needX<span class="op">)</span> table<span class="op">-&gt;</span>X <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>needY<span class="op">)</span> table<span class="op">-&gt;</span>Y <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"All locks released.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    LockTable table <span class="op">=</span> <span class="op">{</span><span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">};</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>acquire_all<span class="op">(&amp;</span>table<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Transaction running...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        release_all<span class="op">(&amp;</span>table<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-2" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-2">Why It Matters</h4>
<ul>
<li>Deadlock-Free, no transaction ever blocks another mid-lock.</li>
<li>Predictable Behavior, transactions either run or wait.</li>
<li>Safe Scheduling, ideal for real-time or critical systems.</li>
<li>Simple Recovery, fewer mid-flight dependencies.</li>
</ul>
<p>Trade-off: less concurrency, waiting happens upfront, even if resources would’ve freed later.</p>
</section>
<section id="comparison-table" class="level4">
<h4 class="anchored" data-anchor-id="comparison-table">Comparison Table</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 38%">
<col style="width: 13%">
<col style="width: 23%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Basic 2PL</th>
<th>Strict 2PL</th>
<th>Conservative 2PL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Serializability</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr class="even">
<td>Cascading Abort Prevention</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr class="odd">
<td>Deadlock Prevention</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr class="even">
<td>Lock Timing</td>
<td>As needed</td>
<td>Hold till commit</td>
<td>All at start</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-2" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-2">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate two transactions (T1:{X,Y}, T2:{Y,X}).</p>
<ul>
<li>Try with basic 2PL → deadlock.</li>
<li>Try with C2PL → one waits early, no deadlock.</li>
</ul></li>
<li><p>Build a lock request queue for each resource.</p></li>
<li><p>Experiment with partial lock denial → transaction retries.</p></li>
</ol>
</section>
<section id="test-cases-2" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-2">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Lock Requests</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1:{X,Y}, T2:{Y,X}</td>
<td>All-or-nothing</td>
<td>No deadlock</td>
</tr>
<tr class="even">
<td>T1:{A,B,C} granted, T2:{B} waits</td>
<td>Ordered access</td>
<td>Safe</td>
</tr>
<tr class="odd">
<td>Partial lock grant</td>
<td>Denied</td>
<td>Wait</td>
</tr>
<tr class="even">
<td>All locks free</td>
<td>Granted</td>
<td>Run immediately</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-2" class="level4">
<h4 class="anchored" data-anchor-id="complexity-2">Complexity</h4>
<ul>
<li>Time: O(n) per lock request (checking availability)</li>
<li>Space: O(#resources × #transactions)</li>
</ul>
<p>Conservative 2PL is your peacekeeper, by thinking ahead, it avoids the traps of mid-flight contention. It’s cautious, yes, but in systems where predictability matters more than speed, it’s a wise choice.</p>
</section>
</section>
<section id="timestamp-ordering-to" class="level3">
<h3 class="anchored" data-anchor-id="timestamp-ordering-to">804 Timestamp Ordering (TO)</h3>
<p>Timestamp Ordering (TO) is a non-locking concurrency control method that orders all transactions by timestamps. Instead of locks, it uses logical time to ensure that the result of concurrent execution is equivalent to some serial order based on when transactions started.</p>
<section id="what-problem-are-we-solving-3" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-3">What Problem Are We Solving?</h4>
<p>Lock-based protocols like 2PL prevent conflicts by blocking transactions, which can lead to deadlocks or waiting. Timestamp ordering avoids that.</p>
<p>The idea: each transaction gets a timestamp when it begins. Every read or write must respect that order. If an operation would violate it, the transaction rolls back and restarts.</p>
<p>So rather than blocking, TO says:</p>
<blockquote class="blockquote">
<p>“If you’re too late, you restart. No waiting in line.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-3" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-3">How Does It Work (Plain Language)?</h4>
<p>Think of a library checkout system where every reader has a ticket number. You can only borrow or return a book if your number fits the time order, if you come late but try to rewrite history, the librarian (scheduler) denies your request.</p>
<p>Each data item X keeps:</p>
<ul>
<li><code>RT(X)</code>: Read Timestamp (largest timestamp that read X)</li>
<li><code>WT(X)</code>: Write Timestamp (largest timestamp that wrote X)</li>
</ul>
<p>When a transaction T with timestamp <code>TS(T)</code> tries to read or write, we compare timestamps:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 47%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Operation</th>
<th>Condition</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Read(X)</td>
<td>If <code>TS(T) &lt; WT(X)</code></td>
<td>Abort (too late, stale data)</td>
</tr>
<tr class="even">
<td>Write(X)</td>
<td>If <code>TS(T) &lt; RT(X)</code> or <code>TS(T) &lt; WT(X)</code></td>
<td>Abort (conflict)</td>
</tr>
<tr class="odd">
<td>Otherwise</td>
<td>Safe</td>
<td>Execute and update timestamps</td>
</tr>
</tbody>
</table>
<p>No locks, no waits, just immediate validation against logical time.</p>
</section>
<section id="example-walkthrough" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Operation</th>
<th>Condition</th>
<th>Action</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T1 (TS=5)</td>
<td>Write(X)</td>
<td>OK</td>
<td>WT(X)=5</td>
<td>Writes X</td>
</tr>
<tr class="even">
<td>2</td>
<td>T2 (TS=10)</td>
<td>Read(X)</td>
<td>10 &gt; 5</td>
<td>OK</td>
<td>Reads X</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T1 (TS=5)</td>
<td>Read(Y)</td>
<td>OK</td>
<td>RT(Y)=5</td>
<td>Reads Y</td>
</tr>
<tr class="even">
<td>4</td>
<td>T2 (TS=10)</td>
<td>Write(X)</td>
<td>10 &gt; RT(X)=10</td>
<td>OK</td>
<td>WT(X)=10</td>
</tr>
<tr class="odd">
<td>5</td>
<td>T1 (TS=5)</td>
<td>Write(X)</td>
<td>5 &lt; WT(X)=10</td>
<td>Abort</td>
<td>Too late</td>
</tr>
</tbody>
</table>
<p>T1 tries to write after a newer transaction has modified X, not allowed.</p>
</section>
<section id="tiny-code-conceptual-example" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-example">Tiny Code (Conceptual Example)</h4>
<p>C (Simplified Timestamp Check)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> RT<span class="op">;</span> <span class="co">// Read timestamp</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> WT<span class="op">;</span> <span class="co">// Write timestamp</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DataItem<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> read_item<span class="op">(</span>DataItem <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> TS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>TS <span class="op">&lt;</span> x<span class="op">-&gt;</span>WT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Abort: read too late (TS=</span><span class="sc">%d</span><span class="st">, WT=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> TS<span class="op">,</span> x<span class="op">-&gt;</span>WT<span class="op">);</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>TS <span class="op">&gt;</span> x<span class="op">-&gt;</span>RT<span class="op">)</span> x<span class="op">-&gt;</span>RT <span class="op">=</span> TS<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Read successful (TS=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> TS<span class="op">);</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> write_item<span class="op">(</span>DataItem <span class="op">*</span>x<span class="op">,</span> <span class="dt">int</span> TS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>TS <span class="op">&lt;</span> x<span class="op">-&gt;</span>RT <span class="op">||</span> TS <span class="op">&lt;</span> x<span class="op">-&gt;</span>WT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Abort: write too late (TS=</span><span class="sc">%d</span><span class="st">, RT=</span><span class="sc">%d</span><span class="st">, WT=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> TS<span class="op">,</span> x<span class="op">-&gt;</span>RT<span class="op">,</span> x<span class="op">-&gt;</span>WT<span class="op">);</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">-&gt;</span>WT <span class="op">=</span> TS<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Write successful (TS=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> TS<span class="op">);</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    DataItem X <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    write_item<span class="op">(&amp;</span>X<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    read_item<span class="op">(&amp;</span>X<span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    write_item<span class="op">(&amp;</span>X<span class="op">,</span> <span class="dv">5</span><span class="op">);</span> <span class="co">// Abort</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-3" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-3">Why It Matters</h4>
<ul>
<li>No Deadlocks, no waiting or circular waits</li>
<li>Deterministic Order, based on timestamps</li>
<li>Optimistic, transactions proceed freely, validated on each access</li>
<li>Good for Read-Mostly Workloads, fewer conflicts, more throughput</li>
</ul>
<p>Drawback: high abort rates if many concurrent writes conflict on the same data.</p>
</section>
<section id="variants" class="level4">
<h4 class="anchored" data-anchor-id="variants">Variants</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 43%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Variant</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Basic TO</td>
<td>Check timestamps at each operation</td>
<td>Simple databases</td>
</tr>
<tr class="even">
<td>Thomas Write Rule</td>
<td>Ignore obsolete writes instead of aborting</td>
<td>Reduces aborts</td>
</tr>
<tr class="odd">
<td>Multiversion TO</td>
<td>Combine with snapshots (MVCC)</td>
<td>Modern systems (e.g., PostgreSQL)</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-3" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-3">Try It Yourself</h4>
<ol type="1">
<li><p>Assign timestamps to T1=5, T2=10.</p>
<ul>
<li>Let T1 write X, then T2 write X, allowed.</li>
<li>Now T1 tries to write X again, should abort.</li>
</ul></li>
<li><p>Add a third transaction T3 (TS=15), reading and writing, trace timestamp updates.</p></li>
<li><p>Compare results with 2PL, how do waiting and aborting differ?</p></li>
</ol>
</section>
<section id="test-cases-3" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-3">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Condition</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1 (TS=5) reads after T2 (TS=10) writes</td>
<td>5 &lt; WT(X)=10</td>
<td>Abort</td>
</tr>
<tr class="even">
<td>T2 (TS=10) writes after T1 (TS=5) reads</td>
<td>10 &gt; RT(X)=5</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>T1 (TS=5) writes after T2 (TS=10) writes</td>
<td>5 &lt; WT(X)=10</td>
<td>Abort</td>
</tr>
<tr class="even">
<td>T2 (TS=10) reads X written by T1 (TS=5)</td>
<td>10 &gt; WT(X)=5</td>
<td>OK</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-3" class="level4">
<h4 class="anchored" data-anchor-id="complexity-3">Complexity</h4>
<ul>
<li>Time: O(1) per access (timestamp check)</li>
<li>Space: O(#items) for <code>RT</code> and <code>WT</code></li>
</ul>
<p>Timestamp Ordering swaps waiting for rewinding, transactions race ahead but may be rolled back if they arrive out of order. It’s an elegant balance between optimism and order, perfect for systems that favor speed over contention.</p>
</section>
</section>
<section id="multiversion-concurrency-control-mvcc" class="level3">
<h3 class="anchored" data-anchor-id="multiversion-concurrency-control-mvcc">805 Multiversion Concurrency Control (MVCC)</h3>
<p>Multiversion Concurrency Control (MVCC) is a snapshot-based concurrency method that lets readers and writers coexist peacefully. Instead of blocking each other with locks, every write creates a new version of the data, and every reader sees a consistent snapshot of the database as of when it started.</p>
<section id="what-problem-are-we-solving-4" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-4">What Problem Are We Solving?</h4>
<p>In traditional locking schemes, readers block writers and writers block readers, slowing down workloads that mix reads and writes.</p>
<p>MVCC flips the script. Readers don’t block writers because they read old committed versions, and writers don’t block readers because they write new versions.</p>
<p>The result: high concurrency, no dirty reads, and a consistent view for each transaction.</p>
</section>
<section id="how-does-it-work-plain-language-4" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-4">How Does It Work (Plain Language)?</h4>
<p>Imagine a library where no one fights over a single copy. Each time a writer updates a book, they make a new edition. Readers keep reading the edition they checked out when they entered.</p>
<p>Each version has:</p>
<ul>
<li><code>WriteTS</code> – when it was written</li>
<li><code>ValidFrom</code>, <code>ValidTo</code> – version’s time range</li>
<li>Data value</li>
</ul>
<p>When a transaction starts, it gets a snapshot timestamp (its view of time).</p>
<ul>
<li>Readers see the latest version whose <code>WriteTS ≤ snapshot</code>.</li>
<li>Writers create new versions at commit time, marking older ones as expired.</li>
</ul>
</section>
<section id="example-walkthrough-1" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-1">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 15%">
<col style="width: 16%">
<col style="width: 36%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Operation</th>
<th>Version Table (X)</th>
<th>Visible To</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T1 (TS=5)</td>
<td>Write X=10</td>
<td>X₁: {value=10, WriteTS=5}</td>
<td>All TS ≥ 5</td>
</tr>
<tr class="even">
<td>2</td>
<td>T2 (TS=8)</td>
<td>Read X</td>
<td>Sees X₁ (TS=5)</td>
<td>OK</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T3 (TS=12)</td>
<td>Write X=20</td>
<td>X₂: {value=20, WriteTS=12}</td>
<td>All TS ≥ 12</td>
</tr>
<tr class="even">
<td>4</td>
<td>T2 (TS=8)</td>
<td>Read X again</td>
<td>Still X₁</td>
<td>Snapshot isolation</td>
</tr>
<tr class="odd">
<td>5</td>
<td>T2 commits</td>
<td>–</td>
<td>–</td>
<td>Consistent snapshot</td>
</tr>
</tbody>
</table>
<p>Even if T3 writes new data, T2 keeps seeing its old snapshot, no inconsistency, no blocking.</p>
</section>
<section id="tiny-code-conceptual-example-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-example-1">Tiny Code (Conceptual Example)</h4>
<p>C (Simplified Version Table)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> writeTS<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Version<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>Version versions<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> version_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> write_value<span class="op">(</span><span class="dt">int</span> ts<span class="op">,</span> <span class="dt">int</span> val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    versions<span class="op">[</span>version_count<span class="op">].</span>value <span class="op">=</span> val<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    versions<span class="op">[</span>version_count<span class="op">].</span>writeTS <span class="op">=</span> ts<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    version_count<span class="op">++;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Write: X=</span><span class="sc">%d</span><span class="st"> at TS=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> val<span class="op">,</span> ts<span class="op">);</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> read_value<span class="op">(</span><span class="dt">int</span> ts<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> visible <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> version_count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>versions<span class="op">[</span>i<span class="op">].</span>writeTS <span class="op">&lt;=</span> ts<span class="op">)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            visible <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Read: X=</span><span class="sc">%d</span><span class="st"> (TS=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> versions<span class="op">[</span>visible<span class="op">].</span>value<span class="op">,</span> ts<span class="op">);</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> versions<span class="op">[</span>visible<span class="op">].</span>value<span class="op">;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    write_value<span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    write_value<span class="op">(</span><span class="dv">12</span><span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    read_value<span class="op">(</span><span class="dv">8</span><span class="op">);</span>  <span class="co">// sees version 5</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    read_value<span class="op">(</span><span class="dv">15</span><span class="op">);</span> <span class="co">// sees version 12</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-4" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-4">Why It Matters</h4>
<ul>
<li>Readers never block, they read consistent snapshots.</li>
<li>Writers never block readers, they add new versions.</li>
<li>Prevents dirty reads, non-repeatable reads, ensures snapshot isolation.</li>
<li>Used by major databases: PostgreSQL, Oracle, CockroachDB.</li>
</ul>
<p>Trade-off: needs version cleanup (garbage collection) to remove obsolete data.</p>
</section>
<section id="key-concepts" class="level4">
<h4 class="anchored" data-anchor-id="key-concepts">Key Concepts</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 68%">
</colgroup>
<thead>
<tr class="header">
<th>Concept</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Snapshot Isolation</td>
<td>Each transaction sees a fixed snapshot at start</td>
</tr>
<tr class="even">
<td>Version Chain</td>
<td>Linked list of old values per data item</td>
</tr>
<tr class="odd">
<td>Garbage Collection</td>
<td>Remove old versions no longer visible</td>
</tr>
<tr class="even">
<td>Conflict Detection</td>
<td>Writers check overlapping updates before commit</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-4" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-4">Try It Yourself</h4>
<ol type="1">
<li>Simulate T1 (TS=5) writing X=10, T2 (TS=8) reading X, T3 (TS=12) writing X=20.</li>
<li>Let T2 read before and after T3’s write, snapshot stays stable.</li>
<li>Add garbage collection: remove versions with <code>WriteTS &lt; min(active TS)</code>.</li>
<li>Compare with locking: what’s different in behavior and concurrency?</li>
</ol>
</section>
<section id="test-cases-4" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-4">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 44%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Reader starts before writer</td>
<td>Reads old version</td>
<td>Consistent</td>
</tr>
<tr class="even">
<td>Writer starts before reader</td>
<td>Reader sees writer only if committed</td>
<td>No dirty read</td>
</tr>
<tr class="odd">
<td>Concurrent writes</td>
<td>New version chain</td>
<td>Conflict detection</td>
</tr>
<tr class="even">
<td>Long-running read</td>
<td>Snapshot stays fixed</td>
<td>Repeatable reads</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-4" class="level4">
<h4 class="anchored" data-anchor-id="complexity-4">Complexity</h4>
<ul>
<li>Time: O(#versions per item) to find visible version</li>
<li>Space: O(total versions) until garbage collected</li>
</ul>
<p>MVCC is like a time-traveling database, every transaction gets its own consistent world. By turning conflict into coexistence, it powers the high-performance, non-blocking systems behind modern relational and distributed databases.</p>
</section>
</section>
<section id="optimistic-concurrency-control-occ" class="level3">
<h3 class="anchored" data-anchor-id="optimistic-concurrency-control-occ">806 Optimistic Concurrency Control (OCC)</h3>
<p>Optimistic Concurrency Control (OCC) assumes that conflicts are rare, so transactions can run without locks, and only check for conflicts at the end, during validation. If no conflicts are found, the transaction commits; if conflicts exist, it rolls back and retries.</p>
<section id="what-problem-are-we-solving-5" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-5">What Problem Are We Solving?</h4>
<p>Locking (like 2PL) prevents conflicts by blocking access, but that means waiting and deadlocks. In read-heavy workloads where collisions are infrequent, that’s wasteful.</p>
<p>OCC flips the mindset:</p>
<blockquote class="blockquote">
<p>“Let everyone run freely. We’ll check for trouble at the finish line.”</p>
</blockquote>
<p>This approach maximizes concurrency, especially in low-contention systems, by separating execution from validation.</p>
</section>
<section id="how-does-it-work-plain-language-5" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-5">How Does It Work (Plain Language)?</h4>
<p>Think of a group project where everyone edits their own copy, then at the end, a teacher compares notes. If no two people changed the same part, all merges succeed; if not, someone has to redo.</p>
<p>OCC runs each transaction through three phases:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 74%">
</colgroup>
<thead>
<tr class="header">
<th>Phase</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1. Read Phase</td>
<td>Transaction reads data, makes local copies, computes changes.</td>
</tr>
<tr class="even">
<td>2. Validation Phase</td>
<td>Before committing, check for conflicts with committed transactions.</td>
</tr>
<tr class="odd">
<td>3. Write Phase</td>
<td>If validation passes, apply updates atomically. Otherwise, abort.</td>
</tr>
</tbody>
</table>
<p>No locks are used while reading or writing locally, only a validation check before commit decides success.</p>
</section>
<section id="example-walkthrough-2" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-2">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 43%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Phase</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T1</td>
<td>Read</td>
<td>Read X=5</td>
<td>Local copy</td>
</tr>
<tr class="even">
<td>2</td>
<td>T2</td>
<td>Read</td>
<td>Read X=5</td>
<td>Local copy</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T1</td>
<td>Compute</td>
<td>X=5+1</td>
<td>Local change (6)</td>
</tr>
<tr class="even">
<td>4</td>
<td>T2</td>
<td>Compute</td>
<td>X=5+2</td>
<td>Local change (7)</td>
</tr>
<tr class="odd">
<td>5</td>
<td>T1</td>
<td>Validate</td>
<td>No conflict (T2 not committed)</td>
<td>Commit X=6</td>
</tr>
<tr class="even">
<td>6</td>
<td>T2</td>
<td>Validate</td>
<td>Conflict: X changed since read</td>
<td>Abort and retry</td>
</tr>
</tbody>
</table>
<p>Both worked in parallel; T2 must retry since its read set overlapped with a changed item.</p>
</section>
<section id="tiny-code-conceptual-simulation-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-1">Tiny Code (Conceptual Simulation)</h4>
<p>C (Simple OCC Example)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> version<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> DataItem<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> validate<span class="op">(</span>DataItem <span class="op">*</span>item<span class="op">,</span> <span class="dt">int</span> readVersion<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> item<span class="op">-&gt;</span>version <span class="op">==</span> readVersion<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> commit<span class="op">(</span>DataItem <span class="op">*</span>item<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>localValue<span class="op">,</span> <span class="dt">int</span> readVersion<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>validate<span class="op">(</span>item<span class="op">,</span> readVersion<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Abort: data changed by another transaction.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    item<span class="op">-&gt;</span>value <span class="op">=</span> <span class="op">*</span>localValue<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    item<span class="op">-&gt;</span>version<span class="op">++;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Commit successful. New value = </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> item<span class="op">-&gt;</span>value<span class="op">);</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    DataItem X <span class="op">=</span> <span class="op">{</span><span class="dv">5</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> local <span class="op">=</span> X<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    local <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    commit<span class="op">(&amp;</span>X<span class="op">,</span> <span class="op">&amp;</span>local<span class="op">,</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// OK</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> local2 <span class="op">=</span> X<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    local2 <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    commit<span class="op">(&amp;</span>X<span class="op">,</span> <span class="op">&amp;</span>local2<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// Abort (version changed)</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-5" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-5">Why It Matters</h4>
<ul>
<li>High Concurrency, no locks during execution.</li>
<li>No Deadlocks, transactions don’t block each other.</li>
<li>Ideal for Read-Heavy Workloads, where conflicts are rare.</li>
<li>Clear Validation Logic, easy to reason about correctness.</li>
</ul>
<p>Trade-off: wasted work if many conflicts, transactions may repeat often.</p>
</section>
<section id="validation-rules-simplified" class="level4">
<h4 class="anchored" data-anchor-id="validation-rules-simplified">Validation Rules (Simplified)</h4>
<p>Each transaction T has:</p>
<ul>
<li>Read Set (RS) – items read</li>
<li>Write Set (WS) – items written</li>
<li>TS(T) – timestamp</li>
</ul>
<p>At commit, T passes validation if for every committed Tᵢ:</p>
<ul>
<li>Tᵢ finishes before T starts, or</li>
<li>RS(T) ∩ WS(Tᵢ) = ∅ (no overlap)</li>
</ul>
<p>If conflict found → abort and retry.</p>
</section>
<section id="try-it-yourself-5" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-5">Try It Yourself</h4>
<ol type="1">
<li>Run two transactions reading X, both writing new values.</li>
<li>Validate sequentially, see which one passes.</li>
<li>Add a third read-only transaction, should always pass.</li>
<li>Vary overlap between read/write sets to test conflict detection.</li>
</ol>
</section>
<section id="test-cases-5" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-5">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 67%">
<col style="width: 12%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Conflict</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Two transactions read same data, one writes</td>
<td>No</td>
<td>Both commit</td>
</tr>
<tr class="even">
<td>Two write same data</td>
<td>Yes</td>
<td>One aborts</td>
</tr>
<tr class="odd">
<td>Read-only transactions</td>
<td>None</td>
<td>Always commit</td>
</tr>
<tr class="even">
<td>High contention</td>
<td>Frequent</td>
<td>Many retries</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-5" class="level4">
<h4 class="anchored" data-anchor-id="complexity-5">Complexity</h4>
<ul>
<li>Time: O(#active transactions) during validation</li>
<li>Space: O(#read/write sets) per transaction</li>
</ul>
<p>Optimistic Concurrency Control is trust but verify for databases, let transactions race ahead, then double-check before sealing the deal. In workloads where contention is rare, OCC shines with near-lock-free performance and clean serializable results.</p>
</section>
</section>
<section id="serializable-snapshot-isolation-ssi" class="level3">
<h3 class="anchored" data-anchor-id="serializable-snapshot-isolation-ssi">807 Serializable Snapshot Isolation (SSI)</h3>
<p>Serializable Snapshot Isolation (SSI) is a hybrid concurrency control scheme that merges the speed of MVCC with the safety of full serializability. It builds on snapshot isolation (SI), where every transaction sees a consistent snapshot, and adds conflict detection to prevent anomalies that SI alone can’t catch.</p>
<section id="what-problem-are-we-solving-6" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-6">What Problem Are We Solving?</h4>
<p>Snapshot Isolation (like in MVCC) avoids dirty reads and non-repeatable reads, but it is not fully serializable. It can still produce write skew anomalies, where two transactions read overlapping data and write disjoint but conflicting updates.</p>
<p>Example of write skew:</p>
<ul>
<li>T1: reads X, Y → updates X</li>
<li>T2: reads X, Y → updates Y Both think the condition holds and commit, but together they break an invariant (e.g., “X + Y ≥ 1”).</li>
</ul>
<p>SSI fixes this by detecting dangerous dependency patterns and aborting transactions that would violate serializability.</p>
</section>
<section id="how-does-it-work-plain-language-6" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-6">How Does It Work (Plain Language)?</h4>
<p>Imagine every transaction walks through the database wearing snapshot glasses. They see the world as it was when they started. If two walkers make changes that can’t coexist in any real order, one gets stopped at the gate.</p>
<p>Steps:</p>
<ol type="1">
<li>Read Phase – Transaction reads from its snapshot and records dependencies.</li>
<li>Write Phase – Tentative writes stored, visible only after validation.</li>
<li>Validation Phase – Detect “dangerous structures” (e.g., T1 → T2 → T3 cycles).</li>
<li>Commit – Only if no serialization conflict is found.</li>
</ol>
<p>So each transaction acts on its own versioned world, but SSI ensures those worlds can be arranged into a conflict-free serial order.</p>
</section>
<section id="example-walkthrough-3" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-3">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Action</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T1 (<a href="mailto:start@5" class="email">start@5</a>)</td>
<td>Reads X=10, Y=10</td>
<td>Snapshot view</td>
</tr>
<tr class="even">
<td>2</td>
<td>T2 (<a href="mailto:start@6" class="email">start@6</a>)</td>
<td>Reads X=10, Y=10</td>
<td>Snapshot view</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T1</td>
<td>Updates X=0</td>
<td>Tentative write</td>
</tr>
<tr class="even">
<td>4</td>
<td>T2</td>
<td>Updates Y=0</td>
<td>Tentative write</td>
</tr>
<tr class="odd">
<td>5</td>
<td>T1 Commit</td>
<td>OK</td>
<td>No prior conflicts</td>
</tr>
<tr class="even">
<td>6</td>
<td>T2 Commit</td>
<td>Conflict detected (write skew)</td>
<td>Abort</td>
</tr>
</tbody>
</table>
<p>Both tried to update disjoint data, but together violated invariant → SSI aborts one.</p>
</section>
<section id="tiny-code-conceptual-illustration" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-illustration">Tiny Code (Conceptual Illustration)</h4>
<p>C (Simplified Conflict Check)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> readX<span class="op">,</span> readY<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> writeX<span class="op">,</span> writeY<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Txn<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> conflict<span class="op">(</span>Txn a<span class="op">,</span> Txn b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>a<span class="op">.</span>readX <span class="op">&amp;&amp;</span> b<span class="op">.</span>writeX<span class="op">)</span> <span class="op">||</span> <span class="op">(</span>a<span class="op">.</span>readY <span class="op">&amp;&amp;</span> b<span class="op">.</span>writeY<span class="op">))</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    Txn T1 <span class="op">=</span> <span class="op">{.</span>readX <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="op">.</span>readY <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="op">.</span>writeX <span class="op">=</span> <span class="kw">true</span><span class="op">};</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    Txn T2 <span class="op">=</span> <span class="op">{.</span>readX <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="op">.</span>readY <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="op">.</span>writeY <span class="op">=</span> <span class="kw">true</span><span class="op">};</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>conflict<span class="op">(</span>T1<span class="op">,</span> T2<span class="op">))</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Conflict detected: abort one transaction.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"No conflict: can commit both.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output: <code>Conflict detected: abort one transaction.</code></p>
</section>
<section id="why-it-matters-6" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-6">Why It Matters</h4>
<ul>
<li>Serializable – guarantees true serializable behavior.</li>
<li>MVCC-based – still non-blocking reads.</li>
<li>Anomaly-Free – prevents write skew, phantoms, and dangerous cycles.</li>
<li>Used by PostgreSQL – default for SERIALIZABLE isolation level.</li>
</ul>
<p>Trade-off: needs dependency tracking and conflict analysis, which add overhead.</p>
</section>
<section id="ssi-dependency-types" class="level4">
<h4 class="anchored" data-anchor-id="ssi-dependency-types">SSI Dependency Types</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 73%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Dependency</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>rw-conflict</td>
<td>T1 reads X, T2 later writes X</td>
</tr>
<tr class="even">
<td>wr-conflict</td>
<td>T1 writes X, T2 later reads X</td>
</tr>
<tr class="odd">
<td>ww-conflict</td>
<td>Both write same X</td>
</tr>
<tr class="even">
<td>SSI looks for rw-cycles (T1 → T2 → T3 → T1) as signs of non-serializability.</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-6" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-6">Try It Yourself</h4>
<ol type="1">
<li>Simulate two transactions reading overlapping data and writing disjoint updates.</li>
<li>Check if invariant (e.g., <code>X + Y ≥ 1</code>) still holds after both commit.</li>
<li>Add conflict detection logic, abort one when cycle found.</li>
<li>Compare with plain SI, see anomaly disappear under SSI.</li>
</ol>
</section>
<section id="test-cases-6" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-6">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Isolation</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Write skew (X+Y ≥ 1)</td>
<td>SI</td>
<td>Violated</td>
</tr>
<tr class="even">
<td>Write skew (X+Y ≥ 1)</td>
<td>SSI</td>
<td>Prevented (abort)</td>
</tr>
<tr class="odd">
<td>Concurrent readers only</td>
<td>SSI</td>
<td>No aborts</td>
</tr>
<tr class="even">
<td>Overlapping writes</td>
<td>SSI</td>
<td>Conflict → abort one</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-6" class="level4">
<h4 class="anchored" data-anchor-id="complexity-6">Complexity</h4>
<ul>
<li>Time: O(#dependencies) per validation</li>
<li>Space: O(#active transactions × #reads/writes)</li>
</ul>
<p>Serializable Snapshot Isolation is like giving every transaction a time bubble, then checking afterward if those bubbles can line up without overlapping in illegal ways. It delivers serializable safety with snapshot performance, a modern best-of-both-worlds solution for databases.</p>
</section>
</section>
<section id="lock-free-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="lock-free-algorithm">808 Lock-Free Algorithm</h3>
<p>Lock-Free algorithms are the superheroes of concurrency, they coordinate threads without using locks, avoiding deadlocks, priority inversion, and context-switch overhead. Instead of mutual exclusion, they rely on atomic operations (like Compare-and-Swap) to ensure correctness even when many threads race ahead together.</p>
<section id="what-problem-are-we-solving-7" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-7">What Problem Are We Solving?</h4>
<p>In traditional concurrency, locks are used to protect shared data. But locks can cause:</p>
<ul>
<li>Deadlocks – when threads wait on each other forever</li>
<li>Starvation – some threads never get a chance</li>
<li>Blocking delays – a slow or paused thread holds everyone back</li>
</ul>
<p>Lock-free algorithms fix this by ensuring progress, at least one thread always makes forward progress, no matter what others do.</p>
<blockquote class="blockquote">
<p>The system never freezes, it keeps moving.</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-7" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-7">How Does It Work (Plain Language)?</h4>
<p>Instead of locking a resource, a lock-free algorithm optimistically updates shared data using atomic primitives. If a conflict occurs, the thread retries, no waiting, no blocking.</p>
<p>Key primitive: Compare-And-Swap (CAS)</p>
<pre><code>CAS(address, expected, new)</code></pre>
<p>Atomically checks if <code>*address == expected</code>. If yes → replace with <code>new</code> and return true. If not → return false (someone else changed it).</p>
<p>Threads keep looping until their CAS succeeds, that’s the “lock-free dance.”</p>
</section>
<section id="example-lock-free-stack" class="level4">
<h4 class="anchored" data-anchor-id="example-lock-free-stack">Example: Lock-Free Stack</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 22%">
<col style="width: 30%">
<col style="width: 15%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Thread A</th>
<th>Thread B</th>
<th>Stack Top</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Reads top = X</td>
<td>–</td>
<td>X</td>
<td>A plans push(Y)</td>
</tr>
<tr class="even">
<td>2</td>
<td>–</td>
<td>Reads top = X</td>
<td>X</td>
<td>B plans push(Z)</td>
</tr>
<tr class="odd">
<td>3</td>
<td>A CAS(X, Y)</td>
<td>succeeds</td>
<td>Y</td>
<td>Y → X</td>
</tr>
<tr class="even">
<td>4</td>
<td>B CAS(X, Z)</td>
<td>fails</td>
<td>–</td>
<td>Top changed</td>
</tr>
<tr class="odd">
<td>5</td>
<td>B retries</td>
<td>CAS(Y, Z) succeeds</td>
<td>Z</td>
<td>Z → Y → X</td>
</tr>
</tbody>
</table>
<p>No locks, both threads push safely via atomic retries.</p>
</section>
<section id="tiny-code-c-example-with-cas" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-example-with-cas">Tiny Code (C Example with CAS)</h4>
<p>C (Lock-Free Stack Push)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdatomic.h&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Node <span class="op">{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Node<span class="op">*</span> next<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Node<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">_Atomic</span><span class="op">(</span>Node<span class="op">*)</span> top <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> push<span class="op">(</span><span class="dt">int</span> val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    Node<span class="op">*</span> new_node <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Node<span class="op">));</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    new_node<span class="op">-&gt;</span>value <span class="op">=</span> val<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    Node<span class="op">*</span> old_top<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        old_top <span class="op">=</span> atomic_load<span class="op">(&amp;</span>top<span class="op">);</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        new_node<span class="op">-&gt;</span>next <span class="op">=</span> old_top<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>atomic_compare_exchange_weak<span class="op">(&amp;</span>top<span class="op">,</span> <span class="op">&amp;</span>old_top<span class="op">,</span> new_node<span class="op">));</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Pushed </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> val<span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    push<span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each push:</p>
<ul>
<li>Loads the current top</li>
<li>Points new node to it</li>
<li>Attempts CAS to install the new top</li>
<li>Retries if another thread changed <code>top</code></li>
</ul>
</section>
<section id="why-it-matters-7" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-7">Why It Matters</h4>
<ul>
<li>No Deadlocks – progress guaranteed</li>
<li>No Blocking – slow threads don’t hold others</li>
<li>High Performance – fewer context switches</li>
<li>Scalable – ideal for multicore systems</li>
</ul>
<p>Used in:</p>
<ul>
<li>Concurrent queues, stacks, hash maps</li>
<li>Memory allocators, garbage collectors</li>
<li>High-performance databases and kernels</li>
</ul>
</section>
<section id="progress-guarantees" class="level4">
<h4 class="anchored" data-anchor-id="progress-guarantees">Progress Guarantees</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 72%">
</colgroup>
<thead>
<tr class="header">
<th>Guarantee</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Wait-Free</td>
<td>Every thread finishes in bounded steps</td>
</tr>
<tr class="even">
<td>Lock-Free</td>
<td>System makes progress (at least one thread succeeds)</td>
</tr>
<tr class="odd">
<td>Obstruction-Free</td>
<td>Progress if no interference</td>
</tr>
</tbody>
</table>
<p>Lock-Free sits in the middle, a good balance between safety and performance.</p>
</section>
<section id="try-it-yourself-7" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-7">Try It Yourself</h4>
<ol type="1">
<li>Implement a lock-free stack or counter using <code>atomic_compare_exchange_weak</code>.</li>
<li>Add two threads incrementing a shared counter, watch CAS retries in action.</li>
<li>Compare with a mutex-based version, note CPU usage and fairness.</li>
<li>Simulate interference, ensure at least one thread always moves forward.</li>
</ol>
</section>
<section id="test-cases-7" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-7">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Description</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Single thread push</td>
<td>No conflict</td>
<td>Success</td>
</tr>
<tr class="even">
<td>Two threads push</td>
<td>CAS retry loop</td>
<td>Both succeed</td>
</tr>
<tr class="odd">
<td>CAS failure</td>
<td>Detected by compare</td>
<td>Retry</td>
</tr>
<tr class="even">
<td>Pause one thread</td>
<td>Other continues</td>
<td>Progress</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-7" class="level4">
<h4 class="anchored" data-anchor-id="complexity-7">Complexity</h4>
<ul>
<li>Time: O(1) average per operation (with retries)</li>
<li>Space: O(n) for data structure</li>
</ul>
<p>Lock-Free algorithms are the art of optimism in concurrency, no waiting, no locking, just atomic cooperation. They shine in high-throughput, low-latency systems where speed and liveness matter more than simplicity.</p>
</section>
</section>
<section id="wait-die-wound-wait" class="level3">
<h3 class="anchored" data-anchor-id="wait-die-wound-wait">809 Wait-Die / Wound-Wait</h3>
<p>The Wait-Die and Wound-Wait schemes are classic deadlock prevention strategies in timestamp-based concurrency control. They use transaction timestamps to decide who waits and who aborts, keeping the system moving and avoiding circular waits entirely.</p>
<section id="what-problem-are-we-solving-8" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-8">What Problem Are We Solving?</h4>
<p>When multiple transactions compete for the same resources, deadlocks can occur:</p>
<ul>
<li>T1 locks X and wants Y</li>
<li>T2 locks Y and wants X → both wait forever</li>
</ul>
<p>We need a rule that breaks these cycles before they form.</p>
<p>The trick? Give every transaction a timestamp (its “age”) and use it to resolve conflicts deterministically, no cycles, no guessing.</p>
</section>
<section id="how-does-it-work-plain-language-8" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-8">How Does It Work (Plain Language)?</h4>
<p>Each transaction T gets a timestamp TS(T) when it starts. Whenever T requests a lock held by another transaction U, we apply one of two strategies:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 62%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Scheme</th>
<th>Rule</th>
<th>Intuition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Wait-Die</td>
<td>If T is older than U → wait; else (younger) → abort (die)</td>
<td>Old ones wait, young ones restart</td>
</tr>
<tr class="even">
<td>Wound-Wait</td>
<td>If T is older than U → wound (abort U); else (younger) → wait</td>
<td>Old ones preempt, young ones wait</td>
</tr>
</tbody>
</table>
<p>Because timestamps never change, cycles cannot form, one direction always wins.</p>
</section>
<section id="example-walkthrough-4" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-4">Example Walkthrough</h4>
<p>Let TS(T1)=5 (older), TS(T2)=10 (younger)</p>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 53%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Scheme</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T1 (old) wants lock held by T2</td>
<td>Wait-Die: T1 waits <br> Wound-Wait: T2 aborts</td>
<td>Safe either way</td>
</tr>
<tr class="even">
<td>T2 (young) wants lock held by T1</td>
<td>Wait-Die: T2 aborts <br> Wound-Wait: T2 waits</td>
<td>Safe either way</td>
</tr>
</tbody>
</table>
<p>No cycle is possible, all waits move from older to younger, or abort younger, breaking loops.</p>
</section>
<section id="tiny-code-conceptual-simulation-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-2">Tiny Code (Conceptual Simulation)</h4>
<p>C (Wait-Die Logic)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ts<span class="op">;</span> <span class="co">// timestamp</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Txn<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> wait_die<span class="op">(</span>Txn T<span class="op">,</span> Txn U<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>T<span class="op">.</span>ts <span class="op">&lt;</span> U<span class="op">.</span>ts<span class="op">)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"T</span><span class="sc">%d</span><span class="st"> waits for T</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> T<span class="op">.</span>id<span class="op">,</span> U<span class="op">.</span>id<span class="op">);</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"T</span><span class="sc">%d</span><span class="st"> aborts (younger than T</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> T<span class="op">.</span>id<span class="op">,</span> U<span class="op">.</span>id<span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    Txn T1 <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">};</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    Txn T2 <span class="op">=</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">10</span><span class="op">};</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    wait_die<span class="op">(</span>T1<span class="op">,</span> T2<span class="op">);</span> <span class="co">// T1 waits</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    wait_die<span class="op">(</span>T2<span class="op">,</span> T1<span class="op">);</span> <span class="co">// T2 aborts</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>T1 waits for T2  
T2 aborts (younger than T1)</code></pre>
</section>
<section id="why-it-matters-8" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-8">Why It Matters</h4>
<ul>
<li>Deadlock-Free, no circular waits ever form</li>
<li>Fair, older transactions prioritized</li>
<li>Predictable, simple, timestamp-based rules</li>
<li>Compatible with 2PL, plug-in deadlock prevention</li>
</ul>
<p>Trade-off: younger transactions may abort frequently in high-contention systems.</p>
</section>
<section id="comparison" class="level4">
<h4 class="anchored" data-anchor-id="comparison">Comparison</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Feature</th>
<th>Wait-Die</th>
<th>Wound-Wait</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Older wants lock</td>
<td>Wait</td>
<td>Abort younger</td>
</tr>
<tr class="even">
<td>Younger wants lock</td>
<td>Abort</td>
<td>Wait</td>
</tr>
<tr class="odd">
<td>Starvation</td>
<td>Possible for young</td>
<td>Rare</td>
</tr>
<tr class="even">
<td>Aggressiveness</td>
<td>Conservative</td>
<td>Aggressive</td>
</tr>
<tr class="odd">
<td>Implementation</td>
<td>Easier</td>
<td>Slightly complex</td>
</tr>
</tbody>
</table>
</section>
<section id="try-it-yourself-8" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-8">Try It Yourself</h4>
<ol type="1">
<li><p>Assign timestamps T1=5, T2=10.</p>
<ul>
<li>T1 wants T2’s lock → compare rules.</li>
<li>T2 wants T1’s lock → compare rules.</li>
</ul></li>
<li><p>Add a third transaction T3=15 and simulate conflicts.</p></li>
<li><p>Observe how order always flows older → younger, never forming cycles.</p></li>
<li><p>Try integrating with 2PL: apply rules before acquiring locks.</p></li>
</ol>
</section>
<section id="test-cases-8" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-8">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Conflict</th>
<th>Wait-Die</th>
<th>Wound-Wait</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Old wants lock from young</td>
<td>Wait</td>
<td>Abort young</td>
<td>No deadlock</td>
</tr>
<tr class="even">
<td>Young wants lock from old</td>
<td>Abort</td>
<td>Wait</td>
<td>No deadlock</td>
</tr>
<tr class="odd">
<td>Equal timestamps</td>
<td>Choose order</td>
<td>Choose order</td>
<td>Deterministic</td>
</tr>
<tr class="even">
<td>Multiple waits</td>
<td>Directed by TS</td>
<td>Directed by TS</td>
<td>Acyclic graph</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-8" class="level4">
<h4 class="anchored" data-anchor-id="complexity-8">Complexity</h4>
<ul>
<li>Time: O(1) per conflict check (compare timestamps)</li>
<li>Space: O(#active transactions) for timestamp table</li>
</ul>
<p>Wait-Die and Wound-Wait are elegant timestamp rules that turn potential deadlocks into quick decisions, old transactions keep their dignity, young ones retry politely.</p>
</section>
</section>
<section id="deadlock-detection-wait-for-graph" class="level3">
<h3 class="anchored" data-anchor-id="deadlock-detection-wait-for-graph">810 Deadlock Detection (Wait-for Graph)</h3>
<p>Deadlock Detection is the watchdog of concurrency control. Instead of preventing deadlocks in advance, it allows them to occur and then detects and resolves them automatically. This strategy is ideal for systems where deadlocks are rare but possible, and where concurrency should remain as high as possible.</p>
<section id="what-problem-are-we-solving-9" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-9">What Problem Are We Solving?</h4>
<p>When multiple transactions compete for shared resources, they may enter a circular wait that halts progress entirely.</p>
<p>Example:</p>
<ul>
<li>T₁ locks X, then requests Y</li>
<li>T₂ locks Y, then requests X</li>
</ul>
<p>Now neither can proceed. Both are waiting on each other, forming a deadlock.</p>
<p>If we cannot avoid such patterns ahead of time, we must detect them dynamically and recover by aborting one of the transactions.</p>
</section>
<section id="how-does-it-work-plain-language-9" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-9">How Does It Work (Plain Language)</h4>
<p>We represent the system’s waiting relationships as a Wait-For Graph (WFG):</p>
<ul>
<li>Each node represents a transaction.</li>
<li>A directed edge <span class="math inline">\(T_i \rightarrow T_j\)</span> means “Transaction <span class="math inline">\(T_i\)</span> is waiting for <span class="math inline">\(T_j\)</span>” to release a resource.</li>
<li>A cycle in this graph implies a deadlock.</li>
</ul>
<p>The detection algorithm:</p>
<ol type="1">
<li>Construct the wait-for graph from the current lock table.</li>
<li>Run a cycle detection algorithm (e.g., DFS or Tarjan’s SCC).</li>
<li>If a cycle exists, abort one transaction (the <em>victim</em>).</li>
<li>Release its locks, allowing other transactions to proceed.</li>
</ol>
<p>This guarantees system liveness, deadlocks never persist indefinitely.</p>
</section>
<section id="example-walkthrough-5" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-5">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 7%">
<col style="width: 22%">
<col style="width: 17%">
<col style="width: 19%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Locks Held</th>
<th>Waiting For</th>
<th>Graph Edge</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T₁ locks X</td>
<td>X</td>
<td>–</td>
<td>–</td>
</tr>
<tr class="even">
<td>2</td>
<td>T₂ locks Y</td>
<td>Y</td>
<td>–</td>
<td>–</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T₁ requests Y</td>
<td>held by T₂</td>
<td>Y</td>
<td><span class="math inline">\(T₁ \rightarrow T₂\)</span></td>
</tr>
<tr class="even">
<td>4</td>
<td>T₂ requests X</td>
<td>held by T₁</td>
<td>X</td>
<td><span class="math inline">\(T₂ \rightarrow T₁\)</span></td>
</tr>
</tbody>
</table>
<p>The resulting wait-for graph contains a cycle:</p>
<p><span class="math display">\[
T_1 \rightarrow T_2 \rightarrow T_1
\]</span></p>
<p>A deadlock has formed. The detector aborts one transaction (e.g., the youngest) to break the cycle.</p>
</section>
<section id="tiny-code-conceptual-example-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-example-2">Tiny Code (Conceptual Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define N </span><span class="dv">3</span><span class="pp"> </span><span class="co">// number of transactions</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> graph<span class="op">[</span>N<span class="op">][</span>N<span class="op">];</span>     <span class="co">// adjacency matrix</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> visited<span class="op">[</span>N<span class="op">],</span> stack<span class="op">[</span>N<span class="op">];</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> dfs<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    visited<span class="op">[</span>v<span class="op">]</span> <span class="op">=</span> stack<span class="op">[</span>v<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> u <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> u <span class="op">&lt;</span> N<span class="op">;</span> u<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>graph<span class="op">[</span>v<span class="op">][</span>u<span class="op">])</span> <span class="op">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>u<span class="op">]</span> <span class="op">&amp;&amp;</span> dfs<span class="op">(</span>u<span class="op">))</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>stack<span class="op">[</span>u<span class="op">])</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// cycle found</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    stack<span class="op">[</span>v<span class="op">]</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> has_cycle<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> visited<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> stack<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>i<span class="op">]</span> <span class="op">&amp;&amp;</span> dfs<span class="op">(</span>i<span class="op">))</span> <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    graph<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// T1 -&gt; T2</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    graph<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// T2 -&gt; T1</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>has_cycle<span class="op">())</span> printf<span class="op">(</span><span class="st">"Deadlock detected.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> printf<span class="op">(</span><span class="st">"No deadlock.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Deadlock detected.</code></pre>
</section>
<section id="why-it-matters-9" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-9">Why It Matters</h4>
<ul>
<li>Detects all deadlocks, including multi-transaction cycles</li>
<li>Maximizes concurrency, since no locks are preemptively withheld</li>
<li>Ensures progress, by selecting and aborting a victim</li>
<li>Used in databases and operating systems where concurrency is complex</li>
</ul>
<p>Trade-off: deadlocks must actually occur before being resolved, which may waste partial work.</p>
</section>
<section id="deadlock-resolution-strategy" class="level4">
<h4 class="anchored" data-anchor-id="deadlock-resolution-strategy">Deadlock Resolution Strategy</h4>
<ol type="1">
<li><p>Victim Selection Choose a transaction to abort based on:</p>
<ul>
<li>Age (youngest first)</li>
<li>Cost (least work done)</li>
<li>Priority (lowest first)</li>
</ul></li>
<li><p>Rollback Abort the victim and release its locks.</p></li>
<li><p>Restart Retry the aborted transaction after a short delay.</p></li>
</ol>
</section>
<section id="a-gentle-proof-why-it-works" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works">A Gentle Proof (Why It Works)</h4>
<p>Let the Wait-For Graph be <span class="math inline">\(G = (V, E)\)</span>, where:</p>
<ul>
<li><span class="math inline">\(V\)</span> = set of active transactions</li>
<li><span class="math inline">\(E\)</span> = set of edges <span class="math inline">\((T_i, T_j)\)</span>, meaning <span class="math inline">\(T_i\)</span> waits for <span class="math inline">\(T_j\)</span></li>
</ul>
<p>A deadlock exists if and only if there is a cycle in <span class="math inline">\(G\)</span>.</p>
<p>Proof sketch:</p>
<ul>
<li><p>(If) Suppose a cycle exists: <span class="math display">\[
T_1 \rightarrow T_2 \rightarrow \cdots \rightarrow T_k \rightarrow T_1
\]</span> Each transaction in the cycle waits for the next. No transaction can proceed since each holds a resource another needs. Therefore, they are all blocked, a deadlock.</p></li>
<li><p>(Only if) Conversely, if a set of transactions is deadlocked, each must be waiting for another in the set. Constructing edges for these wait relationships forms a cycle.</p></li>
</ul>
<p>Thus, detecting cycles in <span class="math inline">\(G\)</span> is equivalent to detecting deadlocks. Once a cycle is found, removing any vertex <span class="math inline">\(T_v\)</span> (aborting a transaction) breaks the cycle:</p>
<p><span class="math display">\[
G' = G - {T_v}
\]</span></p>
<p>and allows progress to resume.</p>
</section>
<section id="try-it-yourself-9" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-9">Try It Yourself</h4>
<ol type="1">
<li><p>Construct a graph: <span class="math display">\[
T_1 \rightarrow T_2, \quad T_2 \rightarrow T_3, \quad T_3 \rightarrow T_1
\]</span> Detect the cycle using DFS.</p></li>
<li><p>Abort <span class="math inline">\(T_3\)</span>, remove its edges, and verify that no cycles remain.</p></li>
<li><p>Compare with Wait-Die and Wound-Wait:</p>
<ul>
<li>Those prevent cycles.</li>
<li>This approach detects and breaks them after the fact.</li>
</ul></li>
<li><p>Experiment with victim selection rules and measure system throughput.</p></li>
</ol>
</section>
<section id="test-cases-9" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-9">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 67%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>Waits</th>
<th>Graph</th>
<th>Cycle</th>
<th>Deadlock?</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(T_1 \rightarrow T_2, T_2 \rightarrow T_1\)</span></td>
<td>2 nodes</td>
<td>Yes</td>
<td>Yes</td>
<td>Abort one</td>
</tr>
<tr class="even">
<td><span class="math inline">\(T_1 \rightarrow T_2, T_2 \rightarrow T_3\)</span></td>
<td>3 nodes</td>
<td>No</td>
<td>No</td>
<td>Continue</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T_1 \rightarrow T_2, T_2 \rightarrow T_3, T_3 \rightarrow T_1\)</span></td>
<td>3 nodes</td>
<td>Yes</td>
<td>Yes</td>
<td>Abort one</td>
</tr>
<tr class="even">
<td>No edges</td>
<td>Empty</td>
<td>No</td>
<td>No</td>
<td>Continue</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-9" class="level4">
<h4 class="anchored" data-anchor-id="complexity-9">Complexity</h4>
<p>Let <span class="math inline">\(V\)</span> be the number of transactions and <span class="math inline">\(E\)</span> the number of edges.</p>
<ul>
<li><p>Time Complexity: <span class="math display">\[ O(V + E) \]</span> (using Depth-First Search)</p></li>
<li><p>Space Complexity: <span class="math display">\[ O(V^2) \]</span> (for adjacency matrix representation)</p></li>
</ul>
<p>Deadlock Detection acts as a runtime safety net. It accepts that deadlocks may arise in high-concurrency systems and ensures they never persist by identifying cycles in the wait-for graph and removing one transaction. This keeps the system live, responsive, and deadlock-free over time.</p>
</section>
</section>
</section>
<section id="section-82.-logging-recovery-and-commit-protocols" class="level1">
<h1>Section 82. Logging, Recovery, and Commit Protocols</h1>
<section id="write-ahead-logging-wal" class="level3">
<h3 class="anchored" data-anchor-id="write-ahead-logging-wal">811 Write-Ahead Logging (WAL)</h3>
<p>Write-Ahead Logging (WAL) is the foundation of reliable storage systems. It ensures that updates to data are never applied before being recorded, allowing recovery after crashes. The golden rule of WAL: log first, write later.</p>
<section id="what-problem-are-we-solving-10" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-10">What Problem Are We Solving?</h4>
<p>In any durable database or file system, failures can strike mid-write. Without precautions, we might end up with partially applied updates, corrupting the data.</p>
<p>Example:</p>
<ul>
<li>T₁ updates record X</li>
<li>System crashes before writing X to disk</li>
</ul>
<p>After restart, we must replay or undo changes to restore consistency. WAL provides the structure for doing exactly that.</p>
<p>By writing intentions to a log before applying them, WAL guarantees that every update is reproducible or reversible.</p>
</section>
<section id="how-does-it-work-plain-language-10" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-10">How Does It Work (Plain Language)</h4>
<p>WAL maintains a sequential log on stable storage. Each log record describes:</p>
<ul>
<li>The transaction ID</li>
<li>The old value (for undo)</li>
<li>The new value (for redo)</li>
</ul>
<p>The WAL protocol enforces two key rules:</p>
<ol type="1">
<li><p>Write-Ahead Rule: Before modifying any data page on disk, its log record must be flushed to the log.</p></li>
<li><p>Commit Rule: A transaction is committed only after all its log records are safely on disk.</p></li>
</ol>
<p>So, even if a crash happens, the log can replay all completed operations.</p>
</section>
<section id="example-walkthrough-6" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-6">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 16%">
<col style="width: 26%">
<col style="width: 37%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Transaction</th>
<th>Action</th>
<th>Log</th>
<th>Data</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>T₁</td>
<td>Start</td>
<td><code>[BEGIN T₁]</code></td>
<td>–</td>
</tr>
<tr class="even">
<td>2</td>
<td>T₁</td>
<td>Update X: 10 → 20</td>
<td><code>[T₁, X, old=10, new=20]</code></td>
<td>In memory</td>
</tr>
<tr class="odd">
<td>3</td>
<td>T₁</td>
<td>Flush log</td>
<td><code>[T₁, X, old=10, new=20]</code></td>
<td>Persisted</td>
</tr>
<tr class="even">
<td>4</td>
<td>T₁</td>
<td>Write X=20 to disk</td>
<td>–</td>
<td>Updated</td>
</tr>
<tr class="odd">
<td>5</td>
<td>T₁</td>
<td>Commit</td>
<td><code>[COMMIT T₁]</code></td>
<td>Durable</td>
</tr>
</tbody>
</table>
<p>If crash occurs:</p>
<ul>
<li>Before Step 3 → no log record → no action</li>
<li>After Step 3 → log says what to redo → recovery replays X=20</li>
</ul>
</section>
<section id="tiny-code-conceptual-example-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-example-3">Tiny Code (Conceptual Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> old_val<span class="op">,</span> new_val<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>record<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LogEntry<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> write_ahead<span class="op">(</span>LogEntry log<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Write log: old=</span><span class="sc">%d</span><span class="st">, new=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> log<span class="op">.</span>old_val<span class="op">,</span> log<span class="op">.</span>new_val<span class="op">);</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> apply_update<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>x<span class="op">,</span> LogEntry log<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>x <span class="op">=</span> log<span class="op">.</span>new_val<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Apply: X=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> <span class="op">*</span>x<span class="op">);</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> X <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    LogEntry log <span class="op">=</span> <span class="op">{</span><span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="st">"T1-X"</span><span class="op">};</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    write_ahead<span class="op">(</span>log<span class="op">);</span> <span class="co">// Step 1: Log</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    apply_update<span class="op">(&amp;</span>X<span class="op">,</span> log<span class="op">);</span> <span class="co">// Step 2: Write data</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Commit.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Write log: old=10, new=20
Apply: X=20
Commit.</code></pre>
</section>
<section id="why-it-matters-10" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-10">Why It Matters</h4>
<ul>
<li><p>Durability (D in ACID): No committed change is ever lost.</p></li>
<li><p>Atomicity (A in ACID): Uncommitted changes can be undone via the log.</p></li>
<li><p>Crash Recovery: Replay committed updates (redo), roll back uncommitted (undo).</p></li>
<li><p>Efficiency: Sequential log writes are faster than random data writes.</p></li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-1" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-1">A Gentle Proof (Why It Works)</h4>
<p>Suppose <span class="math inline">\(L\)</span> is the log, <span class="math inline">\(D\)</span> the data pages, and <span class="math inline">\(T_i\)</span> a transaction.</p>
<p>For each update <span class="math inline">\(u\)</span>:</p>
<ol type="1">
<li><p>Log record <span class="math inline">\(r(u)\)</span> is flushed to <span class="math inline">\(L\)</span> before <span class="math inline">\(u\)</span> is applied to <span class="math inline">\(D\)</span>. <span class="math display">\[
\text{write}(L, r(u)) \Rightarrow \text{write}(D, u)
\]</span></p></li>
<li><p>On commit, <span class="math inline">\(L\)</span> contains every record <span class="math inline">\(r(u)\)</span> of <span class="math inline">\(T_i\)</span>.</p></li>
<li><p>If the system crashes:</p>
<ul>
<li>For committed <span class="math inline">\(T_i\)</span>: redo all <span class="math inline">\(r(u)\)</span> from <span class="math inline">\(L\)</span>.</li>
<li>For uncommitted <span class="math inline">\(T_i\)</span>: undo using old values in <span class="math inline">\(L\)</span>.</li>
</ul></li>
</ol>
<p>Thus, after recovery: <span class="math display">\[
D' = \text{REDO(committed)} + \text{UNDO(uncommitted)}
\]</span> ensuring the database matches a valid serial state.</p>
</section>
<section id="try-it-yourself-10" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-10">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate a transaction updating <span class="math inline">\(X=10 \to 20\)</span>.</p>
<ul>
<li>Log before data write → crash → recover via redo.</li>
</ul></li>
<li><p>Reverse order (data before log). Observe recovery failure.</p></li>
<li><p>Add <code>[BEGIN, UPDATE, COMMIT]</code> records and test recovery logic.</p></li>
<li><p>Experiment with undo logging vs redo logging.</p></li>
</ol>
</section>
<section id="test-cases-10" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-10">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 35%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Log State</th>
<th>Recovery Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Crash before log write</td>
<td>–</td>
<td>Ignore (no record)</td>
</tr>
<tr class="even">
<td>Crash after log, before data</td>
<td><code>[T₁, X, 10, 20]</code></td>
<td>Redo</td>
</tr>
<tr class="odd">
<td>Crash before commit</td>
<td><code>[BEGIN, UPDATE]</code></td>
<td>Undo</td>
</tr>
<tr class="even">
<td>Crash after commit</td>
<td><code>[BEGIN, UPDATE, COMMIT]</code></td>
<td>Redo</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-10" class="level4">
<h4 class="anchored" data-anchor-id="complexity-10">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> per recovery (scan log)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> log records per transaction</li>
</ul>
<p>Write-Ahead Logging is the journal of truth in a database. Every change is written down before it happens, ensuring that even after a crash, the system can always find its way back to a consistent state.</p>
</section>
</section>
<section id="aries-recovery-algorithms-for-recovery-and-isolation-exploiting-semantics" class="level3">
<h3 class="anchored" data-anchor-id="aries-recovery-algorithms-for-recovery-and-isolation-exploiting-semantics">812 ARIES Recovery (Algorithms for Recovery and Isolation Exploiting Semantics)</h3>
<p>ARIES is the gold standard of database recovery algorithms. It builds on Write-Ahead Logging (WAL) and combines redo, undo, and checkpoints to guarantee atomicity and durability, even in the face of crashes. ARIES powers major systems like DB2, SQL Server, and PostgreSQL variants.</p>
<section id="what-problem-are-we-solving-11" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-11">What Problem Are We Solving?</h4>
<p>When a database crashes, we face three tasks:</p>
<ol type="1">
<li>Redo committed work (to ensure durability).</li>
<li>Undo uncommitted work (to maintain atomicity).</li>
<li>Resume from a recent checkpoint (to avoid scanning the entire log).</li>
</ol>
<p>Earlier systems often had to choose between efficiency and correctness. ARIES solves this by combining three principles:</p>
<ol type="1">
<li>Write-Ahead Logging (WAL), log before data writes.</li>
<li>Repeating History, redo everything since the last checkpoint.</li>
<li>Physiological Logging, log changes at the page level, not just logical or physical.</li>
</ol>
</section>
<section id="how-does-it-work-plain-language-11" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-11">How Does It Work (Plain Language)</h4>
<p>Think of ARIES as a time machine for your database. After a crash, it replays the past exactly as it happened, then rewinds uncommitted changes.</p>
<p>The ARIES recovery process runs in three phases:</p>
<ol type="1">
<li><p>Analysis Phase</p>
<ul>
<li>Scan the log forward from the last checkpoint.</li>
<li>Reconstruct the Transaction Table (TT) and Dirty Page Table (DPT).</li>
<li>Identify transactions that were active at crash time.</li>
</ul></li>
<li><p>Redo Phase</p>
<ul>
<li>Reapply all updates from the earliest log sequence number (LSN) in the DPT.</li>
<li>Repeat history to bring the database to the exact pre-crash state.</li>
</ul></li>
<li><p>Undo Phase</p>
<ul>
<li>Roll back uncommitted transactions using Compensation Log Records (CLRs).</li>
<li>Each undo writes a CLR for idempotent recovery.</li>
</ul></li>
</ol>
<p>After undo completes, the database reflects only committed work.</p>
</section>
<section id="example-walkthrough-7" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-7">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Log Record</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>[BEGIN T₁]</code></td>
<td>Transaction starts</td>
</tr>
<tr class="even">
<td>2</td>
<td><code>[T₁, X, old=10, new=20]</code></td>
<td>Update logged</td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>[BEGIN T₂]</code></td>
<td>Second transaction</td>
</tr>
<tr class="even">
<td>4</td>
<td><code>[T₂, Y, old=5, new=9]</code></td>
<td>Update logged</td>
</tr>
<tr class="odd">
<td>5</td>
<td><code>[COMMIT T₁]</code></td>
<td>T₁ committed</td>
</tr>
<tr class="even">
<td>6</td>
<td>Crash occurs</td>
<td>T₂ not committed</td>
</tr>
</tbody>
</table>
<p>Recovery runs:</p>
<ul>
<li>Analysis: finds T₁ committed, T₂ active</li>
<li>Redo: replays both updates (repeating history)</li>
<li>Undo: rolls back T₂ with CLRs</li>
</ul>
<p>Final state:</p>
<ul>
<li>X = 20 (T₁ committed)</li>
<li>Y = 5 (T₂ undone)</li>
</ul>
</section>
<section id="tiny-code-conceptual-simulation-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-3">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> txn<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> action<span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> old_val<span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> new_val<span class="op">;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LogRecord<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> redo<span class="op">(</span>LogRecord log<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Redo: </span><span class="sc">%s</span><span class="st"> sets value </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> log<span class="op">.</span>txn<span class="op">,</span> log<span class="op">.</span>new_val<span class="op">);</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> undo<span class="op">(</span>LogRecord log<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Undo: </span><span class="sc">%s</span><span class="st"> restores value </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> log<span class="op">.</span>txn<span class="op">,</span> log<span class="op">.</span>old_val<span class="op">);</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    LogRecord L1 <span class="op">=</span> <span class="op">{</span><span class="st">"T1"</span><span class="op">,</span> <span class="st">"UPDATE"</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">};</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    LogRecord L2 <span class="op">=</span> <span class="op">{</span><span class="st">"T2"</span><span class="op">,</span> <span class="st">"UPDATE"</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">9</span><span class="op">};</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Analysis Phase: T1 committed, T2 active</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Redo Phase:</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    redo<span class="op">(</span>L1<span class="op">);</span> redo<span class="op">(</span>L2<span class="op">);</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Undo Phase:</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    undo<span class="op">(</span>L2<span class="op">);</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Analysis Phase: T1 committed, T2 active
Redo Phase:
Redo: T1 sets value 20
Redo: T2 sets value 9
Undo Phase:
Undo: T2 restores value 5</code></pre>
</section>
<section id="why-it-matters-11" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-11">Why It Matters</h4>
<ul>
<li>Fast Recovery, no full log scan; start from last checkpoint.</li>
<li>Repeatable and Idempotent, crash during recovery? Just restart.</li>
<li>Supports Fine-Grained Logging, per-page LSN ensures correctness.</li>
<li>Industry Proven, used in enterprise databases.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-2" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-2">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(LSN(p)\)</span> be the log sequence number of the last update applied to page <span class="math inline">\(p\)</span>.</p>
<p>During redo:</p>
<ul>
<li>For each log record <span class="math inline">\(r\)</span> with <span class="math inline">\(LSN(r) \ge \min(LSN(p))\)</span>, redo only if <span class="math inline">\(LSN(r) &gt; LSN(p)\)</span> (to avoid double-apply).</li>
</ul>
<p>During undo:</p>
<ul>
<li>For each uncommitted transaction <span class="math inline">\(T\)</span>, undo records in reverse order.</li>
<li>Each undo writes a Compensation Log Record (CLR) so recovery remains idempotent: <span class="math display">\[
\text{UNDO}(r) \implies \text{WRITE(CLR)} \land \text{APPLY(old\_val)}
\]</span> Thus, ARIES ensures after recovery: <span class="math display">\[
\text{DB State} = \text{Redo(Committed)} + \text{Undo(Uncommitted)}
\]</span> which satisfies atomicity and durability.</li>
</ul>
</section>
<section id="try-it-yourself-11" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-11">Try It Yourself</h4>
<ol type="1">
<li>Simulate two transactions <span class="math inline">\(T_1\)</span> and <span class="math inline">\(T_2\)</span>, one committed, one not.</li>
<li>Add log records <code>[BEGIN]</code>, <code>[UPDATE]</code>, <code>[COMMIT]</code>, <code>[END]</code>.</li>
<li>Trigger a crash before <span class="math inline">\(T_2\)</span> commits.</li>
<li>Run ARIES: analysis → redo → undo.</li>
<li>Confirm only <span class="math inline">\(T_1\)</span>’s updates persist.</li>
</ol>
</section>
<section id="test-cases-11" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-11">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 18%">
<col style="width: 25%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Log</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Crash after commit</td>
<td><code>[COMMIT T₁]</code></td>
<td>Redo only</td>
<td>T₁’s data restored</td>
</tr>
<tr class="even">
<td>Crash before commit</td>
<td><code>[UPDATE T₂]</code></td>
<td>Redo + Undo</td>
<td>T₂ undone</td>
</tr>
<tr class="odd">
<td>Crash during recovery</td>
<td>Mixed</td>
<td>Restart</td>
<td>Idempotent recovery</td>
</tr>
<tr class="even">
<td>Multiple active txns</td>
<td>Mixed</td>
<td>Reconstruct TT/DPT</td>
<td>All safe</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-11" class="level4">
<h4 class="anchored" data-anchor-id="complexity-11">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> (scan from checkpoint)</li>
<li>Space: <span class="math inline">\(O(\text{\#active transactions})\)</span> (TT + DPT)</li>
</ul>
<p>ARIES is the architecture of resilience, it carefully replays the past, repairs the present, and preserves the future. By blending redo, undo, and checkpoints, it guarantees that every crash leads not to chaos, but to consistency restored.</p>
</section>
</section>
<section id="shadow-paging" class="level3">
<h3 class="anchored" data-anchor-id="shadow-paging">813 Shadow Paging</h3>
<p>Shadow Paging is a copy-on-write recovery technique that eliminates the need for a log. Instead of writing to existing pages, it creates new copies (shadows) and atomically switches to them at commit. If a crash occurs before the switch, the old pages remain untouched, guaranteeing consistency.</p>
<section id="what-problem-are-we-solving-12" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-12">What Problem Are We Solving?</h4>
<p>Traditional recovery methods (like WAL and ARIES) maintain logs to replay or undo changes. This adds overhead and complexity.</p>
<p>Shadow Paging offers a simpler alternative:</p>
<ul>
<li>No undo or redo phase</li>
<li>No need for logs</li>
<li>Commit = pointer swap</li>
</ul>
<p>By using page versioning, it ensures that uncommitted changes never overwrite stable data.</p>
</section>
<section id="how-does-it-work-plain-language-12" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-12">How Does It Work (Plain Language)</h4>
<p>Imagine the database as a tree of pages, with a root page pointing to all others. Instead of updating in place, each modification creates a new copy (shadow page). The transaction updates pointers privately, and when ready to commit, it atomically replaces the root.</p>
<p>Steps:</p>
<ol type="1">
<li>Maintain a page table (mapping logical pages → physical pages).</li>
<li>On update, copy the target page, modify the copy, and update the page table.</li>
<li>At commit, atomically update the root pointer to the new page table.</li>
<li>If crash before commit, old root is still valid → automatic rollback.</li>
</ol>
<p>No log replay, no undo, no redo, just pointer swaps.</p>
</section>
<section id="example-walkthrough-8" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-8">Example Walkthrough</h4>
<p>Suppose we have a page table:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Logical Page</th>
<th>Physical Page</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>1</td>
</tr>
<tr class="even">
<td>B</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Transaction wants to update B:</p>
<ol type="1">
<li>Copy page 2 → page 3</li>
<li>Update page 3</li>
<li>Update table to point B → 3</li>
<li>On commit, replace old root pointer with new table</li>
</ol>
<p>If crash occurs before commit, system uses old root → B=2 (old version). If commit succeeds, root now points to table with B=3 (new version).</p>
</section>
<section id="tiny-code-conceptual-simulation-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-4">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> A<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> B<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> PageTable<span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>PageTable stable <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>PageTable shadow<span class="op">;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> update<span class="op">(</span>PageTable <span class="op">*</span>pt<span class="op">,</span> <span class="dt">char</span> page<span class="op">,</span> <span class="dt">int</span> new_val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>page <span class="op">==</span> <span class="ch">'A'</span><span class="op">)</span> pt<span class="op">-&gt;</span>A <span class="op">=</span> new_val<span class="op">;</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>page <span class="op">==</span> <span class="ch">'B'</span><span class="op">)</span> pt<span class="op">-&gt;</span>B <span class="op">=</span> new_val<span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy current table to shadow</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(&amp;</span>shadow<span class="op">,</span> <span class="op">&amp;</span>stable<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>PageTable<span class="op">));</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update shadow copy</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    update<span class="op">(&amp;</span>shadow<span class="op">,</span> <span class="ch">'B'</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Shadow table: A=</span><span class="sc">%d</span><span class="st">, B=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> shadow<span class="op">.</span>A<span class="op">,</span> shadow<span class="op">.</span>B<span class="op">);</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Commit: atomically swap root</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    stable <span class="op">=</span> shadow<span class="op">;</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Committed table: A=</span><span class="sc">%d</span><span class="st">, B=</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> stable<span class="op">.</span>A<span class="op">,</span> stable<span class="op">.</span>B<span class="op">);</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Shadow table: A=1, B=3
Committed table: A=1, B=3</code></pre>
</section>
<section id="why-it-matters-12" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-12">Why It Matters</h4>
<ul>
<li>Crash-safe by design, commit is atomic</li>
<li>No undo/redo needed</li>
<li>Simple recovery, old root = consistent state</li>
<li>Ideal for immutability-based systems</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Copying overhead (especially large trees)</li>
<li>Fragmentation from multiple versions</li>
<li>Harder to support concurrency and partial updates</li>
</ul>
<p>Used in:</p>
<ul>
<li>Early DBMS (e.g., System R variants)</li>
<li>File systems like ZFS and WAFL</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-3" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-3">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(R_0\)</span> be the root pointer before the transaction and <span class="math inline">\(R_1\)</span> the root after commit.</p>
<p>During updates:</p>
<ul>
<li>All changes occur in shadow pages, leaving <span class="math inline">\(R_0\)</span> untouched.</li>
<li>Commit = atomic pointer swap: <span class="math display">\[
R \leftarrow R_1
\]</span> If crash occurs:</li>
<li>If before swap → <span class="math inline">\(R = R_0\)</span> (old consistent state)</li>
<li>If after swap → <span class="math inline">\(R = R_1\)</span> (new consistent state)</li>
</ul>
<p>Thus the invariant holds: <span class="math display">\[
R \in { R_0, R_1 }
\]</span> No intermediate state is ever visible, ensuring atomicity and durability.</p>
</section>
<section id="try-it-yourself-12" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-12">Try It Yourself</h4>
<ol type="1">
<li>Build a page table mapping {A, B, C}.</li>
<li>Perform shadow copies on update.</li>
<li>Simulate crash before and after commit, verify recovery.</li>
<li>Extend with multiple levels (root → branch → leaf).</li>
<li>Compare performance with WAL: write amplification vs simplicity.</li>
</ol>
</section>
<section id="test-cases-12" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-12">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Update page, crash before commit</td>
<td>Root not swapped</td>
<td>Old data visible</td>
</tr>
<tr class="even">
<td>Update page, commit succeeds</td>
<td>Root swapped</td>
<td>New data visible</td>
</tr>
<tr class="odd">
<td>Partial write during swap</td>
<td>Swap atomic</td>
<td>One valid root</td>
</tr>
<tr class="even">
<td>Multiple updates</td>
<td>All or none</td>
<td>Atomic commit</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-12" class="level4">
<h4 class="anchored" data-anchor-id="complexity-12">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> (copy modified pages)</li>
<li>Space: <span class="math inline">\(O(\text{\#updated pages})\)</span> (new copies)</li>
</ul>
<p>Shadow Paging is copy-on-write recovery made simple. By treating updates as new versions and using atomic root swaps, it turns complex recovery logic into pointer arithmetic, a clean, elegant path to consistency.</p>
</section>
</section>
<section id="two-phase-commit-2pc" class="level3">
<h3 class="anchored" data-anchor-id="two-phase-commit-2pc">814 Two-Phase Commit (2PC)</h3>
<p>The Two-Phase Commit (2PC) protocol ensures atomic commitment across distributed systems. It coordinates multiple participants so that either all commit or all abort, preserving atomicity even when nodes fail.</p>
<p>It’s the cornerstone of distributed transactions in databases, message queues, and microservices.</p>
<section id="what-problem-are-we-solving-13" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-13">What Problem Are We Solving?</h4>
<p>In a distributed transaction, multiple nodes (participants) must agree on a single outcome. If one commits and another aborts, global inconsistency results.</p>
<p>We need a coordination protocol that ensures:</p>
<ul>
<li>All or nothing outcome</li>
<li>Agreement despite failures</li>
<li>Durable record of the decision</li>
</ul>
<p>The Two-Phase Commit protocol achieves this by introducing a coordinator that manages a two-step handshake across all participants.</p>
</section>
<section id="how-does-it-work-plain-language-13" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-13">How Does It Work (Plain Language)</h4>
<p>Think of a conductor leading an orchestra:</p>
<ol type="1">
<li>First, they ask each musician, <em>“Are you ready?”</em></li>
<li>Only when everyone says yes, the conductor signals <em>“Play!”</em></li>
</ol>
<p>If any musician says <em>“No”</em>, the performance stops.</p>
<p>Similarly, 2PC proceeds in two phases:</p>
<section id="phase-1-prepare-voting-phase" class="level5">
<h5 class="anchored" data-anchor-id="phase-1-prepare-voting-phase">Phase 1: Prepare (Voting Phase)</h5>
<ul>
<li><p>Coordinator sends PREPARE to all participants.</p></li>
<li><p>Each participant:</p>
<ul>
<li>Writes its prepare record to disk (for durability).</li>
<li>Replies YES if ready to commit, NO if not.</li>
</ul></li>
</ul>
</section>
<section id="phase-2-commit-decision-phase" class="level5">
<h5 class="anchored" data-anchor-id="phase-2-commit-decision-phase">Phase 2: Commit (Decision Phase)</h5>
<ul>
<li><p>If all voted YES:</p>
<ul>
<li>Coordinator writes COMMIT record and sends COMMIT to all.</li>
</ul></li>
<li><p>If any voted NO or timeout:</p>
<ul>
<li>Coordinator writes ABORT record and sends ABORT.</li>
</ul></li>
</ul>
<p>Each participant follows the coordinator’s final decision.</p>
</section>
</section>
<section id="example-walkthrough-9" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-9">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 20%">
<col style="width: 19%">
<col style="width: 19%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Coordinator</th>
<th>Participant 1</th>
<th>Participant 2</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Send <code>PREPARE</code></td>
<td>Wait</td>
<td>Wait</td>
<td>Coordinator starts vote</td>
</tr>
<tr class="even">
<td>2</td>
<td>Wait</td>
<td>Vote YES</td>
<td>Vote YES</td>
<td>Participants ready</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Collect votes</td>
<td>–</td>
<td>–</td>
<td>All YES</td>
</tr>
<tr class="even">
<td>4</td>
<td>Send <code>COMMIT</code></td>
<td>Commit</td>
<td>Commit</td>
<td>Global commit</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Done</td>
<td>Done</td>
<td>Done</td>
<td>Atomic outcome</td>
</tr>
</tbody>
</table>
<p>If one votes NO:</p>
<ul>
<li>Coordinator sends ABORT to all</li>
<li>Every participant rolls back</li>
</ul>
</section>
<section id="tiny-code-conceptual-simulation-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-5">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> participant_vote<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span> <span class="dt">bool</span> can_commit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> votes </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> name<span class="op">,</span> can_commit <span class="op">?</span> <span class="st">"YES"</span> <span class="op">:</span> <span class="st">"NO"</span><span class="op">);</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> can_commit<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> p1 <span class="op">=</span> participant_vote<span class="op">(</span><span class="st">"P1"</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> p2 <span class="op">=</span> participant_vote<span class="op">(</span><span class="st">"P2"</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p1 <span class="op">&amp;&amp;</span> p2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Coordinator: All YES → COMMIT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Coordinator: Vote failed → ABORT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (All YES):</p>
<pre><code>P1 votes YES
P2 votes YES
Coordinator: All YES → COMMIT</code></pre>
</section>
<section id="why-it-matters-13" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-13">Why It Matters</h4>
<ul>
<li>Ensures atomic commit across multiple systems</li>
<li>Crash recovery via durable logs</li>
<li>Standard in distributed databases and middleware</li>
</ul>
<p>However, 2PC has one weakness: If the coordinator crashes after PREPARE but before COMMIT, participants are left blocking, waiting for a decision.</p>
<p>This motivates Three-Phase Commit (3PC) and consensus-based alternatives like Paxos Commit and Raft.</p>
</section>
<section id="a-gentle-proof-why-it-works-4" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-4">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(P_1, P_2, \dots, P_n\)</span> be participants and <span class="math inline">\(C\)</span> the coordinator.</p>
<p>Each participant records:</p>
<ul>
<li><span class="math inline">\(\text{prepare}(T)\)</span> before voting YES</li>
<li><span class="math inline">\(\text{commit}(T)\)</span> or <span class="math inline">\(\text{abort}(T)\)</span> after receiving decision</li>
</ul>
<p>Coordinator records:</p>
<ul>
<li><span class="math inline">\(\text{decision}(T) \in {\text{commit}, \text{abort}}\)</span></li>
</ul>
<p>At commit:</p>
<ol type="1">
<li>All participants have <span class="math inline">\(\text{prepare}(T)\)</span></li>
<li>Coordinator has <span class="math inline">\(\text{commit}(T)\)</span></li>
<li>Messages ensure all commit or all abort: <span class="math display">\[
\forall i, j:; \text{state}(P_i) = \text{state}(P_j)
\]</span></li>
</ol>
<p>Hence, atomicity and agreement hold, even under partial failures.</p>
</section>
<section id="try-it-yourself-13" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-13">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate two participants and one coordinator.</p>
<ul>
<li>All YES → commit</li>
<li>One NO → abort</li>
</ul></li>
<li><p>Add a timeout in the coordinator before Phase 2.</p>
<ul>
<li>What happens? (Participants block)</li>
</ul></li>
<li><p>Add logging: <code>[BEGIN, PREPARE, COMMIT]</code></p>
<ul>
<li>Recover coordinator after crash, reissue final decision.</li>
</ul></li>
<li><p>Compare behavior with 3PC (non-blocking variant).</p></li>
</ol>
</section>
<section id="test-cases-13" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-13">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 21%">
<col style="width: 11%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Votes</th>
<th>Result</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>All YES</td>
<td>YES, YES, YES</td>
<td>Commit</td>
<td>All agree</td>
</tr>
<tr class="even">
<td>One NO</td>
<td>YES, NO, YES</td>
<td>Abort</td>
<td>Atomic abort</td>
</tr>
<tr class="odd">
<td>Timeout (no response)</td>
<td>YES, –, YES</td>
<td>Abort</td>
<td>Safety over progress</td>
</tr>
<tr class="even">
<td>Crash after prepare</td>
<td>All YES</td>
<td>Blocked</td>
<td>Wait for coordinator</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-13" class="level4">
<h4 class="anchored" data-anchor-id="complexity-13">Complexity</h4>
<ul>
<li>Message Complexity: <span class="math inline">\(O(n)\)</span> per phase</li>
<li>Log Writes: 1 per phase (prepare, commit)</li>
<li>Blocking: possible if coordinator fails post-prepare</li>
</ul>
<p>Two-Phase Commit is the atomic handshake of distributed systems, a simple, rigorous guarantee that all participants move together, or not at all. It laid the groundwork for fault-tolerant consensus protocols that followed.</p>
</section>
</section>
<section id="three-phase-commit-3pc" class="level3">
<h3 class="anchored" data-anchor-id="three-phase-commit-3pc">815 Three-Phase Commit (3PC)</h3>
<p>The Three-Phase Commit (3PC) protocol extends Two-Phase Commit (2PC) to avoid its main weakness, blocking. It ensures that no participant ever remains stuck waiting for a decision, even if the coordinator crashes. 3PC achieves this by inserting a pre-commit phase, separating <em>agreement</em> from <em>execution</em>.</p>
<section id="what-problem-are-we-solving-14" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-14">What Problem Are We Solving?</h4>
<p>2PC guarantees atomicity, but not liveness. If the coordinator fails after all participants vote YES, everyone waits indefinitely, the system stalls.</p>
<p>3PC fixes this by ensuring that:</p>
<ul>
<li>All participants move through the same sequence of states</li>
<li>No state is ambiguous after a crash</li>
<li>Timeouts always lead to safe progress (abort or commit)</li>
</ul>
<p>This makes 3PC a non-blocking atomic commitment protocol, assuming no network partitions and bounded message delays.</p>
</section>
<section id="how-does-it-work-plain-language-14" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-14">How Does It Work (Plain Language)</h4>
<p>3PC divides the commit process into three phases, adding a <em>pre-commit</em> handshake before final commit.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 4%">
<col style="width: 11%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th>Phase</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>CanCommit?</td>
<td>Coordinator asks if participants can commit.</td>
</tr>
<tr class="even">
<td>2</td>
<td>PreCommit</td>
<td>If all vote YES, coordinator sends <em>pre-commit</em> (promise). Participants prepare to commit and acknowledge.</td>
</tr>
<tr class="odd">
<td>3</td>
<td>DoCommit</td>
<td>Coordinator sends final <em>commit</em>. Participants complete and acknowledge.</td>
</tr>
</tbody>
</table>
<p>If any participant or coordinator times out waiting for a message, it can safely decide (commit or abort) based on its last known state.</p>
</section>
<section id="example-walkthrough-10" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-10">Example Walkthrough</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 27%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Coordinator</th>
<th>Participant 1</th>
<th>Participant 2</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Send <code>CanCommit?</code></td>
<td>Wait</td>
<td>Wait</td>
<td>Ask for votes</td>
</tr>
<tr class="even">
<td>2</td>
<td>Wait for replies</td>
<td>Vote YES</td>
<td>Vote YES</td>
<td>Ready</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Send <code>PreCommit</code></td>
<td>Prepare</td>
<td>Prepare</td>
<td>No turning back</td>
</tr>
<tr class="even">
<td>4</td>
<td>Wait for acks</td>
<td>Ack</td>
<td>Ack</td>
<td>Everyone ready</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Send <code>DoCommit</code></td>
<td>Commit</td>
<td>Commit</td>
<td>All finish</td>
</tr>
</tbody>
</table>
<p>If one fails mid-phase:</p>
<ul>
<li>Others use timeouts to make a consistent choice</li>
<li>No one blocks forever</li>
</ul>
</section>
<section id="state-transitions" class="level4">
<h4 class="anchored" data-anchor-id="state-transitions">State Transitions</h4>
<p>Participants move through states in lockstep:</p>
<p><span class="math display">\[
\text{INIT} \rightarrow \text{WAIT} \rightarrow \text{PRECOMMIT} \rightarrow \text{COMMIT}
\]</span></p>
<p>If timeout occurs:</p>
<ul>
<li>In WAIT, abort safely</li>
<li>In PRECOMMIT, commit safely</li>
</ul>
<p>No ambiguous states exist after a crash.</p>
</section>
<section id="tiny-code-conceptual-simulation-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-6">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span>INIT<span class="op">,</span> WAIT<span class="op">,</span> PRECOMMIT<span class="op">,</span> COMMIT<span class="op">,</span> ABORT<span class="op">}</span> State<span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> transition<span class="op">(</span>State <span class="op">*</span>s<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(*</span>s <span class="op">==</span> INIT <span class="op">&amp;&amp;</span> msg <span class="op">==</span> <span class="st">"CanCommit?"</span><span class="op">)</span> <span class="op">*</span>s <span class="op">=</span> WAIT<span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(*</span>s <span class="op">==</span> WAIT <span class="op">&amp;&amp;</span> msg <span class="op">==</span> <span class="st">"PreCommit"</span><span class="op">)</span> <span class="op">*</span>s <span class="op">=</span> PRECOMMIT<span class="op">;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(*</span>s <span class="op">==</span> PRECOMMIT <span class="op">&amp;&amp;</span> msg <span class="op">==</span> <span class="st">"DoCommit"</span><span class="op">)</span> <span class="op">*</span>s <span class="op">=</span> COMMIT<span class="op">;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    State P <span class="op">=</span> INIT<span class="op">;</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"State: INIT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    transition<span class="op">(&amp;</span>P<span class="op">,</span> <span class="st">"CanCommit?"</span><span class="op">);</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"State: WAIT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    transition<span class="op">(&amp;</span>P<span class="op">,</span> <span class="st">"PreCommit"</span><span class="op">);</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"State: PRECOMMIT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    transition<span class="op">(&amp;</span>P<span class="op">,</span> <span class="st">"DoCommit"</span><span class="op">);</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"State: COMMIT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>State: INIT
State: WAIT
State: PRECOMMIT
State: COMMIT</code></pre>
</section>
<section id="why-it-matters-14" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-14">Why It Matters</h4>
<ul>
<li>Non-blocking: Participants never wait forever</li>
<li>Coordination-safe: No mixed commit/abort outcomes</li>
<li>Crash-tolerant: Safe state transitions after recovery</li>
</ul>
<p>3PC improves availability compared to 2PC, but requires synchronous assumptions (bounded delays). In real-world networks with partitions, Paxos Commit or Raft are preferred.</p>
</section>
<section id="a-gentle-proof-why-it-works-5" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-5">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(P_i\)</span> be a participant with state <span class="math inline">\(s_i(t)\)</span> at time <span class="math inline">\(t\)</span>.</p>
<p>Invariant: <span class="math display">\[
\forall i, j:\ s_i(t) \neq \text{COMMIT} \land s_j(t) = \text{ABORT}
\]</span> That is, no process commits while another aborts.</p>
<ul>
<li>In WAIT, if timeout occurs → abort (safe).</li>
<li>In PRECOMMIT, all participants acknowledged → all can safely commit.</li>
<li>Hence, no uncertain or contradictory outcomes arise.</li>
</ul>
<p>Each state implies a safe local decision: <span class="math display">\[
\begin{cases}
\text{WAIT} \implies \text{ABORT} \
\text{PRECOMMIT} \implies \text{COMMIT}
\end{cases}
\]</span> Therefore, even with timeouts, global consistency is preserved.</p>
</section>
<section id="try-it-yourself-14" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-14">Try It Yourself</h4>
<ol type="1">
<li>Simulate all participants voting YES, system commits.</li>
<li>Make one participant vote NO, all abort.</li>
<li>Crash the coordinator during PRECOMMIT, participants commit safely.</li>
<li>Compare with 2PC, where would blocking occur?</li>
</ol>
</section>
<section id="test-cases-14" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-14">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Votes</th>
<th>Failure</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>All YES</td>
<td>None</td>
<td>None</td>
<td>Commit</td>
</tr>
<tr class="even">
<td>One NO</td>
<td>P2</td>
<td>–</td>
<td>Abort</td>
</tr>
<tr class="odd">
<td>Crash in WAIT</td>
<td>Timeout</td>
<td>Abort</td>
<td>Safe</td>
</tr>
<tr class="even">
<td>Crash in PRECOMMIT</td>
<td>Timeout</td>
<td>Commit</td>
<td>Safe</td>
</tr>
<tr class="odd">
<td>Network delay (bounded)</td>
<td>–</td>
<td>–</td>
<td>Non-blocking</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-14" class="level4">
<h4 class="anchored" data-anchor-id="complexity-14">Complexity</h4>
<ul>
<li>Phases: 3 rounds of messages</li>
<li>Message Complexity: <span class="math inline">\(O(n)\)</span> per phase</li>
<li>Time: One more phase than 2PC, but no blocking</li>
</ul>
<p>Three-Phase Commit is the non-blocking evolution of 2PC, by inserting a pre-commit handshake, it ensures that agreement and action are separate, so failures can never leave the system waiting in limbo.</p>
</section>
</section>
<section id="checkpointing" class="level3">
<h3 class="anchored" data-anchor-id="checkpointing">816 Checkpointing</h3>
<p>Checkpointing is the process of periodically saving a consistent snapshot of a system’s state so that recovery after a crash can resume from the checkpoint instead of starting from the very beginning. It’s the backbone of fast recovery in databases, operating systems, and distributed systems.</p>
<section id="what-problem-are-we-solving-15" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-15">What Problem Are We Solving?</h4>
<p>Without checkpoints, recovery after a crash requires replaying the entire log, which can be slow and inefficient. Imagine a database with millions of operations, restarting from scratch would take forever.</p>
<p>By creating checkpoints, we mark safe positions in the log so that:</p>
<ul>
<li>Only actions after the last checkpoint need to be redone or undone</li>
<li>Recovery time is bounded and predictable</li>
<li>System can resume faster after failure</li>
</ul>
<p>Checkpointing trades a small amount of runtime overhead for massive recovery speedup.</p>
</section>
<section id="how-does-it-work-plain-language-15" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-15">How Does It Work (Plain Language)</h4>
<p>A checkpoint captures a snapshot of all necessary recovery information:</p>
<ul>
<li>The transaction table (TT) (active transactions)</li>
<li>The dirty page table (DPT) (pages not yet written to disk)</li>
<li>The log position marking where recovery can resume</li>
</ul>
<p>During normal operation:</p>
<ol type="1">
<li><p>System runs and appends log records (like WAL).</p></li>
<li><p>Periodically, a checkpoint is written:</p>
<ul>
<li><code>[BEGIN CHECKPOINT]</code></li>
<li>Snapshot TT and DPT</li>
<li><code>[END CHECKPOINT]</code></li>
</ul></li>
</ol>
<p>During recovery:</p>
<ul>
<li>Scan log from the last checkpoint, not from the beginning.</li>
<li>Redo or undo only what happened afterward.</li>
</ul>
</section>
<section id="example-walkthrough-11" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-11">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Log Entry</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>[BEGIN T₁]</code></td>
<td>Transaction starts</td>
</tr>
<tr class="even">
<td>2</td>
<td><code>[UPDATE T₁, X, 10→20]</code></td>
<td>Modify data</td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>[BEGIN CHECKPOINT]</code></td>
<td>Capture snapshot</td>
</tr>
<tr class="even">
<td>4</td>
<td><code>{TT: {T₁}, DPT: {X}}</code></td>
<td>Write table states</td>
</tr>
<tr class="odd">
<td>5</td>
<td><code>[END CHECKPOINT]</code></td>
<td>Finish checkpoint</td>
</tr>
<tr class="even">
<td>6</td>
<td><code>[UPDATE T₁, Y, 5→7]</code></td>
<td>Continue operations</td>
</tr>
</tbody>
</table>
<p>If a crash occurs after Step 6, recovery starts after Step 3, not Step 1.</p>
</section>
<section id="types-of-checkpointing" class="level4">
<h4 class="anchored" data-anchor-id="types-of-checkpointing">Types of Checkpointing</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 43%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Consistent</td>
<td>All transactions paused</td>
<td>Simpler, slower</td>
</tr>
<tr class="even">
<td>Fuzzy</td>
<td>Taken while system runs</td>
<td>Used in ARIES</td>
</tr>
<tr class="odd">
<td>Coordinated</td>
<td>Global sync in distributed systems</td>
<td>Snapshot algorithm</td>
</tr>
<tr class="even">
<td>Uncoordinated</td>
<td>Each node independent</td>
<td>Risk of inconsistent states</td>
</tr>
</tbody>
</table>
<p>Most modern systems use fuzzy checkpointing, no global pause, only metadata consistency.</p>
</section>
<section id="tiny-code-conceptual-simulation-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-7">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> txn_count<span class="op">;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> dirty_pages<span class="op">;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Checkpoint<span class="op">;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> checkpoint_write<span class="op">(</span>Checkpoint c<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"BEGIN CHECKPOINT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"TT: </span><span class="sc">%d</span><span class="st">, DPT: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> c<span class="op">.</span>txn_count<span class="op">,</span> c<span class="op">.</span>dirty_pages<span class="op">);</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"END CHECKPOINT</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    Checkpoint c <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    checkpoint_write<span class="op">(</span>c<span class="op">);</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>BEGIN CHECKPOINT
TT: 1, DPT: 2
END CHECKPOINT</code></pre>
</section>
<section id="why-it-matters-15" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-15">Why It Matters</h4>
<ul>
<li>Faster recovery, skip irrelevant parts of the log</li>
<li>Stable restore point, known consistent state</li>
<li>Reduced I/O, only recent updates redone</li>
<li>Works with WAL and ARIES, key building block of recovery</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Overhead during checkpointing</li>
<li>Extra disk writes</li>
<li>Must ensure snapshot consistency</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-6" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-6">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(L = [r_1, r_2, \ldots, r_n]\)</span> be the log and <span class="math inline">\(C_k\)</span> a checkpoint after record <span class="math inline">\(r_k\)</span>.</p>
<p>The recovery rule:</p>
<ul>
<li>Redo all log records after <span class="math inline">\(C_k\)</span></li>
<li>Undo incomplete transactions from <span class="math inline">\(C_k\)</span> forward</li>
</ul>
<p>Since <span class="math inline">\(C_k\)</span> captures all prior committed states, we have: <span class="math display">\[
\text{state}(C_k) = \text{apply}(r_1, \ldots, r_k)
\]</span></p>
<p>So after crash: <span class="math display">\[
\text{Recover} = \text{Redo}(r_{k+1}, \ldots, r_n)
\]</span></p>
<p>Checkpoint ensures we never need to revisit <span class="math inline">\(r_1, \ldots, r_k\)</span> again.</p>
</section>
<section id="try-it-yourself-15" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-15">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate a log with 10 updates and 2 checkpoints.</p>
<ul>
<li>Recover starting from last checkpoint.</li>
</ul></li>
<li><p>Compare runtime with full log replay.</p></li>
<li><p>Add dirty pages to checkpoint, redo only affected ones.</p></li>
<li><p>Implement fuzzy checkpoint (no pause, capture snapshot metadata).</p></li>
</ol>
</section>
<section id="test-cases-15" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-15">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 33%">
<col style="width: 21%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Action</th>
<th>Recovery Start</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No checkpoint</td>
<td>Replay all</td>
<td><span class="math inline">\(r_1\)</span></td>
<td>Slow</td>
</tr>
<tr class="even">
<td>One checkpoint</td>
<td>Start after checkpoint</td>
<td><span class="math inline">\(r_k\)</span></td>
<td>Faster</td>
</tr>
<tr class="odd">
<td>Multiple checkpoints</td>
<td>Use last one</td>
<td><span class="math inline">\(r_m\)</span></td>
<td>Fastest</td>
</tr>
<tr class="even">
<td>Fuzzy checkpoint</td>
<td>No pause</td>
<td><span class="math inline">\(r_m\)</span></td>
<td>Efficient</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-15" class="level4">
<h4 class="anchored" data-anchor-id="complexity-15">Complexity</h4>
<ul>
<li>Checkpointing Time: <span class="math inline">\(O(\text{\#dirty pages})\)</span></li>
<li>Recovery Time: <span class="math inline">\(O(\text{log length after checkpoint})\)</span></li>
<li>Space: small metadata overhead</li>
</ul>
<p>Checkpointing is the pause button for recovery, a snapshot of safety that lets systems bounce back quickly. By remembering where it last stood firm, a database can restart with confidence, skipping over the past and diving straight into the present.</p>
</section>
</section>
<section id="undo-logging" class="level3">
<h3 class="anchored" data-anchor-id="undo-logging">817 Undo Logging</h3>
<p>Undo Logging is one of the earliest and simplest recovery mechanisms in database systems. Its core idea is straightforward: never overwrite a value until its old version has been saved to the log. After a crash, the system can undo any uncommitted changes using the saved old values.</p>
<section id="what-problem-are-we-solving-16" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-16">What Problem Are We Solving?</h4>
<p>In systems that modify data directly on disk (in-place updates), a crash could leave incomplete or inconsistent data behind. We need a way to rollback uncommitted transactions safely and restore the database to its previous consistent state.</p>
<p>Undo Logging solves this by logging before writing, ensuring that old values are always recoverable.</p>
<p>This principle is known as Write-Ahead Rule:</p>
<blockquote class="blockquote">
<p><em>Before any change is written to the database, the old value must be written to the log.</em></p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-16" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-16">How Does It Work (Plain Language)</h4>
<p>Undo Logging maintains a log of old values for every update.</p>
<p>Log record format:</p>
<pre><code>&lt;T, X, old_value&gt;</code></pre>
<p>where:</p>
<ul>
<li><code>T</code> = transaction ID</li>
<li><code>X</code> = data item</li>
<li><code>old_value</code> = value before modification</li>
</ul>
<section id="protocol-rules" class="level5">
<h5 class="anchored" data-anchor-id="protocol-rules">Protocol Rules</h5>
<ol type="1">
<li><p>Write-Ahead Rule Log the old value before writing to disk.</p></li>
<li><p>Commit Rule A transaction commits only after all writes are flushed to disk.</p></li>
</ol>
<p>If a crash occurs:</p>
<ul>
<li>Committed transactions are left as-is.</li>
<li>Uncommitted transactions are undone using old values in the log.</li>
</ul>
</section>
</section>
<section id="example-walkthrough-12" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-12">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Action</th>
<th>Log</th>
<th>Data</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>&lt;START T₁&gt;</code></td>
<td>Start transaction</td>
<td>–</td>
</tr>
<tr class="even">
<td>2</td>
<td><code>&lt;T₁, X, 10&gt;</code></td>
<td>Log old value</td>
<td>–</td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>X = 20</code></td>
<td>Write new value</td>
<td>20</td>
</tr>
<tr class="even">
<td>4</td>
<td><code>&lt;COMMIT T₁&gt;</code></td>
<td>Commit recorded</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>If crash occurs before <code>&lt;COMMIT T₁&gt;</code>:</p>
<ul>
<li>Recovery scans log backward</li>
<li>Finds <code>&lt;T₁, X, 10&gt;</code></li>
<li>Restores <code>X = 10</code></li>
</ul>
</section>
<section id="recovery-algorithm-backward-pass" class="level4">
<h4 class="anchored" data-anchor-id="recovery-algorithm-backward-pass">Recovery Algorithm (Backward Pass)</h4>
<ol type="1">
<li><p>Scan log backward.</p></li>
<li><p>For each uncommitted transaction <span class="math inline">\(T\)</span>:</p>
<ul>
<li>For each record <code>&lt;T, X, old_value&gt;</code>: restore <span class="math inline">\(X \leftarrow old_value\)</span></li>
</ul></li>
<li><p>Write <code>&lt;END T&gt;</code> for each undone transaction.</p></li>
</ol>
<p>All committed transactions remain unchanged.</p>
</section>
<section id="tiny-code-conceptual-simulation-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-8">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> txn<span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> var<span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> old_val<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> new_val<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LogEntry<span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> X <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    LogEntry L <span class="op">=</span> <span class="op">{</span><span class="st">"T1"</span><span class="op">,</span> <span class="st">"X"</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">};</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"&lt;START </span><span class="sc">%s</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> L<span class="op">.</span>txn<span class="op">);</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"&lt;</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">, </span><span class="sc">%d</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> L<span class="op">.</span>txn<span class="op">,</span> L<span class="op">.</span>var<span class="op">,</span> L<span class="op">.</span>old_val<span class="op">);</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L<span class="op">.</span>new_val<span class="op">;</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"X = </span><span class="sc">%d</span><span class="st"> (updated)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> X<span class="op">);</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate crash before commit</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Crash! Rolling back...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Undo</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L<span class="op">.</span>old_val<span class="op">;</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Undo: X restored to </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> X<span class="op">);</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>&lt;START T1&gt;
&lt;T1, X, 10&gt;
X = 20 (updated)
Crash! Rolling back...
Undo: X restored to 10</code></pre>
</section>
<section id="why-it-matters-16" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-16">Why It Matters</h4>
<ul>
<li>Simple and effective rollback mechanism</li>
<li>Guaranteed atomicity, uncommitted updates never persist</li>
<li>Used in early DBMS and transactional file systems</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Writes must be in-place (no shadow copies)</li>
<li>Requires flushing log before every write → slower</li>
<li>No built-in redo (can’t restore committed updates)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-7" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-7">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(L\)</span> be the log sequence, and <span class="math inline">\(D\)</span> the database.</p>
<p>Invariant: Before any update <span class="math inline">\((X \leftarrow v_{\text{new}})\)</span>, its old value <span class="math inline">\(v_{\text{old}}\)</span> is logged: <span class="math display">\[
\text{write}(L, \langle T, X, v_{\text{old}} \rangle) \Rightarrow \text{write}(D, X = v_{\text{new}})
\]</span></p>
<p>Upon crash:</p>
<ul>
<li>For any transaction <span class="math inline">\(T\)</span> without <code>&lt;COMMIT T&gt;</code>, scan backward, restoring each <span class="math inline">\(X\)</span>: <span class="math display">\[
X \leftarrow v_{\text{old}}
\]</span></li>
<li>For committed <span class="math inline">\(T\)</span>, no undo is performed.</li>
</ul>
<p>Thus: <span class="math display">\[
D_{\text{after recovery}} = D_{\text{before uncommitted updates}}
\]</span></p>
<p>ensuring atomicity and consistency.</p>
</section>
<section id="try-it-yourself-16" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-16">Try It Yourself</h4>
<ol type="1">
<li>Update two variables (X, Y) under one transaction.</li>
<li>Crash before <code>&lt;COMMIT&gt;</code>, rollback both.</li>
<li>Crash after <code>&lt;COMMIT&gt;</code>, no rollback.</li>
<li>Extend with <code>&lt;END T&gt;</code> records for cleanup.</li>
</ol>
</section>
<section id="test-cases-16" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-16">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 17%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Log</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&lt;START T₁&gt;, &lt;T₁, X, 10&gt;, crash</code></td>
<td>Uncommitted</td>
<td>Undo <code>X=10</code></td>
</tr>
<tr class="even">
<td><code>&lt;START T₁&gt;, &lt;T₁, X, 10&gt;, &lt;COMMIT T₁&gt;</code></td>
<td>Committed</td>
<td>No action</td>
</tr>
<tr class="odd">
<td>Multiple txns, one uncommitted</td>
<td>Partial undo</td>
<td>Rollback only active</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-16" class="level4">
<h4 class="anchored" data-anchor-id="complexity-16">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> (scan log backward)</li>
<li>Space: <span class="math inline">\(O(\text{\#updates})\)</span> (log size)</li>
</ul>
<p>Undo Logging is the guardian of old values, always writing the past before touching the present. If the system stumbles, the log becomes its map back to safety, step by step, undo by undo.</p>
</section>
</section>
<section id="redo-logging" class="level3">
<h3 class="anchored" data-anchor-id="redo-logging">818 Redo Logging</h3>
<p>Redo Logging is the dual of Undo Logging. Instead of recording old values for rollback, it logs new values so that after a crash, the system can reapply (redo) all committed updates. It ensures durability by replaying only the operations that made it to the commit point.</p>
<section id="what-problem-are-we-solving-17" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-17">What Problem Are We Solving?</h4>
<p>If a system crashes before flushing data to disk, some committed transactions might exist only in memory. Without protection, their updates would be lost, violating durability.</p>
<p>Redo Logging solves this by logging all new values before commit, so recovery can reconstruct them later, even if data pages were never written.</p>
<p>The rule is simple:</p>
<blockquote class="blockquote">
<p><em>Never declare a transaction committed until all its new values are logged to stable storage.</em></p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-17" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-17">How Does It Work (Plain Language)</h4>
<p>Redo Logging keeps records of new values for each update.</p>
<p>Log record format:</p>
<pre><code>&lt;T, X, new_value&gt;</code></pre>
<p>where:</p>
<ul>
<li><code>T</code> = transaction ID</li>
<li><code>X</code> = data item</li>
<li><code>new_value</code> = value after modification</li>
</ul>
<section id="rules-of-redo-logging" class="level5">
<h5 class="anchored" data-anchor-id="rules-of-redo-logging">Rules of Redo Logging</h5>
<ol type="1">
<li><p>Log Before Commit Every <code>&lt;T, X, new_value&gt;</code> must be written before <code>&lt;COMMIT T&gt;</code>.</p></li>
<li><p>Write Data After Commit Actual data pages can be written after the transaction commits.</p></li>
<li><p>Redo on Recovery If a committed transaction’s changes weren’t applied to disk, reapply them.</p></li>
</ol>
<p>Uncommitted transactions are ignored, their changes never reach the database.</p>
</section>
</section>
<section id="example-walkthrough-13" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-13">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Action</th>
<th>Log</th>
<th>Data</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>&lt;START T₁&gt;</code></td>
<td>Start transaction</td>
<td>–</td>
</tr>
<tr class="even">
<td>2</td>
<td><code>&lt;T₁, X, 20&gt;</code></td>
<td>Log new value</td>
<td>–</td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>&lt;COMMIT T₁&gt;</code></td>
<td>Commit</td>
<td>–</td>
</tr>
<tr class="even">
<td>4</td>
<td><code>X = 20</code></td>
<td>Write data</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>If crash occurs after commit but before writing X, recovery will redo the update from log: <code>X = 20</code>.</p>
</section>
<section id="recovery-algorithm-forward-pass" class="level4">
<h4 class="anchored" data-anchor-id="recovery-algorithm-forward-pass">Recovery Algorithm (Forward Pass)</h4>
<ol type="1">
<li><p>Scan log forward from start.</p></li>
<li><p>Identify committed transactions.</p></li>
<li><p>For each committed transaction <span class="math inline">\(T\)</span>:</p>
<ul>
<li>For each record <code>&lt;T, X, new_value&gt;</code> reapply <span class="math inline">\(X \leftarrow new_value\)</span></li>
</ul></li>
<li><p>Write <code>&lt;END T&gt;</code> to mark completion.</p></li>
</ol>
<p>No undo needed, uncommitted updates are never written.</p>
</section>
<section id="tiny-code-conceptual-simulation-9" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-9">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> txn<span class="op">;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> var<span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> new_val<span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LogEntry<span class="op">;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> X <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    LogEntry L <span class="op">=</span> <span class="op">{</span><span class="st">"T1"</span><span class="op">,</span> <span class="st">"X"</span><span class="op">,</span> <span class="dv">20</span><span class="op">};</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"&lt;START </span><span class="sc">%s</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> L<span class="op">.</span>txn<span class="op">);</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"&lt;</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">, </span><span class="sc">%d</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> L<span class="op">.</span>txn<span class="op">,</span> L<span class="op">.</span>var<span class="op">,</span> L<span class="op">.</span>new_val<span class="op">);</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"&lt;COMMIT </span><span class="sc">%s</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> L<span class="op">.</span>txn<span class="op">);</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Crash before data write</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Crash! Recovering...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Redo</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L<span class="op">.</span>new_val<span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Redo: X = </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> X<span class="op">);</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>&lt;START T1&gt;
&lt;T1, X, 20&gt;
&lt;COMMIT T1&gt;
Crash! Recovering...
Redo: X = 20</code></pre>
</section>
<section id="why-it-matters-17" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-17">Why It Matters</h4>
<ul>
<li>Ensures durability (D in ACID), committed updates never lost</li>
<li>Simple recovery, only reapply committed updates</li>
<li>Safe to delay writes, data written lazily</li>
<li>Used in systems with deferred writes</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires forward recovery scan</li>
<li>Can’t undo, assumes uncommitted updates never flushed</li>
<li>Must force <code>&lt;COMMIT&gt;</code> record before declaring success</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-8" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-8">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(L\)</span> be the log and <span class="math inline">\(D\)</span> the data pages.</p>
<p>Invariant:</p>
<ul>
<li>Before commit: <span class="math display">\[
\forall (T, X, v_{\text{new}}) \in L,\ \text{no write to } D
\]</span></li>
<li>At commit: <span class="math display">\[
\text{write}(L, \langle \text{COMMIT } T \rangle) \Rightarrow \text{all new values in } L
\]</span></li>
</ul>
<p>On recovery:</p>
<ul>
<li>For committed <span class="math inline">\(T\)</span>, reapply updates: <span class="math display">\[
X \leftarrow v_{\text{new}}
\]</span></li>
<li>For uncommitted <span class="math inline">\(T\)</span>, skip (no changes persisted)</li>
</ul>
<p>Thus final state is: <span class="math display">\[
D_{\text{after recovery}} = D_{\text{after committed txns}}
\]</span> ensuring atomicity and durability.</p>
</section>
<section id="try-it-yourself-17" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-17">Try It Yourself</h4>
<ol type="1">
<li>Simulate <span class="math inline">\(T_1\)</span>: update <span class="math inline">\(X=10 \to 20\)</span>, crash before writing <span class="math inline">\(X\)</span>.</li>
<li>Replay log → verify <span class="math inline">\(X=20\)</span>.</li>
<li>Add uncommitted <span class="math inline">\(T_2\)</span>, no redo applied.</li>
<li>Combine with checkpoint, skip old transactions.</li>
</ol>
</section>
<section id="test-cases-17" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-17">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Log</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&lt;START T₁&gt;, &lt;T₁, X, 20&gt;, &lt;COMMIT T₁&gt;</code></td>
<td>Redo</td>
<td>X=20</td>
</tr>
<tr class="even">
<td><code>&lt;START T₁&gt;, &lt;T₁, X, 20&gt;</code> (no commit)</td>
<td>Skip</td>
<td>X unchanged</td>
</tr>
<tr class="odd">
<td>Two txns, one committed</td>
<td>Redo one</td>
<td>Only T₁ applied</td>
</tr>
<tr class="even">
<td>Commit record missing</td>
<td>Skip</td>
<td>Safe recovery</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-17" class="level4">
<h4 class="anchored" data-anchor-id="complexity-17">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> (forward scan)</li>
<li>Space: <span class="math inline">\(O(\text{\#updates})\)</span> (log size)</li>
</ul>
<p>Redo Logging is the replay artist of recovery, always forward-looking, always restoring the future you meant to have. By saving every <em>new value before commit</em>, it ensures that no crash can erase what was promised.</p>
</section>
</section>
<section id="quorum-commit" class="level3">
<h3 class="anchored" data-anchor-id="quorum-commit">819 Quorum Commit</h3>
<p>Quorum Commit is a distributed commit protocol that ensures consistency by requiring a majority (quorum) of replicas to agree before a transaction is considered committed. It’s the foundation of fault-tolerant replication systems such as Dynamo, Cassandra, and Paxos-based databases.</p>
<p>Instead of one coordinator forcing all participants to commit (like 2PC), quorum commit spreads control across replicas, commit happens only when enough nodes agree.</p>
<section id="what-problem-are-we-solving-18" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-18">What Problem Are We Solving?</h4>
<p>In replicated systems, data is stored across multiple nodes for fault tolerance. We need a way to ensure:</p>
<ul>
<li>Durability: data survives node failures</li>
<li>Consistency: all replicas converge</li>
<li>Availability: progress despite partial failures</li>
</ul>
<p>If we required all replicas to acknowledge every write, one crashed node would block progress. Quorum Commit fixes this by requiring only a majority: <span class="math display">\[
W + R &gt; N
\]</span> where:</p>
<ul>
<li><span class="math inline">\(N\)</span> = total replicas</li>
<li><span class="math inline">\(W\)</span> = write quorum size</li>
<li><span class="math inline">\(R\)</span> = read quorum size</li>
</ul>
<p>This ensures every read overlaps with the latest committed write.</p>
</section>
<section id="how-does-it-work-plain-language-18" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-18">How Does It Work (Plain Language)</h4>
<p>Each transaction (or write) is sent to N replicas. The coordinator waits for W acknowledgments before declaring commit success.</p>
<p>On reads, the client queries R replicas and merges responses. Because <span class="math inline">\(W + R &gt; N\)</span>, at least one replica in any read quorum has the latest value.</p>
<section id="steps-for-write" class="level5">
<h5 class="anchored" data-anchor-id="steps-for-write">Steps for Write:</h5>
<ol type="1">
<li>Send write to all <span class="math inline">\(N\)</span> replicas.</li>
<li>Wait for <span class="math inline">\(W\)</span> acknowledgments.</li>
<li>If <span class="math inline">\(W\)</span> reached → commit success.</li>
<li>If fewer → abort or retry.</li>
</ol>
</section>
<section id="steps-for-read" class="level5">
<h5 class="anchored" data-anchor-id="steps-for-read">Steps for Read:</h5>
<ol type="1">
<li>Query <span class="math inline">\(R\)</span> replicas.</li>
<li>Collect responses.</li>
<li>Choose value with latest timestamp/version.</li>
</ol>
<p>This model supports eventual consistency or strong consistency, depending on <span class="math inline">\(W\)</span> and <span class="math inline">\(R\)</span>.</p>
</section>
</section>
<section id="example-walkthrough-14" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-14">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Parameter</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(N = 3\)</span></td>
<td>total replicas</td>
</tr>
<tr class="even">
<td><span class="math inline">\(W = 2\)</span></td>
<td>write quorum</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(R = 2\)</span></td>
<td>read quorum</td>
</tr>
</tbody>
</table>
<p>Write “X=10”:</p>
<ul>
<li>Send to replicas A, B, C</li>
<li>A and B respond → quorum reached → commit</li>
<li>C may lag, will catch up later</li>
</ul>
<p>Read “X”:</p>
<ul>
<li>Query A, C</li>
<li>A has X=10, C has X=old</li>
<li>Choose latest (A wins)</li>
</ul>
<p>Because <span class="math inline">\(W + R = 4 &gt; 3\)</span>, overlap guarantees correctness.</p>
</section>
<section id="tiny-code-conceptual-simulation-10" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-10">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> N <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> W <span class="op">=</span> <span class="dv">2</span><span class="op">,</span> ack <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> replicas<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span> <span class="co">// A, B ack; C fails</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>replicas<span class="op">[</span>i<span class="op">])</span> ack<span class="op">++;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ack <span class="op">&gt;=</span> W<span class="op">)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Commit success (acks=</span><span class="sc">%d</span><span class="st">, quorum=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> ack<span class="op">,</span> W<span class="op">);</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Commit failed (acks=</span><span class="sc">%d</span><span class="st">, quorum=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> ack<span class="op">,</span> W<span class="op">);</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Commit success (acks=2, quorum=2)</code></pre>
</section>
<section id="why-it-matters-18" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-18">Why It Matters</h4>
<ul>
<li>Fault Tolerance: survives <span class="math inline">\(N - W\)</span> replica failures</li>
<li>Low Latency: avoids waiting for all nodes</li>
<li>Consistency–Availability Tradeoff: tunable via <span class="math inline">\(W\)</span> and <span class="math inline">\(R\)</span></li>
<li>Foundation for Dynamo, Cassandra, Riak, CockroachDB</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Eventual consistency if replicas lag</li>
<li>Higher coordination than single-node commit</li>
<li>Conflicts if concurrent writes (solved via versioning)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-9" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-9">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(N\)</span> = total replicas</li>
<li><span class="math inline">\(W\)</span> = write quorum size</li>
<li><span class="math inline">\(R\)</span> = read quorum size</li>
</ul>
<p>To ensure every read sees the latest committed write: <span class="math display">\[
W + R &gt; N
\]</span></p>
<p>Proof sketch:</p>
<ul>
<li>Write completes after <span class="math inline">\(W\)</span> replicas store the update.</li>
<li>Read queries <span class="math inline">\(R\)</span> replicas.</li>
<li>Since <span class="math inline">\(W + R &gt; N\)</span>, there must be at least one replica <span class="math inline">\(p\)</span> that received both. Thus, every read overlaps with the latest write.</li>
</ul>
<p>So every read intersects with the set of written replicas, ensuring consistency.</p>
</section>
<section id="try-it-yourself-18" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-18">Try It Yourself</h4>
<ol type="1">
<li><p>Set <span class="math inline">\(N=5\)</span>, <span class="math inline">\(W=3\)</span>, <span class="math inline">\(R=3\)</span> → check overlap.</p></li>
<li><p>Simulate replica failures:</p>
<ul>
<li>If 1 fails → still commit (3 of 5).</li>
<li>If 3 fail → no quorum → abort.</li>
</ul></li>
<li><p>Reduce <span class="math inline">\(W\)</span> to 1 → faster but weaker consistency.</p></li>
<li><p>Visualize <span class="math inline">\(W+R &gt; N\)</span> overlap condition.</p></li>
</ol>
</section>
<section id="test-cases-18" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-18">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th><span class="math inline">\(N\)</span></th>
<th><span class="math inline">\(W\)</span></th>
<th><span class="math inline">\(R\)</span></th>
<th><span class="math inline">\(W + R &gt; N\)</span></th>
<th>Consistent?</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>2</td>
<td>2</td>
<td>4 &gt; 3</td>
<td>✅</td>
<td>Strong consistency</td>
</tr>
<tr class="even">
<td>3</td>
<td>2</td>
<td>1</td>
<td>3 = 3</td>
<td>✅</td>
<td>OK but fragile</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>1</td>
<td>2 &lt; 3</td>
<td>❌</td>
<td>Inconsistent</td>
</tr>
<tr class="even">
<td>5</td>
<td>3</td>
<td>3</td>
<td>6 &gt; 5</td>
<td>✅</td>
<td>Safe overlap</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-18" class="level4">
<h4 class="anchored" data-anchor-id="complexity-18">Complexity</h4>
<ul>
<li>Write latency: wait for <span class="math inline">\(W\)</span> acks → <span class="math inline">\(O(W)\)</span></li>
<li>Read latency: wait for <span class="math inline">\(R\)</span> responses → <span class="math inline">\(O(R)\)</span></li>
<li>Fault tolerance: up to <span class="math inline">\(N - W\)</span> failures</li>
</ul>
<p>Quorum Commit is the voting system of distributed data, decisions made by majority, not unanimity. By tuning <span class="math inline">\(W\)</span> and <span class="math inline">\(R\)</span>, you can steer the system toward strong consistency, high availability, or low latency, one quorum at a time.</p>
</section>
</section>
<section id="consensus-commit" class="level3">
<h3 class="anchored" data-anchor-id="consensus-commit">820 Consensus Commit</h3>
<p>Consensus Commit merges the atomic commit protocol of 2PC with the fault tolerance of consensus algorithms like Paxos or Raft. It ensures that a distributed transaction reaches a durable, consistent decision (commit or abort) even if coordinators or participants crash.</p>
<p>This is how modern distributed databases (e.g., Spanner, CockroachDB, Calvin) achieve atomicity and consistency in the presence of failures.</p>
<section id="what-problem-are-we-solving-19" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-19">What Problem Are We Solving?</h4>
<p>Traditional Two-Phase Commit (2PC) ensures atomicity but is blocking, if the coordinator fails after all participants prepare, they may wait forever.</p>
<p>Consensus Commit solves this by replacing the coordinator’s single point of failure with a consensus group. The commit decision is reached through majority agreement, so even if some nodes fail, others can continue.</p>
<p>In short:</p>
<ul>
<li>2PC: atomic but blocking</li>
<li>Consensus Commit: atomic, fault-tolerant, non-blocking</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-19" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-19">How Does It Work (Plain Language)</h4>
<p>Consensus Commit wraps 2PC inside a consensus layer (like Paxos or Raft). Instead of a single coordinator deciding, the commit decision itself is replicated and agreed upon.</p>
<p>Steps:</p>
<ol type="1">
<li><p>Prepare Phase</p>
<ul>
<li>Each participant votes YES/NO (like 2PC).</li>
<li>Votes sent to a leader node.</li>
</ul></li>
<li><p>Consensus Phase</p>
<ul>
<li>Leader proposes a final decision (commit/abort).</li>
<li>Decision is replicated via consensus protocol (Paxos/Raft).</li>
<li>Majority accepts → decision is durable.</li>
</ul></li>
<li><p>Commit Phase</p>
<ul>
<li>Decision broadcast to all participants.</li>
<li>Each applies commit/abort locally.</li>
<li>Even if the leader crashes, the decision can be recovered.</li>
</ul></li>
</ol>
<p>So, the decision itself is stored redundantly across nodes, eliminating coordinator failure as a single point of blocking.</p>
</section>
<section id="example-walkthrough-15" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-15">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Role</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Leader</td>
<td>Collect votes from participants</td>
</tr>
<tr class="even">
<td>2</td>
<td>Participants</td>
<td>Vote YES / NO</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Leader</td>
<td>Propose final decision = COMMIT</td>
</tr>
<tr class="even">
<td>4</td>
<td>Replicas</td>
<td>Reach consensus via Raft/Paxos</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Majority</td>
<td>Agree → Decision durable</td>
</tr>
<tr class="even">
<td>6</td>
<td>All</td>
<td>Apply COMMIT locally</td>
</tr>
</tbody>
</table>
<p>If the leader fails after step 4, a new leader reads the replicated log and continues from the same decision.</p>
</section>
<section id="visual-summary" class="level4">
<h4 class="anchored" data-anchor-id="visual-summary">Visual Summary</h4>
<p><span class="math display">\[
\text{Consensus Commit} = \text{2PC} + \text{Consensus Replication}
\]</span></p>
<p>Ensures:</p>
<ul>
<li>Atomicity (via 2PC votes)</li>
<li>Durability (via consensus log)</li>
<li>Fault tolerance (via quorum agreement)</li>
</ul>
</section>
<section id="tiny-code-conceptual-simulation-11" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-11">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> participant_vote<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">,</span> <span class="dt">bool</span> can_commit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> votes </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> name<span class="op">,</span> can_commit <span class="op">?</span> <span class="st">"YES"</span> <span class="op">:</span> <span class="st">"NO"</span><span class="op">);</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> can_commit<span class="op">;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> consensus_replicate<span class="op">(</span><span class="dt">bool</span> decision<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Consensus group agrees: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> decision <span class="op">?</span> <span class="st">"COMMIT"</span> <span class="op">:</span> <span class="st">"ABORT"</span><span class="op">);</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decision<span class="op">;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> p1 <span class="op">=</span> participant_vote<span class="op">(</span><span class="st">"P1"</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> p2 <span class="op">=</span> participant_vote<span class="op">(</span><span class="st">"P2"</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> decision <span class="op">=</span> <span class="op">(</span>p1 <span class="op">&amp;&amp;</span> p2<span class="op">);</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    consensus_replicate<span class="op">(</span>decision<span class="op">);</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Final Decision: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> decision <span class="op">?</span> <span class="st">"COMMIT"</span> <span class="op">:</span> <span class="st">"ABORT"</span><span class="op">);</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>P1 votes YES
P2 votes YES
Consensus group agrees: COMMIT
Final Decision: COMMIT</code></pre>
</section>
<section id="why-it-matters-19" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-19">Why It Matters</h4>
<ul>
<li>Atomic: all-or-nothing commit across nodes</li>
<li>Non-blocking: decision replicated, not centralized</li>
<li>Crash-safe: leader can fail, new leader recovers state</li>
<li>Used in: Google Spanner, CockroachDB, YugabyteDB</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>More message rounds than 2PC</li>
<li>Consensus overhead (<span class="math inline">\(O(\text{log replication})\)</span>)</li>
<li>Complexity in coordinating multiple consensus groups</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-10" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-10">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(P_i\)</span> = participant nodes</li>
<li><span class="math inline">\(L\)</span> = leader</li>
<li><span class="math inline">\(Q\)</span> = majority quorum</li>
</ul>
<p>Key properties:</p>
<ol type="1">
<li><p>Agreement: Commit decision is replicated to a majority <span class="math inline">\(Q\)</span>. Any new leader must read from <span class="math inline">\(Q\)</span>, so all leaders share the same decision: <span class="math display">\[
\forall L_1, L_2:\ \text{decision}(L_1) = \text{decision}(L_2)
\]</span></p></li>
<li><p>Atomicity: All participants apply the same decision: <span class="math display">\[
\forall i, j:\ \text{state}(P_i) = \text{state}(P_j)
\]</span></p></li>
<li><p>Durability: Once quorum stores the decision, it cannot be lost, even if some replicas fail.</p></li>
</ol>
<p>Thus Consensus Commit guarantees: <span class="math display">\[
\text{Atomicity} + \text{Consistency} + \text{Fault Tolerance}
\]</span></p>
</section>
<section id="try-it-yourself-19" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-19">Try It Yourself</h4>
<ol type="1">
<li>Simulate 3 replicas (<span class="math inline">\(N=3\)</span>), 2 participants.</li>
<li>One replica crashes after commit proposal → consensus still succeeds.</li>
<li>Restart crashed node → replay from consensus log.</li>
<li>Compare with 2PC: where does blocking happen?</li>
<li>Test mixed votes, one NO → system aborts.</li>
</ol>
</section>
<section id="test-cases-19" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-19">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 20%">
<col style="width: 21%">
<col style="width: 41%">
</colgroup>
<thead>
<tr class="header">
<th>Votes</th>
<th>Consensus</th>
<th>Result</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>YES, YES</td>
<td>COMMIT</td>
<td>Commit</td>
<td>Normal case</td>
</tr>
<tr class="even">
<td>YES, NO</td>
<td>ABORT</td>
<td>Abort</td>
<td>Atomic abort</td>
</tr>
<tr class="odd">
<td>Leader crash</td>
<td>Majority exists</td>
<td>Commit continues</td>
<td>Non-blocking</td>
</tr>
<tr class="even">
<td>Majority lost</td>
<td>–</td>
<td>Wait</td>
<td>No progress (safety &gt; liveness)</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-19" class="level4">
<h4 class="anchored" data-anchor-id="complexity-19">Complexity</h4>
<ul>
<li>Message Rounds: 2PC (2 rounds) + Consensus (2–3 rounds)</li>
<li>Time: <span class="math inline">\(O(\text{consensus latency})\)</span></li>
<li>Fault Tolerance: survives <span class="math inline">\(f\)</span> failures out of <span class="math inline">\(2f+1\)</span> replicas</li>
</ul>
<p>Consensus Commit is atomic commitment with brains, blending the simplicity of 2PC with the resilience of consensus. It guarantees that even in a storm of failures, every node sees the same decision, and that decision is final, durable, and agreed by majority.</p>
</section>
</section>
</section>
<section id="section-83.-scheduling" class="level1">
<h1>Section 83. Scheduling</h1>
<section id="first-come-first-served-fcfs" class="level3">
<h3 class="anchored" data-anchor-id="first-come-first-served-fcfs">821 First-Come First-Served (FCFS)</h3>
<p>First-Come First-Served (FCFS) is the simplest scheduling algorithm, it processes tasks strictly in the order they arrive. No preemption, no priority, just a fair queue: the first job in is the first job out.</p>
<p>It’s used in operating systems, job schedulers, and even I/O queues where fairness matters more than responsiveness.</p>
<section id="what-problem-are-we-solving-20" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-20">What Problem Are We Solving?</h4>
<p>When multiple jobs compete for a shared resource (CPU, disk, printer), we need a policy to decide which runs first.</p>
<p>The FCFS strategy solves this by providing:</p>
<ul>
<li>Fairness: every job gets a turn</li>
<li>Simplicity: easy to implement</li>
<li>Predictability: execution order is transparent</li>
</ul>
<p>But because jobs run non-preemptively, long jobs can block short ones, a phenomenon known as the convoy effect.</p>
</section>
<section id="how-does-it-work-plain-language-20" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-20">How Does It Work (Plain Language)</h4>
<p>Jobs are ordered by arrival time. The scheduler always picks the earliest waiting job.</p>
<p>Steps:</p>
<ol type="1">
<li>Maintain a FIFO queue of ready jobs.</li>
<li>When the CPU is free, dequeue the first job.</li>
<li>Run it to completion (no interruption).</li>
<li>Repeat for the next job in line.</li>
</ol>
<p>No priorities. No time slicing. Just fairness in time order.</p>
</section>
<section id="example-walkthrough-16" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-16">Example Walkthrough</h4>
<p>Suppose 3 jobs arrive:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Arrival</th>
<th>Burst Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>5</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>2</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>Execution Order: J₁ → J₂ → J₃</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Start</th>
<th>Finish</th>
<th>Turnaround</th>
<th>Waiting</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>5</td>
<td>5</td>
<td>0</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>5</td>
<td>8</td>
<td>7</td>
<td>4</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>8</td>
<td>16</td>
<td>14</td>
<td>6</td>
</tr>
</tbody>
</table>
<p>Average waiting time = <span class="math inline">\((0 + 4 + 6)/3 = 3.33\)</span></p>
<p>The later a job arrives, the longer it may wait, especially behind long tasks.</p>
</section>
<section id="tiny-code-conceptual-simulation-12" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-12">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> burst<span class="op">;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Job<span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    Job q<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">8</span><span class="op">}};</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Job </span><span class="sc">%d</span><span class="st"> starts at </span><span class="sc">%d</span><span class="st">, runs for </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>               q<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> time<span class="op">,</span> q<span class="op">[</span>i<span class="op">].</span>burst<span class="op">);</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        time <span class="op">+=</span> q<span class="op">[</span>i<span class="op">].</span>burst<span class="op">;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Job </span><span class="sc">%d</span><span class="st"> finishes at </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> q<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> time<span class="op">);</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Job 1 starts at 0, runs for 5
Job 1 finishes at 5
Job 2 starts at 5, runs for 3
Job 2 finishes at 8
Job 3 starts at 8, runs for 8
Job 3 finishes at 16</code></pre>
</section>
<section id="why-it-matters-20" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-20">Why It Matters</h4>
<ul>
<li>Fairness: all jobs treated equally</li>
<li>Simplicity: trivial to implement</li>
<li>Good throughput when tasks are similar</li>
</ul>
<p>But:</p>
<ul>
<li>Convoy effect: one long job delays all others</li>
<li>Poor responsiveness: no preemption for I/O-bound jobs</li>
<li>Not ideal for interactive systems</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-11" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-11">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(n\)</span> jobs arrive at times <span class="math inline">\(a_i\)</span> with burst times <span class="math inline">\(b_i\)</span> (sorted by arrival).</p>
<p>In FCFS, each job starts after the previous finishes: <span class="math display">\[
S_1 = a_1, \quad S_i = \max(a_i, F_{i-1})
\]</span> <span class="math display">\[
F_i = S_i + b_i
\]</span></p>
<p>Turnaround time: <span class="math display">\[
T_i = F_i - a_i
\]</span></p>
<p>Waiting time: <span class="math display">\[
W_i = T_i - b_i
\]</span></p>
<p>Because the order is fixed, FCFS minimizes context switching overhead, though not necessarily waiting time.</p>
</section>
<section id="try-it-yourself-20" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-20">Try It Yourself</h4>
<ol type="1">
<li>Simulate 5 jobs with varying burst times.</li>
<li>Compute average turnaround and waiting time.</li>
<li>Add a very long job first, observe convoy effect.</li>
<li>Compare with Shortest Job First (SJF), note differences.</li>
</ol>
</section>
<section id="test-cases-20" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-20">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Jobs</th>
<th>Arrival</th>
<th>Burst</th>
<th>Order</th>
<th>Avg Waiting</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>0,1,2</td>
<td>5,3,8</td>
<td>FCFS</td>
<td>3.33</td>
</tr>
<tr class="even">
<td>3</td>
<td>0,2,4</td>
<td>2,2,2</td>
<td>FCFS</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0,1,2</td>
<td>10,1,1</td>
<td>FCFS</td>
<td>High (convoy)</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-20" class="level4">
<h4 class="anchored" data-anchor-id="complexity-20">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> (linear scan through queue)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> (queue size)</li>
</ul>
<p>FCFS is the gentle giant of scheduling, slow to adapt, but steady and fair. Its simplicity makes it ideal for batch systems and FIFO queues, though modern schedulers often add priorities and preemption to tame its convoy effect.</p>
</section>
</section>
<section id="shortest-job-first-sjf" class="level3">
<h3 class="anchored" data-anchor-id="shortest-job-first-sjf">822 Shortest Job First (SJF)</h3>
<p>Shortest Job First (SJF) scheduling always picks the job with the smallest execution time next. It’s the optimal scheduling algorithm for minimizing average waiting time, small tasks never get stuck behind long ones.</p>
<p>There are two variants:</p>
<ul>
<li>Non-preemptive SJF: once a job starts, it runs to completion.</li>
<li>Preemptive SJF (Shortest Remaining Time First, SRTF): if a new job arrives with a shorter remaining time, it preempts the current one.</li>
</ul>
<section id="what-problem-are-we-solving-21" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-21">What Problem Are We Solving?</h4>
<p>First-Come First-Served (FCFS) can cause the convoy effect, short tasks wait behind long ones. SJF fixes that by prioritizing shorter tasks, improving average turnaround and responsiveness.</p>
<p>The intuition:</p>
<blockquote class="blockquote">
<p>“Always do the easiest thing first.”</p>
</blockquote>
<p>This mirrors real-world queues, serve quick customers first to minimize average waiting.</p>
</section>
<section id="how-does-it-work-plain-language-21" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-21">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Maintain a list of ready jobs.</li>
<li>When CPU is free, pick the job with smallest burst time.</li>
<li>Run it (non-preemptive), or switch if a shorter job arrives (preemptive).</li>
<li>Repeat until all jobs finish.</li>
</ol>
<p>If burst times are known (e.g., predicted via exponential averaging), SJF gives provably minimal waiting time.</p>
</section>
<section id="example-walkthrough-non-preemptive" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-non-preemptive">Example Walkthrough (Non-Preemptive)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Arrival</th>
<th>Burst</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>7</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td>J₄</td>
<td>3</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>Execution order:</p>
<ul>
<li>At <span class="math inline">\(t=0\)</span>, only J₁ (7) → run J₁</li>
<li>When J₁ finishes at <span class="math inline">\(t=7\)</span>, pick shortest among {J₂(4), J₃(1), J₄(4)} → J₃</li>
<li>Then J₂ → J₄</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Start</th>
<th>Finish</th>
<th>Turnaround</th>
<th>Waiting</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>7</td>
<td>7</td>
<td>0</td>
</tr>
<tr class="even">
<td>J₃</td>
<td>7</td>
<td>8</td>
<td>6</td>
<td>5</td>
</tr>
<tr class="odd">
<td>J₂</td>
<td>8</td>
<td>12</td>
<td>11</td>
<td>7</td>
</tr>
<tr class="even">
<td>J₄</td>
<td>12</td>
<td>16</td>
<td>13</td>
<td>9</td>
</tr>
</tbody>
</table>
<p>Average waiting = <span class="math inline">\((0 + 5 + 7 + 9)/4 = 5.25\)</span></p>
</section>
<section id="example-walkthrough-preemptive-srtf" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-preemptive-srtf">Example Walkthrough (Preemptive / SRTF)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Arrival</th>
<th>Burst</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>8</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Timeline:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: J₁ starts</li>
<li><span class="math inline">\(t=1\)</span>: J₂ arrives (4 &lt; 7 remaining) → preempt J₁</li>
<li><span class="math inline">\(t=2\)</span>: J₃ arrives (2 &lt; 3 remaining) → preempt J₂</li>
<li>Execute J₃ → J₂ → J₁</li>
</ul>
<p>Total waiting time = smaller than FCFS or non-preemptive SJF.</p>
</section>
<section id="tiny-code-conceptual-simulation-13" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-13">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> burst<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Job<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sjf<span class="op">(</span>Job jobs<span class="op">[],</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple selection-sort style scheduling</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> min <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jobs<span class="op">[</span>j<span class="op">].</span>burst <span class="op">&lt;</span> jobs<span class="op">[</span>min<span class="op">].</span>burst<span class="op">)</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>                min <span class="op">=</span> j<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        Job temp <span class="op">=</span> jobs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        jobs<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> jobs<span class="op">[</span>min<span class="op">];</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        jobs<span class="op">[</span>min<span class="op">]</span> <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Job </span><span class="sc">%d</span><span class="st"> starts at </span><span class="sc">%d</span><span class="st">, burst = </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>               jobs<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> time<span class="op">,</span> jobs<span class="op">[</span>i<span class="op">].</span>burst<span class="op">);</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        time <span class="op">+=</span> jobs<span class="op">[</span>i<span class="op">].</span>burst<span class="op">;</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    Job jobs<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">7</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">}};</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    sjf<span class="op">(</span>jobs<span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Job 3 starts at 0, burst = 1
Job 2 starts at 1, burst = 4
Job 4 starts at 5, burst = 4
Job 1 starts at 9, burst = 7</code></pre>
</section>
<section id="why-it-matters-21" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-21">Why It Matters</h4>
<ul>
<li>Minimizes average waiting time, provably optimal</li>
<li>Fair for small jobs, but starves long ones</li>
<li>Foundation for priority-based and multilevel feedback schedulers</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires knowledge or estimation of burst times</li>
<li>Not suitable for unpredictable workloads</li>
<li>May lead to starvation (long jobs never scheduled)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-12" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-12">A Gentle Proof (Why It Works)</h4>
<p>Let jobs have burst times <span class="math inline">\(b_1, b_2, \dots, b_n\)</span>, sorted ascending. Total waiting time: <span class="math display">\[
W = \sum_{i=1}^{n-1} (n - i) b_i
\]</span> SJF minimizes <span class="math inline">\(W\)</span> because exchanging any longer job earlier increases total waiting. Hence, by Shortest Processing Time First (SPT) principle, SJF is optimal for minimizing mean waiting time.</p>
</section>
<section id="try-it-yourself-21" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-21">Try It Yourself</h4>
<ol type="1">
<li>Simulate 4 jobs with burst = 7, 4, 1, 4.</li>
<li>Draw a Gantt chart for non-preemptive SJF.</li>
<li>Now add preemption (SRTF), compare results.</li>
<li>Try a long job arriving early, observe starvation.</li>
<li>Compare average waiting time vs FCFS.</li>
</ol>
</section>
<section id="test-cases-21" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-21">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Jobs</th>
<th>Burst</th>
<th>Order</th>
<th>Avg Waiting</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>5, 2, 1</td>
<td>3→2→1</td>
<td>2</td>
<td>SJF optimal</td>
</tr>
<tr class="even">
<td>4</td>
<td>7,4,1,4</td>
<td>3→2→4→1</td>
<td>5.25</td>
<td>Matches example</td>
</tr>
<tr class="odd">
<td>3</td>
<td>2,2,2</td>
<td>Any</td>
<td>2</td>
<td>Tie safe</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-21" class="level4">
<h4 class="anchored" data-anchor-id="complexity-21">Complexity</h4>
<ul>
<li>Sorting: <span class="math inline">\(O(n \log n)\)</span></li>
<li>Scheduling: <span class="math inline">\(O(n)\)</span></li>
<li>Space: <span class="math inline">\(O(n)\)</span></li>
</ul>
<p>SJF is the strategist of schedulers, always choosing the shortest path to reduce waiting. Elegant in theory, but demanding in practice, it shines when burst times are known or predictable.</p>
</section>
</section>
<section id="priority-scheduling" class="level3">
<h3 class="anchored" data-anchor-id="priority-scheduling">824 Priority Scheduling</h3>
<p>Priority Scheduling selects the next job based on its priority value, not its arrival order or length. Higher-priority jobs run first; lower ones wait. It’s a generalization of SJF (where priority = <span class="math inline">\(1/\text{burst time}\)</span>) and underpins many real-world schedulers like those in Linux, Windows, and databases.</p>
<p>There are two main modes:</p>
<ul>
<li>Non-preemptive: once started, the job runs to completion.</li>
<li>Preemptive: if a higher-priority job arrives, it interrupts the current one.</li>
</ul>
<section id="what-problem-are-we-solving-22" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-22">What Problem Are We Solving?</h4>
<p>In real systems, not all jobs are equal:</p>
<ul>
<li>Some are time-critical (e.g., interrupts, real-time tasks)</li>
<li>Others are low-urgency (e.g., background jobs)</li>
</ul>
<p>We need a mechanism that reflects importance or urgency, scheduling by priority rather than by fairness or order.</p>
</section>
<section id="how-does-it-work-plain-language-22" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-22">How Does It Work (Plain Language)</h4>
<p>Each job has a priority number (higher = more urgent).</p>
<p>Algorithm steps:</p>
<ol type="1">
<li>Insert incoming jobs into a ready queue, sorted by priority.</li>
<li>Pick the job with the highest priority.</li>
<li>Run (to completion or until preempted).</li>
<li>On completion or preemption, select next highest priority.</li>
</ol>
<p>Priority may be:</p>
<ul>
<li>Static: assigned once</li>
<li>Dynamic: updated (e.g., aging, feedback)</li>
</ul>
</section>
<section id="example-walkthrough-non-preemptive-1" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-non-preemptive-1">Example Walkthrough (Non-Preemptive)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Arrival</th>
<th>Burst</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>5</td>
<td>2</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>1</td>
<td>3</td>
<td>4</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>2</td>
<td>1</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Order of selection:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: J₁ starts (only job)</li>
<li><span class="math inline">\(t=1\)</span>: J₂ arrives (priority 4 &gt; 2), but J₁ non-preemptive</li>
<li><span class="math inline">\(t=5\)</span>: J₂ (4), then J₃ (3)</li>
</ul>
<p>Execution order: J₁ → J₂ → J₃</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Start</th>
<th>Finish</th>
<th>Turnaround</th>
<th>Waiting</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>0</td>
<td>5</td>
<td>5</td>
<td>0</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>5</td>
<td>8</td>
<td>7</td>
<td>4</td>
</tr>
<tr class="odd">
<td>J₃</td>
<td>8</td>
<td>9</td>
<td>7</td>
<td>6</td>
</tr>
</tbody>
</table>
</section>
<section id="example-walkthrough-preemptive" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-preemptive">Example Walkthrough (Preemptive)</h4>
<p>Same jobs, preemptive mode:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: Run J₁ (p=2)</li>
<li><span class="math inline">\(t=1\)</span>: J₂ arrives (p=4) → preempt J₁</li>
<li><span class="math inline">\(t=1–4\)</span>: Run J₂ (done)</li>
<li><span class="math inline">\(t=4\)</span>: J₁ resumes</li>
<li><span class="math inline">\(t=5\)</span>: J₃ arrives (p=3) → preempt J₁ again</li>
<li><span class="math inline">\(t=5–6\)</span>: Run J₃</li>
<li><span class="math inline">\(t=6–9\)</span>: Finish J₁</li>
</ul>
<p>Execution order: J₁ → J₂ → J₁ → J₃ → J₁</p>
</section>
<section id="tiny-code-conceptual-simulation-14" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-14">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> burst<span class="op">,</span> priority<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Job<span class="op">;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sort_by_priority<span class="op">(</span>Job jobs<span class="op">[],</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jobs<span class="op">[</span>j<span class="op">].</span>priority <span class="op">&gt;</span> jobs<span class="op">[</span>i<span class="op">].</span>priority<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                Job t <span class="op">=</span> jobs<span class="op">[</span>i<span class="op">];</span> jobs<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> jobs<span class="op">[</span>j<span class="op">];</span> jobs<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    Job jobs<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">2</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">}};</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    sort_by_priority<span class="op">(</span>jobs<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Job </span><span class="sc">%d</span><span class="st"> (P=</span><span class="sc">%d</span><span class="st">) runs from </span><span class="sc">%d</span><span class="st"> to </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>               jobs<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> jobs<span class="op">[</span>i<span class="op">].</span>priority<span class="op">,</span> time<span class="op">,</span> time <span class="op">+</span> jobs<span class="op">[</span>i<span class="op">].</span>burst<span class="op">);</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        time <span class="op">+=</span> jobs<span class="op">[</span>i<span class="op">].</span>burst<span class="op">;</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Job 2 (P=4) runs from 0 to 3
Job 3 (P=3) runs from 3 to 4
Job 1 (P=2) runs from 4 to 9</code></pre>
</section>
<section id="why-it-matters-22" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-22">Why It Matters</h4>
<ul>
<li>Expresses urgency directly</li>
<li>Used in OS kernels, device drivers, real-time systems</li>
<li>Enables service differentiation (foreground vs background)</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Starvation possible (low-priority jobs may never run)</li>
<li>Needs aging or dynamic priorities to ensure fairness</li>
<li>Priority inversion possible (low-priority blocking high-priority)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-13" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-13">A Gentle Proof (Why It Works)</h4>
<p>Let each job <span class="math inline">\(J_i\)</span> have priority <span class="math inline">\(p_i\)</span>. The scheduler picks job <span class="math inline">\(J_k\)</span> where: <span class="math display">\[
p_k = \max_i(p_i)
\]</span></p>
<p>To ensure bounded waiting, use aging: <span class="math display">\[
p_i(t) = p_i(0) + \alpha t
\]</span> where <span class="math inline">\(\alpha\)</span> is a small increment per unit time. Eventually, every job’s priority rises enough to execute, preventing starvation.</p>
</section>
<section id="try-it-yourself-22" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-22">Try It Yourself</h4>
<ol type="1">
<li>Simulate jobs with priorities 5, 3, 1 → observe order.</li>
<li>Add aging: every time unit, increase waiting job’s priority.</li>
<li>Compare preemptive vs non-preemptive runs.</li>
<li>Add I/O-bound jobs with high priority, note responsiveness.</li>
</ol>
</section>
<section id="test-cases-22" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-22">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job Priorities</th>
<th>Mode</th>
<th>Order</th>
<th>Starvation?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>4, 3, 2</td>
<td>Non-preemptive</td>
<td>1→2→3</td>
<td>No</td>
</tr>
<tr class="even">
<td>5, 1, 1</td>
<td>Preemptive</td>
<td>1→2/3</td>
<td>Maybe</td>
</tr>
<tr class="odd">
<td>Aging on</td>
<td>Preemptive</td>
<td>Fair rotation</td>
<td>No</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-22" class="level4">
<h4 class="anchored" data-anchor-id="complexity-22">Complexity</h4>
<ul>
<li>Sorting-based: <span class="math inline">\(O(n \log n)\)</span> per scheduling decision</li>
<li>Dynamic aging: <span class="math inline">\(O(n)\)</span> update per tick</li>
<li>Preemption overhead: depends on frequency</li>
</ul>
<p>Priority Scheduling is the executive scheduler, giving the CPU to whoever shouts loudest. It’s powerful but political: without aging, the quiet ones might never be heard.</p>
</section>
</section>
<section id="multilevel-queue-scheduling" class="level3">
<h3 class="anchored" data-anchor-id="multilevel-queue-scheduling">825 Multilevel Queue Scheduling</h3>
<p>Multilevel Queue Scheduling divides the ready queue into multiple sub-queues, each dedicated to a class of processes, for example, system, interactive, batch, or background. Each queue has its own scheduling policy, and queues themselves are scheduled using fixed priorities or time slices.</p>
<p>This design mirrors real operating systems, where not all processes are equal, some need immediate attention (like keyboard interrupts), while others can wait (like backups).</p>
<section id="what-problem-are-we-solving-23" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-23">What Problem Are We Solving?</h4>
<p>In a single-queue scheduler (like FCFS or RR), all processes compete together. But real systems need differentiation:</p>
<ul>
<li>Foreground (interactive) jobs need fast response.</li>
<li>Background (batch) jobs need throughput.</li>
<li>System tasks need instant service.</li>
</ul>
<p>Multilevel queues solve this by classification + specialization:</p>
<ul>
<li>Different job types → different queues</li>
<li>Different queues → different policies</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-23" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-23">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Partition processes into distinct categories (e.g., system, interactive, batch).</p></li>
<li><p>Assign each category to a queue.</p></li>
<li><p>Each queue has its own scheduling algorithm (RR, FCFS, SJF, etc.).</p></li>
<li><p>Queue selection policy:</p>
<ul>
<li>Fixed priority: higher queue always served first.</li>
<li>Time slicing: share CPU between queues (e.g., 80% user, 20% background).</li>
</ul></li>
</ol>
</section>
<section id="example-queue-setup" class="level4">
<h4 class="anchored" data-anchor-id="example-queue-setup">Example Queue Setup</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Queue</th>
<th>Type</th>
<th>Policy</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Q₁</td>
<td>System</td>
<td>FCFS</td>
<td>1 (highest)</td>
</tr>
<tr class="even">
<td>Q₂</td>
<td>Interactive</td>
<td>RR</td>
<td>2</td>
</tr>
<tr class="odd">
<td>Q₃</td>
<td>Batch</td>
<td>SJF</td>
<td>3 (lowest)</td>
</tr>
</tbody>
</table>
<p>CPU selection order:</p>
<ol type="1">
<li>Always check Q₁ first.</li>
<li>If empty, check Q₂.</li>
<li>If Q₂ empty, check Q₃.</li>
</ol>
<p>Each queue runs its own local scheduler independently.</p>
</section>
<section id="example-walkthrough-17" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-17">Example Walkthrough</h4>
<p>Suppose:</p>
<ul>
<li>Q₁: System → J₁(3), J₂(2)</li>
<li>Q₂: Interactive → J₃(4), J₄(3)</li>
<li>Q₃: Batch → J₅(6)</li>
</ul>
<p>Fixed-priority scheme:</p>
<ul>
<li>Run all Q₁ jobs (J₁, J₂) first (FCFS)</li>
<li>Then Q₂ jobs (RR)</li>
<li>Finally Q₃ (SJF)</li>
</ul>
<p>Result: System responsiveness guaranteed, background delayed.</p>
<p>Time-slice scheme (e.g., 50%-30%-20%):</p>
<ul>
<li>Q₁ gets 50% CPU, Q₂ 30%, Q₃ 20%</li>
<li>Scheduler rotates between queues proportionally</li>
</ul>
</section>
<section id="tiny-code-conceptual-simulation-15" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-15">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> burst<span class="op">,</span> queue<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Job<span class="op">;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> run_queue<span class="op">(</span>Job jobs<span class="op">[],</span> <span class="dt">int</span> n<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Running </span><span class="sc">%s</span><span class="st"> queue:</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"  Job </span><span class="sc">%d</span><span class="st"> (burst=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> jobs<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> jobs<span class="op">[</span>i<span class="op">].</span>burst<span class="op">);</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    Job sys<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">}};</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    Job inter<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">2</span><span class="op">},</span> <span class="op">{</span><span class="dv">4</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">}};</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    Job batch<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">3</span><span class="op">}};</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    run_queue<span class="op">(</span>sys<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"System (FCFS)"</span><span class="op">);</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    run_queue<span class="op">(</span>inter<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"Interactive (RR)"</span><span class="op">);</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    run_queue<span class="op">(</span>batch<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"Batch (SJF)"</span><span class="op">);</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Running System (FCFS):
  Job 1 (burst=3)
  Job 2 (burst=2)
Running Interactive (RR):
  Job 3 (burst=4)
  Job 4 (burst=3)
Running Batch (SJF):
  Job 5 (burst=6)</code></pre>
</section>
<section id="why-it-matters-23" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-23">Why It Matters</h4>
<ul>
<li>Supports job differentiation (system vs user vs batch)</li>
<li>Combines multiple policies for hybrid workloads</li>
<li>Predictable service for high-priority queues</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Rigid separation: processes can’t move between queues</li>
<li>Starvation: lower queues may never run (in fixed priority)</li>
<li>Complex tuning: balancing queue shares requires care</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-14" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-14">A Gentle Proof (Why It Works)</h4>
<p>Let queues <span class="math inline">\(Q_1, Q_2, \ldots, Q_k\)</span> with priorities <span class="math inline">\(P_1 &gt; P_2 &gt; \ldots &gt; P_k\)</span>.</p>
<p>For fixed priority:</p>
<ul>
<li>CPU always serves the non-empty queue with highest <span class="math inline">\(P_i\)</span>.</li>
<li>Thus, system tasks (higher <span class="math inline">\(P_i\)</span>) never blocked by user tasks.</li>
</ul>
<p>For time slicing:</p>
<ul>
<li>Each queue gets CPU share <span class="math inline">\(s_i\)</span>, with <span class="math inline">\(\sum s_i = 1\)</span>.</li>
<li>Over time <span class="math inline">\(T\)</span>, each queue executes for <span class="math inline">\(s_i T\)</span>, ensuring fair allocation across classes.</li>
</ul>
<p>This ensures bounded delay and deterministic control.</p>
</section>
<section id="try-it-yourself-23" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-23">Try It Yourself</h4>
<ol type="1">
<li>Create 3 queues: System (FCFS), Interactive (RR), Batch (SJF).</li>
<li>Simulate fixed-priority vs time-slice scheduling.</li>
<li>Add a long-running batch job → observe starvation.</li>
<li>Switch to time-slice → compare fairness.</li>
<li>Experiment with different share ratios.</li>
</ol>
</section>
<section id="test-cases-23" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-23">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Queues</th>
<th>Policy</th>
<th>Mode</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>FCFS, RR</td>
<td>Fixed priority</td>
<td>Fast system jobs</td>
</tr>
<tr class="even">
<td>3</td>
<td>FCFS, RR, SJF</td>
<td>Time-slice</td>
<td>Balanced fairness</td>
</tr>
<tr class="odd">
<td>2</td>
<td>RR, SJF</td>
<td>Fixed priority</td>
<td>Starvation risk</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-23" class="level4">
<h4 class="anchored" data-anchor-id="complexity-23">Complexity</h4>
<ul>
<li>Scheduling: <span class="math inline">\(O(k)\)</span> (choose queue) + local queue policy</li>
<li>Space: <span class="math inline">\(O(\sum n_i)\)</span> (total jobs across queues)</li>
</ul>
<p>Multilevel Queue Scheduling is like a tiered city, express lanes for the urgent, side streets for the steady. Each level runs by its own rhythm, but the mayor (scheduler) decides who gets the CPU next.</p>
</section>
</section>
<section id="earliest-deadline-first-edf" class="level3">
<h3 class="anchored" data-anchor-id="earliest-deadline-first-edf">826 Earliest Deadline First (EDF)</h3>
<p>Earliest Deadline First (EDF) is a dynamic priority scheduling algorithm used primarily in real-time systems. At any scheduling decision point, it picks the task with the closest deadline. If a new task arrives with an earlier deadline, it can preempt the current one.</p>
<p>EDF is optimal for single-processor real-time systems, if a feasible schedule exists, EDF will find it.</p>
<section id="what-problem-are-we-solving-24" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-24">What Problem Are We Solving?</h4>
<p>In real-time systems, timing is everything, missing a deadline can mean failure (e.g., missed sensor reading or delayed control signal).</p>
<p>We need a scheduling policy that:</p>
<ul>
<li>Always meets deadlines (if possible)</li>
<li>Adapts to dynamic task arrivals</li>
<li>Ensures predictability under time constraints</li>
</ul>
<p>EDF achieves this by making the most urgent task run first, urgency measured by deadline proximity.</p>
</section>
<section id="how-does-it-work-plain-language-24" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-24">How Does It Work (Plain Language)</h4>
<p>Each task <span class="math inline">\(T_i\)</span> has:</p>
<ul>
<li>Execution time: <span class="math inline">\(C_i\)</span></li>
<li>Period (or arrival time): <span class="math inline">\(P_i\)</span></li>
<li>Absolute deadline: <span class="math inline">\(D_i\)</span></li>
</ul>
<p>At each moment:</p>
<ol type="1">
<li>Collect all ready tasks.</li>
<li>Select the one with the earliest deadline.</li>
<li>Run it (preempt if another task arrives with an earlier <span class="math inline">\(D_i\)</span>).</li>
<li>Repeat as new tasks arrive.</li>
</ol>
<p>The CPU always runs the most urgent task first.</p>
</section>
<section id="example-walkthrough-18" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-18">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Task</th>
<th>Arrival</th>
<th>Exec Time (<span class="math inline">\(C\)</span>)</th>
<th>Deadline (<span class="math inline">\(D\)</span>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T₁</td>
<td>0</td>
<td>2</td>
<td>5</td>
</tr>
<tr class="even">
<td>T₂</td>
<td>1</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="odd">
<td>T₃</td>
<td>2</td>
<td>2</td>
<td>7</td>
</tr>
</tbody>
</table>
<p>Timeline:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: T₁ ready (D=5) → run T₁</li>
<li><span class="math inline">\(t=1\)</span>: T₂ arrives (D=3 &lt; 5) → preempt T₁, run T₂</li>
<li><span class="math inline">\(t=2\)</span>: T₂ finishes → resume T₁</li>
<li><span class="math inline">\(t=4\)</span>: T₁ done → run T₃</li>
</ul>
<p>Execution order: T₁ (0–1), T₂ (1–2), T₁ (2–4), T₃ (4–6)</p>
<p>All deadlines met ✅</p>
</section>
<section id="feasibility-condition" class="level4">
<h4 class="anchored" data-anchor-id="feasibility-condition">Feasibility Condition</h4>
<p>For periodic tasks with execution time <span class="math inline">\(C_i\)</span> and period <span class="math inline">\(P_i\)</span>:</p>
<p><span class="math display">\[
U = \sum_{i=1}^{n} \frac{C_i}{P_i}
\]</span></p>
<p>EDF guarantees all deadlines if:</p>
<p><span class="math display">\[
U \le 1
\]</span></p>
<p>That is, total CPU utilization ≤ 100%.</p>
</section>
<section id="tiny-code-conceptual-simulation-16" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-16">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> exec<span class="op">,</span> deadline<span class="op">;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Task<span class="op">;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> edf<span class="op">(</span>Task t<span class="op">[],</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> min <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>t<span class="op">[</span>i<span class="op">].</span>deadline <span class="op">&lt;</span> t<span class="op">[</span>min<span class="op">].</span>deadline<span class="op">)</span> min <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Time </span><span class="sc">%d</span><span class="st">–</span><span class="sc">%d</span><span class="st">: Task </span><span class="sc">%d</span><span class="st"> (D=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>               time<span class="op">,</span> time <span class="op">+</span> t<span class="op">[</span>min<span class="op">].</span>exec<span class="op">,</span> t<span class="op">[</span>min<span class="op">].</span>id<span class="op">,</span> t<span class="op">[</span>min<span class="op">].</span>deadline<span class="op">);</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        time <span class="op">+=</span> t<span class="op">[</span>min<span class="op">].</span>exec<span class="op">;</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> min<span class="op">;</span> j <span class="op">&lt;</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> j<span class="op">++)</span> t<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> t<span class="op">[</span>j <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        n<span class="op">--;</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    Task tasks<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">7</span><span class="op">}};</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    edf<span class="op">(</span>tasks<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Time 0–1: Task 2 (D=3)
Time 1–3: Task 1 (D=5)
Time 3–5: Task 3 (D=7)</code></pre>
</section>
<section id="why-it-matters-24" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-24">Why It Matters</h4>
<ul>
<li>Optimal for single CPU, meets all deadlines if feasible</li>
<li>Dynamic priority: adapts as deadlines approach</li>
<li>Widely used in real-time OS and embedded systems</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Overhead: frequent priority updates and preemptions</li>
<li>Needs accurate deadlines and execution times</li>
<li>Can thrash under overload (misses multiple deadlines)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-15" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-15">A Gentle Proof (Why It Works)</h4>
<p>Suppose EDF fails to meet a deadline while a feasible schedule exists. Then at the missed deadline <span class="math inline">\(D_i\)</span>, some task <span class="math inline">\(T_j\)</span> with <span class="math inline">\(D_j &gt; D_i\)</span> must have run instead. Swapping their execution order would bring <span class="math inline">\(T_i\)</span> earlier without delaying <span class="math inline">\(T_j\)</span> past <span class="math inline">\(D_j\)</span>, contradicting optimality.</p>
<p>Hence, EDF always finds a feasible schedule if one exists.</p>
<p>Feasibility: <span class="math display">\[
\sum_{i=1}^{n} \frac{C_i}{P_i} \le 1 \implies \text{All deadlines met.}
\]</span></p>
</section>
<section id="try-it-yourself-24" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-24">Try It Yourself</h4>
<ol type="1">
<li>Create 3 tasks with <span class="math inline">\((C, D)\)</span> = (2, 5), (1, 3), (2, 7).</li>
<li>Run EDF, draw Gantt chart.</li>
<li>Add overload: <span class="math inline">\((C, D)\)</span> = (3, 4), (3, 5).</li>
<li>Observe missed deadlines if <span class="math inline">\(U &gt; 1\)</span>.</li>
<li>Compare with Rate Monotonic (RMS).</li>
</ol>
</section>
<section id="test-cases-24" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-24">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 15%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th>Tasks</th>
<th><span class="math inline">\(C_i\)</span></th>
<th><span class="math inline">\(D_i\)</span></th>
<th><span class="math inline">\(U\)</span></th>
<th>Feasible?</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>(2,5),(1,3),(2,7)</td>
<td>–</td>
<td>–</td>
<td>0.9</td>
<td>✅</td>
<td>All deadlines met</td>
</tr>
<tr class="even">
<td>(3,4),(3,5)</td>
<td>–</td>
<td>–</td>
<td>1.35</td>
<td>❌</td>
<td>Deadline miss</td>
</tr>
<tr class="odd">
<td>(1,4),(1,5),(2,10)</td>
<td>–</td>
<td>–</td>
<td>0.9</td>
<td>✅</td>
<td>Feasible</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-24" class="level4">
<h4 class="anchored" data-anchor-id="complexity-24">Complexity</h4>
<ul>
<li>Scheduling decision: <span class="math inline">\(O(n)\)</span> per step</li>
<li>Preemption cost: high (dynamic)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> task list</li>
</ul>
<p>EDF is the watchmaker of schedulers, always attending to the next ticking clock. When tasks have precise deadlines, it’s the most reliable guide to keep every second in order.</p>
</section>
</section>
<section id="rate-monotonic-scheduling-rms" class="level3">
<h3 class="anchored" data-anchor-id="rate-monotonic-scheduling-rms">827 Rate Monotonic Scheduling (RMS)</h3>
<p>Rate Monotonic Scheduling (RMS) is a fixed-priority real-time scheduling algorithm. It assigns priorities based on task frequency (rate): the shorter the period, the higher the priority. RMS is optimal among all fixed-priority schedulers, if a set of periodic tasks cannot be scheduled by RMS, no other fixed-priority policy can do better.</p>
<section id="what-problem-are-we-solving-25" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-25">What Problem Are We Solving?</h4>
<p>In real-time systems, tasks repeat periodically and must finish before their deadlines. We need a static, predictable scheduler with:</p>
<ul>
<li>Low runtime overhead (fixed priorities)</li>
<li>Deterministic timing</li>
<li>Guaranteed feasibility under certain CPU loads</li>
</ul>
<p>EDF (dynamic) is optimal but costly to maintain. RMS trades a bit of flexibility for simplicity and determinism.</p>
</section>
<section id="how-does-it-work-plain-language-25" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-25">How Does It Work (Plain Language)</h4>
<p>Each periodic task <span class="math inline">\(T_i\)</span> is characterized by:</p>
<ul>
<li>Period <span class="math inline">\(P_i\)</span> (interval between releases)</li>
<li>Computation time <span class="math inline">\(C_i\)</span> (execution per cycle)</li>
<li>Deadline = end of period (<span class="math inline">\(D_i = P_i\)</span>)</li>
</ul>
<p>RMS rule:</p>
<blockquote class="blockquote">
<p>Assign higher priority to the task with smaller <span class="math inline">\(P_i\)</span> (higher frequency).</p>
</blockquote>
<p>Scheduler steps:</p>
<ol type="1">
<li>Sort all tasks by increasing period (shorter = higher priority).</li>
<li>Run the highest-priority ready task.</li>
<li>Preempt lower ones if necessary.</li>
<li>Repeat every cycle.</li>
</ol>
</section>
<section id="example-walkthrough-19" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-19">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Task</th>
<th>Execution <span class="math inline">\(C_i\)</span></th>
<th>Period <span class="math inline">\(P_i\)</span></th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T₁</td>
<td>1</td>
<td>4</td>
<td>High</td>
</tr>
<tr class="even">
<td>T₂</td>
<td>2</td>
<td>5</td>
<td>Medium</td>
</tr>
<tr class="odd">
<td>T₃</td>
<td>3</td>
<td>10</td>
<td>Low</td>
</tr>
</tbody>
</table>
<p>Timeline:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: Run T₁ (1 unit)</li>
<li><span class="math inline">\(t=1\)</span>: Run T₂ (2 units)</li>
<li><span class="math inline">\(t=3\)</span>: Run T₃ (3 units)</li>
<li><span class="math inline">\(t=4\)</span>: T₁ releases again → preempts T₃</li>
</ul>
<p>The CPU always picks the highest-frequency ready task.</p>
</section>
<section id="utilization-bound-feasibility-test" class="level4">
<h4 class="anchored" data-anchor-id="utilization-bound-feasibility-test">Utilization Bound (Feasibility Test)</h4>
<p>For <span class="math inline">\(n\)</span> periodic tasks with periods <span class="math inline">\(P_i\)</span> and execution times <span class="math inline">\(C_i\)</span>, RMS guarantees all deadlines if total utilization:</p>
<p><span class="math display">\[
U = \sum_{i=1}^{n} \frac{C_i}{P_i} \le n \cdot (2^{1/n} - 1)
\]</span></p>
<p>As <span class="math inline">\(n \to \infty\)</span>, <span class="math display">\[
U \to \ln 2 \approx 0.693
\]</span></p>
<p>So up to 69.3% CPU utilization is guaranteed safe. Above that, schedulability depends on specific task alignment.</p>
</section>
<section id="example" class="level4">
<h4 class="anchored" data-anchor-id="example">Example</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Task</th>
<th><span class="math inline">\(C_i\)</span></th>
<th><span class="math inline">\(P_i\)</span></th>
<th><span class="math inline">\(C_i / P_i\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T₁</td>
<td>1</td>
<td>4</td>
<td>0.25</td>
</tr>
<tr class="even">
<td>T₂</td>
<td>1</td>
<td>5</td>
<td>0.20</td>
</tr>
<tr class="odd">
<td>T₃</td>
<td>2</td>
<td>10</td>
<td>0.20</td>
</tr>
</tbody>
</table>
<p><span class="math display">\[
U = 0.25 + 0.2 + 0.2 = 0.65 \le 3(2^{1/3}-1) \approx 0.78
\]</span></p>
<p>✅ Feasible under RMS</p>
</section>
<section id="tiny-code-conceptual-simulation-17" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-17">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> exec<span class="op">,</span> period<span class="op">,</span> remaining<span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Task<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    Task tasks<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">2</span><span class="op">}};</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> end <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>time <span class="op">&lt;</span> end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> sel <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>time <span class="op">%</span> tasks<span class="op">[</span>i<span class="op">].</span>period <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>                tasks<span class="op">[</span>i<span class="op">].</span>remaining <span class="op">=</span> tasks<span class="op">[</span>i<span class="op">].</span>exec<span class="op">;</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>tasks<span class="op">[</span>i<span class="op">].</span>remaining <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>sel <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">||</span> tasks<span class="op">[</span>i<span class="op">].</span>period <span class="op">&lt;</span> tasks<span class="op">[</span>sel<span class="op">].</span>period<span class="op">))</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>                sel <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sel <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"t=</span><span class="sc">%d</span><span class="st">: Run T</span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> time<span class="op">,</span> tasks<span class="op">[</span>sel<span class="op">].</span>id<span class="op">);</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>            tasks<span class="op">[</span>sel<span class="op">].</span>remaining<span class="op">--;</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> printf<span class="op">(</span><span class="st">"t=</span><span class="sc">%d</span><span class="st">: Idle</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> time<span class="op">);</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        time<span class="op">++;</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (excerpt):</p>
<pre><code>t=0: Run T1
t=1: Run T2
t=2: Run T2
t=3: Run T3
t=4: Run T1
...</code></pre>
</section>
<section id="why-it-matters-25" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-25">Why It Matters</h4>
<ul>
<li>Fixed-priority = simple, predictable</li>
<li>Provably optimal among fixed-priority schedulers</li>
<li>Used in RTOS, embedded control loops, avionics</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Static priorities → less flexible than EDF</li>
<li>Utilization bound &lt; 100% → may leave idle CPU</li>
<li>Overload can cause deadline misses for low-priority tasks</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-16" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-16">A Gentle Proof (Why It Works)</h4>
<p>For tasks with harmonic periods (<span class="math inline">\(P_i\)</span> divides <span class="math inline">\(P_j\)</span>), <span class="math display">\[
U = \sum_{i=1}^{n} \frac{C_i}{P_i} \le 1
\]</span> is both necessary and sufficient.</p>
<p>In general:</p>
<ul>
<li>If <span class="math inline">\(U \le n(2^{1/n}-1)\)</span> → RMS guarantees deadlines.</li>
<li>Else, may still be feasible (but not guaranteed).</li>
</ul>
<p>Proof sketch:</p>
<blockquote class="blockquote">
<p>Any deadline miss implies a lower-priority task delayed a higher-priority one, impossible in RMS, as higher-priority tasks always preempt.</p>
</blockquote>
<p>Thus RMS is optimal among fixed-priority schedulers.</p>
</section>
<section id="try-it-yourself-25" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-25">Try It Yourself</h4>
<ol type="1">
<li>Create tasks: <span class="math inline">\((C,P) = (1,4),(1,5),(2,10)\)</span> → check feasibility.</li>
<li>Increase <span class="math inline">\(C_3\)</span> to 3 → recompute <span class="math inline">\(U\)</span>, observe miss.</li>
<li>Compare RMS vs EDF on same set.</li>
<li>Add harmonic tasks (<span class="math inline">\(P_2 = 2P_1\)</span>) → easier scheduling.</li>
</ol>
</section>
<section id="test-cases-25" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-25">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Tasks</th>
<th><span class="math inline">\(U\)</span></th>
<th>Bound</th>
<th>Feasible?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>(1,4),(1,5),(2,10)</td>
<td>0.65</td>
<td>0.78</td>
<td>✅</td>
</tr>
<tr class="even">
<td>(2,5),(2,7),(2,10)</td>
<td>0.86</td>
<td>0.78</td>
<td>⚠️ Possibly</td>
</tr>
<tr class="odd">
<td>(1,4),(2,5),(3,10)</td>
<td>0.95</td>
<td>0.78</td>
<td>❌ Likely miss</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-25" class="level4">
<h4 class="anchored" data-anchor-id="complexity-25">Complexity</h4>
<ul>
<li>Decision time: <span class="math inline">\(O(n)\)</span> (pick smallest <span class="math inline">\(P_i\)</span> ready)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> task table</li>
<li>Overhead: low (static priorities)</li>
</ul>
<p>RMS is the metronome of real-time scheduling, simple, rhythmic, and fixed. Each task knows its place, and the CPU dances to the beat of their periods.</p>
</section>
</section>
<section id="lottery-scheduling" class="level3">
<h3 class="anchored" data-anchor-id="lottery-scheduling">828 Lottery Scheduling</h3>
<p>Lottery Scheduling introduces probabilistic fairness into CPU scheduling. Each process holds a certain number of tickets, and at every scheduling decision, the scheduler randomly draws one ticket, the owner gets the CPU. Over time, the proportion of CPU time each process receives approximates its ticket share.</p>
<p>It’s like holding a lottery for CPU time: more tickets → more chances to win → more CPU time.</p>
<section id="what-problem-are-we-solving-26" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-26">What Problem Are We Solving?</h4>
<p>Traditional schedulers (like FCFS or Priority) are deterministic, but rigid. They can cause:</p>
<ul>
<li>Starvation of low-priority processes</li>
<li>Poor adaptability when workloads change</li>
<li>Static allocation (hard to adjust dynamically)</li>
</ul>
<p>Lottery Scheduling offers:</p>
<ul>
<li>Fairness in the long run</li>
<li>Dynamic adjustability (change ticket counts anytime)</li>
<li>Proportional sharing across processes</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-26" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-26">How Does It Work (Plain Language)</h4>
<p>Each process <span class="math inline">\(P_i\)</span> holds <span class="math inline">\(t_i\)</span> tickets. The total pool is <span class="math inline">\(T = \sum_i t_i\)</span>.</p>
<p>At each scheduling step:</p>
<ol type="1">
<li>Draw a random number <span class="math inline">\(r \in [1, T]\)</span>.</li>
<li>Find the process whose cumulative ticket range includes <span class="math inline">\(r\)</span>.</li>
<li>Run that process for one quantum.</li>
<li>Repeat.</li>
</ol>
<p>Over many draws, process <span class="math inline">\(P_i\)</span> runs approximately:</p>
<p><span class="math display">\[
\text{Fraction of time} = \frac{t_i}{T}
\]</span></p>
<p>Thus, the expected CPU share is proportional to its ticket count.</p>
</section>
<section id="example-walkthrough-20" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-20">Example Walkthrough</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Process</th>
<th>Tickets</th>
<th>Expected Share</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>P₁</td>
<td>50</td>
<td>50%</td>
</tr>
<tr class="even">
<td>P₂</td>
<td>30</td>
<td>30%</td>
</tr>
<tr class="odd">
<td>P₃</td>
<td>20</td>
<td>20%</td>
</tr>
</tbody>
</table>
<p>Over 1000 quanta:</p>
<ul>
<li>P₁ runs ≈ 500 times</li>
<li>P₂ runs ≈ 300 times</li>
<li>P₃ runs ≈ 200 times</li>
</ul>
<p>Small variations occur (random), but long-term fairness holds.</p>
</section>
<section id="example-ticket-ranges" class="level4">
<h4 class="anchored" data-anchor-id="example-ticket-ranges">Example Ticket Ranges</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Process</th>
<th>Tickets</th>
<th>Range</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>P₁</td>
<td>50</td>
<td>1–50</td>
</tr>
<tr class="even">
<td>P₂</td>
<td>30</td>
<td>51–80</td>
</tr>
<tr class="odd">
<td>P₃</td>
<td>20</td>
<td>81–100</td>
</tr>
</tbody>
</table>
<p>If <span class="math inline">\(r = 73\)</span> → P₂ wins If <span class="math inline">\(r = 12\)</span> → P₁ wins If <span class="math inline">\(r = 95\)</span> → P₃ wins</p>
</section>
<section id="tiny-code-conceptual-simulation-18" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-18">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> tickets<span class="op">;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Proc<span class="op">;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> pick_winner<span class="op">(</span>Proc p<span class="op">[],</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> total <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> total <span class="op">+=</span> p<span class="op">[</span>i<span class="op">].</span>tickets<span class="op">;</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> draw <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> total <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        sum <span class="op">+=</span> p<span class="op">[</span>i<span class="op">].</span>tickets<span class="op">;</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>draw <span class="op">&lt;=</span> sum<span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    srand<span class="op">(</span>time<span class="op">(</span>NULL<span class="op">));</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    Proc p<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">50</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">30</span><span class="op">},</span> <span class="op">{</span><span class="dv">3</span><span class="op">,</span> <span class="dv">20</span><span class="op">}};</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> w <span class="op">=</span> pick_winner<span class="op">(</span>p<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Quantum </span><span class="sc">%d</span><span class="st">: Process </span><span class="sc">%d</span><span class="st"> runs</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> p<span class="op">[</span>w<span class="op">].</span>id<span class="op">);</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (sample):</p>
<pre><code>Quantum 1: Process 1 runs
Quantum 2: Process 2 runs
Quantum 3: Process 1 runs
Quantum 4: Process 3 runs
...</code></pre>
</section>
<section id="why-it-matters-26" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-26">Why It Matters</h4>
<ul>
<li>Proportional fairness: share CPU by weight</li>
<li>Dynamic control: just adjust ticket counts</li>
<li>Starvation-free: everyone gets some chance</li>
<li>Simple to implement probabilistically</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Approximate fairness: not exact short-term</li>
<li>Randomness: unpredictable at small scale</li>
<li>Overhead: random number generation, cumulative scan</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-17" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-17">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(t_i\)</span> be tickets for process <span class="math inline">\(i\)</span>, and <span class="math inline">\(T\)</span> be total tickets. Each draw is uniformly random over <span class="math inline">\([1, T]\)</span>.</p>
<p>Probability <span class="math inline">\(P_i\)</span> wins: <span class="math display">\[
P(\text{win}_i) = \frac{t_i}{T}
\]</span></p>
<p>Over <span class="math inline">\(N\)</span> quanta, expected wins: <span class="math display">\[
E[\text{runs}_i] = N \cdot \frac{t_i}{T}
\]</span></p>
<p>By the Law of Large Numbers, actual runs converge to <span class="math inline">\(E[\text{runs}_i]\)</span> as <span class="math inline">\(N \to \infty\)</span>: <span class="math display">\[
\frac{\text{runs}_i}{N} \to \frac{t_i}{T}
\]</span></p>
<p>Thus, long-term proportional fairness is guaranteed.</p>
</section>
<section id="try-it-yourself-26" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-26">Try It Yourself</h4>
<ol type="1">
<li>Assign tickets: (50, 30, 20). Run 100 quanta, measure distribution.</li>
<li>Increase P₃’s tickets, see its share rise.</li>
<li>Remove tickets mid-run, process disappears.</li>
<li>Combine with compensation tickets for I/O-bound jobs.</li>
<li>Compare with Round Robin (equal tickets).</li>
</ol>
</section>
<section id="test-cases-26" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-26">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Processes</th>
<th>Tickets</th>
<th>Expected Ratio</th>
<th>Observed (approx)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>(50, 30, 20)</td>
<td>100</td>
<td>5:3:2</td>
<td>502:303:195</td>
</tr>
<tr class="even">
<td>(1, 1, 1)</td>
<td>3</td>
<td>1:1:1</td>
<td>~Equal</td>
</tr>
<tr class="odd">
<td>(90, 10)</td>
<td>2</td>
<td>9:1</td>
<td>~9:1</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-26" class="level4">
<h4 class="anchored" data-anchor-id="complexity-26">Complexity</h4>
<ul>
<li>Draw: <span class="math inline">\(O(n)\)</span> (linear scan) or <span class="math inline">\(O(\log n)\)</span> (tree)</li>
<li>Space: <span class="math inline">\(O(n)\)</span></li>
<li>Overhead: small per quantum</li>
</ul>
<p>Lottery Scheduling is the casino of schedulers, fair in the long run, playful in the short run. Instead of rigid rules, it trusts probability to balance the load, giving everyone a ticket, and a chance.</p>
</section>
</section>
<section id="multilevel-feedback-queue-mlfq" class="level3">
<h3 class="anchored" data-anchor-id="multilevel-feedback-queue-mlfq">829 Multilevel Feedback Queue (MLFQ)</h3>
<p>Multilevel Feedback Queue (MLFQ) is one of the most flexible and adaptive CPU scheduling algorithms. Unlike Multilevel Queue Scheduling (where a process is stuck in one queue), MLFQ allows processes to move between queues, gaining or losing priority based on observed behavior.</p>
<p>It blends priority scheduling, Round Robin, and feedback adaptation, rewarding interactive jobs with fast service and demoting CPU-hungry jobs.</p>
<section id="what-problem-are-we-solving-27" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-27">What Problem Are We Solving?</h4>
<p>In real-world systems, processes vary:</p>
<ul>
<li>Some are interactive (short bursts, frequent I/O)</li>
<li>Others are CPU-bound (long computations)</li>
</ul>
<p>We don’t always know this beforehand. MLFQ learns dynamically:</p>
<ul>
<li>If a process uses too much CPU → lower priority</li>
<li>If a process frequently yields (I/O-bound) → higher priority</li>
</ul>
<p>Thus, MLFQ adapts automatically, achieving a balance between responsiveness and throughput.</p>
</section>
<section id="how-does-it-work-plain-language-27" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-27">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Maintain multiple ready queues, each with different priority levels.</li>
<li>Each queue has its own time quantum (higher priority → shorter quantum).</li>
<li>A new job enters the top queue.</li>
<li>If it uses its whole quantum → demote to a lower queue.</li>
<li>If it yields early (I/O wait) → stay or promote.</li>
<li>Always schedule from the highest non-empty queue.</li>
<li>Periodically reset all processes to the top (aging).</li>
</ol>
</section>
<section id="example-setup" class="level4">
<h4 class="anchored" data-anchor-id="example-setup">Example Setup</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Queue</th>
<th>Priority</th>
<th>Time Quantum</th>
<th>Policy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Q₁</td>
<td>High</td>
<td>1 unit</td>
<td>RR</td>
</tr>
<tr class="even">
<td>Q₂</td>
<td>Medium</td>
<td>2 units</td>
<td>RR</td>
</tr>
<tr class="odd">
<td>Q₃</td>
<td>Low</td>
<td>4 units</td>
<td>FCFS</td>
</tr>
</tbody>
</table>
<p>Rules:</p>
<ul>
<li>Always prefer Q₁ over Q₂, Q₂ over Q₃.</li>
<li>Use time slice = quantum of current queue.</li>
<li>If process finishes early → stays.</li>
<li>If uses full quantum → demote.</li>
</ul>
</section>
<section id="example-walkthrough-21" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-21">Example Walkthrough</h4>
<p>Jobs:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Job</th>
<th>Burst</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J₁</td>
<td>8</td>
<td>CPU-bound</td>
</tr>
<tr class="even">
<td>J₂</td>
<td>2</td>
<td>I/O-bound</td>
</tr>
</tbody>
</table>
<p>Timeline:</p>
<ul>
<li><span class="math inline">\(t=0\)</span>: J₁ (Q₁, quantum 1) → uses full → demote to Q₂</li>
<li><span class="math inline">\(t=1\)</span>: J₂ (Q₁, quantum 1) → yields early → stays</li>
<li><span class="math inline">\(t=2\)</span>: J₂ (Q₁) → finishes</li>
<li><span class="math inline">\(t=3\)</span>: J₁ (Q₂, quantum 2) → uses full → demote to Q₃</li>
<li><span class="math inline">\(t=5\)</span>: J₁ (Q₃, FCFS) → finish</li>
</ul>
<p>Outcome:</p>
<ul>
<li>J₂ (interactive) finishes fast</li>
<li>J₁ (CPU-bound) gets fair share, lower priority</li>
</ul>
</section>
<section id="tiny-code-conceptual-simulation-19" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-19">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id<span class="op">,</span> burst<span class="op">,</span> queue<span class="op">;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Job<span class="op">;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    Job jobs<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">}};</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> time <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>jobs<span class="op">[</span><span class="dv">0</span><span class="op">].</span>burst <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> jobs<span class="op">[</span><span class="dv">1</span><span class="op">].</span>burst <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">2</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jobs<span class="op">[</span>i<span class="op">].</span>burst <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> q <span class="op">=</span> jobs<span class="op">[</span>i<span class="op">].</span>queue<span class="op">;</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> quantum <span class="op">=</span> <span class="op">(</span>q <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">(</span>q <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">?</span> <span class="dv">2</span> <span class="op">:</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> run <span class="op">=</span> jobs<span class="op">[</span>i<span class="op">].</span>burst <span class="op">&lt;</span> quantum <span class="op">?</span> jobs<span class="op">[</span>i<span class="op">].</span>burst <span class="op">:</span> quantum<span class="op">;</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"t=</span><span class="sc">%d</span><span class="st">: Job </span><span class="sc">%d</span><span class="st"> (Q</span><span class="sc">%d</span><span class="st">) runs for </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>                   time<span class="op">,</span> jobs<span class="op">[</span>i<span class="op">].</span>id<span class="op">,</span> q<span class="op">,</span> run<span class="op">);</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>            time <span class="op">+=</span> run<span class="op">;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>            jobs<span class="op">[</span>i<span class="op">].</span>burst <span class="op">-=</span> run<span class="op">;</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>jobs<span class="op">[</span>i<span class="op">].</span>burst <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> run <span class="op">==</span> quantum <span class="op">&amp;&amp;</span> q <span class="op">&lt;</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>                jobs<span class="op">[</span>i<span class="op">].</span>queue<span class="op">++;</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>t=0: Job 1 (Q1) runs for 1
t=1: Job 2 (Q1) runs for 1
t=2: Job 2 (Q1) runs for 1
t=3: Job 1 (Q2) runs for 2
t=5: Job 1 (Q3) runs for 4
t=9: Job 1 (Q3) runs for 1</code></pre>
</section>
<section id="why-it-matters-27" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-27">Why It Matters</h4>
<ul>
<li>Adaptive: no need to know job lengths ahead of time</li>
<li>Fairness: all jobs eventually get CPU time</li>
<li>Responsiveness: favors short and I/O-bound tasks</li>
<li>Widely used: foundation of UNIX and modern OS schedulers</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Complex tuning: many parameters (quanta, queues)</li>
<li>Overhead: managing promotions/demotions</li>
<li>Starvation risk: if not periodically boosted</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-18" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-18">A Gentle Proof (Why It Works)</h4>
<p>Over time, CPU-bound jobs descend to lower queues, leaving top queues free for short, interactive ones. Given enough reset periods, every job eventually returns to top priority.</p>
<p>Thus, MLFQ guarantees eventual progress and low latency for I/O-bound tasks.</p>
<p>Let queues <span class="math inline">\(Q_1, Q_2, \ldots, Q_k\)</span> with quanta <span class="math inline">\(q_1 &lt; q_2 &lt; \cdots &lt; q_k\)</span>. A job that uses full quanta each time moves to queue <span class="math inline">\(Q_k\)</span> after <span class="math inline">\(k-1\)</span> steps. Periodic resets restore fairness, preventing indefinite starvation.</p>
</section>
<section id="try-it-yourself-27" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-27">Try It Yourself</h4>
<ol type="1">
<li>Simulate 3 jobs: CPU-bound, short burst, interactive.</li>
<li>Assign quanta: 1, 2, 4.</li>
<li>Watch promotions/demotions.</li>
<li>Add periodic reset → verify fairness.</li>
<li>Compare with Round Robin and Priority Scheduling.</li>
</ol>
</section>
<section id="test-cases-27" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-27">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Jobs</th>
<th>Bursts</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>8, 2</td>
<td>CPU vs I/O</td>
<td>I/O finishes early</td>
</tr>
<tr class="even">
<td>3</td>
<td>5, 3, 2</td>
<td>Mixed</td>
<td>CPU job demoted</td>
</tr>
<tr class="odd">
<td>1</td>
<td>10</td>
<td>CPU-bound</td>
<td>Ends in low queue</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-27" class="level4">
<h4 class="anchored" data-anchor-id="complexity-27">Complexity</h4>
<ul>
<li>Scheduling: <span class="math inline">\(O(\text{\#queues})\)</span> per decision</li>
<li>Space: <span class="math inline">\(O(\sum n_i)\)</span></li>
<li>Overhead: promotions, demotions, resets</li>
</ul>
<p>MLFQ is the chameleon of schedulers, constantly adapting, learning job behavior on the fly. It rewards patience and responsiveness alike, orchestrating fairness across time.</p>
</section>
</section>
<section id="fair-queuing-fq" class="level3">
<h3 class="anchored" data-anchor-id="fair-queuing-fq">830 Fair Queuing (FQ)</h3>
<p>Fair Queuing (FQ) is a network scheduling algorithm that divides bandwidth fairly among flows. It treats each flow as if it had its own private queue and allocates transmission opportunities proportionally and smoothly, preventing one flow from dominating the link.</p>
<p>In CPU scheduling terms, FQ is the weighted Round Robin of packets, everyone gets a turn, but heavier weights get proportionally more bandwidth.</p>
<section id="what-problem-are-we-solving-28" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-28">What Problem Are We Solving?</h4>
<p>In shared systems (like routers or CPU schedulers), multiple flows or processes compete for a single resource. Without fairness, one greedy flow can monopolize capacity, causing starvation or jitter for others.</p>
<p>Fair Queuing ensures:</p>
<ul>
<li>Fair bandwidth sharing</li>
<li>Isolation between flows</li>
<li>Smooth latency for well-behaved traffic</li>
</ul>
<p>Used widely in network routers, I/O schedulers, and virtualization systems.</p>
</section>
<section id="how-does-it-work-plain-language-28" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-28">How Does It Work (Plain Language)</h4>
<p>Each flow maintains its own FIFO queue of packets (or jobs). Conceptually, the scheduler simulates bit-by-bit Round Robin across all active flows, then transmits whole packets in the same order.</p>
<p>The trick is to assign each packet a virtual finish time and always send the one that would finish earliest under perfect fairness.</p>
</section>
<section id="key-idea-virtual-finish-time" class="level4">
<h4 class="anchored" data-anchor-id="key-idea-virtual-finish-time">Key Idea: Virtual Finish Time</h4>
<p>For each packet <span class="math inline">\(p_{i,k}\)</span> (packet <span class="math inline">\(k\)</span> of flow <span class="math inline">\(i\)</span>):</p>
<ul>
<li>Arrival time: <span class="math inline">\(A_{i,k}\)</span></li>
<li>Length: <span class="math inline">\(L_{i,k}\)</span></li>
<li>Start time: <span class="math display">\[ S_{i,k} = \max(F_{i,k-1}, V(A_{i,k})) \]</span></li>
<li>Finish time: <span class="math display">\[ F_{i,k} = S_{i,k} + \frac{L_{i,k}}{w_i} \]</span></li>
</ul>
<p>where:</p>
<ul>
<li><span class="math inline">\(F_{i,k-1}\)</span> = finish time of previous packet in flow <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(V(t)\)</span> = system virtual time at <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(w_i\)</span> = weight (priority) of flow <span class="math inline">\(i\)</span></li>
</ul>
<p>Scheduler always picks the packet with smallest <span class="math inline">\(F_{i,k}\)</span> next.</p>
<p>This emulates Weighted Fair Queuing (WFQ) if <span class="math inline">\(w_i\)</span> varies.</p>
</section>
<section id="example-walkthrough-22" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-22">Example Walkthrough</h4>
<p>Suppose two flows:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Flow</th>
<th>Packet Length</th>
<th>Weight</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>F₁</td>
<td>100 bytes</td>
<td>1</td>
<td></td>
</tr>
<tr class="even">
<td>F₂</td>
<td>50 bytes</td>
<td>1</td>
<td></td>
</tr>
</tbody>
</table>
<p>If both active:</p>
<ul>
<li>F₁’s packet finishes at time 100</li>
<li>F₂’s at 50 → send F₂ first</li>
<li>Next F₁ → total bandwidth shared 50/50</li>
</ul>
<p>If F₂ sends more, F₁ still gets equal share over time.</p>
</section>
<section id="tiny-code-conceptual-simulation-20" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-20">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> flow<span class="op">,</span> length<span class="op">,</span> finish<span class="op">;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Packet<span class="op">;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    Packet p<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">100</span><span class="op">},</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">50</span><span class="op">},</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">200</span><span class="op">},</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">100</span><span class="op">}</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort by finish time (simplified)</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>p<span class="op">[</span>j<span class="op">].</span>finish <span class="op">&lt;</span> p<span class="op">[</span>i<span class="op">].</span>finish<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                Packet t <span class="op">=</span> p<span class="op">[</span>i<span class="op">];</span> p<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> p<span class="op">[</span>j<span class="op">];</span> p<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Send packet from Flow </span><span class="sc">%d</span><span class="st"> (finish=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>               p<span class="op">[</span>i<span class="op">].</span>flow<span class="op">,</span> p<span class="op">[</span>i<span class="op">].</span>finish<span class="op">);</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Send packet from Flow 2 (finish=50)
Send packet from Flow 2 (finish=100)
Send packet from Flow 1 (finish=100)
Send packet from Flow 1 (finish=200)</code></pre>
</section>
<section id="why-it-matters-28" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-28">Why It Matters</h4>
<ul>
<li>Bandwidth fairness: no flow hogs the link</li>
<li>Delay fairness: small packets don’t starve</li>
<li>Isolation: misbehaving flows can’t harm others</li>
<li>Used in: routers, disks, and OS process schedulers</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Computational cost: must track virtual finish times</li>
<li>Approximation needed for high-speed systems</li>
<li>Large number of flows increases overhead</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-19" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-19">A Gentle Proof (Why It Works)</h4>
<p>Fair Queuing approximates an ideal fluid system where each flow gets <span class="math display">\[
\frac{w_i}{\sum_j w_j}
\]</span> of the link rate continuously.</p>
<p>Each packet <span class="math inline">\(p_{i,k}\)</span> has a finish time: <span class="math display">\[
F_{i,k} = \max(F_{i,k-1}, V(A_{i,k})) + \frac{L_{i,k}}{w_i}
\]</span></p>
<p>By transmitting packets in increasing order of <span class="math inline">\(F_{i,k}\)</span>, we ensure at any time, the service lag between any two flows is bounded by one packet size.</p>
<p>Thus, no flow ever gets more than its fair share.</p>
</section>
<section id="try-it-yourself-28" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-28">Try It Yourself</h4>
<ol type="1">
<li>Two flows, equal weights, simulate finish times.</li>
<li>Change weights (1:2), check proportional bandwidth.</li>
<li>Add flow with large packets, observe fairness.</li>
<li>Compare with FIFO, note difference under contention.</li>
<li>Add new flow mid-stream, verify smooth integration.</li>
</ol>
</section>
<section id="test-cases-28" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-28">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Flows</th>
<th>Weights</th>
<th>Packets</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>1:1</td>
<td>Equal</td>
<td>Fair 50/50</td>
</tr>
<tr class="even">
<td>2</td>
<td>1:2</td>
<td>Equal</td>
<td>Weighted 1:2 share</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1:1:1</td>
<td>Varied size</td>
<td>Equal service over time</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-28" class="level4">
<h4 class="anchored" data-anchor-id="complexity-28">Complexity</h4>
<ul>
<li>Decision time: <span class="math inline">\(O(\log n)\)</span> (priority queue by <span class="math inline">\(F_{i,k}\)</span>)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> active flows</li>
<li>Accuracy: within 1 packet of ideal fair share</li>
</ul>
<p>Fair Queuing is the balancer of schedulers, a calm arbiter ensuring every flow gets its due. Like a maestro, it interleaves packets just right, letting all voices share the line in harmony.</p>
</section>
</section>
</section>
<section id="section-84.-caching-and-replacement" class="level1">
<h1>Section 84. Caching and Replacement</h1>
<section id="lru-least-recently-used" class="level3">
<h3 class="anchored" data-anchor-id="lru-least-recently-used">831 LRU (Least Recently Used)</h3>
<p>Least Recently Used (LRU) is one of the most classic cache replacement policies. It removes the least recently accessed item when space runs out, assuming that recently used items are likely to be used again soon (temporal locality).</p>
<p>It’s simple, intuitive, and widely used in memory management, CPU caches, web caches, and databases.</p>
<section id="what-problem-are-we-solving-29" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-29">What Problem Are We Solving?</h4>
<p>Caches have limited space. When they’re full, we need to decide which item to evict to make room for a new one.</p>
<p>If we evict the wrong item, we might need it again soon, causing cache misses.</p>
<p>LRU chooses to evict the item that hasn’t been used for the longest time, based on the principle of recency:</p>
<blockquote class="blockquote">
<p>“What you haven’t used recently is less likely to be used next.”</p>
</blockquote>
<p>This policy adapts well to temporal locality, where recently accessed data tends to be accessed again.</p>
</section>
<section id="how-does-it-work-plain-language-29" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-29">How Does It Work (Plain Language)</h4>
<p>Track the order of accesses. When the cache is full:</p>
<ul>
<li>Remove the oldest (least recently used) item.</li>
<li>Insert the new item at the most recent position.</li>
</ul>
<p>Each time an item is accessed:</p>
<ul>
<li>Move it to the front (most recent position).</li>
</ul>
<p>Think of it as a queue (or list) ordered by recency:</p>
<ul>
<li>Front = most recently used</li>
<li>Back = least recently used</li>
</ul>
</section>
<section id="example-walkthrough-23" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-23">Example Walkthrough</h4>
<p>Suppose cache size = 3.</p>
<p>Access sequence: <code>A, B, C, A, D</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Cache (Front → Back)</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>B A</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>C B A</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>A</td>
<td>A C B</td>
<td>-</td>
</tr>
<tr class="odd">
<td>5</td>
<td>D</td>
<td>D A C</td>
<td>B</td>
</tr>
</tbody>
</table>
<p>Explanation</p>
<ul>
<li>After accessing A again, move A to front.</li>
<li>When inserting D, cache is full, evict B, least recently used.</li>
</ul>
</section>
<section id="tiny-code-c" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c">Tiny Code (C)</h4>
<p>Using a linked list + hash map (for O(1) lookup):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Node <span class="op">{</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> key<span class="op">;</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Node <span class="op">*</span>prev<span class="op">,</span> <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Node<span class="op">;</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>Node <span class="op">*</span>head <span class="op">=</span> NULL<span class="op">,</span> <span class="op">*</span>tail <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> move_to_front<span class="op">(</span>Node <span class="op">*</span>n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> head<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n<span class="op">-&gt;</span>prev<span class="op">)</span> n<span class="op">-&gt;</span>prev<span class="op">-&gt;</span>next <span class="op">=</span> n<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n<span class="op">-&gt;</span>next<span class="op">)</span> n<span class="op">-&gt;</span>next<span class="op">-&gt;</span>prev <span class="op">=</span> n<span class="op">-&gt;</span>prev<span class="op">;</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> tail<span class="op">)</span> tail <span class="op">=</span> n<span class="op">-&gt;</span>prev<span class="op">;</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    n<span class="op">-&gt;</span>prev <span class="op">=</span> NULL<span class="op">;</span> n<span class="op">-&gt;</span>next <span class="op">=</span> head<span class="op">;</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>head<span class="op">)</span> head<span class="op">-&gt;</span>prev <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    head <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">int</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    Node <span class="op">*</span>n <span class="op">=</span> head<span class="op">;</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>n <span class="op">&amp;&amp;</span> n<span class="op">-&gt;</span>key <span class="op">!=</span> key<span class="op">)</span> n <span class="op">=</span> n<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        move_to_front<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%d</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%d</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Node<span class="op">));</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    n<span class="op">-&gt;</span>key <span class="op">=</span> key<span class="op">;</span> n<span class="op">-&gt;</span>prev <span class="op">=</span> NULL<span class="op">;</span> n<span class="op">-&gt;</span>next <span class="op">=</span> head<span class="op">;</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>head<span class="op">)</span> head<span class="op">-&gt;</span>prev <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    head <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>tail<span class="op">)</span> tail <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> Node <span class="op">*</span>t <span class="op">=</span> head<span class="op">;</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>t<span class="op">)</span> <span class="op">{</span> count<span class="op">++;</span> <span class="cf">if</span> <span class="op">(</span>count <span class="op">&gt;</span> CAP<span class="op">)</span> <span class="cf">break</span><span class="op">;</span> t <span class="op">=</span> t<span class="op">-&gt;</span>next<span class="op">;</span> <span class="op">}</span></span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count <span class="op">&gt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        Node <span class="op">*</span>evict <span class="op">=</span> tail<span class="op">;</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        tail <span class="op">=</span> tail<span class="op">-&gt;</span>prev<span class="op">;</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        tail<span class="op">-&gt;</span>next <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        free<span class="op">(</span>evict<span class="op">);</span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">};</span></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-29" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-29">Why It Matters</h4>
<ul>
<li>Adaptive: works well with temporal locality</li>
<li>Simple and effective: easy mental model</li>
<li>Widely used: OS pages, DB buffers, web caches</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Overhead: needs tracking of recency</li>
<li>Not optimal for cyclic access patterns (e.g., sequential scans larger than cache)</li>
<li>O(1) implementations require hash + list</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-20" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-20">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S\)</span> be the access sequence and <span class="math inline">\(C\)</span> the cache capacity.</p>
<p>If an item <span class="math inline">\(x\)</span> hasn’t been used in the last <span class="math inline">\(C\)</span> distinct accesses, then adding a new item means <span class="math inline">\(x\)</span> would not be reused soon (in most practical workloads).</p>
<p>LRU approximates Belady’s optimal policy under the stack property:</p>
<blockquote class="blockquote">
<p>Increasing cache size under LRU never increases misses.</p>
</blockquote>
<p>So, LRU’s performance is monotonic, a rare and valuable property.</p>
</section>
<section id="try-it-yourself-29" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-29">Try It Yourself</h4>
<ol type="1">
<li>Simulate LRU for capacity = 3 and sequence <code>A, B, C, D, A, B, E, A, B, C, D, E</code>.</li>
<li>Compare hit ratio with FIFO and Random replacement.</li>
<li>Observe how temporal locality improves hits.</li>
<li>Try a cyclic pattern (<code>A, B, C, D, A, B, C, D, ...</code>), see weakness.</li>
<li>Implement LRU with a stack or ordered map.</li>
</ol>
</section>
<section id="test-cases-29" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-29">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Cache Size</th>
<th>Sequence</th>
<th>Hits</th>
<th>Misses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>A B C A D</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="even">
<td>3</td>
<td>A B C A B C</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="odd">
<td>2</td>
<td>A B A B A B</td>
<td>4</td>
<td>2</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-29" class="level4">
<h4 class="anchored" data-anchor-id="complexity-29">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> (with hash + list)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> (cache + metadata)</li>
</ul>
<p>LRU is the memory of recency, a cache that learns from your habits. What you touch often stays close; what you forget, it lets go.</p>
</section>
</section>
<section id="lfu-least-frequently-used" class="level3">
<h3 class="anchored" data-anchor-id="lfu-least-frequently-used">832 LFU (Least Frequently Used)</h3>
<p>Least Frequently Used (LFU) is a cache replacement policy that evicts the least frequently accessed item first. Instead of looking at <em>recency</em> (like LRU), LFU focuses on frequency, assuming that items accessed often are likely to be accessed again.</p>
<p>It’s a natural fit for workloads with hot items that stay popular over time.</p>
<section id="what-problem-are-we-solving-30" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-30">What Problem Are We Solving?</h4>
<p>In many systems, some data is repeatedly reused (hot items), while others are rarely needed. If we use LRU, a single burst of sequential access might flush out popular items, a phenomenon called cache pollution.</p>
<p>LFU solves this by tracking access counts, so frequently accessed items are protected from eviction.</p>
<p>Eviction rule: Remove the item with the lowest access frequency.</p>
</section>
<section id="how-does-it-work-plain-language-30" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-30">How Does It Work (Plain Language)</h4>
<p>Every time an item is accessed:</p>
<ul>
<li>Increase its frequency count</li>
<li>Reorder or reclassify it by that count</li>
</ul>
<p>When cache is full:</p>
<ul>
<li>Evict item(s) with smallest frequency</li>
</ul>
<p>Think of it as a priority queue ranked by access frequency:</p>
<ul>
<li>Items that appear often rise to the top</li>
<li>Rarely accessed ones drift down and out</li>
</ul>
</section>
<section id="example-walkthrough-24" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-24">Example Walkthrough</h4>
<p>Cache capacity = 3 Access sequence: <code>A, B, C, A, B, A, D</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Frequency Counts</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A:1</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A:1, B:1</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A:1, B:1, C:1</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>A</td>
<td>A:2, B:1, C:1</td>
<td>-</td>
</tr>
<tr class="odd">
<td>5</td>
<td>B</td>
<td>A:2, B:2, C:1</td>
<td>-</td>
</tr>
<tr class="even">
<td>6</td>
<td>A</td>
<td>A:3, B:2, C:1</td>
<td>-</td>
</tr>
<tr class="odd">
<td>7</td>
<td>D</td>
<td>A:3, B:2, C:1</td>
<td>Evict C</td>
</tr>
</tbody>
</table>
<p>Eviction: C (lowest frequency)</p>
<p>Final cache: A (3), B (2), D (1)</p>
</section>
<section id="tiny-code-c-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-1">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> key<span class="op">;</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> freq<span class="op">;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Entry<span class="op">;</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>Entry cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">].</span>key <span class="op">==</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">[</span>i<span class="op">].</span>freq<span class="op">++;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit, freq=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">,</span> cache<span class="op">[</span>i<span class="op">].</span>freq<span class="op">);</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>Entry<span class="op">){</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Evict LFU</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> min_i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">].</span>freq <span class="op">&lt;</span> cache<span class="op">[</span>min_i<span class="op">].</span>freq<span class="op">)</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>            min_i <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c</span><span class="st"> (freq=</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>min_i<span class="op">].</span>key<span class="op">,</span> cache<span class="op">[</span>min_i<span class="op">].</span>freq<span class="op">);</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    cache<span class="op">[</span>min_i<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>Entry<span class="op">){</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">};</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">7</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Access A (miss)
Access B (miss)
Access C (miss)
Access A (hit, freq=2)
Access B (hit, freq=2)
Access A (hit, freq=3)
Access D (miss)
Evict C (freq=1)</code></pre>
</section>
<section id="why-it-matters-30" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-30">Why It Matters</h4>
<ul>
<li>Protects hot data that stays popular</li>
<li>Reduces cache pollution from one-time scans</li>
<li>Great for skewed workloads (Zipfian distributions)</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Harder to implement efficiently (needs priority by freq)</li>
<li>Old popular items may linger forever (no aging)</li>
<li>Heavy bookkeeping if naive</li>
</ul>
<p>Variants like LFU with aging or TinyLFU solve staleness by decaying frequencies over time.</p>
</section>
<section id="a-gentle-proof-why-it-works-21" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-21">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(f(x)\)</span> be the frequency count of item <span class="math inline">\(x\)</span>. LFU keeps in cache all items with highest <span class="math inline">\(f(x)\)</span> under capacity <span class="math inline">\(C\)</span>.</p>
<p>If access distribution is stable, then the top <span class="math inline">\(C\)</span> frequent items minimize cache misses.</p>
<p>In probabilistic terms, for access probabilities <span class="math inline">\(p(x)\)</span>, the optimal steady-state cache holds the <span class="math inline">\(C\)</span> items with largest <span class="math inline">\(p(x)\)</span>, LFU approximates this by counting.</p>
</section>
<section id="try-it-yourself-30" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-30">Try It Yourself</h4>
<ol type="1">
<li>Run sequence <code>A B C A B A D</code> (capacity 3).</li>
<li>Try a streaming pattern (A B C D E F …), watch LFU degenerate.</li>
<li>Add aging (divide all frequencies by 2 periodically).</li>
<li>Compare results with LRU and Random.</li>
<li>Visualize counts over time, see persistence of hot items.</li>
</ol>
</section>
<section id="test-cases-30" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-30">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Cache Size</th>
<th>Sequence</th>
<th>Evicted</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>A B C A B A D</td>
<td>C</td>
<td>A(3), B(2), D(1)</td>
</tr>
<tr class="even">
<td>2</td>
<td>A B A B C</td>
<td>C</td>
<td>C replaces A</td>
</tr>
<tr class="odd">
<td>3</td>
<td>A B C D E</td>
<td>A,B,C</td>
<td>all 1, arbitrary evict</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-30" class="level4">
<h4 class="anchored" data-anchor-id="complexity-30">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(\log n)\)</span> (heap) or <span class="math inline">\(O(1)\)</span> (frequency buckets)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> for frequency tracking</li>
</ul>
<p>LFU is the statistician of caches, watching patterns, counting faithfully, and keeping only what history proves to be popular.</p>
</section>
</section>
<section id="fifo-cache-first-in-first-out" class="level3">
<h3 class="anchored" data-anchor-id="fifo-cache-first-in-first-out">833 FIFO Cache (First-In, First-Out)</h3>
<p>First-In, First-Out (FIFO) is one of the simplest cache replacement policies. It evicts the oldest item in the cache, the one that has been there the longest, regardless of how often or recently it was used.</p>
<p>It’s easy to implement with a simple queue, but doesn’t consider recency or frequency, making it prone to anomalies.</p>
<section id="what-problem-are-we-solving-31" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-31">What Problem Are We Solving?</h4>
<p>When a cache is full, we must remove something to make space. FIFO answers the question with a simple rule:</p>
<blockquote class="blockquote">
<p>“Evict the item that entered first.”</p>
</blockquote>
<p>This works well when data follows streaming patterns (old items are unlikely to be reused), but fails when older items are still hot (reused frequently).</p>
<p>It’s mostly used when simplicity is preferred over precision.</p>
</section>
<section id="how-does-it-work-plain-language-31" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-31">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Maintain a queue of items in insertion order.</p></li>
<li><p>When a new item is accessed:</p>
<ul>
<li>If it’s already in cache → hit (do nothing)</li>
<li>If not → miss, insert at rear</li>
</ul></li>
<li><p>If the cache is full → evict item at front (oldest)</p></li>
</ol>
<p>No reordering happens on access, unlike LRU.</p>
</section>
<section id="example-walkthrough-25" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-25">Example Walkthrough</h4>
<p>Cache capacity = 3 Access sequence: <code>A, B, C, A, D, B</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Cache (Front → Back)</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A B</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A B C</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>A</td>
<td>A B C</td>
<td>-</td>
</tr>
<tr class="odd">
<td>5</td>
<td>D</td>
<td>B C D</td>
<td>Evict A</td>
</tr>
<tr class="even">
<td>6</td>
<td>B</td>
<td>B C D</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Observation: Even though A was used again, FIFO evicted it because it was oldest, not least used.</p>
</section>
<section id="tiny-code-c-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-2">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> front <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> in_cache<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> key<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>in_cache<span class="op">(</span>key<span class="op">))</span> <span class="op">{</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>front<span class="op">]);</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>front<span class="op">]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        front <span class="op">=</span> <span class="op">(</span>front <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> CAP<span class="op">;</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">};</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">6</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Access A (miss)
Access B (miss)
Access C (miss)
Access A (hit)
Access D (miss)
Evict A
Access B (hit)</code></pre>
</section>
<section id="why-it-matters-31" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-31">Why It Matters</h4>
<ul>
<li>Simplicity: easy to implement (just a queue)</li>
<li>Deterministic: predictable behavior</li>
<li>Useful for FIFO queues and streams</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>No recency awareness: evicts recently used data</li>
<li>Belady’s anomaly: increasing cache size may increase misses</li>
<li>Poor temporal locality handling</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-22" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-22">A Gentle Proof (Why It Works)</h4>
<p>FIFO operates as a sliding window of recent insertions. Each new access pushes out the oldest, regardless of usage.</p>
<p>Formally, at time <span class="math inline">\(t\)</span>, cache holds the last <span class="math inline">\(C\)</span> unique insertions. If a reused item’s insertion lies outside that window, it’s gone, hence poor performance for repeating patterns.</p>
</section>
<section id="try-it-yourself-31" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-31">Try It Yourself</h4>
<ol type="1">
<li>Simulate capacity = 3, sequence <code>A B C A B C A B C</code>.</li>
<li>Note that every access after the third is a miss, no reuse captured.</li>
<li>Compare with LRU, which reuses past data.</li>
<li>Test with streaming data (e.g.&nbsp;sequential blocks), FIFO shines.</li>
<li>Visualize queue evolution step by step.</li>
</ol>
</section>
<section id="test-cases-31" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-31">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Cache Size</th>
<th>Sequence</th>
<th>Miss Count</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>A B C A D B</td>
<td>4</td>
<td>Evicts by age</td>
</tr>
<tr class="even">
<td>3</td>
<td>A B C A B C</td>
<td>6</td>
<td>Belady’s anomaly</td>
</tr>
<tr class="odd">
<td>2</td>
<td>A B A B A B</td>
<td>2</td>
<td>Works if reuse fits window</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-31" class="level4">
<h4 class="anchored" data-anchor-id="complexity-31">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> (queue operations)</li>
<li>Space: <span class="math inline">\(O(C)\)</span> (cache array)</li>
</ul>
<p>FIFO is the assembly line of caches, it moves steadily forward, never looking back to see what it’s letting go.</p>
</section>
</section>
<section id="clock-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="clock-algorithm">834 CLOCK Algorithm</h3>
<p>The CLOCK algorithm is an efficient approximation of LRU (Least Recently Used). Instead of maintaining a full recency list, CLOCK keeps a circular buffer and a use bit for each page, achieving near-LRU performance with much lower overhead.</p>
<p>It’s widely used in operating systems (e.g., page replacement in virtual memory) due to its simplicity and speed.</p>
<section id="what-problem-are-we-solving-32" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-32">What Problem Are We Solving?</h4>
<p>A true LRU cache needs to track exact access order, which can be expensive:</p>
<ul>
<li>Updating position on every access</li>
<li>Maintaining linked lists or timestamps</li>
</ul>
<p>The CLOCK algorithm approximates LRU using a single reference bit, rotating like a clock hand to find victims lazily.</p>
<p>This reduces overhead while maintaining similar hit rates.</p>
</section>
<section id="how-does-it-work-plain-language-32" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-32">How Does It Work (Plain Language)</h4>
<p>Imagine pages arranged in a circle, each with a use bit (0 or 1). A clock hand moves around the circle, pointing at candidates for eviction.</p>
<p>When a page is accessed:</p>
<ul>
<li>Set its use bit = 1</li>
</ul>
<p>When cache is full and eviction is needed:</p>
<ol type="1">
<li>Look at the page under the clock hand.</li>
<li>If use bit = 0, evict it.</li>
<li>If use bit = 1, set it to 0 and advance the hand.</li>
<li>Repeat until a 0 is found.</li>
</ol>
<p>This ensures recently used pages get a second chance.</p>
</section>
<section id="example-walkthrough-26" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-26">Example Walkthrough</h4>
<p>Cache capacity = 3</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Cache</th>
<th>Use Bits</th>
<th>Hand</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>[1]</td>
<td>→A</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A B</td>
<td>[1 1]</td>
<td>→A</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A B C</td>
<td>[1 1 1]</td>
<td>→A</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>A B C</td>
<td>[0 1 1]</td>
<td>→B</td>
<td>Evict A</td>
</tr>
<tr class="odd">
<td>5</td>
<td>B</td>
<td>A B C</td>
<td>[0 1 1]</td>
<td>→B</td>
<td>-</td>
</tr>
<tr class="even">
<td>6</td>
<td>E</td>
<td>D B C</td>
<td>[1 1 1]</td>
<td>→D</td>
<td>Evict next 0</td>
</tr>
</tbody>
</table>
<p>Detailed steps:</p>
<ul>
<li>When full, D arrives. Hand points to A with use=1 → set 0 → move → B (1) → set 0 → move → C (1) → set 0 → move → back to A (0) → evict A → insert D.</li>
</ul>
</section>
<section id="tiny-code-c-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-3">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> key<span class="op">;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> use<span class="op">;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Page<span class="op">;</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>Page cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> hand <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> find<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">].</span>key <span class="op">==</span> key<span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> find<span class="op">(</span>key<span class="op">);</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>i<span class="op">].</span>use <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>Page<span class="op">){</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// CLOCK eviction</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>hand<span class="op">].</span>use <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>hand<span class="op">].</span>key<span class="op">);</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">[</span>hand<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>Page<span class="op">){</span>key<span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>            hand <span class="op">=</span> <span class="op">(</span>hand <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> CAP<span class="op">;</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>hand<span class="op">].</span>use <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>        hand <span class="op">=</span> <span class="op">(</span>hand <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> CAP<span class="op">;</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">};</span></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">6</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-32" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-32">Why It Matters</h4>
<ul>
<li>LRU-like performance, simpler data structures</li>
<li>Constant-time eviction using circular pointer</li>
<li>OS standard: used in UNIX, Linux, Windows VM</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Approximation, not perfect LRU</li>
<li>May favor pages with frequent but spaced-out accesses</li>
<li>Still needs per-page bit storage</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-23" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-23">A Gentle Proof (Why It Works)</h4>
<p>Let each page have a use bit <span class="math inline">\(u_i \in {0, 1}\)</span>. When a page is referenced, <span class="math inline">\(u_i = 1\)</span>. The hand cycles through pages, clearing <span class="math inline">\(u_i = 0\)</span> if it was 1.</p>
<p>A page survives one full rotation only if it was accessed, so only unreferenced pages are eventually replaced.</p>
<p>Hence, CLOCK guarantees: <span class="math display">\[
\text{Eviction order approximates recency order}
\]</span> with <span class="math inline">\(O(1)\)</span> maintenance cost.</p>
</section>
<section id="try-it-yourself-32" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-32">Try It Yourself</h4>
<ol type="1">
<li>Simulate sequence <code>A B C D A B E</code>.</li>
<li>Track use bits and hand pointer.</li>
<li>Compare with LRU results, usually same evictions.</li>
<li>Increase capacity, verify similar trends.</li>
<li>Extend to Second-Chance FIFO (CLOCK = improved FIFO).</li>
</ol>
</section>
<section id="test-cases-32" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-32">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Cache Size</th>
<th>Sequence</th>
<th>Evicted</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>A B C D B E</td>
<td>A, C</td>
<td>Matches LRU</td>
</tr>
<tr class="even">
<td>2</td>
<td>A B A C A</td>
<td>B</td>
<td>Similar to LRU</td>
</tr>
<tr class="odd">
<td>3</td>
<td>A A B C D</td>
<td>A, B</td>
<td>Preserves recent A</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-32" class="level4">
<h4 class="anchored" data-anchor-id="complexity-32">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span></li>
<li>Evict: <span class="math inline">\(O(1)\)</span> (amortized)</li>
<li>Space: <span class="math inline">\(O(C)\)</span></li>
</ul>
<p>The CLOCK algorithm is the gentle LRU, quietly spinning, giving second chances, and evicting only what truly rests forgotten.</p>
</section>
</section>
<section id="arc-adaptive-replacement-cache" class="level3">
<h3 class="anchored" data-anchor-id="arc-adaptive-replacement-cache">835 ARC (Adaptive Replacement Cache)</h3>
<p>Adaptive Replacement Cache (ARC) is a self-tuning caching algorithm that dynamically balances recency and frequency. It combines the strengths of LRU (recently used items) and LFU (frequently used items), and <em>adapts automatically</em> as access patterns change.</p>
<p>ARC was introduced by IBM Research and is used in systems like ZFS for intelligent caching under mixed workloads.</p>
<section id="what-problem-are-we-solving-33" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-33">What Problem Are We Solving?</h4>
<p>Traditional caches choose a fixed policy:</p>
<ul>
<li>LRU favors <em>recency</em> but fails under cyclic scans.</li>
<li>LFU favors <em>frequency</em> but forgets recency.</li>
</ul>
<p>Real-world workloads fluctuate, sometimes new items matter more, sometimes reused ones do.</p>
<p>ARC solves this by tracking both and adapting dynamically based on which side yields more hits.</p>
<blockquote class="blockquote">
<p>“If recency helps, favor LRU. If frequency helps, favor LFU.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-33" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-33">How Does It Work (Plain Language)</h4>
<p>ARC maintains four lists:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>List</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T₁</td>
<td><em>Recent</em> items seen once (LRU)</td>
</tr>
<tr class="even">
<td>T₂</td>
<td><em>Frequent</em> items seen twice+ (LFU)</td>
</tr>
<tr class="odd">
<td>B₁</td>
<td><em>Ghost list</em> of recently evicted T₁ items</td>
</tr>
<tr class="even">
<td>B₂</td>
<td><em>Ghost list</em> of recently evicted T₂ items</td>
</tr>
</tbody>
</table>
<p>The ghost lists don’t store data, only keys, to remember what was evicted.</p>
<p>ARC dynamically adjusts a target size p:</p>
<ul>
<li>If a <em>ghost hit</em> occurs in B₁, recency is under-allocated → increase p (favor T₁)</li>
<li>If a <em>ghost hit</em> occurs in B₂, frequency is under-allocated → decrease p (favor T₂)</li>
</ul>
<p>Thus, ARC learns online how to divide cache between recency (T₁) and frequency (T₂).</p>
</section>
<section id="example-flow" class="level4">
<h4 class="anchored" data-anchor-id="example-flow">Example Flow</h4>
<p>Cache size = 4</p>
<ol type="1">
<li>Access <code>A B C D</code> → fills T₁ = [D C B A]</li>
<li>Access <code>A</code> again → move A from T₁ → T₂</li>
<li>Access <code>E</code> → evict least recent (D) from T₁ → record in B₁</li>
<li>Later, access <code>D</code> again → ghost hit in B₁ → increase <em>p</em> → favor T₁</li>
</ol>
<p>ARC continuously balances recency vs frequency using these ghost signals.</p>
</section>
<section id="tiny-code-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-pseudocode">Tiny Code (Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>on access<span class="op">(</span>x<span class="op">):</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x in T1 or x in T2<span class="op">:</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// cache hit</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>        move x to front of T2</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> x in B1<span class="op">:</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ghost hit in recency</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        increase p</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        replace<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        move x to front of T2</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> x in B2<span class="op">:</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ghost hit in frequency</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        decrease p</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        replace<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        move x to front of T2</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span><span class="op">:</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// new item</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> T1<span class="op">.</span>size <span class="op">+</span> B1<span class="op">.</span>size <span class="op">==</span> c<span class="op">:</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> T1<span class="op">.</span>size <span class="op">&lt;</span> c<span class="op">:</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>                remove oldest from B1</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>                replace<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> remove oldest from T1</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> total size <span class="op">&gt;=</span> c<span class="op">:</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total size <span class="op">==</span> <span class="dv">2</span><span class="er">c</span><span class="op">:</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>                remove oldest from B2</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        insert x to front of T1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-33" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-33">Why It Matters</h4>
<ul>
<li>Self-tuning: adjusts between LRU and LFU automatically</li>
<li>Workload adaptive: handles scans + hot items gracefully</li>
<li>No manual tuning needed: <em>p</em> updates online</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>More complex bookkeeping</li>
<li>Higher metadata overhead (four lists)</li>
<li>Patented (IBM; used with license in ZFS)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-24" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-24">A Gentle Proof (Why It Works)</h4>
<p>ARC approximates the optimal adaptive mix of LRU and LFU.</p>
<p>Let:</p>
<ul>
<li><span class="math inline">\(c\)</span> = total cache size</li>
<li><span class="math inline">\(p\)</span> = partition target for recency (T₁)</li>
</ul>
<p>At any moment:</p>
<ul>
<li>T₁ stores <span class="math inline">\(\min(p, c)\)</span> most recent items</li>
<li>T₂ stores remaining <span class="math inline">\(\max(0, c - p)\)</span> most frequent items</li>
</ul>
<p>Ghost lists (B₁, B₂) serve as feedback channels. If <span class="math inline">\(|B₁| &gt; |B₂|\)</span>, more recency hits → increase <span class="math inline">\(p\)</span> (favor LRU). If <span class="math inline">\(|B₂| &gt; |B₁|\)</span>, more frequency hits → decrease <span class="math inline">\(p\)</span> (favor LFU).</p>
<p>Thus, ARC converges to a policy close to OPT for given access distribution.</p>
</section>
<section id="try-it-yourself-33" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-33">Try It Yourself</h4>
<ol type="1">
<li>Simulate sequence <code>A B C D A B E A B C D</code> (capacity 4).</li>
<li>Watch <em>p</em> shift as ghost hits occur.</li>
<li>Compare with pure LRU and LFU, ARC adapts better.</li>
<li>Introduce a long scan (A…Z) → ARC shifts toward frequency.</li>
<li>Replay mixed workload, ARC oscillates intelligently.</li>
</ol>
</section>
<section id="test-cases-33" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-33">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>Sequence</th>
<th>Capacity</th>
<th>LRU Misses</th>
<th>LFU Misses</th>
<th>ARC Misses</th>
<th>Winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Repeating (A,B,C,A,B,C)</td>
<td>3</td>
<td>Low</td>
<td>Low</td>
<td>Low</td>
<td>Tie</td>
</tr>
<tr class="even">
<td>Scanning (A,B,C,D,E)</td>
<td>3</td>
<td>High</td>
<td>High</td>
<td>Medium</td>
<td>ARC</td>
</tr>
<tr class="odd">
<td>Mixed hot+scan</td>
<td>4</td>
<td>High</td>
<td>Medium</td>
<td>Low</td>
<td>ARC</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-33" class="level4">
<h4 class="anchored" data-anchor-id="complexity-33">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> amortized (list ops)</li>
<li>Space: <span class="math inline">\(O(2C)\)</span> (real + ghost lists)</li>
<li>Adaptive parameter: <span class="math inline">\(p \in [0, C]\)</span></li>
</ul>
<p>ARC is the smart hybrid, watching both history and frequency, learning which pattern rules the moment, and shifting its balance like a living system.</p>
</section>
</section>
<section id="two-queue-2q" class="level3">
<h3 class="anchored" data-anchor-id="two-queue-2q">836 Two-Queue (2Q)</h3>
<p>Two-Queue (2Q) caching is a clever and lightweight enhancement over plain LRU. It separates recently accessed pages from frequently reused ones, reducing cache pollution caused by one-time accesses, a problem LRU alone struggles with.</p>
<p>You can think of 2Q as a simplified, practical cousin of ARC, same spirit, fewer moving parts.</p>
<section id="what-problem-are-we-solving-34" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-34">What Problem Are We Solving?</h4>
<p>LRU evicts the least recently used page, but in workloads with large sequential scans, those newly seen pages can push out hot pages that are still needed.</p>
<p>2Q prevents that by keeping new pages in a probationary queue first. Only items accessed twice move into the main queue.</p>
<blockquote class="blockquote">
<p>“New items must earn their place in the main cache.”</p>
</blockquote>
<p>This drastically improves performance when there’s a mix of one-shot and repeated data.</p>
</section>
<section id="how-does-it-work-plain-language-34" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-34">How Does It Work (Plain Language)</h4>
<p>2Q maintains two LRU queues:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Queue</th>
<th>Meaning</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A1 (In)</td>
<td>Recently seen once</td>
<td>Temporary holding area</td>
</tr>
<tr class="even">
<td>Am (Main)</td>
<td>Seen at least twice</td>
<td>Long-term cache</td>
</tr>
</tbody>
</table>
<p>Flow of access:</p>
<ol type="1">
<li>On miss: insert page into A1 (if not full).</li>
<li>On hit in A1: promote page to Am.</li>
<li>On hit in Am: move to MRU (front).</li>
<li>If A1 is full → evict oldest (LRU) from A1.</li>
<li>If Am is full → evict oldest from Am.</li>
</ol>
</section>
<section id="example-walkthrough-27" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-27">Example Walkthrough</h4>
<p>Cache capacity = 4 (A1 = 2, Am = 2) Access sequence: <code>A, B, C, A, D, B, E, A</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>A1 (Recent)</th>
<th>Am (Frequent)</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>B A</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>C B</td>
<td>-</td>
<td>Evict A (oldest A1)</td>
</tr>
<tr class="even">
<td>4</td>
<td>A</td>
<td>B</td>
<td>A</td>
<td>Promote A to Am</td>
</tr>
<tr class="odd">
<td>5</td>
<td>D</td>
<td>D B</td>
<td>A</td>
<td>-</td>
</tr>
<tr class="even">
<td>6</td>
<td>B</td>
<td>D</td>
<td>A B</td>
<td>Promote B to Am</td>
</tr>
<tr class="odd">
<td>7</td>
<td>E</td>
<td>E D</td>
<td>A B</td>
<td>Evict oldest A1</td>
</tr>
<tr class="even">
<td>8</td>
<td>A</td>
<td>E D</td>
<td>A B</td>
<td>Hit in Am</td>
</tr>
</tbody>
</table>
<p>Result: hot pages A, B persist; cold scans flushed harmlessly.</p>
</section>
<section id="tiny-code-c-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-4">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define A1_SIZE </span><span class="dv">2</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define AM_SIZE </span><span class="dv">2</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> A1<span class="op">[</span>A1_SIZE<span class="op">][</span><span class="dv">2</span><span class="op">],</span> Am<span class="op">[</span>AM_SIZE<span class="op">][</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> a1_len <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> am_len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> in_list<span class="op">(</span><span class="dt">char</span> list<span class="op">[][</span><span class="dv">2</span><span class="op">],</span> <span class="dt">int</span> len<span class="op">,</span> <span class="dt">char</span> k<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>list<span class="op">[</span>i<span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> k<span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> k<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>i <span class="op">=</span> in_list<span class="op">(</span>Am<span class="op">,</span> am_len<span class="op">,</span> k<span class="op">))</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit in Am)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> k<span class="op">);</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>i <span class="op">=</span> in_list<span class="op">(</span>A1<span class="op">,</span> a1_len<span class="op">,</span> k<span class="op">))</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (promote to Am)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> k<span class="op">);</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// remove from A1</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        memmove<span class="op">(&amp;</span>A1<span class="op">[</span>i<span class="op">],</span> <span class="op">&amp;</span>A1<span class="op">[</span>i<span class="op">+</span><span class="dv">1</span><span class="op">],</span> <span class="op">(</span>a1_len <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>        a1_len<span class="op">--;</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// insert into Am</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>am_len <span class="op">==</span> AM_SIZE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c</span><span class="st"> from Am</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> Am<span class="op">[</span>AM_SIZE<span class="op">-</span><span class="dv">1</span><span class="op">][</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>            am_len<span class="op">--;</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        memmove<span class="op">(&amp;</span>Am<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>Am<span class="op">[</span><span class="dv">0</span><span class="op">],</span> am_len <span class="op">*</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        Am<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> k<span class="op">;</span> am_len<span class="op">++;</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss, insert in A1)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> k<span class="op">);</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a1_len <span class="op">==</span> A1_SIZE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c</span><span class="st"> from A1</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> A1<span class="op">[</span>A1_SIZE<span class="op">-</span><span class="dv">1</span><span class="op">][</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>        a1_len<span class="op">--;</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>    memmove<span class="op">(&amp;</span>A1<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>A1<span class="op">[</span><span class="dv">0</span><span class="op">],</span> a1_len <span class="op">*</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>    A1<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> k<span class="op">;</span> a1_len<span class="op">++;</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">};</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-34" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-34">Why It Matters</h4>
<ul>
<li>Mitigates LRU’s weakness: avoids flushing cache during scans</li>
<li>Lightweight: simpler than ARC, easy to implement</li>
<li>Adapts automatically to reuse frequency</li>
<li>Used in: PostgreSQL, InnoDB, and OS caches</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Two parameters (sizes of A1 and Am) need tuning</li>
<li>Slightly more metadata than plain LRU</li>
<li>Doesn’t fully capture long-term frequency like LFU</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-25" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-25">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(A_1\)</span> track items seen once</li>
<li><span class="math inline">\(A_m\)</span> track items seen at least twice</li>
</ul>
<p>Assume access probabilities <span class="math inline">\(p_i\)</span>. Under steady state:</p>
<ul>
<li><span class="math inline">\(A_1\)</span> filters one-timers (low <span class="math inline">\(p_i\)</span>)</li>
<li><span class="math inline">\(A_m\)</span> holds high-<span class="math inline">\(p_i\)</span> items so 2Q approximates a frequency-aware policy with linear overhead.</li>
</ul>
<p>Formally, 2Q’s miss rate is lower than LRU when <span class="math inline">\(p(\text{one-timers}) &gt; 0\)</span> because such pages are quickly cycled out before polluting the main cache.</p>
</section>
<section id="try-it-yourself-34" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-34">Try It Yourself</h4>
<ol type="1">
<li>Simulate with sequences that mix hot and cold pages.</li>
<li>Compare LRU vs 2Q under a long sequential scan.</li>
<li>Adjust A1/Am ratio (e.g., 25/75, 50/50), observe sensitivity.</li>
<li>Add repeated hot items among cold ones, see 2Q adapt.</li>
<li>Measure hit ratio vs LRU and LFU.</li>
</ol>
</section>
<section id="test-cases-34" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-34">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Sequence</th>
<th>Capacity</th>
<th>Policy</th>
<th>Hit Ratio</th>
<th>Winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A B C D A B C D</td>
<td>4</td>
<td>LRU</td>
<td>Low</td>
<td>-</td>
</tr>
<tr class="even">
<td>A B C D A B</td>
<td>4</td>
<td>2Q</td>
<td>Higher</td>
<td>2Q</td>
</tr>
<tr class="odd">
<td>Hot + Cold mix</td>
<td>4</td>
<td>2Q</td>
<td>Better stability</td>
<td>2Q</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-34" class="level4">
<h4 class="anchored" data-anchor-id="complexity-34">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> (with linked lists or queues)</li>
<li>Space: <span class="math inline">\(O(C)\)</span> (two queues)</li>
<li>Adaptation: static ratio (manual tuning)</li>
</ul>
<p>2Q is the street-smart LRU, it doesn’t trust new pages right away. They must prove their worth before joining the inner circle of trusted, frequently used data.</p>
</section>
</section>
<section id="lirs-low-inter-reference-recency-set" class="level3">
<h3 class="anchored" data-anchor-id="lirs-low-inter-reference-recency-set">837 LIRS (Low Inter-reference Recency Set)</h3>
<p>LIRS (Low Inter-reference Recency Set) is a high-performance cache replacement algorithm that refines LRU by distinguishing truly hot pages from temporarily popular ones. It measures reuse distance rather than just recency, capturing deeper temporal patterns in access behavior.</p>
<p>Invented by Jiang and Zhang (2002), LIRS achieves lower miss rates than LRU and ARC in workloads with irregular reuse patterns.</p>
<section id="what-problem-are-we-solving-35" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-35">What Problem Are We Solving?</h4>
<p>LRU ranks pages by time since last access, assuming that recently used pages will be used again soon. But this fails when some pages are accessed once per long interval, they still appear “recent” but aren’t hot.</p>
<p>LIRS improves upon this by ranking pages by their reuse distance:</p>
<blockquote class="blockquote">
<p>“How recently has this page been reused, compared to others?”</p>
</blockquote>
<p>The smaller the reuse distance, the more likely the page will be reused again.</p>
</section>
<section id="how-does-it-work-plain-language-35" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-35">How Does It Work (Plain Language)</h4>
<p>LIRS maintains two sets:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 26%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Set</th>
<th>Meaning</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>LIR (Low Inter-reference Recency)</td>
<td>Frequently reused pages</td>
<td>Kept in cache</td>
</tr>
<tr class="even">
<td>HIR (High Inter-reference Recency)</td>
<td>Rarely reused or new pages</td>
<td>Some resident, most only recorded</td>
</tr>
</tbody>
</table>
<p>All pages (resident or not) are tracked in a stack S, ordered by <em>recency</em>. A subset Q of S contains the <em>resident HIR</em> pages.</p>
<p>When a page is accessed:</p>
<ol type="1">
<li>If it’s in LIR → move it to the top (most recent).</li>
<li>If it’s in HIR (resident) → promote it to LIR; demote the least recent LIR to HIR.</li>
<li>If it’s not resident → add it as HIR; evict oldest resident HIR if needed.</li>
<li>Trim the bottom of stack S to remove obsolete entries (non-resident and non-referenced).</li>
</ol>
<p>Thus, LIRS dynamically adjusts based on actual reuse distance, not just latest access.</p>
</section>
<section id="example-walkthrough-28" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-28">Example Walkthrough</h4>
<p>Cache size = 3 Access sequence: <code>A, B, C, D, A, B, E, A, B, C</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>LIR</th>
<th>HIR (Resident)</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A B</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A B C</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>B C</td>
<td>D</td>
<td>Evict A</td>
</tr>
<tr class="odd">
<td>5</td>
<td>A</td>
<td>C D</td>
<td>A</td>
<td>Evict B</td>
</tr>
<tr class="even">
<td>6</td>
<td>B</td>
<td>D A</td>
<td>B</td>
<td>Evict C</td>
</tr>
<tr class="odd">
<td>7</td>
<td>E</td>
<td>A B</td>
<td>E</td>
<td>Evict D</td>
</tr>
<tr class="even">
<td>8</td>
<td>A</td>
<td>B E</td>
<td>A</td>
<td>Evict none (A reused)</td>
</tr>
<tr class="odd">
<td>9</td>
<td>B</td>
<td>E A</td>
<td>B</td>
<td>-</td>
</tr>
<tr class="even">
<td>10</td>
<td>C</td>
<td>A B</td>
<td>C</td>
<td>Evict E</td>
</tr>
</tbody>
</table>
<p>Hot pages (A,B) stay stable in LIR; cold ones cycle through HIR.</p>
</section>
<section id="tiny-code-conceptual-simulation-21" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-21">Tiny Code (Conceptual Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Page <span class="op">{</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> key<span class="op">;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> isLIR<span class="op">,</span> resident<span class="op">;</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Page<span class="op">;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>Page cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">].</span>key <span class="op">==</span> key<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>i<span class="op">].</span>isLIR <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>Page<span class="op">){</span>key<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> victim <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>cache<span class="op">[</span>i<span class="op">].</span>isLIR<span class="op">)</span> <span class="op">{</span> victim <span class="op">=</span> i<span class="op">;</span> <span class="cf">break</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c</span><span class="st"> (HIR)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>victim<span class="op">].</span>key<span class="op">);</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>    cache<span class="op">[</span>victim<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>Page<span class="op">){</span>key<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">};</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>(Simplified logic; real LIRS maintains stack S and set Q explicitly.)</em></p>
</section>
<section id="why-it-matters-35" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-35">Why It Matters</h4>
<ul>
<li>Higher hit ratio than LRU for mixed workloads</li>
<li>Handles scans gracefully (avoids LRU thrashing)</li>
<li>Adapts dynamically without manual tuning</li>
<li>Used in: database buffer pools, SSD caching, OS kernels</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>More bookkeeping (stack and sets)</li>
<li>Slightly higher overhead than LRU</li>
<li>Harder to implement from scratch</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-26" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-26">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(r(p)\)</span> be the inter-reference recency of page <span class="math inline">\(p\)</span> (the number of distinct pages accessed between two uses of <span class="math inline">\(p\)</span>). LIRS retains pages with low <span class="math inline">\(r(p)\)</span> (frequent reuse).</p>
<p>Over time, the algorithm maintains:</p>
<ul>
<li>LIR set = pages with small <span class="math inline">\(r(p)\)</span></li>
<li>HIR set = pages with large <span class="math inline">\(r(p)\)</span></li>
</ul>
<p>Since low-<span class="math inline">\(r\)</span> pages minimize expected misses, LIRS approximates OPT (Belady’s optimal) more closely than LRU.</p>
<p>Formally, the LIR set approximates: <span class="math display">\[
\text{LIR} = \arg\min_{|S| = C} \sum_{p \in S} r(p)
\]</span></p>
</section>
<section id="try-it-yourself-35" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-35">Try It Yourself</h4>
<ol type="1">
<li>Simulate LIRS on sequence <code>A B C D A B E A B C</code>.</li>
<li>Compare with LRU, LIRS avoids excessive evictions.</li>
<li>Add a large scan (<code>A B C D E F G A</code>), note fewer misses.</li>
<li>Visualize reuse distances, see how LIR stabilizes.</li>
<li>Experiment with different cache sizes.</li>
</ol>
</section>
<section id="test-cases-35" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-35">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Sequence</th>
<th>Policy</th>
<th>Miss Rate</th>
<th>Winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Repeating (A,B,C,A,B,C)</td>
<td>LRU</td>
<td>Low</td>
<td>Tie</td>
</tr>
<tr class="even">
<td>Scanning (A,B,C,D,E)</td>
<td>LRU</td>
<td>High</td>
<td>LIRS</td>
</tr>
<tr class="odd">
<td>Mixed reuse</td>
<td>LIRS</td>
<td>Lowest</td>
<td>LIRS</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-35" class="level4">
<h4 class="anchored" data-anchor-id="complexity-35">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> (amortized, with stack trimming)</li>
<li>Space: <span class="math inline">\(O(C)\)</span> (cache + metadata)</li>
<li>Adaptivity: automatic</li>
</ul>
<p>LIRS is the strategist of cache algorithms, it doesn’t just remember <em>when</em> you used something, it remembers <em>how regularly</em> you come back to it, and prioritizes accordingly.</p>
</section>
</section>
<section id="tinylfu-tiny-least-frequently-used" class="level3">
<h3 class="anchored" data-anchor-id="tinylfu-tiny-least-frequently-used">838 TinyLFU (Tiny Least Frequently Used)</h3>
<p>TinyLFU is a modern, probabilistic cache admission policy that tracks item frequencies using compact counters instead of storing full histories. It decides which items deserve to enter the cache rather than which ones to evict directly, often combined with another policy like LRU or ARC.</p>
<p>TinyLFU powers real-world systems like Caffeine (Java cache) and modern web caching layers, achieving near-optimal hit rates with minimal memory.</p>
<section id="what-problem-are-we-solving-36" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-36">What Problem Are We Solving?</h4>
<p>Classic LFU requires storing a frequency counter for every cached item, which is space-expensive. Also, it updates counters even for items that are soon evicted, wasting memory and CPU.</p>
<p>TinyLFU solves both problems by using approximate counting with a fixed-size sketch to record frequencies of recently seen items. It makes admission decisions probabilistically, keeping only items that are <em>more popular</em> than the one being evicted.</p>
<blockquote class="blockquote">
<p>“Don’t just evict wisely, admit wisely.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-36" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-36">How Does It Work (Plain Language)</h4>
<p>TinyLFU consists of two key ideas:</p>
<ol type="1">
<li><p>Frequency Sketch</p>
<ul>
<li>A compact counter structure (like a <em>count-min sketch</em>) tracks how often items are seen in a sliding window.</li>
<li>Old frequencies are decayed periodically.</li>
</ul></li>
<li><p>Admission Policy</p>
<ul>
<li><p>When the cache is full and a new item arrives:</p>
<ul>
<li>Estimate its frequency <code>f_new</code></li>
<li>Compare to the victim’s frequency <code>f_victim</code></li>
<li>If <code>f_new &gt; f_victim</code>, admit the new item</li>
<li>Else, reject it (keep the old one)</li>
</ul></li>
</ul></li>
</ol>
<p>Thus, TinyLFU doesn’t blindly replace, it asks:</p>
<blockquote class="blockquote">
<p>“Is this newcomer really more popular than the current tenant?”</p>
</blockquote>
</section>
<section id="example-walkthrough-29" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-29">Example Walkthrough</h4>
<p>Cache capacity = 3 Access sequence: <code>A, B, C, D, A, E, A, F</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Frequency Estimates</th>
<th>Decision</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A:1</td>
<td>Admit</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>B:1</td>
<td>Admit</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>C:1</td>
<td>Admit</td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>D:1, Victim C:1</td>
<td>Reject (equal)</td>
</tr>
<tr class="odd">
<td>5</td>
<td>A</td>
<td>A:2</td>
<td>Keep</td>
</tr>
<tr class="even">
<td>6</td>
<td>E</td>
<td>E:1, Victim B:1</td>
<td>Reject</td>
</tr>
<tr class="odd">
<td>7</td>
<td>A</td>
<td>A:3</td>
<td>Keep</td>
</tr>
<tr class="even">
<td>8</td>
<td>F</td>
<td>F:1, Victim B:1</td>
<td>Reject</td>
</tr>
</tbody>
</table>
<p>Result: Cache stabilizes with A (3), B (1), C (1). Most frequent item A dominates, efficient memory use.</p>
</section>
<section id="tiny-code-conceptual-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-pseudocode">Tiny Code (Conceptual Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>cache<span class="op">.</span>contains<span class="op">(</span>x<span class="op">))</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// hit: increase frequency</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    sketch<span class="op">.</span>increment<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// miss: estimate frequency</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> f_new <span class="op">=</span> sketch<span class="op">.</span>estimate<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> f_victim <span class="op">=</span> sketch<span class="op">.</span>estimate<span class="op">(</span>victim<span class="op">);</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>f_new <span class="op">&gt;</span> f_victim<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        evict<span class="op">(</span>victim<span class="op">);</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">.</span>insert<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    sketch<span class="op">.</span>increment<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The sketch here is a fixed-size table of hashed counters, updated probabilistically to save space.</p>
</section>
<section id="why-it-matters-36" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-36">Why It Matters</h4>
<ul>
<li>Space-efficient: approximate counters, no per-item state</li>
<li>High performance: near-optimal hit rate for dynamic workloads</li>
<li>Works with others: often paired with LRU or CLOCK for recency tracking</li>
<li>Resistant to scan pollution: ignores rare or one-shot items</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Probabilistic errors: counter collisions cause small inaccuracies</li>
<li>Extra computation: requires hashing and frequency comparison</li>
<li>No strict ordering: depends on approximate popularity</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-27" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-27">A Gentle Proof (Why It Works)</h4>
<p>TinyLFU estimates frequencies over a recent access window of size <span class="math inline">\(W\)</span>. Each counter represents a bin in a <em>count-min sketch</em>, so for an item <span class="math inline">\(x\)</span>, frequency is approximated as:</p>
<p><span class="math display">\[
\hat{f}(x) = \min_{i} C[h_i(x)]
\]</span></p>
<p>where <span class="math inline">\(C\)</span> are the counters and <span class="math inline">\(h_i\)</span> are hash functions.</p>
<p>New items are admitted only if:</p>
<p><span class="math display">\[
\hat{f}(x_\text{new}) &gt; \hat{f}(x_\text{victim})
\]</span></p>
<p>This ensures the cache tends toward frequency-optimal content while keeping space complexity <span class="math inline">\(O(\log n)\)</span> instead of <span class="math inline">\(O(n)\)</span>.</p>
<p>Since frequencies decay periodically, the sketch naturally forgets old data, keeping focus on recent popularity.</p>
</section>
<section id="try-it-yourself-36" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-36">Try It Yourself</h4>
<ol type="1">
<li>Implement a count-min sketch (4 hash functions, 1024 counters).</li>
<li>Run sequence <code>A B C D A E A F</code>.</li>
<li>Observe which items are admitted vs rejected.</li>
<li>Compare with LFU, see how TinyLFU mimics it with 1% of the space.</li>
<li>Integrate with LRU for eviction, “W-TinyLFU”.</li>
</ol>
</section>
<section id="test-cases-36" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-36">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Sequence</th>
<th>Policy</th>
<th>Miss Rate</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A B C D A E A F</td>
<td>LFU</td>
<td>0.50</td>
<td>baseline</td>
</tr>
<tr class="even">
<td>A B C D A E A F</td>
<td>TinyLFU</td>
<td>0.33</td>
<td>better hit rate</td>
</tr>
<tr class="odd">
<td>Streaming + hot</td>
<td>TinyLFU</td>
<td>lowest</td>
<td>adaptively filtered</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-36" class="level4">
<h4 class="anchored" data-anchor-id="complexity-36">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span> (hashing + counter ops)</li>
<li>Space: <span class="math inline">\(O(k \log W)\)</span> for sketch</li>
<li>Eviction: paired with LRU or CLOCK</li>
</ul>
<p>TinyLFU is the gatekeeper of modern caches, small, fast, and smart enough to remember what truly matters, admitting only the worthy into memory.</p>
</section>
</section>
<section id="random-replacement" class="level3">
<h3 class="anchored" data-anchor-id="random-replacement">839 Random Replacement</h3>
<p>Random Replacement is the simplest cache eviction strategy imaginable. When the cache is full and a new item arrives, it evicts a randomly chosen existing item. No recency, no frequency, just chance.</p>
<p>It sounds naive, but surprisingly, Random Replacement performs reasonably well for certain workloads and serves as a baseline for evaluating smarter policies like LRU or ARC.</p>
<section id="what-problem-are-we-solving-37" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-37">What Problem Are We Solving?</h4>
<p>In constrained environments (hardware caches, embedded systems, or high-speed switches), maintaining detailed metadata for LRU or LFU can be too expensive. Updating access timestamps or maintaining linked lists every hit costs time and memory.</p>
<p>Random Replacement eliminates that cost. It trades precision for simplicity and speed.</p>
<blockquote class="blockquote">
<p>“When you can’t decide who to evict, let randomness decide.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-37" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-37">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>On every access:</p>
<ul>
<li>If the item is in the cache, it’s a hit.</li>
<li>If not, it’s a miss.</li>
</ul></li>
<li><p>If cache is full:</p>
<ul>
<li>Pick a random slot.</li>
<li>Replace that item with the new one.</li>
</ul></li>
<li><p>Otherwise, just insert the new item.</p></li>
</ol>
<p>No ordering, no tracking, no statistics.</p>
</section>
<section id="example-walkthrough-30" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-30">Example Walkthrough</h4>
<p>Cache capacity = 3 Access sequence: <code>A, B, C, D, B, A, E</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Cache Contents</th>
<th>Eviction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>A</td>
<td>-</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A B</td>
<td>-</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A B C</td>
<td>-</td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>B C D</td>
<td>Evict random (A)</td>
</tr>
<tr class="odd">
<td>5</td>
<td>B</td>
<td>B C D</td>
<td>-</td>
</tr>
<tr class="even">
<td>6</td>
<td>A</td>
<td>C D A</td>
<td>Evict random (B)</td>
</tr>
<tr class="odd">
<td>7</td>
<td>E</td>
<td>D A E</td>
<td>Evict random (C)</td>
</tr>
</tbody>
</table>
<p>Each eviction is uniform at random, so behavior varies per run, but overall, Random keeps the cache populated with recent and older items in roughly balanced proportions.</p>
</section>
<section id="tiny-code-c-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-5">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> in_cache<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> key<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>in_cache<span class="op">(</span>key<span class="op">))</span> <span class="op">{</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> victim <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> CAP<span class="op">;</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c</span><span class="st"> (random)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>victim<span class="op">]);</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">[</span>victim<span class="op">]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    srand<span class="op">(</span>time<span class="op">(</span>NULL<span class="op">));</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">};</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">7</span><span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>seq<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-37" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-37">Why It Matters</h4>
<ul>
<li>No metadata overhead, just a simple array</li>
<li>Constant time for all operations</li>
<li>Useful baseline to test cache efficiency</li>
<li>Robust under uniform workloads</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Poor locality capture, ignores recency and frequency</li>
<li>Unpredictable performance</li>
<li>Can evict hot pages accidentally</li>
</ul>
<p>Still, Random is common in hardware caches (like TLBs) where simplicity and speed are crucial.</p>
</section>
<section id="a-gentle-proof-why-it-works-28" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-28">A Gentle Proof (Why It Works)</h4>
<p>In steady state, every item in the cache has an equal chance <span class="math inline">\(1/C\)</span> of being evicted on each miss. For items with uniform access probability, the hit ratio is roughly:</p>
<p><span class="math display">\[
H = 1 - \frac{1}{C + 1}
\]</span></p>
<p>This means Random Replacement achieves about the same hit rate as LRU for uniform random access, but performs worse under temporal locality.</p>
<p>As cache size increases, variance smooths out and hit rate converges.</p>
</section>
<section id="try-it-yourself-37" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-37">Try It Yourself</h4>
<ol type="1">
<li>Simulate 100 random access sequences (e.g., over 10 items, cache size 3).</li>
<li>Measure average hit ratio.</li>
<li>Compare with LRU and LFU, note how Random stays consistent but never optimal.</li>
<li>Try with skewed access patterns (Zipfian), Random falls behind.</li>
<li>Measure standard deviation, Random’s variance is small in large systems.</li>
</ol>
</section>
<section id="test-cases-37" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-37">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Sequence</th>
<th>Policy</th>
<th>Cache Size</th>
<th>Miss Rate</th>
<th>Winner</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Uniform Random Access</td>
<td>Random</td>
<td>3</td>
<td>Low</td>
<td>≈LRU</td>
</tr>
<tr class="even">
<td>Hot + Cold Mix</td>
<td>Random</td>
<td>3</td>
<td>Higher</td>
<td>LRU</td>
</tr>
<tr class="odd">
<td>Sequential Scan</td>
<td>Random</td>
<td>3</td>
<td>Similar</td>
<td>FIFO</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-37" class="level4">
<h4 class="anchored" data-anchor-id="complexity-37">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(1)\)</span></li>
<li>Space: <span class="math inline">\(O(C)\)</span></li>
<li>No bookkeeping overhead</li>
</ul>
<p>Random Replacement is the coin flip of caching, it doesn’t remember or predict, yet it stays surprisingly stable. When simplicity and speed are king, randomness is enough.</p>
</section>
</section>
<section id="beladys-optimal-algorithm-opt" class="level3">
<h3 class="anchored" data-anchor-id="beladys-optimal-algorithm-opt">840 Belady’s Optimal Algorithm (OPT)</h3>
<p>Belady’s Optimal Algorithm, often called OPT, is the theoretical gold standard of cache replacement. It knows the future: at each eviction, it removes the item that will not be used for the longest time in the future.</p>
<p>No real cache can implement this perfectly (since we can’t see the future), but OPT serves as the benchmark against which all practical algorithms (LRU, LFU, ARC, etc.) are measured.</p>
<section id="what-problem-are-we-solving-38" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-38">What Problem Are We Solving?</h4>
<p>Every cache replacement policy tries to minimize cache misses. But all practical algorithms rely only on past and present access patterns.</p>
<p>Belady’s OPT assumes perfect foresight, it can see the entire future access sequence and thus make the globally optimal choice at every step.</p>
<blockquote class="blockquote">
<p>“If you know what’s coming next, you’ll never make the wrong eviction.”</p>
</blockquote>
<p>It gives the lowest possible miss rate for any given access trace and cache size.</p>
</section>
<section id="how-does-it-work-plain-language-38" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-38">How Does It Work (Plain Language)</h4>
<p>When the cache is full and a new item must be inserted:</p>
<ol type="1">
<li><p>Look ahead in the future access sequence.</p></li>
<li><p>For each item currently in the cache, find when it will be used next.</p></li>
<li><p>Evict the item whose next use is farthest in the future.</p>
<ul>
<li>If an item is never used again, it’s the perfect victim.</li>
</ul></li>
</ol>
<p>That’s it, simple in concept, impossible in practice.</p>
</section>
<section id="example-walkthrough-31" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-31">Example Walkthrough</h4>
<p>Cache capacity = 3 Access sequence: <code>A, B, C, D, A, B, E, A, B, C, D, E</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 19%">
<col style="width: 26%">
<col style="width: 22%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Access</th>
<th>Cache (before)</th>
<th>Future Uses</th>
<th>Evict</th>
<th>Cache (after)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>A</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>A</td>
<td>-</td>
<td>-</td>
<td>A B</td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>A B</td>
<td>-</td>
<td>-</td>
<td>A B C</td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>A B C</td>
<td>A(5), B(6), C(9)</td>
<td>C (farthest)</td>
<td>A B D</td>
</tr>
<tr class="odd">
<td>5</td>
<td>A</td>
<td>A B D</td>
<td>B(6), D(10)</td>
<td>-</td>
<td>A B D</td>
</tr>
<tr class="even">
<td>6</td>
<td>B</td>
<td>A B D</td>
<td>A(8), D(10)</td>
<td>-</td>
<td>A B D</td>
</tr>
<tr class="odd">
<td>7</td>
<td>E</td>
<td>A B D</td>
<td>A(8), B(9), D(10)</td>
<td>D (farthest)</td>
<td>A B E</td>
</tr>
<tr class="even">
<td>8</td>
<td>A</td>
<td>A B E</td>
<td>B(9), E(12)</td>
<td>-</td>
<td>A B E</td>
</tr>
<tr class="odd">
<td>9</td>
<td>B</td>
<td>A B E</td>
<td>A(10), E(12)</td>
<td>-</td>
<td>A B E</td>
</tr>
<tr class="even">
<td>10</td>
<td>C</td>
<td>A B E</td>
<td>A(10), B(11), E(12)</td>
<td>E (farthest)</td>
<td>A B C</td>
</tr>
<tr class="odd">
<td>11</td>
<td>D</td>
<td>A B C</td>
<td>A(10), B(11), C(-)</td>
<td>C (never reused)</td>
<td>A B D</td>
</tr>
<tr class="even">
<td>12</td>
<td>E</td>
<td>A B D</td>
<td>A(-), B(-), D(-)</td>
<td>any</td>
<td>A B E</td>
</tr>
</tbody>
</table>
<p>Result: minimal possible misses, no other policy can do better.</p>
</section>
<section id="tiny-code-c-for-simulation" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-for-simulation">Tiny Code (C, for simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CAP </span><span class="dv">3</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SEQ_LEN </span><span class="dv">12</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> seq<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">,</span><span class="ch">'A'</span><span class="op">,</span><span class="ch">'B'</span><span class="op">,</span><span class="ch">'C'</span><span class="op">,</span><span class="ch">'D'</span><span class="op">,</span><span class="ch">'E'</span><span class="op">};</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> cache<span class="op">[</span>CAP<span class="op">];</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> find<span class="op">(</span><span class="dt">char</span> key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cache<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> key<span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> next_use<span class="op">(</span><span class="dt">char</span> key<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> pos <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> SEQ_LEN<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>seq<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> key<span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">999</span><span class="op">;</span> <span class="co">// infinity (never used again)</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> access<span class="op">(</span><span class="dt">int</span> pos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> key <span class="op">=</span> seq<span class="op">[</span>pos<span class="op">];</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>find<span class="op">(</span>key<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (hit)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Access </span><span class="sc">%c</span><span class="st"> (miss)</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>size <span class="op">&lt;</span> CAP<span class="op">)</span> <span class="op">{</span> cache<span class="op">[</span>size<span class="op">++]</span> <span class="op">=</span> key<span class="op">;</span> <span class="cf">return</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// OPT eviction</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> victim <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> farthest <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> next <span class="op">=</span> next_use<span class="op">(</span>cache<span class="op">[</span>i<span class="op">],</span> pos<span class="op">);</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>next <span class="op">&gt;</span> farthest<span class="op">)</span> <span class="op">{</span> farthest <span class="op">=</span> next<span class="op">;</span> victim <span class="op">=</span> i<span class="op">;</span> <span class="op">}</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Evict </span><span class="sc">%c\n</span><span class="st">"</span><span class="op">,</span> cache<span class="op">[</span>victim<span class="op">]);</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>    cache<span class="op">[</span>victim<span class="op">]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> SEQ_LEN<span class="op">;</span> i<span class="op">++)</span> access<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-38" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-38">Why It Matters</h4>
<ul>
<li>Defines the theoretical lower bound of cache misses</li>
<li>Benchmark for evaluating other policies</li>
<li>Helps prove optimality gaps (how close LRU or ARC gets)</li>
<li>Conceptually simple, analytically powerful</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires complete future knowledge (impossible in real systems)</li>
<li>Offline only, but essential for simulation and research</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-29" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-29">A Gentle Proof (Why It Works)</h4>
<p>Let the future access sequence be <span class="math inline">\(S = [s_1, s_2, \dots, s_n]\)</span> and cache capacity <span class="math inline">\(C\)</span>.</p>
<p>At any time <span class="math inline">\(t\)</span>, OPT evicts the page <span class="math inline">\(p\)</span> whose next reference <span class="math inline">\(r(p)\)</span> satisfies:</p>
<p><span class="math display">\[
r(p) = \max_{x \in \text{cache}} \text{next}(x)
\]</span></p>
<p>meaning: the item used farthest in the future.</p>
<p>By induction on the sequence:</p>
<ul>
<li>At each step, OPT minimizes misses for prefix <span class="math inline">\(S_t\)</span>.</li>
<li>Evicting any other page cannot lead to fewer future misses, since that page would be needed sooner.</li>
</ul>
<p>Thus, OPT produces the minimal miss count among all possible policies.</p>
</section>
<section id="try-it-yourself-38" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-38">Try It Yourself</h4>
<ol type="1">
<li>Simulate the sequence <code>A B C D A B E A B C D E</code>.</li>
<li>Compare miss rates of LRU, FIFO, and OPT.</li>
<li>Observe that no policy beats OPT.</li>
<li>Increase cache size → measure diminishing returns.</li>
<li>Use OPT as ground truth for evaluating custom algorithms.</li>
</ol>
</section>
<section id="test-cases-38" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-38">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 35%">
<col style="width: 15%">
<col style="width: 17%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Cache Size</th>
<th>Sequence</th>
<th>LRU Misses</th>
<th>FIFO Misses</th>
<th>OPT Misses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>A B C D A B E A B C D E</td>
<td>9</td>
<td>10</td>
<td>7</td>
</tr>
<tr class="even">
<td>2</td>
<td>A B A B A B</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<td>4</td>
<td>A B C D A B C D</td>
<td>4</td>
<td>4</td>
<td>4</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-38" class="level4">
<h4 class="anchored" data-anchor-id="complexity-38">Complexity</h4>
<ul>
<li>Access: <span class="math inline">\(O(C)\)</span> (linear scan of cache)</li>
<li>Next-use lookup: <span class="math inline">\(O(N)\)</span> per access (can be precomputed)</li>
<li>Overall: <span class="math inline">\(O(NC)\)</span> simulation</li>
</ul>
<p>Belady’s OPT is the oracle of caching, perfect in hindsight, impossible in foresight. Every practical algorithm strives to approximate its wisdom, one cache miss at a time.</p>
</section>
</section>
</section>
<section id="section-85.-networking" class="level1">
<h1>Section 85. Networking</h1>
<section id="dijkstras-routing-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="dijkstras-routing-algorithm">841 Dijkstra’s Routing Algorithm</h3>
<p>Dijkstra’s Algorithm finds the shortest path from a source node to all other nodes in a graph with non-negative edge weights. It forms the basis of link-state routing protocols like OSPF (Open Shortest Path First), used in modern computer networks to determine efficient routes for data packets.</p>
<section id="what-problem-are-we-solving-39" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-39">What Problem Are We Solving?</h4>
<p>In a network of routers, each link has a cost, representing delay, congestion, or distance. The goal is to compute the shortest (lowest-cost) path from one router to all others, ensuring that packets travel efficiently.</p>
<p>Formally, given a graph <span class="math inline">\(G = (V, E)\)</span> with edge weights <span class="math inline">\(w(u, v) \ge 0\)</span>, find the minimal total cost from source <span class="math inline">\(s\)</span> to every vertex <span class="math inline">\(v \in V\)</span>.</p>
<blockquote class="blockquote">
<p>“We need to know how to go everywhere, and how far it really is.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-39" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-39">How Does It Work (Plain Language)</h4>
<p>Dijkstra’s algorithm grows a tree of shortest paths starting from the source. At each step, it expands the closest unvisited node and relaxes its neighbors.</p>
<ol type="1">
<li><p>Start with the source node <span class="math inline">\(s\)</span>, distance <span class="math inline">\(d[s] = 0\)</span>.</p></li>
<li><p>All other nodes get <span class="math inline">\(d[v] = \infty\)</span> initially.</p></li>
<li><p>Repeatedly:</p>
<ul>
<li><p>Pick the node <span class="math inline">\(u\)</span> with the smallest tentative distance.</p></li>
<li><p>Mark it as <em>visited</em> (its distance is now final).</p></li>
<li><p>For each neighbor <span class="math inline">\(v\)</span> of <span class="math inline">\(u\)</span>:</p>
<ul>
<li>If <span class="math inline">\(d[v] &gt; d[u] + w(u, v)\)</span>, update <span class="math inline">\(d[v]\)</span>.</li>
</ul></li>
</ul></li>
</ol>
<p>Continue until all nodes are visited.</p>
</section>
<section id="example-walkthrough-32" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-32">Example Walkthrough</h4>
<p>Graph:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Edge</th>
<th>Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A → B</td>
<td>4</td>
</tr>
<tr class="even">
<td>A → C</td>
<td>2</td>
</tr>
<tr class="odd">
<td>B → C</td>
<td>3</td>
</tr>
<tr class="even">
<td>B → D</td>
<td>2</td>
</tr>
<tr class="odd">
<td>C → D</td>
<td>4</td>
</tr>
<tr class="even">
<td>D → E</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Start: A</p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 16%">
<col style="width: 58%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Visited</th>
<th>Tentative Distances (A, B, C, D, E)</th>
<th>Chosen Node</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>-</td>
<td>(0, ∞, ∞, ∞, ∞)</td>
<td>A</td>
</tr>
<tr class="even">
<td>2</td>
<td>A</td>
<td>(0, 4, 2, ∞, ∞)</td>
<td>C</td>
</tr>
<tr class="odd">
<td>3</td>
<td>A, C</td>
<td>(0, 4, 2, 6, ∞)</td>
<td>B</td>
</tr>
<tr class="even">
<td>4</td>
<td>A, C, B</td>
<td>(0, 4, 2, 6, ∞)</td>
<td>D</td>
</tr>
<tr class="odd">
<td>5</td>
<td>A, C, B, D</td>
<td>(0, 4, 2, 6, 7)</td>
<td>E</td>
</tr>
</tbody>
</table>
<p>Shortest paths from A:</p>
<ul>
<li>A→C = 2</li>
<li>A→B = 4</li>
<li>A→D = 6</li>
<li>A→E = 7</li>
</ul>
</section>
<section id="tiny-code-c-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-6">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define V </span><span class="dv">5</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> minDistance<span class="op">(</span><span class="dt">int</span> dist<span class="op">[],</span> <span class="dt">int</span> visited<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> min <span class="op">=</span> INT_MAX<span class="op">,</span> min_index <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> v <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> v <span class="op">&lt;</span> V<span class="op">;</span> v<span class="op">++)</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>v<span class="op">]</span> <span class="op">&amp;&amp;</span> dist<span class="op">[</span>v<span class="op">]</span> <span class="op">&lt;=</span> min<span class="op">)</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>            min <span class="op">=</span> dist<span class="op">[</span>v<span class="op">],</span> min_index <span class="op">=</span> v<span class="op">;</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> min_index<span class="op">;</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> dijkstra<span class="op">(</span><span class="dt">int</span> graph<span class="op">[</span>V<span class="op">][</span>V<span class="op">],</span> <span class="dt">int</span> src<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> dist<span class="op">[</span>V<span class="op">],</span> visited<span class="op">[</span>V<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span> dist<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> INT_MAX<span class="op">;</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    dist<span class="op">[</span>src<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> count <span class="op">&lt;</span> V <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> count<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> u <span class="op">=</span> minDistance<span class="op">(</span>dist<span class="op">,</span> visited<span class="op">);</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>        visited<span class="op">[</span>u<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> v <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> v <span class="op">&lt;</span> V<span class="op">;</span> v<span class="op">++)</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>v<span class="op">]</span> <span class="op">&amp;&amp;</span> graph<span class="op">[</span>u<span class="op">][</span>v<span class="op">]</span> <span class="op">&amp;&amp;</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>                dist<span class="op">[</span>u<span class="op">]</span> <span class="op">+</span> graph<span class="op">[</span>u<span class="op">][</span>v<span class="op">]</span> <span class="op">&lt;</span> dist<span class="op">[</span>v<span class="op">])</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>                dist<span class="op">[</span>v<span class="op">]</span> <span class="op">=</span> dist<span class="op">[</span>u<span class="op">]</span> <span class="op">+</span> graph<span class="op">[</span>u<span class="op">][</span>v<span class="op">];</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"A -&gt; </span><span class="sc">%c</span><span class="st"> = </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> <span class="ch">'A'</span> <span class="op">+</span> i<span class="op">,</span> dist<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-39" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-39">Why It Matters</h4>
<ul>
<li>Foundation of routing protocols like OSPF and IS-IS</li>
<li>Guaranteed optimal paths for non-negative weights</li>
<li>Predictable and efficient, runs in polynomial time</li>
<li>Used beyond networks: maps, logistics, games, planning</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slower for large graphs (without heaps)</li>
<li>Requires all edges to have non-negative weights</li>
<li>Needs global topology knowledge (each router must know the map)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-30" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-30">A Gentle Proof (Why It Works)</h4>
<p>Each node is permanently labeled (finalized) when it is the closest possible unvisited node. Suppose a shorter path existed through another unvisited node, it would contradict that we picked the minimum.</p>
<p>Formally, if <span class="math inline">\(d[u]\)</span> is finalized, then:</p>
<p><span class="math display">\[
d[u] = \min_{P: s \to u} \text{cost}(P)
\]</span></p>
<p>The invariant is preserved since every relaxation keeps <span class="math inline">\(d[v]\)</span> as the minimum known distance at all times.</p>
<p>Hence, when all nodes are processed, <span class="math inline">\(d[v]\)</span> holds the true shortest distance.</p>
</section>
<section id="try-it-yourself-39" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-39">Try It Yourself</h4>
<ol type="1">
<li><p>Run Dijkstra on the graph:</p>
<ul>
<li>A→B=1, A→C=4, B→C=2, C→D=1</li>
<li>Find all shortest paths from A.</li>
</ul></li>
<li><p>Modify one edge weight to test stability.</p></li>
<li><p>Add a negative edge (e.g., -2) and observe the failure, it no longer works.</p></li>
<li><p>Compare with Bellman–Ford (842) on the same graph.</p></li>
</ol>
</section>
<section id="test-cases-39" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-39">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 45%">
<col style="width: 8%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>Graph</th>
<th>Source</th>
<th>Result (shortest distances)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A→B=4, A→C=2, B→D=2, C→D=4, D→E=1</td>
<td>A</td>
<td>A:(0), B:(4), C:(2), D:(6), E:(7)</td>
</tr>
<tr class="even">
<td>A→B=1, B→C=1, C→D=1</td>
<td>A</td>
<td>A:(0), B:(1), C:(2), D:(3)</td>
</tr>
<tr class="odd">
<td>A→B=3, A→C=1, C→B=1</td>
<td>A</td>
<td>A:(0), B:(2), C:(1)</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-39" class="level4">
<h4 class="anchored" data-anchor-id="complexity-39">Complexity</h4>
<ul>
<li><p>Time:</p>
<ul>
<li><span class="math inline">\(O(V^2)\)</span> using arrays</li>
<li><span class="math inline">\(O((V + E)\log V)\)</span> with priority queue (heap)</li>
</ul></li>
<li><p>Space: <span class="math inline">\(O(V)\)</span> for distances and visited set</p></li>
</ul>
<p>Dijkstra’s algorithm is the navigator of the network world, it maps every possible route, finds the fastest one, and proves that efficiency is just organized exploration.</p>
</section>
</section>
<section id="bellmanford-routing-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="bellmanford-routing-algorithm">842 Bellman–Ford Routing Algorithm</h3>
<p>Bellman–Ford is the foundation of distance-vector routing protocols such as RIP (Routing Information Protocol). It computes the shortest paths from a single source node to all other nodes, even when edge weights are negative, something Dijkstra’s algorithm cannot handle. It does this through iterative relaxation, propagating distance estimates through the network until convergence.</p>
<section id="what-problem-are-we-solving-40" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-40">What Problem Are We Solving?</h4>
<p>In a network, routers often only know their immediate neighbors, not the entire topology. They need a distributed way to discover routes and adapt when costs change, even if some links become “negative” (e.g., reduced cost or incentive path).</p>
<p>Bellman–Ford allows each router to find minimal path costs using only local communication with neighbors.</p>
<p>Formally, given a weighted graph <span class="math inline">\(G = (V, E)\)</span> and a source <span class="math inline">\(s\)</span>, find <span class="math inline">\(d[v] = \min \text{cost}(s \to v)\)</span> for all <span class="math inline">\(v \in V\)</span>, even when some <span class="math inline">\(w(u, v) &lt; 0\)</span>, as long as there are no negative cycles.</p>
</section>
<section id="how-does-it-work-plain-language-40" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-40">How Does It Work (Plain Language)</h4>
<p>Bellman–Ford updates all edges repeatedly, “relaxing” them, until no further improvements are possible.</p>
<ol type="1">
<li><p>Initialize all distances: <span class="math inline">\(d[s] = 0\)</span>, and <span class="math inline">\(d[v] = \infty\)</span> for all other <span class="math inline">\(v\)</span>.</p></li>
<li><p>Repeat <span class="math inline">\(V - 1\)</span> times:</p>
<ul>
<li><p>For every edge <span class="math inline">\((u, v)\)</span> with weight <span class="math inline">\(w(u, v)\)</span>:</p>
<ul>
<li>If <span class="math inline">\(d[v] &gt; d[u] + w(u, v)\)</span>, update <span class="math inline">\(d[v] = d[u] + w(u, v)\)</span>.</li>
</ul></li>
</ul></li>
<li><p>After <span class="math inline">\(V - 1\)</span> iterations, all shortest paths are found.</p></li>
<li><p>One more pass can detect negative cycles, if any edge can still relax, a cycle exists.</p></li>
</ol>
</section>
<section id="example-walkthrough-33" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-33">Example Walkthrough</h4>
<p>Graph:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Edge</th>
<th>Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A → B</td>
<td>4</td>
</tr>
<tr class="even">
<td>A → C</td>
<td>5</td>
</tr>
<tr class="odd">
<td>B → C</td>
<td>-2</td>
</tr>
<tr class="even">
<td>C → D</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Start: A</p>
<p>Initialization: <span class="math inline">\(d[A]=0\)</span>, <span class="math inline">\(d[B]=\infty\)</span>, <span class="math inline">\(d[C]=\infty\)</span>, <span class="math inline">\(d[D]=\infty\)</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Iteration</th>
<th>Relaxed Edges</th>
<th>Updated Distances <span class="math inline">\((A,B,C,D)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A→B, A→C</td>
<td>(0, 4, 5, ∞)</td>
</tr>
<tr class="even">
<td></td>
<td>B→C</td>
<td>(0, 4, 2, ∞)</td>
</tr>
<tr class="odd">
<td></td>
<td>C→D</td>
<td>(0, 4, 2, 5)</td>
</tr>
<tr class="even">
<td>2</td>
<td>No change</td>
<td>(0, 4, 2, 5)</td>
</tr>
<tr class="odd">
<td>3</td>
<td>No change</td>
<td>(0, 4, 2, 5)</td>
</tr>
</tbody>
</table>
<p>Shortest paths from A: A→B=4, A→C=2, A→D=5</p>
</section>
<section id="tiny-code-c-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-7">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define V </span><span class="dv">4</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define E </span><span class="dv">4</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Edge <span class="op">{</span> <span class="dt">int</span> u<span class="op">,</span> v<span class="op">,</span> w<span class="op">;</span> <span class="op">};</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bellmanFord<span class="op">(</span><span class="kw">struct</span> Edge edges<span class="op">[],</span> <span class="dt">int</span> src<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> dist<span class="op">[</span>V<span class="op">];</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span> dist<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> INT_MAX<span class="op">;</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    dist<span class="op">[</span>src<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> E<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> u <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>u<span class="op">,</span> v <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>v<span class="op">,</span> w <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>dist<span class="op">[</span>u<span class="op">]</span> <span class="op">!=</span> INT_MAX <span class="op">&amp;&amp;</span> dist<span class="op">[</span>u<span class="op">]</span> <span class="op">+</span> w <span class="op">&lt;</span> dist<span class="op">[</span>v<span class="op">])</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                dist<span class="op">[</span>v<span class="op">]</span> <span class="op">=</span> dist<span class="op">[</span>u<span class="op">]</span> <span class="op">+</span> w<span class="op">;</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> E<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> u <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>u<span class="op">,</span> v <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>v<span class="op">,</span> w <span class="op">=</span> edges<span class="op">[</span>j<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>dist<span class="op">[</span>u<span class="op">]</span> <span class="op">!=</span> INT_MAX <span class="op">&amp;&amp;</span> dist<span class="op">[</span>u<span class="op">]</span> <span class="op">+</span> w <span class="op">&lt;</span> dist<span class="op">[</span>v<span class="op">])</span> <span class="op">{</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Negative cycle detected</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"A -&gt; </span><span class="sc">%c</span><span class="st"> = </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> <span class="ch">'A'</span> <span class="op">+</span> i<span class="op">,</span> dist<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Edge edges<span class="op">[</span>E<span class="op">]</span> <span class="op">=</span> <span class="op">{{</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">},{</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span><span class="op">},{</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,-</span><span class="dv">2</span><span class="op">},{</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">}};</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>    bellmanFord<span class="op">(</span>edges<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-40" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-40">Why It Matters</h4>
<ul>
<li>Works with negative weights, unlike Dijkstra</li>
<li>Core of distance-vector routing protocols (RIP)</li>
<li>Easy to distribute, each node only needs neighbor info</li>
<li>Detects routing loops (negative cycles)</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slower than Dijkstra (<span class="math inline">\(O(VE)\)</span>)</li>
<li>Can oscillate in unstable networks if updates are asynchronous</li>
<li>Sensitive to delayed or inconsistent updates between nodes</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-31" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-31">A Gentle Proof (Why It Works)</h4>
<p>Each iteration of Bellman–Ford guarantees that all shortest paths with at most <span class="math inline">\(k\)</span> edges are correctly computed after <span class="math inline">\(k\)</span> relaxations. Since any shortest path can contain at most <span class="math inline">\(V-1\)</span> edges (in a graph with <span class="math inline">\(V\)</span> vertices), after <span class="math inline">\(V-1\)</span> iterations all distances are final.</p>
<p>Formally:</p>
<p><span class="math display">\[
d^{(k)}[v] = \min_{(u,v) \in E}(d^{(k-1)}[u] + w(u,v))
\]</span></p>
<p>After <span class="math inline">\(V-1\)</span> iterations, <span class="math inline">\(d[v] = \min_{P: s \to v} \text{cost}(P)\)</span> for all <span class="math inline">\(v\)</span>.</p>
<p>If a shorter path exists afterward, it must include a cycle, and if that cycle decreases cost, it’s negative.</p>
</section>
<section id="try-it-yourself-40" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-40">Try It Yourself</h4>
<ol type="1">
<li>Build your own graph and run Bellman–Ford manually.</li>
<li>Introduce a negative edge (e.g., B→A = -5) and see how it updates.</li>
<li>Add a negative cycle (A→B=-2, B→A=-2), watch it detect instability.</li>
<li>Compare number of relaxations with Dijkstra’s algorithm.</li>
<li>Implement the distributed version (used in RIP).</li>
</ol>
</section>
<section id="test-cases-40" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-40">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 16%">
<col style="width: 17%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Graph</th>
<th>Negative Edge</th>
<th>Negative Cycle</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A→B=4, A→C=5, B→C=-2, C→D=3</td>
<td>Yes</td>
<td>No</td>
<td>OK (shortest paths found)</td>
</tr>
<tr class="even">
<td>A→B=3, B→C=4, C→A=-8</td>
<td>Yes</td>
<td>Yes</td>
<td>Negative cycle detected</td>
</tr>
<tr class="odd">
<td>A→B=2, A→C=1, C→D=3</td>
<td>No</td>
<td>No</td>
<td>Works fine</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-40" class="level4">
<h4 class="anchored" data-anchor-id="complexity-40">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(VE)\)</span></li>
<li>Space: <span class="math inline">\(O(V)\)</span></li>
<li>For dense graphs, slower than Dijkstra; for sparse graphs, still efficient.</li>
</ul>
<p>Bellman–Ford is the patient messenger of networking, it doesn’t rush, it just keeps updating until everyone knows the truth.</p>
</section>
</section>
<section id="link-state-routing-ospf" class="level3">
<h3 class="anchored" data-anchor-id="link-state-routing-ospf">843 Link-State Routing (OSPF)</h3>
<p>Link-State Routing is the core principle behind modern routing protocols like OSPF (Open Shortest Path First) and IS-IS. Unlike distance-vector protocols (e.g.&nbsp;RIP), where routers share only distances with neighbors, link-state protocols share the entire topology, every node knows the full network map and computes optimal paths using Dijkstra’s algorithm.</p>
<section id="what-problem-are-we-solving-41" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-41">What Problem Are We Solving?</h4>
<p>Routers must find the most efficient path to every other router in a large, changing network. Distance-vector routing (like Bellman–Ford) works but is slow to converge and prone to loops.</p>
<p>Link-State Routing solves this by giving every router a complete and consistent view of the network topology, so each can independently compute shortest paths.</p>
<blockquote class="blockquote">
<p>“Instead of gossiping about distances, every router holds a map of the world.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-41" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-41">How Does It Work (Plain Language)</h4>
<p>Each router performs five key steps:</p>
<ol type="1">
<li><p>Discover neighbors: Send “hello” packets to directly connected routers.</p></li>
<li><p>Measure link costs: Determine delay or cost to each neighbor.</p></li>
<li><p>Build Link-State Packets (LSP): Describe all neighbors and link costs (like a mini adjacency list).</p></li>
<li><p>Flood LSPs through the network: Each router forwards others’ LSPs to ensure everyone has the same map.</p></li>
<li><p>Run Dijkstra’s Algorithm: Compute shortest paths from itself to all destinations.</p></li>
</ol>
<p>When the network changes (a link fails or cost changes), only updated LSPs are flooded, keeping convergence fast and reliable.</p>
</section>
<section id="example-walkthrough-34" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-34">Example Walkthrough</h4>
<p>Suppose we have a small network:</p>
<pre><code>A --1-- B --2-- C
 \      |
  4     3
   \    |
     D--E</code></pre>
<p>Each router advertises its local links:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Router</th>
<th>Advertised Links</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>A–B(1), A–D(4)</td>
</tr>
<tr class="even">
<td>B</td>
<td>B–A(1), B–C(2), B–E(3)</td>
</tr>
<tr class="odd">
<td>C</td>
<td>C–B(2)</td>
</tr>
<tr class="even">
<td>D</td>
<td>D–A(4), D–E(1)</td>
</tr>
<tr class="odd">
<td>E</td>
<td>E–B(3), E–D(1)</td>
</tr>
</tbody>
</table>
<p>After exchanging LSPs, all routers have the same global map.</p>
<p>Router A then runs Dijkstra to compute shortest paths:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Destination</th>
<th>Shortest Path</th>
<th>Total Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>B</td>
<td>A→B</td>
<td>1</td>
</tr>
<tr class="even">
<td>C</td>
<td>A→B→C</td>
<td>3</td>
</tr>
<tr class="odd">
<td>D</td>
<td>A→D</td>
<td>4</td>
</tr>
<tr class="even">
<td>E</td>
<td>A→B→E</td>
<td>4</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-conceptual-simulation-in-python" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-conceptual-simulation-in-python">Tiny Code (Conceptual Simulation in Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dijkstra(graph, src):</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> {v: <span class="bu">float</span>(<span class="st">'inf'</span>) <span class="cf">for</span> v <span class="kw">in</span> graph}</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    dist[src] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    pq <span class="op">=</span> [(<span class="dv">0</span>, src)]</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> pq:</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        d, u <span class="op">=</span> heapq.heappop(pq)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d <span class="op">&gt;</span> dist[u]:</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v, w <span class="kw">in</span> graph[u]:</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> dist[v] <span class="op">&gt;</span> d <span class="op">+</span> w:</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>                dist[v] <span class="op">=</span> d <span class="op">+</span> w</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>                heapq.heappush(pq, (dist[v], v))</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dist</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> {</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A'</span>: [(<span class="st">'B'</span>,<span class="dv">1</span>), (<span class="st">'D'</span>,<span class="dv">4</span>)],</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'B'</span>: [(<span class="st">'A'</span>,<span class="dv">1</span>), (<span class="st">'C'</span>,<span class="dv">2</span>), (<span class="st">'E'</span>,<span class="dv">3</span>)],</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'C'</span>: [(<span class="st">'B'</span>,<span class="dv">2</span>)],</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'D'</span>: [(<span class="st">'A'</span>,<span class="dv">4</span>), (<span class="st">'E'</span>,<span class="dv">1</span>)],</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'E'</span>: [(<span class="st">'B'</span>,<span class="dv">3</span>), (<span class="st">'D'</span>,<span class="dv">1</span>)]</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dijkstra(graph, <span class="st">'A'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output: <code>{'A': 0, 'B': 1, 'C': 3, 'D': 4, 'E': 4}</code></p>
</section>
<section id="why-it-matters-41" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-41">Why It Matters</h4>
<ul>
<li>Fast convergence: all routers update instantly with consistent topology</li>
<li>Loop-free paths: Dijkstra ensures deterministic routes</li>
<li>Scalability: supports hierarchical routing (areas in OSPF)</li>
<li>Flexibility: adapts to cost metrics beyond distance (delay, load, reliability)</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires more memory to store global topology</li>
<li>Flooding overhead for large networks</li>
<li>Complexity in managing link-state databases</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-32" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-32">A Gentle Proof (Why It Works)</h4>
<p>Each router eventually receives an identical set of link-state advertisements, forming the same graph <span class="math inline">\(G=(V,E)\)</span>. Running Dijkstra from its own node <span class="math inline">\(s\)</span> yields:</p>
<p><span class="math display">\[
d[s,v] = \min_{P: s \to v} \sum_{(u,w) \in P} c(u,w)
\]</span></p>
<p>Because every router computes from the same consistent map, the resulting routing tables are loop-free and globally consistent.</p>
<p>If link costs change, only local LSPs are updated, convergence time is proportional to network diameter, not path length.</p>
</section>
<section id="try-it-yourself-41" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-41">Try It Yourself</h4>
<ol type="1">
<li>Create a 5-node network and manually flood link-state messages.</li>
<li>Build a small adjacency list from each router’s perspective.</li>
<li>Run Dijkstra’s algorithm from each router.</li>
<li>Simulate a link failure, e.g., remove A–B, and recompute routes.</li>
<li>Observe how quickly the network re-stabilizes.</li>
</ol>
</section>
<section id="test-cases-41" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-41">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Network</th>
<th>Protocol</th>
<th>Convergence</th>
<th>Loop-Free</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>5 routers, full mesh</td>
<td>OSPF</td>
<td>Fast</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>10 routers, single failure</td>
<td>OSPF</td>
<td>Very fast</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>5 routers, RIP</td>
<td>Slower</td>
<td>Possibly No</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-41" class="level4">
<h4 class="anchored" data-anchor-id="complexity-41">Complexity</h4>
<ul>
<li>Flooding: <span class="math inline">\(O(E)\)</span> for link propagation</li>
<li>Computation: <span class="math inline">\(O(V^2)\)</span> (or <span class="math inline">\(O((V+E)\log V)\)</span> with a heap)</li>
<li>Memory: <span class="math inline">\(O(V + E)\)</span> for topology storage</li>
</ul>
<p>Link-State Routing is the cartographer of the Internet, every router keeps a copy of the world map and recalculates its best path as soon as the landscape changes.</p>
</section>
</section>
<section id="distance-vector-routing-rip" class="level3">
<h3 class="anchored" data-anchor-id="distance-vector-routing-rip">844 Distance-Vector Routing (RIP)</h3>
<p>Distance-Vector Routing is one of the earliest and simplest distributed routing algorithms, forming the basis of RIP (Routing Information Protocol). Each router shares its current view of the world, its “distance vector”, with neighbors, and they iteratively update their own distances until everyone converges on the shortest paths.</p>
<section id="what-problem-are-we-solving-42" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-42">What Problem Are We Solving?</h4>
<p>In large, decentralized networks, routers can’t see the entire topology. They only know how far away their neighbors are and how costly it is to reach them.</p>
<p>The question is:</p>
<blockquote class="blockquote">
<p>“If I only know my neighbors and their distances, can I still find the shortest paths to all destinations?”</p>
</blockquote>
<p>Distance-Vector Routing answers yes, through repeated local updates, routers eventually agree on globally shortest paths.</p>
</section>
<section id="how-does-it-work-plain-language-42" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-42">How Does It Work (Plain Language)</h4>
<p>Each router maintains a distance vector <span class="math inline">\(D[v]\)</span>, which holds its current estimate of the shortest path cost to every other node.</p>
<ol type="1">
<li><p>Initialize:</p>
<ul>
<li><span class="math inline">\(D[s] = 0\)</span> for itself,</li>
<li><span class="math inline">\(D[v] = \infty\)</span> for all others.</li>
</ul></li>
<li><p>Periodically, each router sends its vector to all neighbors.</p></li>
<li><p>When a router receives a vector from a neighbor <span class="math inline">\(N\)</span>, it updates: <span class="math display">\[
D[v] = \min(D[v], \text{cost}(s, N) + D_N[v])
\]</span> where <span class="math inline">\(D_N[v]\)</span> is the neighbor’s advertised cost to <span class="math inline">\(v\)</span>.</p></li>
<li><p>Repeat until no updates occur (network converges).</p></li>
</ol>
<p>This is essentially the distributed form of Bellman–Ford.</p>
</section>
<section id="example-walkthrough-35" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-35">Example Walkthrough</h4>
<p>Network:</p>
<pre><code>A --1-- B --2-- C
 \           /
  \--5-- D--/</code></pre>
<p>Initial distances:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Router</th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>0</td>
<td>1</td>
<td>∞</td>
<td>5</td>
</tr>
<tr class="even">
<td>B</td>
<td>1</td>
<td>0</td>
<td>2</td>
<td>∞</td>
</tr>
<tr class="odd">
<td>C</td>
<td>∞</td>
<td>2</td>
<td>0</td>
<td>3</td>
</tr>
<tr class="even">
<td>D</td>
<td>5</td>
<td>∞</td>
<td>3</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Step 1: A receives vector from B A learns: <span class="math inline">\(D[A,C] = 1 + 2 = 3\)</span> (better than ∞)</p>
<p>Step 2: A receives vector from D A learns: <span class="math inline">\(D[A,C] = \min(3, 5 + 3) = 3\)</span></p>
<p>After convergence, A’s table:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Destination</th>
<th>Next Hop</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>B</td>
<td>B</td>
<td>1</td>
</tr>
<tr class="even">
<td>C</td>
<td>B</td>
<td>3</td>
</tr>
<tr class="odd">
<td>D</td>
<td>D</td>
<td>5</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-c-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-8">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define V </span><span class="dv">4</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define INF </span><span class="dv">999</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> dist<span class="op">[</span>V<span class="op">][</span>V<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> INF<span class="op">,</span> <span class="dv">5</span><span class="op">},</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> INF<span class="op">},</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>INF<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="dv">5</span><span class="op">,</span> INF<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> table<span class="op">[</span>V<span class="op">][</span>V<span class="op">];</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> distanceVector<span class="op">()</span> <span class="op">{</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> V<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>            table<span class="op">[</span>i<span class="op">][</span>j<span class="op">]</span> <span class="op">=</span> dist<span class="op">[</span>i<span class="op">][</span>j<span class="op">];</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> updated<span class="op">;</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        updated <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> V<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;</span> V<span class="op">;</span> k<span class="op">++)</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>table<span class="op">[</span>i<span class="op">][</span>j<span class="op">]</span> <span class="op">&gt;</span> dist<span class="op">[</span>i<span class="op">][</span>k<span class="op">]</span> <span class="op">+</span> table<span class="op">[</span>k<span class="op">][</span>j<span class="op">])</span> <span class="op">{</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>                        table<span class="op">[</span>i<span class="op">][</span>j<span class="op">]</span> <span class="op">=</span> dist<span class="op">[</span>i<span class="op">][</span>k<span class="op">]</span> <span class="op">+</span> table<span class="op">[</span>k<span class="op">][</span>j<span class="op">];</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>                        updated <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>updated<span class="op">);</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> V<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Router </span><span class="sc">%c</span><span class="st">: "</span><span class="op">,</span> <span class="ch">'A'</span><span class="op">+</span>i<span class="op">);</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> V<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"</span><span class="sc">%c</span><span class="st">(</span><span class="sc">%d</span><span class="st">) "</span><span class="op">,</span> <span class="ch">'A'</span><span class="op">+</span>j<span class="op">,</span> table<span class="op">[</span>i<span class="op">][</span>j<span class="op">]);</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span> distanceVector<span class="op">();</span> <span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-42" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-42">Why It Matters</h4>
<ul>
<li>Simple and decentralized, no global map needed</li>
<li>Core of RIP, one of the earliest Internet routing protocols</li>
<li>Each router only talks to its neighbors</li>
<li>Automatically adapts to link failures</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slow convergence, may take many iterations to stabilize</li>
<li>Count-to-infinity problem, loops form during failures</li>
<li>Limited scalability, RIP’s hop count maxes at 15</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-33" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-33">A Gentle Proof (Why It Works)</h4>
<p>Each router <span class="math inline">\(i\)</span> maintains the invariant:</p>
<p><span class="math display">\[
D_i[v] = \min_{(i,j) \in E}(c(i,j) + D_j[v])
\]</span></p>
<p>Initially, only direct links are known. With each exchange, distance estimates propagate one hop further. After at most <span class="math inline">\(V-1\)</span> rounds, all shortest paths (up to length <span class="math inline">\(V-1\)</span>) are known, matching Bellman–Ford’s logic.</p>
<p>Convergence is guaranteed if no link costs change during updates.</p>
</section>
<section id="try-it-yourself-42" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-42">Try It Yourself</h4>
<ol type="1">
<li>Simulate three routers: A–B=1, B–C=1. Watch how C’s distance to A stabilizes after two rounds.</li>
<li>Remove a link temporarily, see “count-to-infinity” occur.</li>
<li>Implement “split horizon” or “poison reverse” to fix it.</li>
<li>Compare update speed with link-state routing (OSPF).</li>
</ol>
</section>
<section id="test-cases-42" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-42">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Network</th>
<th>Protocol</th>
<th>Converges?</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Small mesh (A–B–C–D)</td>
<td>RIP</td>
<td>Yes</td>
<td>Slower, stable</td>
</tr>
<tr class="even">
<td>With link failure</td>
<td>RIP</td>
<td>Eventually</td>
<td>Count-to-infinity issue</td>
</tr>
<tr class="odd">
<td>Fully connected 5-node</td>
<td>RIP</td>
<td>Fast</td>
<td>Stable after few rounds</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-42" class="level4">
<h4 class="anchored" data-anchor-id="complexity-42">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(V \times E)\)</span> (per iteration)</li>
<li>Message Overhead: periodic exchanges per neighbor</li>
<li>Memory: <span class="math inline">\(O(V)\)</span> per router</li>
</ul>
<p>Distance-Vector Routing is the gossip protocol of networks, each router shares what it knows, listens to others, and slowly, the whole network learns the best way to reach everyone else.</p>
</section>
</section>
<section id="path-vector-routing-bgp" class="level3">
<h3 class="anchored" data-anchor-id="path-vector-routing-bgp">845 Path Vector Routing (BGP)</h3>
<p>Path Vector Routing is the foundation of the Internet’s interdomain routing system, the Border Gateway Protocol (BGP). It extends distance-vector routing by including not just the cost, but the entire path to each destination, preventing routing loops and enabling policy-based routing between autonomous systems (ASes).</p>
<section id="what-problem-are-we-solving-43" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-43">What Problem Are We Solving?</h4>
<p>In global Internet routing, we don’t just need the shortest path, we need controllable, loop-free, and policy-respecting paths between independently managed networks (ASes).</p>
<p>Distance-vector algorithms (like RIP) can’t prevent loops or respect policies because they only share costs. We need a richer model, one that includes the path itself.</p>
<blockquote class="blockquote">
<p>“Don’t just tell me how far, tell me which road you’ll take.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-43" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-43">How Does It Work (Plain Language)</h4>
<p>Each node (Autonomous System) advertises:</p>
<ul>
<li>Destination prefixes it can reach</li>
<li>The entire path of AS numbers used to reach them</li>
</ul>
<p>When a router receives an advertisement:</p>
<ol type="1">
<li>It checks the path list to ensure no loops (its own AS number shouldn’t appear).</li>
<li>It may apply routing policies (e.g., prefer customer routes over peer routes).</li>
<li>It updates its routing table if the new path is better by local preference.</li>
</ol>
<p>Then it re-advertises the route to its neighbors, adding its own AS number to the front of the path.</p>
</section>
<section id="example-walkthrough-36" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-36">Example Walkthrough</h4>
<p>Network of four autonomous systems:</p>
<pre><code>AS1 ---- AS2 ---- AS3
   \              /
     \          /
          AS4</code></pre>
<p>Goal: Route traffic between AS1 and AS3.</p>
<p>Initial advertisements:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>AS</th>
<th>Advertised Prefix</th>
<th>Path</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AS3</td>
<td>10.0.0.0/24</td>
<td>[AS3]</td>
</tr>
</tbody>
</table>
<p>Propagation:</p>
<ul>
<li>AS2 receives <code>[AS3]</code>, prepends itself → <code>[AS2, AS3]</code>, advertises to AS1.</li>
<li>AS4 also learns <code>[AS3]</code>, prepends <code>[AS4, AS3]</code>, advertises to AS1.</li>
</ul>
<p>Now AS1 receives two paths to the same destination:</p>
<ul>
<li>Path1: <code>[AS1, AS2, AS3]</code> (via AS2)</li>
<li>Path2: <code>[AS1, AS4, AS3]</code> (via AS4)</li>
</ul>
<p>AS1 applies policy:</p>
<ul>
<li>Prefer shortest path → chooses <code>[AS1, AS2, AS3]</code>.</li>
</ul>
<p>No loops, and everyone’s paths are consistent.</p>
</section>
<section id="tiny-code-simplified-python-simulation" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-simulation">Tiny Code (Simplified Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>routes <span class="op">=</span> {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AS3'</span>: [[<span class="st">'AS3'</span>]]</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> advertise(from_as, to_as, network):</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    new_path <span class="op">=</span> [from_as] <span class="op">+</span> network</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>from_as<span class="sc">}</span><span class="ss"> advertises </span><span class="sc">{</span>new_path<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>to_as<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_path</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co"># AS3 advertises its prefix</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>as2_path <span class="op">=</span> advertise(<span class="st">'AS2'</span>, <span class="st">'AS1'</span>, [<span class="st">'AS3'</span>])</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>as4_path <span class="op">=</span> advertise(<span class="st">'AS4'</span>, <span class="st">'AS1'</span>, [<span class="st">'AS3'</span>])</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co"># AS1 compares routes</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>routes[<span class="st">'AS3'</span>] <span class="op">=</span> [as2_path, as4_path]</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>best <span class="op">=</span> <span class="bu">min</span>(routes[<span class="st">'AS3'</span>], key<span class="op">=</span><span class="bu">len</span>)</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"AS1 chooses path: </span><span class="sc">{</span>best<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>AS2 advertises ['AS2', 'AS3'] to AS1
AS4 advertises ['AS4', 'AS3'] to AS1
AS1 chooses path: ['AS2', 'AS3']</code></pre>
</section>
<section id="why-it-matters-43" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-43">Why It Matters</h4>
<ul>
<li>Scales globally, used by all Internet routers (BGP-4)</li>
<li>Loop-free by design (checks AS path)</li>
<li>Policy-based routing: not just cost, but <em>who</em> you route through</li>
<li>Supports route aggregation (CIDR)</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slower convergence than link-state protocols</li>
<li>Policy conflicts can cause instability</li>
<li>Complex configuration and security risks (route hijacking)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-34" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-34">A Gentle Proof (Why It Works)</h4>
<p>In Path Vector Routing, each route is a tuple:</p>
<p><span class="math display">\[
R = (\text{destination}, \text{AS\_path})
\]</span></p>
<p>A node <span class="math inline">\(i\)</span> accepts a route <span class="math inline">\(R\)</span> from neighbor <span class="math inline">\(j\)</span> iff:</p>
<ol type="1">
<li><span class="math inline">\(i \notin R.\text{AS\_path}\)</span> (no loops)</li>
<li><span class="math inline">\(R\)</span> satisfies <span class="math inline">\(i\)</span>’s local policies</li>
<li><span class="math inline">\(R\)</span> improves over the current best by cost or preference</li>
</ol>
<p>This ensures loop freedom: If any loop formed, an AS would see its own ID in the path and reject it.</p>
<p>Because updates propagate monotonically (paths only grow), convergence is guaranteed when policies are consistent.</p>
</section>
<section id="try-it-yourself-43" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-43">Try It Yourself</h4>
<ol type="1">
<li>Simulate 4 ASes with conflicting policies (AS1 prefers AS2, AS2 prefers AS3, etc.), observe route oscillation.</li>
<li>Add a fake route (AS5 announces AS1’s prefix), simulate route hijack.</li>
<li>Implement loop detection by checking for AS repetition.</li>
<li>Compare convergence time with OSPF or RIP.</li>
</ol>
</section>
<section id="test-cases-43" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-43">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Result</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Normal propagation</td>
<td>Loop-free</td>
<td>Stable</td>
</tr>
<tr class="even">
<td>Policy conflict</td>
<td>Oscillation</td>
<td>Converges slowly</td>
</tr>
<tr class="odd">
<td>Route hijack (fake AS)</td>
<td>Wrong path</td>
<td>Requires security measures</td>
</tr>
<tr class="even">
<td>AS path filtering</td>
<td>Loop-free</td>
<td>Correct convergence</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-43" class="level4">
<h4 class="anchored" data-anchor-id="complexity-43">Complexity</h4>
<ul>
<li>Per router processing: <span class="math inline">\(O(N \log N)\)</span> for <span class="math inline">\(N\)</span> neighbors</li>
<li>Message size: proportional to AS path length</li>
<li>Convergence time: variable (depends on policy conflicts)</li>
</ul>
<p>Path Vector Routing is the diplomat of the Internet, routers don’t just exchange distances, they exchange <em>trust</em>, <em>policies</em>, and <em>stories of how to get there</em>.</p>
</section>
</section>
<section id="flooding-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="flooding-algorithm">846 Flooding Algorithm</h3>
<p>Flooding is the most primitive and reliable way to propagate information across a network, send a message to all neighbors, who then forward it to all of theirs, and so on, until everyone has received it. It’s used as a building block in many systems: link-state routing (OSPF), peer discovery, and epidemic protocols.</p>
<section id="what-problem-are-we-solving-44" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-44">What Problem Are We Solving?</h4>
<p>When a node has new information, say, a new link-state update or a broadcast message, it must ensure every node in the network eventually learns it. Without global knowledge of the topology, the simplest approach is just to flood the message.</p>
<blockquote class="blockquote">
<p>“Tell everyone you know, and ask them to tell everyone they know.”</p>
</blockquote>
<p>Flooding guarantees eventual delivery as long as the network is connected.</p>
</section>
<section id="how-does-it-work-plain-language-44" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-44">How Does It Work (Plain Language)</h4>
<p>Each node maintains a record of messages it has already seen. When a new message arrives:</p>
<ol type="1">
<li>Check ID: If it’s already seen → discard it.</li>
<li>Otherwise: Forward it to all neighbors except the one it came from.</li>
<li>Mark it as delivered.</li>
</ol>
<p>This process continues until the message has spread everywhere. No central coordination is needed.</p>
</section>
<section id="example-walkthrough-37" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-37">Example Walkthrough</h4>
<p>Network:</p>
<pre><code>A --- B --- C
|     |     |
D --- E --- F</code></pre>
<p>Suppose A floods a message with ID = 101.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Node</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>Sends msg(101) to B, D</td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>Forwards to A, C, E (A discards duplicate)</td>
</tr>
<tr class="odd">
<td>3</td>
<td>D</td>
<td>Forwards to A, E (A discards)</td>
</tr>
<tr class="even">
<td>4</td>
<td>E</td>
<td>Receives from B, D → forwards to C, F</td>
</tr>
<tr class="odd">
<td>5</td>
<td>C, F</td>
<td>Receive message, stop (no new neighbors)</td>
</tr>
</tbody>
</table>
<p>Every node receives the message exactly once.</p>
</section>
<section id="tiny-code-python-simulation" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A'</span>: [<span class="st">'B'</span>, <span class="st">'D'</span>],</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'B'</span>: [<span class="st">'A'</span>, <span class="st">'C'</span>, <span class="st">'E'</span>],</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'C'</span>: [<span class="st">'B'</span>, <span class="st">'F'</span>],</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'D'</span>: [<span class="st">'A'</span>, <span class="st">'E'</span>],</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'E'</span>: [<span class="st">'B'</span>, <span class="st">'D'</span>, <span class="st">'F'</span>],</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F'</span>: [<span class="st">'C'</span>, <span class="st">'E'</span>]</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>seen <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flood(node, msg_id, sender<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> msg_id <span class="kw">in</span> seen:</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>node<span class="sc">}</span><span class="ss"> received </span><span class="sc">{</span>msg_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    seen.add(msg_id)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> neighbor <span class="kw">in</span> graph[node]:</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> neighbor <span class="op">!=</span> sender:</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>            flood(neighbor, msg_id, node)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>flood(<span class="st">'A'</span>, <span class="dv">101</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>A received 101
B received 101
D received 101
C received 101
E received 101
F received 101</code></pre>
</section>
<section id="why-it-matters-44" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-44">Why It Matters</h4>
<ul>
<li>Guaranteed delivery (if network is connected)</li>
<li>Simple and decentralized</li>
<li>Used in OSPF link-state advertisements, peer discovery, gossip protocols</li>
<li>No routing tables required</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Redundant messages: exponential in dense graphs</li>
<li>Loops: prevented by tracking message IDs</li>
<li>High bandwidth usage: not scalable to large networks</li>
</ul>
<p>Optimizations:</p>
<ul>
<li>Sequence numbers (unique IDs)</li>
<li>Hop limits (TTL)</li>
<li>Selective forwarding (spanning tree–based)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-35" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-35">A Gentle Proof (Why It Works)</h4>
<p>Let the network be a connected graph <span class="math inline">\(G = (V, E)\)</span>. For a source node <span class="math inline">\(s\)</span>, every node <span class="math inline">\(v\)</span> is reachable via some path <span class="math inline">\(P(s, v)\)</span>. Flooding guarantees that at least one message traverses each edge in <span class="math inline">\(P(s, v)\)</span> before duplicates are suppressed.</p>
<p>Hence, all nodes reachable from <span class="math inline">\(s\)</span> will receive the message exactly once.</p>
<p>Formally:</p>
<p><span class="math display">\[
\forall v \in V, \exists P(s, v) \text{ such that } \text{msg propagates along } P
\]</span></p>
<p>and since nodes drop duplicates, termination is guaranteed.</p>
</section>
<section id="try-it-yourself-44" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-44">Try It Yourself</h4>
<ol type="1">
<li>Simulate flooding on a 5-node mesh.</li>
<li>Add message IDs, count duplicates before suppression.</li>
<li>Introduce a TTL (e.g.&nbsp;3 hops), see how it limits spread.</li>
<li>Build a tree overlay, observe reduced redundancy.</li>
<li>Compare with controlled flooding (used in link-state routing).</li>
</ol>
</section>
<section id="test-cases-44" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-44">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 24%">
<col style="width: 27%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Network</th>
<th>Method</th>
<th>Duplicate Handling</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>4-node chain</td>
<td>Naive Flooding</td>
<td>None</td>
<td>Exponential messages</td>
</tr>
<tr class="even">
<td>6-node mesh</td>
<td>With ID tracking</td>
<td>Yes</td>
<td>Exact delivery</td>
</tr>
<tr class="odd">
<td>10-node</td>
<td>With TTL=3</td>
<td>Yes</td>
<td>Partial reach</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-44" class="level4">
<h4 class="anchored" data-anchor-id="complexity-44">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(E)\)</span> (each link used at most once)</li>
<li>Messages: up to <span class="math inline">\(O(E)\)</span> with ID tracking, <span class="math inline">\(O(2^V)\)</span> without</li>
<li>Space: <span class="math inline">\(O(M)\)</span> for tracking seen message IDs</li>
</ul>
<p>Flooding is the shout across the network, inefficient, noisy, but certain. It’s the seed from which smarter routing grows.</p>
</section>
</section>
<section id="spanning-tree-protocol-stp" class="level3">
<h3 class="anchored" data-anchor-id="spanning-tree-protocol-stp">847 Spanning Tree Protocol (STP)</h3>
<p>Spanning Tree Protocol (STP) is a distributed algorithm that prevents loops in Ethernet networks by dynamically building a loop-free subset of links called a <em>spanning tree</em>. It’s used in switches and bridges to ensure frames don’t circulate forever when redundant links exist.</p>
<section id="what-problem-are-we-solving-45" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-45">What Problem Are We Solving?</h4>
<p>Ethernet networks often have redundant connections for fault tolerance. However, redundant paths can create broadcast storms, frames endlessly looping through switches.</p>
<p>STP solves this by disabling certain links so that the resulting network forms a tree (no cycles) but still stays connected.</p>
<blockquote class="blockquote">
<p>“Keep every switch reachable, but only one path to each.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-45" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-45">How Does It Work (Plain Language)</h4>
<p>STP elects one switch as the Root Bridge, then calculates the shortest path to it from every other switch. Links not on any shortest path are blocked to remove cycles.</p>
<p>Steps:</p>
<ol type="1">
<li><p>Root Bridge Election:</p>
<ul>
<li>Each switch has a unique Bridge ID (priority + MAC address).</li>
<li>The lowest Bridge ID wins as the root.</li>
</ul></li>
<li><p>Path Cost Calculation:</p>
<ul>
<li>Each switch calculates its distance (path cost) to the root.</li>
</ul></li>
<li><p>Designated Ports and Blocking:</p>
<ul>
<li>On each link, only one side (the one closest to the root) forwards frames.</li>
<li>All others are placed in blocking state.</li>
</ul></li>
</ol>
<p>If topology changes (e.g., a link failure), STP recalculates the tree and reactivates backup links.</p>
</section>
<section id="example-walkthrough-38" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-38">Example Walkthrough</h4>
<p>Network of four switches:</p>
<pre><code>     S1
    /  \
   S2--S3
    \  /
     S4</code></pre>
<p>Each link cost = 1.</p>
<p>Step 1: S1 has the lowest Bridge ID → becomes Root Bridge. Step 2: S2, S3, and S4 compute shortest paths to S1. Step 3: Links not on the shortest path (e.g., S2–S3, S3–S4) are blocked.</p>
<p>Resulting Tree:</p>
<pre><code>S1
├── S2
│
└── S3
     \
      S4</code></pre>
<p>Network remains connected but has no cycles.</p>
</section>
<section id="tiny-code-python-simulation-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-1">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'S1'</span>: [<span class="st">'S2'</span>, <span class="st">'S3'</span>],</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'S2'</span>: [<span class="st">'S1'</span>, <span class="st">'S3'</span>, <span class="st">'S4'</span>],</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'S3'</span>: [<span class="st">'S1'</span>, <span class="st">'S2'</span>, <span class="st">'S4'</span>],</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'S4'</span>: [<span class="st">'S2'</span>, <span class="st">'S3'</span>]</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>root <span class="op">=</span> <span class="st">'S1'</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>parent <span class="op">=</span> {root: <span class="va">None</span>}</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>visited <span class="op">=</span> <span class="bu">set</span>([root])</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_spanning_tree(node):</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> neighbor <span class="kw">in</span> graph[node]:</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> neighbor <span class="kw">not</span> <span class="kw">in</span> visited:</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>            visited.add(neighbor)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>            parent[neighbor] <span class="op">=</span> node</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>            build_spanning_tree(neighbor)</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>build_spanning_tree(root)</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Spanning tree connections:"</span>)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> parent:</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parent[n]:</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>parent[n]<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Spanning tree connections:
S1 -&gt; S2
S1 -&gt; S3
S3 -&gt; S4</code></pre>
</section>
<section id="why-it-matters-45" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-45">Why It Matters</h4>
<ul>
<li>Prevents broadcast loops in Ethernet switches</li>
<li>Allows redundancy, links are only <em>temporarily</em> disabled</li>
<li>Adapts automatically to topology changes</li>
<li>Forms the backbone of Layer 2 network stability</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Convergence delay after link failure</li>
<li>All traffic follows a single tree → some links underutilized</li>
<li>Improved variants like RSTP (Rapid STP) fix convergence speed.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-36" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-36">A Gentle Proof (Why It Works)</h4>
<p>STP ensures three key invariants:</p>
<ol type="1">
<li>Single Root: The switch with the smallest Bridge ID is elected globally.</li>
<li>Acyclic Topology: Every switch selects exactly one shortest path to the root.</li>
<li>Connectivity: No switch is isolated from the root.</li>
</ol>
<p>The protocol’s message exchange (Bridge Protocol Data Units, or BPDUs) guarantees all switches eventually agree on the same root and consistent forwarding roles.</p>
<p>Formally, if <span class="math inline">\(G=(V,E)\)</span> is the network graph, STP selects a subset of edges <span class="math inline">\(T \subseteq E\)</span> such that:</p>
<p><span class="math display">\[
T \text{ is a spanning tree of } G \quad \text{(connected, acyclic, minimal cost)}.
\]</span></p>
</section>
<section id="try-it-yourself-45" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-45">Try It Yourself</h4>
<ol type="1">
<li>Draw a small network of 5 switches with loops.</li>
<li>Assign unique Bridge IDs.</li>
<li>Determine the Root Bridge (lowest ID).</li>
<li>Compute path costs to the root from each switch.</li>
<li>Identify which ports forward and which block.</li>
<li>Disconnect the root temporarily, observe how a new tree forms.</li>
</ol>
</section>
<section id="test-cases-45" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-45">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 6%">
<col style="width: 26%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>Network</th>
<th>Root</th>
<th>Blocked Links</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>4-switch mesh</td>
<td>S1</td>
<td>S2–S3, S3–S4</td>
<td>Loop-free</td>
</tr>
<tr class="even">
<td>Ring topology</td>
<td>S1</td>
<td>One link blocked</td>
<td>Single spanning tree</td>
</tr>
<tr class="odd">
<td>Single link failure</td>
<td>S1</td>
<td>Recomputed</td>
<td>Restored connectivity</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-45" class="level4">
<h4 class="anchored" data-anchor-id="complexity-45">Complexity</h4>
<ul>
<li>Message complexity: <span class="math inline">\(O(E)\)</span> (BPDUs flood through edges)</li>
<li>Computation: <span class="math inline">\(O(V \log V)\)</span> (root election + path cost updates)</li>
<li>Memory: <span class="math inline">\(O(V)\)</span> per switch</li>
</ul>
<p>Spanning Tree Protocol is the gardener of Ethernet, it trims redundant loops, keeps the network tidy, and regrows paths when the topology changes.</p>
</section>
</section>
<section id="congestion-control-aimd" class="level3">
<h3 class="anchored" data-anchor-id="congestion-control-aimd">848 Congestion Control (AIMD)</h3>
<p>Additive Increase, Multiplicative Decrease (AIMD) is the classic algorithm used in TCP congestion control. It dynamically adjusts the sender’s transmission rate to balance efficiency (maximize throughput) and fairness (share bandwidth) without overwhelming the network.</p>
<section id="what-problem-are-we-solving-46" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-46">What Problem Are We Solving?</h4>
<p>In computer networks, multiple senders share limited bandwidth. If everyone sends as fast as possible, routers overflow and packets drop, causing congestion collapse. We need a distributed, self-regulating mechanism that adapts each sender’s rate based on network feedback.</p>
<blockquote class="blockquote">
<p>“Send more when it’s quiet, slow down when it’s crowded.”</p>
</blockquote>
<p>AIMD provides exactly that, graceful adaptation based on implicit congestion signals.</p>
</section>
<section id="how-does-it-work-plain-language-46" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-46">How Does It Work (Plain Language)</h4>
<p>Each sender maintains a congestion window (<span class="math inline">\(cwnd\)</span>), which limits the number of unacknowledged packets in flight. The rules:</p>
<ol type="1">
<li><p>Additive Increase:</p>
<ul>
<li>Each round-trip time (RTT) without loss → increase <span class="math inline">\(cwnd\)</span> by a constant (usually 1 packet).</li>
<li>Encourages probing for available bandwidth.</li>
</ul></li>
<li><p>Multiplicative Decrease:</p>
<ul>
<li>When congestion (packet loss) is detected → reduce <span class="math inline">\(cwnd\)</span> by a fixed ratio (usually half).</li>
<li>Quickly relieves pressure on the network.</li>
</ul></li>
</ol>
<p>This creates the famous “sawtooth” pattern of TCP throughput, gradual rise, sudden fall, repeat.</p>
</section>
<section id="example-walkthrough-39" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-39">Example Walkthrough</h4>
<p>Start with initial <span class="math inline">\(cwnd = 1\)</span> packet.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Round</th>
<th>Event</th>
<th><span class="math inline">\(cwnd\)</span> (packets)</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Start</td>
<td>1</td>
<td>Initial slow start</td>
</tr>
<tr class="even">
<td>2</td>
<td>ACK received</td>
<td>2</td>
<td>Increase linearly</td>
</tr>
<tr class="odd">
<td>3</td>
<td>ACK received</td>
<td>3</td>
<td>Additive increase</td>
</tr>
<tr class="even">
<td>4</td>
<td>Packet loss</td>
<td>1.5</td>
<td>Multiplicative decrease</td>
</tr>
<tr class="odd">
<td>5</td>
<td>ACK received</td>
<td>2.5</td>
<td>Additive again</td>
</tr>
<tr class="even">
<td>6</td>
<td>Packet loss</td>
<td>1.25</td>
<td>Decrease again</td>
</tr>
</tbody>
</table>
<p>This process continues indefinitely, gently oscillating around the optimal sending rate.</p>
</section>
<section id="tiny-code-python-simulation-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-2">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>rounds <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>cwnd <span class="op">=</span> [<span class="dv">1</span>]</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, rounds):</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r <span class="op">%</span> <span class="dv">8</span> <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># simulate packet loss every 8 rounds</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        cwnd.append(cwnd[<span class="op">-</span><span class="dv">1</span>] <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>        cwnd.append(cwnd[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(rounds), cwnd)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Round-trip (RTT)"</span>)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Congestion Window (cwnd)"</span>)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"AIMD Congestion Control"</span>)</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The plot shows the sawtooth growth pattern, linear climbs, multiplicative drops.</p>
</section>
<section id="why-it-matters-46" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-46">Why It Matters</h4>
<ul>
<li>Prevents congestion collapse (saves the Internet)</li>
<li>Fairness: multiple flows converge to equal bandwidth share</li>
<li>Stability: simple feedback control loop</li>
<li>Foundation for TCP Reno, NewReno, Cubic, BBR</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Reacts slowly in high-latency networks</li>
<li>Drops can cause underutilization</li>
<li>Not ideal for modern fast, long-haul links (Cubic, BBR improve this)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-37" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-37">A Gentle Proof (Why It Works)</h4>
<p>Let each sender’s window size evolve as:</p>
<p><span class="math display">\[
cwnd(t+1) =
\begin{cases}
cwnd(t) + \alpha, &amp; \text{if no loss},\\
\beta \cdot cwnd(t), &amp; \text{if loss occurs.}
\end{cases}
\]</span></p>
<p>where <span class="math inline">\(\alpha &gt; 0\)</span> (additive step) and <span class="math inline">\(0 &lt; \beta &lt; 1\)</span> (multiplicative reduction).</p>
<p>At equilibrium, congestion signals occur often enough that:</p>
<p><span class="math display">\[
\text{Average throughput} \approx \frac{1}{\sqrt{p}}
\]</span></p>
<p>where <span class="math inline">\(p\)</span> = packet loss probability. Thus, as the network becomes more congested, each flow’s rate naturally decreases, keeping the system stable and fair.</p>
</section>
<section id="try-it-yourself-46" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-46">Try It Yourself</h4>
<ol type="1">
<li>Set <span class="math inline">\(\alpha = 1\)</span>, <span class="math inline">\(\beta = 0.5\)</span>, plot cwnd growth.</li>
<li>Double RTTs, observe slower convergence.</li>
<li>Simulate two senders, see them converge to equal cwnd sizes.</li>
<li>Introduce random losses, see steady oscillation.</li>
<li>Compare with BBR (rate-based) or Cubic (nonlinear growth).</li>
</ol>
</section>
<section id="test-cases-46" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-46">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Condition</th>
<th>Behavior</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No losses</td>
<td>Linear growth</td>
<td>Bandwidth probe</td>
</tr>
<tr class="even">
<td>Periodic losses</td>
<td>Sawtooth oscillation</td>
<td>Stable throughput</td>
</tr>
<tr class="odd">
<td>Random losses</td>
<td>Variance in cwnd</td>
<td>Controlled adaptation</td>
</tr>
<tr class="even">
<td>Two flows</td>
<td>Equal share</td>
<td>Fair convergence</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-46" class="level4">
<h4 class="anchored" data-anchor-id="complexity-46">Complexity</h4>
<ul>
<li>Control time: <span class="math inline">\(O(1)\)</span> per RTT (constant-time update)</li>
<li>Computation: minimal, arithmetic per ACK/loss</li>
<li>Space: <span class="math inline">\(O(1)\)</span> (store current cwnd and threshold)</li>
</ul>
<p>AIMD is the heartbeat of the Internet, a rhythm of sending, sensing, and slowing, keeping millions of connections in harmony through nothing but self-restraint and math.</p>
</section>
</section>
<section id="random-early-detection-red" class="level3">
<h3 class="anchored" data-anchor-id="random-early-detection-red">849 Random Early Detection (RED)</h3>
<p>Random Early Detection (RED) is a proactive congestion-avoidance algorithm used in routers and switches. Instead of waiting for queues to overflow (and then dropping packets suddenly), RED begins to randomly drop or mark packets early as the queue builds up, signaling senders to slow down before the network collapses.</p>
<section id="what-problem-are-we-solving-47" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-47">What Problem Are We Solving?</h4>
<p>Traditional routers use tail drop, packets are accepted until the buffer is full, then all new arrivals are dropped. This leads to:</p>
<ul>
<li>Global synchronization (many TCP flows slow down simultaneously)</li>
<li>Burst losses</li>
<li>Unfair bandwidth sharing</li>
</ul>
<p>RED smooths this by predicting congestion early and randomly notifying some flows to back off, maintaining high throughput with low delay.</p>
<blockquote class="blockquote">
<p>“Don’t wait for the dam to break, release a few drops early.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-47" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-47">How Does It Work (Plain Language)</h4>
<p>The router maintains an average queue size using an exponential moving average:</p>
<p><span class="math display">\[
avg = (1 - w_q) \cdot avg + w_q \cdot q_{current}
\]</span></p>
<p>where <span class="math inline">\(w_q\)</span> is a small weight (e.g., 0.002).</p>
<p>RED defines two thresholds:</p>
<ul>
<li>min_th: start of early detection</li>
<li>max_th: full congestion warning</li>
</ul>
<p>When a packet arrives:</p>
<ol type="1">
<li>Compute <span class="math inline">\(avg\)</span>.</li>
<li>If <span class="math inline">\(avg &lt; min_{th}\)</span> → accept the packet.</li>
<li>If <span class="math inline">\(avg &gt; max_{th}\)</span> → drop or mark it (100% probability).</li>
<li>If in between → drop with probability <span class="math inline">\(p\)</span> increasing linearly between thresholds.</li>
</ol>
<p>This creates a <em>soft</em> congestion signal rather than a sudden cliff.</p>
</section>
<section id="example-walkthrough-40" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-40">Example Walkthrough</h4>
<p>Let’s say:</p>
<ul>
<li><span class="math inline">\(min_{th} = 5\)</span>, <span class="math inline">\(max_{th} = 15\)</span> packets</li>
<li>Current average queue <span class="math inline">\(avg = 10\)</span></li>
<li>Max drop probability <span class="math inline">\(p_{max} = 0.1\)</span></li>
</ul>
<p>Drop probability:</p>
<p><span class="math display">\[
p = p_{\text{max}} \times \frac{avg - min_{\text{th}}}{max_{\text{th}} - min_{\text{th}}}
= 0.1 \times \frac{10 - 5}{10}
= 0.05
\]</span></p>
<p>So, each incoming packet has a 5% chance of being dropped. This random early drop gives TCP flows time to reduce sending rates before the queue overflows.</p>
</section>
<section id="tiny-code-python-simulation-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-3">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>min_th <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>max_th <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>p_max <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>avg <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>w_q <span class="op">=</span> <span class="fl">0.002</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> red_packet(arrivals):</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> avg</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> arrivals:</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> w_q) <span class="op">*</span> avg <span class="op">+</span> w_q <span class="op">*</span> q</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> avg <span class="op">&lt;</span> min_th:</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Queue=</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">, avg=</span><span class="sc">{</span>avg<span class="sc">:.2f}</span><span class="ss">: ACCEPT"</span>)</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> avg <span class="op">&gt;</span> max_th:</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Queue=</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">, avg=</span><span class="sc">{</span>avg<span class="sc">:.2f}</span><span class="ss">: DROP"</span>)</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> p_max <span class="op">*</span> (avg <span class="op">-</span> min_th) <span class="op">/</span> (max_th <span class="op">-</span> min_th)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> random.random() <span class="op">&lt;</span> p:</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Queue=</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">, avg=</span><span class="sc">{</span>avg<span class="sc">:.2f}</span><span class="ss">: DROP (prob=</span><span class="sc">{</span>p<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Queue=</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">, avg=</span><span class="sc">{</span>avg<span class="sc">:.2f}</span><span class="ss">: ACCEPT"</span>)</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>arrivals <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">16</span>, <span class="dv">20</span>]</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>red_packet(arrivals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (example):</p>
<pre><code>Queue=3, avg=0.01: ACCEPT
Queue=7, avg=0.02: ACCEPT
Queue=10, avg=0.04: ACCEPT
Queue=12, avg=0.07: DROP (prob=0.035)
Queue=14, avg=0.10: ACCEPT
Queue=16, avg=0.13: DROP (prob=0.080)
Queue=20, avg=0.17: DROP</code></pre>
</section>
<section id="why-it-matters-47" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-47">Why It Matters</h4>
<ul>
<li>Prevents congestion before it happens</li>
<li>Avoids global synchronization among TCP flows</li>
<li>Maintains stable average queue size</li>
<li>Improves fairness and throughput</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires tuning (<span class="math inline">\(w_q\)</span>, <span class="math inline">\(min_{th}\)</span>, <span class="math inline">\(max_{th}\)</span>, <span class="math inline">\(p_{max}\)</span>)</li>
<li>May be less effective for non-TCP traffic (no feedback reaction)</li>
<li>Too aggressive → underutilization; too lenient → full buffers</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-38" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-38">A Gentle Proof (Why It Works)</h4>
<p>RED models queue dynamics as a feedback system. The average queue length <span class="math inline">\(avg\)</span> evolves as:</p>
<p><span class="math display">\[
avg_{t+1} = (1 - w_q) \cdot avg_t + w_q \cdot q_t
\]</span></p>
<p>and packet drop probability <span class="math inline">\(p\)</span> grows smoothly between thresholds:</p>
<p><span class="math display">\[
p =
\begin{cases}
0, &amp; avg &lt; min_{th} \\
p_{max} \frac{avg - min_{th}}{max_{th} - min_{th}}, &amp; min_{th} \le avg \le max_{th} \\
1, &amp; avg &gt; max_{th}
\end{cases}
\]</span></p>
<p>This continuous control avoids oscillations and stabilizes throughput by randomizing packet drops.</p>
</section>
<section id="try-it-yourself-47" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-47">Try It Yourself</h4>
<ol type="1">
<li>Set <span class="math inline">\(min_{th}=5\)</span>, <span class="math inline">\(max_{th}=15\)</span>, and simulate queue variations.</li>
<li>Plot average queue vs time, observe smooth control.</li>
<li>Increase <span class="math inline">\(w_q\)</span>, see faster but noisier adaptation.</li>
<li>Increase <span class="math inline">\(p_{max}\)</span>, RED reacts more aggressively.</li>
<li>Compare with tail drop, note sudden full-buffer losses.</li>
</ol>
</section>
<section id="test-cases-47" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-47">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>RED Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Light load</td>
<td>No drops</td>
<td>Stable queue</td>
</tr>
<tr class="even">
<td>Gradual buildup</td>
<td>Random early drops</td>
<td>Smooth adaptation</td>
</tr>
<tr class="odd">
<td>Sudden bursts</td>
<td>Some drops</td>
<td>No collapse</td>
</tr>
<tr class="even">
<td>TCP mix flows</td>
<td>Random backoffs</td>
<td>Fair sharing</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-47" class="level4">
<h4 class="anchored" data-anchor-id="complexity-47">Complexity</h4>
<ul>
<li>Per packet: <span class="math inline">\(O(1)\)</span> (constant-time average + probability check)</li>
<li>State: <span class="math inline">\(O(1)\)</span> per queue</li>
<li>Tuning parameters: <span class="math inline">\(w_q, min_{th}, max_{th}, p_{max}\)</span></li>
</ul>
<p>RED is the traffic whisperer of the Internet, it senses the crowd forming, taps a few on the shoulder, and keeps the flow moving before chaos begins.</p>
</section>
</section>
<section id="explicit-congestion-notification-ecn" class="level3">
<h3 class="anchored" data-anchor-id="explicit-congestion-notification-ecn">850 Explicit Congestion Notification (ECN)</h3>
<p>Explicit Congestion Notification (ECN) is a modern congestion-control enhancement that allows routers to signal congestion without dropping packets. Instead of relying on loss as a feedback signal (like traditional TCP), ECN marks packets in-flight, letting endpoints slow down before buffers overflow.</p>
<section id="what-problem-are-we-solving-48" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-48">What Problem Are We Solving?</h4>
<p>Traditional TCP interprets packet loss as a sign of congestion. But packet loss is a crude signal, it wastes bandwidth, increases latency, and can destabilize queues.</p>
<p>We want routers to communicate congestion <em>explicitly</em>, without destroying data, so that endpoints can adjust smoothly.</p>
<blockquote class="blockquote">
<p>“Instead of dropping the package, just stamp it: <em>‘Hey, slow down a bit.’</em>”</p>
</blockquote>
<p>That’s what ECN does, it preserves packets but delivers the same message.</p>
</section>
<section id="how-does-it-work-plain-language-48" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-48">How Does It Work (Plain Language)</h4>
<p>ECN operates by marking packets using two bits in the IP header and feedback bits in the TCP header.</p>
<ol type="1">
<li><p>Sender: marks packets as <em>ECN-capable</em> (<code>ECT(0)</code> or <code>ECT(1)</code>).</p></li>
<li><p>Router: when detecting congestion (e.g., queue exceeds threshold):</p>
<ul>
<li>Instead of dropping packets, it sets the CE (Congestion Experienced) bit.</li>
</ul></li>
<li><p>Receiver: sees CE mark, sets the ECE (Echo Congestion Experienced) flag in TCP ACK.</p></li>
<li><p>Sender: on receiving ECE, reduces its congestion window (like AIMD’s multiplicative decrease), and sends a CWR (Congestion Window Reduced) flag to acknowledge the signal.</p></li>
</ol>
<p>No loss occurs, but congestion control behavior still happens.</p>
</section>
<section id="example-walkthrough-41" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-41">Example Walkthrough</h4>
<ol type="1">
<li><p>Normal flow:</p>
<ul>
<li>Sender → Router → Receiver (packets marked ECT).</li>
<li>Router queue grows → starts marking packets CE.</li>
</ul></li>
<li><p>Feedback:</p>
<ul>
<li>Receiver → Sender (ACKs with ECE bit set).</li>
<li>Sender halves its congestion window, sends ACK with CWR.</li>
</ul></li>
<li><p>Stabilization:</p>
<ul>
<li>Queue drains → router stops marking.</li>
<li>Flow resumes normal additive increase.</li>
</ul></li>
</ol>
<p>Timeline sketch:</p>
<pre><code>Sender: ECT(0) → ECT(0) → CE → ECT(0)
Router: Marks CE when avg queue &gt; threshold
Receiver: ACK (ECE) → ACK (ECE) → ACK (no ECE)
Sender: cwnd ↓ (on ECE)</code></pre>
</section>
<section id="tiny-code-python-simulation-of-signaling" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-of-signaling">Tiny Code (Python Simulation of Signaling)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>cwnd <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>ecn_enabled <span class="op">=</span> <span class="va">True</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rtt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    queue <span class="op">=</span> <span class="dv">5</span> <span class="op">+</span> rtt  <span class="co"># simulate buildup</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ecn_enabled <span class="kw">and</span> queue <span class="op">&gt;</span> <span class="dv">8</span>:</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"RTT </span><span class="sc">{</span>rtt<span class="sc">}</span><span class="ss">: CE marked -&gt; cwnd reduced from </span><span class="sc">{</span>cwnd<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>cwnd<span class="op">//</span><span class="dv">2</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>        cwnd <span class="op">//=</span> <span class="dv">2</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        cwnd <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"RTT </span><span class="sc">{</span>rtt<span class="sc">}</span><span class="ss">: normal -&gt; cwnd=</span><span class="sc">{</span>cwnd<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>RTT 1: normal -&gt; cwnd=11
RTT 2: normal -&gt; cwnd=12
RTT 3: normal -&gt; cwnd=13
RTT 4: normal -&gt; cwnd=14
RTT 5: CE marked -&gt; cwnd reduced from 14 to 7
RTT 6: normal -&gt; cwnd=8
...</code></pre>
</section>
<section id="why-it-matters-48" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-48">Why It Matters</h4>
<ul>
<li>Avoids packet loss, better for delay-sensitive traffic</li>
<li>Lower latency, queues stay short</li>
<li>Smooth feedback, reduces oscillation in throughput</li>
<li>Energy and resource efficient, no retransmissions needed</li>
<li>Works with RED (RFC 3168), routers mark instead of drop</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires end-to-end ECN support (sender, receiver, and routers)</li>
<li>Some middleboxes still strip ECN bits</li>
<li>Needs careful configuration to avoid false positives</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-39" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-39">A Gentle Proof (Why It Works)</h4>
<p>Routers implementing RED or AQM (Active Queue Management) set a marking probability <span class="math inline">\(p\)</span> instead of a drop probability. Marking probability follows:</p>
<p><span class="math display">\[
p = p_{max} \frac{avg - min_{th}}{max_{th} - min_{th}}
\]</span></p>
<p>When a packet is marked with CE, the TCP sender reduces its congestion window:</p>
<p><span class="math display">\[
cwnd_{new} = \beta \cdot cwnd_{old}, \quad \beta &lt; 1
\]</span></p>
<p>This maintains the same AIMD equilibrium as loss-based control but avoids loss events. Since marking is early and gentle, ECN stabilizes queue lengths and minimizes delay.</p>
</section>
<section id="try-it-yourself-48" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-48">Try It Yourself</h4>
<ol type="1">
<li><p>Enable ECN in Linux:</p>
<pre><code>sysctl -w net.ipv4.tcp_ecn=1</code></pre></li>
<li><p>Run an <code>iperf3</code> test between ECN-capable hosts.</p></li>
<li><p>Compare throughput and latency with ECN off.</p></li>
<li><p>Visualize packet captures, look for <code>CE</code> and <code>ECE</code> bits in headers.</p></li>
<li><p>Combine ECN with RED for a complete congestion control loop.</p></li>
</ol>
</section>
<section id="test-cases-48" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-48">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 38%">
<col style="width: 19%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Router queue exceeds min_th</td>
<td>Marks CE</td>
<td>Smooth slowdown</td>
</tr>
<tr class="even">
<td>ECN disabled</td>
<td>Drops packets</td>
<td>Loss-based control</td>
</tr>
<tr class="odd">
<td>ECN enabled end-to-end</td>
<td>Marks packets</td>
<td>Low latency, stable throughput</td>
</tr>
<tr class="even">
<td>One router not ECN-capable</td>
<td>Mixed behavior</td>
<td>Partial benefit</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-48" class="level4">
<h4 class="anchored" data-anchor-id="complexity-48">Complexity</h4>
<ul>
<li>Per packet: <span class="math inline">\(O(1)\)</span> (marking decision)</li>
<li>Overhead: negligible, bit toggling only</li>
<li>Deployment: incremental, backward compatible with non-ECN flows</li>
</ul>
<p>ECN is the gentle hand of congestion control, it doesn’t punish with loss, it warns with a mark, keeping the Internet fast, fair, and calm even under pressure.</p>
</section>
</section>
</section>
<section id="section-86.-distributed-consensus" class="level1">
<h1>Section 86. Distributed Consensus</h1>
<section id="basic-paxos" class="level3">
<h3 class="anchored" data-anchor-id="basic-paxos">851 Basic Paxos</h3>
<p>Basic Paxos is the cornerstone algorithm for reaching agreement among distributed nodes, even if some fail. It allows a group of machines to agree on a single value, safely and consistently, without requiring perfect reliability or synchrony.</p>
<section id="what-problem-are-we-solving-49" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-49">What Problem Are We Solving?</h4>
<p>In distributed systems, multiple nodes might propose values (e.g., “commit transaction X” or “leader is node 3”). They can crash, restart, or have delayed messages. How do we ensure everyone <em>eventually agrees on the same value</em>, even with partial failures?</p>
<p>Paxos answers this fundamental question:</p>
<blockquote class="blockquote">
<p>“How can a system of unreliable participants reach a consistent decision?”</p>
</blockquote>
<p>It ensures safety (no two nodes decide different values) and liveness (eventually a decision is reached, assuming stability).</p>
</section>
<section id="how-does-it-work-plain-language-49" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-49">How Does It Work (Plain Language)</h4>
<p>Paxos separates roles into three participants:</p>
<ul>
<li>Proposers: suggest values to agree on</li>
<li>Acceptors: vote on proposals (a majority is enough)</li>
<li>Learners: learn the final chosen value</li>
</ul>
<p>The algorithm proceeds in <em>two phases</em>.</p>
<section id="phase-1-prepare" class="level5">
<h5 class="anchored" data-anchor-id="phase-1-prepare">Phase 1: Prepare</h5>
<ol type="1">
<li><p>A proposer picks a unique proposal number <code>n</code> and sends a prepare(n) message to all acceptors.</p></li>
<li><p>Each acceptor:</p>
<ul>
<li>If <code>n</code> is greater than any proposal number it has already seen, it promises not to accept proposals below n.</li>
<li>It replies with any previously accepted proposal <code>(n', value')</code> (if any).</li>
</ul></li>
</ol>
</section>
<section id="phase-2-accept" class="level5">
<h5 class="anchored" data-anchor-id="phase-2-accept">Phase 2: Accept</h5>
<ol start="3" type="1">
<li><p>The proposer, after receiving responses from a majority:</p>
<ul>
<li>Chooses the value with the highest-numbered prior acceptance (or its own value if none).</li>
<li>Sends accept(n, value) to all acceptors.</li>
</ul></li>
<li><p>Acceptors:</p>
<ul>
<li>Accept the proposal <code>(n, value)</code> if they have not already promised a higher number.</li>
</ul></li>
</ol>
<p>Once a majority accepts the same <code>(n, value)</code>, that value is chosen. Learners are then notified of the decision.</p>
</section>
</section>
<section id="example-timeline-1" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-1">Example Timeline</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Node</th>
<th>Message</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>P1</td>
<td><code>prepare(1)</code> → all</td>
<td>Proposer starts round</td>
</tr>
<tr class="even">
<td>2</td>
<td>A1, A2</td>
<td>Promise <code>n ≥ 1</code></td>
<td>No previous proposal</td>
</tr>
<tr class="odd">
<td>3</td>
<td>P1</td>
<td><code>accept(1, X)</code> → all</td>
<td>Proposes value X</td>
</tr>
<tr class="even">
<td>4</td>
<td>A1, A2, A3</td>
<td>Accept <code>(1, X)</code></td>
<td>Majority agrees</td>
</tr>
<tr class="odd">
<td>5</td>
<td>P1</td>
<td>Announce decision X</td>
<td>Consensus reached</td>
</tr>
</tbody>
</table>
<p>If another proposer (say P2) tries later with <code>prepare(2)</code>, Paxos ensures it cannot override the chosen value.</p>
</section>
<section id="tiny-code-python-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-pseudocode">Tiny Code (Python Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Acceptor:</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.promised_n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.accepted <span class="op">=</span> <span class="va">None</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare(<span class="va">self</span>, n):</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&gt;</span> <span class="va">self</span>.promised_n:</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.promised_n <span class="op">=</span> n</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (<span class="st">"promise"</span>, <span class="va">self</span>.accepted)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="st">"reject"</span>, <span class="va">None</span>)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> accept(<span class="va">self</span>, n, value):</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&gt;=</span> <span class="va">self</span>.promised_n:</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.accepted <span class="op">=</span> (n, value)</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"accepted"</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"rejected"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This captures the core idea: acceptors promise to honor only higher-numbered proposals, preserving safety.</p>
</section>
<section id="why-it-matters-49" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-49">Why It Matters</h4>
<ul>
<li>Fault tolerance: Works with up to ⌊(N−1)/2⌋ failures.</li>
<li>Safety first: Even with crashes, no inconsistent state arises.</li>
<li>Foundation: Forms the basis of Raft, Multi-Paxos, Zab, EPaxos, and more.</li>
<li>Used in: Google Chubby, Zookeeper, etcd, CockroachDB, Spanner.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Complex message flow and numbering.</li>
<li>High latency (two rounds per decision).</li>
<li>Not designed for high churn or partitions, Raft simplifies this.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-40" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-40">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(Q_1\)</span>, <span class="math inline">\(Q_2\)</span> be any two majorities of acceptors.</li>
</ul>
<p>Then <span class="math inline">\(Q_1 \cap Q_2 \ne \varnothing\)</span> (any two majorities intersect).</p>
<p>Thus, if a value <span class="math inline">\(v\)</span> is accepted by <span class="math inline">\(Q_1\)</span>, any later proposal must contact at least one acceptor in <span class="math inline">\(Q_1\)</span> during prepare phase, which ensures it learns about <span class="math inline">\(v\)</span> and continues proposing it.</p>
<p>Hence, once a value is chosen, no other can ever be chosen.</p>
<p>Safety invariant:</p>
<blockquote class="blockquote">
<p>If a value is chosen, every higher proposal preserves it.</p>
</blockquote>
</section>
<section id="try-it-yourself-49" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-49">Try It Yourself</h4>
<ol type="1">
<li>Simulate three acceptors and two proposers.</li>
<li>Let both propose at once, see how numbering resolves conflict.</li>
<li>Drop some messages, ensure consistency still holds.</li>
<li>Extend to five nodes and test with random delays.</li>
<li>Observe how learners only need one consistent quorum response.</li>
</ol>
</section>
<section id="test-cases-49" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-49">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Expected Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>One proposer</td>
<td>Value chosen quickly</td>
</tr>
<tr class="even">
<td>Two concurrent proposers</td>
<td>Higher-numbered wins</td>
</tr>
<tr class="odd">
<td>Node crash and restart</td>
<td>Safety preserved</td>
</tr>
<tr class="even">
<td>Network delay</td>
<td>Eventual consistency, no conflict</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-49" class="level4">
<h4 class="anchored" data-anchor-id="complexity-49">Complexity</h4>
<ul>
<li>Message rounds: 2 (prepare + accept)</li>
<li>Message complexity: <span class="math inline">\(O(N^2)\)</span> for N participants</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ node failures</li>
<li>Storage: <span class="math inline">\(O(1)\)</span> state per acceptor (promised number + accepted value)</li>
</ul>
<p>Paxos is the mathematical heart of distributed systems, a quiet, stubborn agreement that holds even when the world around it falls apart.</p>
</section>
</section>
<section id="multi-paxos" class="level3">
<h3 class="anchored" data-anchor-id="multi-paxos">852 Multi-Paxos</h3>
<p>Multi-Paxos is an optimized version of Basic Paxos that allows a distributed system to reach <em>many consecutive agreements</em> (like a log of decisions) efficiently. Where Basic Paxos handles a single value, Multi-Paxos extends this to a sequence of values, ideal for replicated logs in systems like databases and consensus clusters.</p>
<section id="what-problem-are-we-solving-50" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-50">What Problem Are We Solving?</h4>
<p>In practice, systems rarely need to agree on just one value. They need to agree repeatedly, for example:</p>
<ul>
<li>Each log entry in a replicated state machine</li>
<li>Each transaction commit</li>
<li>Each configuration update</li>
</ul>
<p>Running Basic Paxos for every single decision would require two message rounds each time, which is inefficient.</p>
<p>Multi-Paxos reduces this overhead by reusing a stable leader to coordinate many decisions.</p>
<blockquote class="blockquote">
<p>“Why elect a new leader every time when one can stay in charge for a while?”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-50" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-50">How Does It Work (Plain Language)</h4>
<p>Multi-Paxos builds directly on Basic Paxos but adds leadership and log indexing.</p>
<section id="key-idea-leader-election" class="level5">
<h5 class="anchored" data-anchor-id="key-idea-leader-election">Key idea: Leader election</h5>
<ul>
<li>One proposer becomes a leader (using a higher proposal number).</li>
<li>Once chosen, the leader skips the prepare phase for subsequent proposals.</li>
</ul>
</section>
<section id="process" class="level5">
<h5 class="anchored" data-anchor-id="process">Process</h5>
<ol type="1">
<li><p>Leader election</p>
<ul>
<li>A proposer performs the prepare phase once and becomes leader.</li>
<li>All acceptors promise not to accept lower proposal numbers.</li>
</ul></li>
<li><p>Steady state</p>
<ul>
<li>For each new log entry (index <span class="math inline">\(i\)</span>), the leader sends accept(i, value) directly.</li>
<li>Acceptors respond with “accepted”.</li>
</ul></li>
<li><p>Learning and replication</p>
<ul>
<li>When a majority accept, the leader notifies learners.</li>
<li>The value becomes committed at position <span class="math inline">\(i\)</span>.</li>
</ul></li>
</ol>
<p>If the leader fails, another proposer starts a new prepare phase with a higher proposal number, reclaiming leadership.</p>
</section>
</section>
<section id="example-timeline-2" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-2">Example Timeline</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 41%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Action</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>P1 starts prepare(1)</td>
<td>Becomes leader</td>
</tr>
<tr class="even">
<td>2</td>
<td>P1 proposes accept(1, “A”)</td>
<td>Value for log index 1</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Majority accept</td>
<td>“A” chosen</td>
</tr>
<tr class="even">
<td>4</td>
<td>P1 proposes accept(2, “B”)</td>
<td>Next log entry, no prepare needed</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Leader fails</td>
<td>P2 runs prepare(2), takes over</td>
</tr>
</tbody>
</table>
<p>So instead of two rounds per value, Multi-Paxos uses:</p>
<ul>
<li>Two rounds only once (for leader election)</li>
<li>One round thereafter for each new decision</li>
</ul>
</section>
<section id="tiny-code-simplified-python-simulation-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-simulation-1">Tiny Code (Simplified Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiPaxosLeader:</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proposal_n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> elect_leader(<span class="va">self</span>, acceptors):</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.proposal_n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        promises <span class="op">=</span> [a.prepare(<span class="va">self</span>.proposal_n) <span class="cf">for</span> a <span class="kw">in</span> acceptors]</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> p, _ <span class="kw">in</span> promises <span class="cf">if</span> p <span class="op">==</span> <span class="st">"promise"</span>) <span class="op">&gt;</span> <span class="bu">len</span>(acceptors) <span class="op">//</span> <span class="dv">2</span>:</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Leader elected"</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> propose(<span class="va">self</span>, index, value, acceptors):</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        accepted <span class="op">=</span> [a.accept(<span class="va">self</span>.proposal_n, value) <span class="cf">for</span> a <span class="kw">in</span> acceptors]</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> accepted.count(<span class="st">"accepted"</span>) <span class="op">&gt;</span> <span class="bu">len</span>(acceptors) <span class="op">//</span> <span class="dv">2</span>:</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.log.append(value)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Committed log[</span><span class="sc">{</span>index<span class="sc">}</span><span class="ss">] = </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-50" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-50">Why It Matters</h4>
<ul>
<li>High throughput: amortizes prepare cost over many decisions</li>
<li>Foundation for replicated logs: underpins Raft, Zab, Chubby, etcd</li>
<li>Fault tolerance: still works with up to ⌊(N−1)/2⌋ node failures</li>
<li>Consistency: all replicas apply operations in the same order</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Needs stable leader to avoid churn</li>
<li>Slight delay on leader failover</li>
<li>Complex implementation in practice (timeouts, heartbeats, elections)</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-41" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-41">A Gentle Proof (Why It Works)</h4>
<p>Let each log index <span class="math inline">\(i\)</span> represent a separate Paxos instance.</p>
<ul>
<li>All instances share the same acceptors.</li>
<li>Once a leader is established with proposal number <span class="math inline">\(n\)</span>, every future accept(i, value) message from that leader uses the same <span class="math inline">\(n\)</span>.</li>
</ul>
<p>The safety invariant of Paxos still holds per index:</p>
<blockquote class="blockquote">
<p>Once a value is chosen for position <span class="math inline">\(i\)</span>, no other value can be chosen.</p>
</blockquote>
<p>Because the leader is fixed, overlapping prepares are eliminated, ensuring a consistent prefix ordering of the log.</p>
<p>Formally, if majority sets <span class="math inline">\(Q_1, Q_2\)</span> intersect, then: <span class="math display">\[
\forall i, ; \text{chosen}(i, v) \Rightarrow \text{future proposals at } i \text{ must propose } v
\]</span></p>
</section>
<section id="try-it-yourself-50" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-50">Try It Yourself</h4>
<ol type="1">
<li>Elect one node as leader; let it propose 5 log entries in a row.</li>
<li>Kill the leader mid-way; watch another proposer take over.</li>
<li>Observe that committed log entries remain intact.</li>
<li>Extend simulation to show log replication across 5 acceptors.</li>
<li>Verify no inconsistency even after restarts.</li>
</ol>
</section>
<section id="test-cases-50" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-50">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Stable leader</td>
<td>Fast single-round commits</td>
<td>Efficient agreement</td>
</tr>
<tr class="even">
<td>Leader crash</td>
<td>New prepare phase</td>
<td>Safe recovery</td>
</tr>
<tr class="odd">
<td>Two leaders</td>
<td>Higher proposal wins</td>
<td>Safety preserved</td>
</tr>
<tr class="even">
<td>Delayed messages</td>
<td>Consistent prefix log</td>
<td>No divergence</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-50" class="level4">
<h4 class="anchored" data-anchor-id="complexity-50">Complexity</h4>
<ul>
<li>Message rounds: 2 for election, then 1 per value</li>
<li>Message complexity: <span class="math inline">\(O(N)\)</span> per decision</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ failures</li>
<li>Log structure: <span class="math inline">\(O(K)\)</span> for K decisions</li>
</ul>
<p>Multi-Paxos turns the <em>single agreement</em> of Paxos into a stream of ordered, fault-tolerant decisions, the living heartbeat of consensus-based systems.</p>
</section>
</section>
<section id="raft" class="level3">
<h3 class="anchored" data-anchor-id="raft">853 Raft</h3>
<p>Raft is a consensus algorithm designed to be easier to understand and implement than Paxos, while providing the same safety and fault tolerance. It keeps a distributed system of servers in agreement on a replicated log, ensuring that all nodes execute the same sequence of commands, even when some crash or reconnect.</p>
<section id="what-problem-are-we-solving-51" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-51">What Problem Are We Solving?</h4>
<p>Consensus is the foundation of reliable distributed systems: databases, cluster managers, and replicated state machines all need it.</p>
<p>Paxos guarantees safety but is notoriously hard to implement correctly. Raft was introduced to make consensus understandable, modular, and practical, by decomposing it into three clear subproblems:</p>
<ol type="1">
<li>Leader election – choose one server to coordinate.</li>
<li>Log replication – leader appends commands and replicates them.</li>
<li>Safety – ensure logs remain consistent even after failures.</li>
</ol>
<blockquote class="blockquote">
<p>“Raft isn’t simpler because it does less, it’s simpler because it explains more.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-51" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-51">How Does It Work (Plain Language)</h4>
<p>Raft maintains the same fundamental safety property as Paxos:</p>
<blockquote class="blockquote">
<p>At most one value is chosen for each log index.</p>
</blockquote>
<p>But it enforces this via <em>leadership</em> and <em>term-based coordination.</em></p>
<section id="roles" class="level5">
<h5 class="anchored" data-anchor-id="roles">Roles</h5>
<ul>
<li>Leader: handles all client requests and replication.</li>
<li>Follower: passive node, responds to leader messages.</li>
<li>Candidate: a follower that times out and runs for election.</li>
</ul>
</section>
<section id="terms" class="level5">
<h5 class="anchored" data-anchor-id="terms">Terms</h5>
<p>Time is divided into terms. Each term starts with an election and can have at most one leader.</p>
</section>
<section id="leader-election" class="level5">
<h5 class="anchored" data-anchor-id="leader-election">Leader Election</h5>
<ol type="1">
<li><p>A follower times out (no heartbeat) and becomes a candidate.</p></li>
<li><p>It increments its term and sends <code>RequestVote(term, id, lastLogIndex, lastLogTerm)</code> to all servers.</p></li>
<li><p>Servers vote for the candidate if:</p>
<ul>
<li>Candidate’s log is at least as up-to-date as theirs.</li>
</ul></li>
<li><p>If the candidate gets a majority, it becomes the leader.</p></li>
<li><p>The leader then starts sending <code>AppendEntries</code> (heartbeats).</p></li>
</ol>
</section>
<section id="log-replication" class="level5">
<h5 class="anchored" data-anchor-id="log-replication">Log Replication</h5>
<ul>
<li>Clients send commands to the leader.</li>
<li>The leader appends the command to its log and sends <code>AppendEntries(term, index, entry)</code> to followers.</li>
<li>When a majority acknowledges, the leader commits the entry and applies it to the state machine.</li>
</ul>
</section>
<section id="safety-rule" class="level5">
<h5 class="anchored" data-anchor-id="safety-rule">Safety Rule</h5>
<p>Before granting a vote, a node ensures that the candidate’s log is at least as complete as its own. This ensures that all committed entries are preserved across leadership changes.</p>
</section>
</section>
<section id="example-timeline-3" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-3">Example Timeline</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 33%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Action</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Node A times out</td>
<td>Starts election for term 1</td>
</tr>
<tr class="even">
<td>2</td>
<td>A requests votes</td>
<td>B, C vote for A</td>
</tr>
<tr class="odd">
<td>3</td>
<td>A becomes leader</td>
<td>Starts sending heartbeats</td>
</tr>
<tr class="even">
<td>4</td>
<td>Client sends command X</td>
<td>A appends entry (1, X)</td>
</tr>
<tr class="odd">
<td>5</td>
<td>A sends AppendEntries</td>
<td>B and C replicate</td>
</tr>
<tr class="even">
<td>6</td>
<td>Majority ACK</td>
<td>A commits and applies X</td>
</tr>
<tr class="odd">
<td>7</td>
<td>A crashes, B elected</td>
<td>B’s log still has X, remains consistent</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-simulation-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-4">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RaftServer:</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>):</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.term <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.voted_for <span class="op">=</span> <span class="va">None</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"follower"</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> request_vote(<span class="va">self</span>, candidate_term, candidate_id, candidate_log_len):</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> candidate_term <span class="op">&gt;</span> <span class="va">self</span>.term:</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.term <span class="op">=</span> candidate_term</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.voted_for <span class="op">=</span> <span class="va">None</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="va">self</span>.voted_for <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="va">self</span>.voted_for <span class="op">==</span> candidate_id):</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.voted_for <span class="op">=</span> candidate_id</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> append_entries(<span class="va">self</span>, term, entries):</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> term <span class="op">&gt;=</span> <span class="va">self</span>.term:</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.log.extend(entries)</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.term <span class="op">=</span> term</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-51" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-51">Why It Matters</h4>
<ul>
<li>Understandable: simpler reasoning than Paxos.</li>
<li>Efficient: only one round of communication per command (via leader).</li>
<li>Safe: no committed entry ever lost.</li>
<li>Practical: widely used in production systems (etcd, Consul, TiKV, CockroachDB).</li>
<li>Reconfigurable: supports safe cluster membership changes.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Needs stable leader (single write point).</li>
<li>Slight delay during re-election after a crash.</li>
<li>More state management (terms, logs, heartbeats).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-42" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-42">A Gentle Proof (Why It Works)</h4>
<p>Raft’s safety depends on the Leader Completeness Property:</p>
<blockquote class="blockquote">
<p>If a log entry is committed in term T, then every future leader must contain that entry.</p>
</blockquote>
<p>Proof sketch:</p>
<ol type="1">
<li>An entry is committed only when stored on a majority of servers.</li>
<li>Any new leader must win a majority vote.</li>
<li>Majorities overlap ⇒ at least one voter has the committed entry.</li>
<li>That voter’s log term ensures the entry is preserved in the new leader’s log.</li>
</ol>
<p>Thus, once committed, an entry remains in all future logs.</p>
<p>Mathematically: <span class="math display">\[
\forall T, i: \text{committed}(i, T) \Rightarrow \forall T' &gt; T, \text{leader}(T') \text{ has entry } i
\]</span></p>
</section>
<section id="try-it-yourself-51" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-51">Try It Yourself</h4>
<ol type="1">
<li>Simulate a 5-node cluster (A–E).</li>
<li>Introduce random election timeouts.</li>
<li>Observe leader elections and stable leadership.</li>
<li>Send commands and watch log replication.</li>
<li>Kill a leader and verify system recovers with consistent logs.</li>
<li>Add a new node and see Raft’s reconfiguration mechanism.</li>
</ol>
</section>
<section id="test-cases-51" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-51">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Expected Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Single leader</td>
<td>Stable heartbeats</td>
</tr>
<tr class="even">
<td>Leader crash</td>
<td>New election after timeout</td>
</tr>
<tr class="odd">
<td>Split-brain (partition)</td>
<td>Only majority side commits</td>
</tr>
<tr class="even">
<td>Rejoin after partition</td>
<td>Logs reconciled safely</td>
</tr>
<tr class="odd">
<td>Cluster reconfiguration</td>
<td>No lost or duplicated entries</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-51" class="level4">
<h4 class="anchored" data-anchor-id="complexity-51">Complexity</h4>
<ul>
<li>Message rounds per operation: 1 (steady state)</li>
<li>Election rounds: variable (timeout + vote requests)</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ node failures</li>
<li>Storage: log + term numbers per server</li>
<li>Communication: <span class="math inline">\(O(N)\)</span> per append</li>
</ul>
<p>Raft turns consensus into a <em>rhythmic heartbeat</em>: leaders rise and fall, logs march forward in unison, and even when chaos strikes, the cluster remembers, exactly, what was decided.</p>
</section>
</section>
<section id="viewstamped-replication-vr" class="level3">
<h3 class="anchored" data-anchor-id="viewstamped-replication-vr">854 Viewstamped Replication (VR)</h3>
<p>Viewstamped Replication (VR) is a consensus and replication algorithm developed before Raft and Multi-Paxos. It was designed to make fault-tolerant state machine replication easier to understand and implement. VR organizes time into views (epochs) led by a primary replica, ensuring that a group of servers maintains a consistent, ordered log of client operations even when some nodes fail.</p>
<section id="what-problem-are-we-solving-52" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-52">What Problem Are We Solving?</h4>
<p>In distributed systems, we need to ensure that:</p>
<ol type="1">
<li>All replicas execute the same sequence of operations.</li>
<li>The system continues to make progress even if some replicas crash.</li>
<li>No two primaries (leaders) can make conflicting decisions.</li>
</ol>
<p>Paxos solved this but was hard to explain; VR re-frames the same problem with <em>primary-backup</em> terminology that developers already understand.</p>
<blockquote class="blockquote">
<p>“Think of it as a primary that keeps a careful diary, and a quorum that makes sure it never forgets what it wrote.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-52" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-52">How Does It Work (Plain Language)</h4>
<p>VR uses three phases that repeat through <em>views</em>:</p>
<section id="normal-operation" class="level5">
<h5 class="anchored" data-anchor-id="normal-operation">1. Normal Operation</h5>
<ul>
<li>One replica acts as primary; others are backups.</li>
<li>The primary receives client requests, assigns log sequence numbers, and sends <code>Prepare</code> messages to backups.</li>
<li>Backups reply with <code>PrepareOK</code>.</li>
<li>Once the primary collects acknowledgments from a majority, it commits the operation and responds to the client.</li>
</ul>
</section>
<section id="view-change-leader-election" class="level5">
<h5 class="anchored" data-anchor-id="view-change-leader-election">2. View Change (Leader Election)</h5>
<ul>
<li>If backups don’t hear from the primary within a timeout, they initiate a view change.</li>
<li>Each replica sends its log and view number to others.</li>
<li>The highest view number’s candidate becomes the new primary.</li>
<li>The new primary merges the most up-to-date logs and starts a new view.</li>
</ul>
</section>
<section id="recovery" class="level5">
<h5 class="anchored" data-anchor-id="recovery">3. Recovery</h5>
<ul>
<li>A crashed or slow replica can rejoin by requesting the current log from others.</li>
<li>It synchronizes up to the most recent committed operation.</li>
</ul>
</section>
</section>
<section id="example-timeline-4" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-4">Example Timeline</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Phase</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Normal</td>
<td>Primary P1 receives request (op X)</td>
</tr>
<tr class="even">
<td>2</td>
<td>Normal</td>
<td>Sends <code>Prepare(view=1, op=X)</code></td>
</tr>
<tr class="odd">
<td>3</td>
<td>Normal</td>
<td>Majority send <code>PrepareOK</code></td>
</tr>
<tr class="even">
<td>4</td>
<td>Normal</td>
<td>P1 commits and replies to client</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Failure</td>
<td>P1 crashes; backups start view change</td>
</tr>
<tr class="even">
<td>6</td>
<td>View change</td>
<td>P2 collects votes, becomes new primary (view=2)</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Recovery</td>
<td>P1 restarts and syncs with P2’s log</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-simplified-python-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-pseudocode">Tiny Code (Simplified Python Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Replica:</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>):</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.view <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.primary <span class="op">=</span> <span class="va">False</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare(<span class="va">self</span>, op):</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.primary:</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>            msg <span class="op">=</span> (<span class="va">self</span>.view, <span class="bu">len</span>(<span class="va">self</span>.log), op)</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> msg</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare_ok(<span class="va">self</span>, msg):</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>        view, index, op <span class="op">=</span> msg</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> view <span class="op">==</span> <span class="va">self</span>.view:</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.log.append(op)</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> start_view_change(<span class="va">self</span>, new_view):</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.view <span class="op">=</span> new_view</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.primary <span class="op">=</span> <span class="va">False</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-52" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-52">Why It Matters</h4>
<ul>
<li>Conceptually clear: Primary-backup model with explicit views.</li>
<li>Fault tolerant: Works with up to ⌊(N−1)/2⌋ failures.</li>
<li>Consistent and safe: All committed operations appear in the same order on all replicas.</li>
<li>Foundation: Inspired Raft and modern replicated log protocols (Zab, PBFT, etc.).</li>
<li>Recovery-friendly: Supports crash recovery via log replay.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slightly more communication than Multi-Paxos.</li>
<li>Requires explicit view management.</li>
<li>Doesn’t separate safety and liveness as cleanly as Raft.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-43" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-43">A Gentle Proof (Why It Works)</h4>
<p>Each <em>view</em> has a single primary that coordinates commits.</p>
<p>Let <span class="math inline">\(V_i\)</span> be view <span class="math inline">\(i\)</span>, and <span class="math inline">\(Q_1\)</span>, <span class="math inline">\(Q_2\)</span> be any two majorities of replicas.</p>
<ol type="1">
<li>When the primary in <span class="math inline">\(V_i\)</span> commits an operation, it has acknowledgments from <span class="math inline">\(Q_1\)</span>.</li>
<li>During the next view change, the new primary gathers logs from a majority <span class="math inline">\(Q_2\)</span>.</li>
<li>Because <span class="math inline">\(Q_1 \cap Q_2 \ne \varnothing\)</span>, the committed entry appears in at least one replica in <span class="math inline">\(Q_2\)</span>.</li>
<li>The new primary merges it, ensuring all future logs include it.</li>
</ol>
<p>Hence, committed operations are never lost.</p>
<p>Formally: <span class="math display">\[
\forall v, i: \text{committed}(v, i) \Rightarrow \forall v' &gt; v, \text{primary}(v') \text{ includes } i
\]</span></p>
</section>
<section id="try-it-yourself-52" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-52">Try It Yourself</h4>
<ol type="1">
<li>Simulate a 3-replica system (P1, P2, P3).</li>
<li>Let P1 act as primary; send operations sequentially.</li>
<li>Kill P1 mid-operation, observe how P2 initiates a new view.</li>
<li>Reintroduce P1 and verify that it synchronizes the log.</li>
<li>Repeat with message drops and recoveries.</li>
</ol>
</section>
<section id="test-cases-52" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-52">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 41%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Normal operation</td>
<td>Primary commits via majority</td>
<td>Linearizable log</td>
</tr>
<tr class="even">
<td>Primary crash</td>
<td>View change elects new primary</td>
<td>Safe recovery</td>
</tr>
<tr class="odd">
<td>Network partition</td>
<td>Only majority proceeds</td>
<td>No conflicting commits</td>
</tr>
<tr class="even">
<td>Recovery after crash</td>
<td>Replica syncs log</td>
<td>Eventual consistency</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-52" class="level4">
<h4 class="anchored" data-anchor-id="complexity-52">Complexity</h4>
<ul>
<li>Message rounds: 2 per operation (prepare + commit)</li>
<li>View change: 1 additional round during leader election</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ replicas</li>
<li>State: log entries, view number, primary flag</li>
</ul>
<p>Viewstamped Replication is the bridge between Paxos and Raft, same mathematical core, but framed as a story of views and primaries, where leadership changes are graceful and memory never fades.</p>
</section>
</section>
<section id="practical-byzantine-fault-tolerance-pbft" class="level3">
<h3 class="anchored" data-anchor-id="practical-byzantine-fault-tolerance-pbft">855 Practical Byzantine Fault Tolerance (PBFT)</h3>
<p>Practical Byzantine Fault Tolerance (PBFT) is a consensus algorithm that tolerates <em>Byzantine failures</em>, arbitrary or even malicious behavior by some nodes, while still ensuring correctness and liveness. It allows a distributed system of <span class="math inline">\(3f + 1\)</span> replicas to continue operating correctly even if up to <span class="math inline">\(f\)</span> of them act incorrectly or dishonestly.</p>
<section id="what-problem-are-we-solving-53" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-53">What Problem Are We Solving?</h4>
<p>Classic consensus algorithms like Paxos or Raft assume crash faults: nodes may stop working, but they never lie. In real-world distributed systems, especially open or adversarial environments (like blockchains, financial systems, or untrusted datacenters), nodes can behave arbitrarily:</p>
<ul>
<li>Send conflicting messages</li>
<li>Forge responses</li>
<li>Replay or reorder messages</li>
</ul>
<p>PBFT ensures the system still reaches agreement and executes operations in the same order, even if some nodes are malicious.</p>
<blockquote class="blockquote">
<p>“It’s consensus in a world where some players cheat, and honesty still wins.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-53" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-53">How Does It Work (Plain Language)</h4>
<p>PBFT operates in views coordinated by a primary (leader), with replicas as backups. Each client request passes through three phases, all authenticated by digital signatures or message digests.</p>
<section id="roles-1" class="level5">
<h5 class="anchored" data-anchor-id="roles-1">Roles</h5>
<ul>
<li>Primary: coordinates request ordering.</li>
<li>Replicas: validate and agree on the primary’s proposals.</li>
<li>Client: sends requests and waits for a quorum of replies.</li>
</ul>
</section>
<section id="the-three-phases" class="level5">
<h5 class="anchored" data-anchor-id="the-three-phases">The Three Phases</h5>
<ol type="1">
<li><p>Pre-Prepare</p>
<ul>
<li>Client sends request: <code>⟨REQUEST, op, timestamp, client⟩</code>.</li>
<li>Primary assigns sequence number <code>n</code>, broadcasts <code>⟨PRE-PREPARE, v, n, d⟩</code>, where <code>d</code> = digest of the request.</li>
</ul></li>
<li><p>Prepare</p>
<ul>
<li>Each replica verifies the message and broadcasts <code>⟨PREPARE, v, n, d⟩</code> to all others.</li>
<li>When a replica receives <span class="math inline">\(2f\)</span> matching PREPARE messages, it becomes <em>prepared</em>.</li>
</ul></li>
<li><p>Commit</p>
<ul>
<li>Each replica broadcasts <code>⟨COMMIT, v, n, d⟩</code>.</li>
<li>When it receives <span class="math inline">\(2f + 1\)</span> matching COMMIT messages, the operation is <em>committed</em> and executed.</li>
</ul></li>
</ol>
<p>The client waits for f + 1 matching replies, guaranteeing that at least one came from a correct node.</p>
</section>
</section>
<section id="example-timeline-for-4-replicas-f-1" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-for-4-replicas-f-1">Example Timeline (for 4 replicas, f = 1)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Phase</th>
<th>Messages</th>
<th>Quorum Size</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Pre-prepare</td>
<td>1 primary → all</td>
<td>N</td>
<td>Order assignment</td>
</tr>
<tr class="even">
<td>Prepare</td>
<td>All-to-all</td>
<td>2f = 2</td>
<td>Agreement on order</td>
</tr>
<tr class="odd">
<td>Commit</td>
<td>All-to-all</td>
<td>2f + 1 = 3</td>
<td>Safe execution</td>
</tr>
</tbody>
</table>
<p>If the primary fails or misbehaves, replicas detect inconsistency and trigger a view change, electing a new primary.</p>
</section>
<section id="tiny-code-simplified-python-simulation-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-simulation-2">Tiny Code (Simplified Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hashlib <span class="im">import</span> sha256</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Replica:</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>, f):</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.f <span class="op">=</span> f</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.view <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> digest(<span class="va">self</span>, msg):</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sha256(msg.encode()).hexdigest()</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> pre_prepare(<span class="va">self</span>, op, n):</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> <span class="va">self</span>.digest(op)</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="st">"PRE-PREPARE"</span>, <span class="va">self</span>.view, n, d)</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare(<span class="va">self</span>, pre_prepare_msg):</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>        phase, view, n, d <span class="op">=</span> pre_prepare_msg</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="st">"PREPARE"</span>, view, n, d)</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> commit(<span class="va">self</span>, prepare_msgs):</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(prepare_msgs) <span class="op">&gt;=</span> <span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.f:</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (<span class="st">"COMMIT"</span>, <span class="va">self</span>.view, prepare_msgs[<span class="dv">0</span>][<span class="dv">2</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-53" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-53">Why It Matters</h4>
<ul>
<li>Byzantine fault tolerance: survives arbitrary node failures.</li>
<li>Strong consistency: all non-faulty nodes agree on the same sequence of operations.</li>
<li>Practicality: avoids expensive cryptographic proofs (unlike earlier BFT protocols).</li>
<li>Low latency: only three message rounds in the common case.</li>
<li>Influence: forms the basis for modern blockchain consensus protocols (Tendermint, HotStuff, PBFT-SMART, LibraBFT).</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>High communication cost (<span class="math inline">\(O(n^2)\)</span> messages per phase).</li>
<li>Assumes authenticated channels.</li>
<li>Performance degrades beyond a small cluster (typically ≤ 20 replicas).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-44" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-44">A Gentle Proof (Why It Works)</h4>
<p>PBFT ensures safety and liveness through quorum intersection and authentication.</p>
<ul>
<li>Each decision requires agreement by <span class="math inline">\(2f + 1\)</span> nodes.</li>
<li>Any two quorums intersect in at least one <em>correct</em> node: <span class="math display">\[
(2f + 1) + (2f + 1) &gt; 3f + 1
\]</span> So there’s always at least one honest replica linking past and future decisions.</li>
<li>Because all messages are signed, a faulty node cannot impersonate or forge votes.</li>
</ul>
<p>Hence, even with up to <span class="math inline">\(f\)</span> malicious nodes, conflicting commits are impossible.</p>
<p>Formally: <span class="math display">\[
\forall n, v: \text{committed}(n, v) \Rightarrow \text{no conflicting } v'
\]</span></p>
</section>
<section id="try-it-yourself-53" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-53">Try It Yourself</h4>
<ol type="1">
<li>Simulate 4 replicas (<span class="math inline">\(f = 1\)</span>).</li>
<li>Let one node send bad messages, the system still agrees on one value.</li>
<li>Observe how the primary coordinates and how view change triggers on fault.</li>
<li>Implement message signing (e.g., SHA-256 + simple verify).</li>
<li>Measure total messages exchanged for 1 request vs Raft.</li>
</ol>
</section>
<section id="test-cases-53" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-53">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 36%">
<col style="width: 37%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No faults</td>
<td>3-phase commit</td>
<td>Agreement achieved</td>
</tr>
<tr class="even">
<td>Primary fails</td>
<td>View change</td>
<td>New primary elected</td>
</tr>
<tr class="odd">
<td>One replica sends bad data</td>
<td>Ignored by quorum</td>
<td>Safety preserved</td>
</tr>
<tr class="even">
<td>Replay attack</td>
<td>Rejected (timestamp/digest)</td>
<td>Integrity preserved</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-53" class="level4">
<h4 class="anchored" data-anchor-id="complexity-53">Complexity</h4>
<ul>
<li>Message complexity: <span class="math inline">\(O(n^2)\)</span> per request</li>
<li>Message rounds: 3 (pre-prepare, prepare, commit)</li>
<li>Fault tolerance: up to <span class="math inline">\(f\)</span> Byzantine failures with <span class="math inline">\(3f + 1\)</span> replicas</li>
<li>Latency: 3 network RTTs (normal case)</li>
</ul>
<p>PBFT is consensus in an adversarial world, where honesty must be proven by quorum, and agreement arises not from trust, but from the mathematics of intersection and integrity.</p>
</section>
</section>
<section id="zab-zookeeper-atomic-broadcast" class="level3">
<h3 class="anchored" data-anchor-id="zab-zookeeper-atomic-broadcast">856 Zab (Zookeeper Atomic Broadcast)</h3>
<p>Zab, short for Zookeeper Atomic Broadcast, is a consensus and replication protocol used by Apache Zookeeper to maintain a consistent distributed state across all servers. It’s designed specifically for leader-based coordination services, ensuring that all updates (state changes) are delivered in the same order to every replica, even across crashes and restarts.</p>
<section id="what-problem-are-we-solving-54" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-54">What Problem Are We Solving?</h4>
<p>Zookeeper provides guarantees that every operation:</p>
<ol type="1">
<li>Executes in a total order (same sequence everywhere).</li>
<li>Survives server crashes and recoveries.</li>
<li>Doesn’t lose committed updates even when the leader fails.</li>
</ol>
<p>Zab solves the challenge of combining:</p>
<ul>
<li>Atomic broadcast (all or nothing delivery), and</li>
<li>Crash recovery (no double-commit or rollback).</li>
</ul>
<blockquote class="blockquote">
<p>“If one server says it happened, then it happened everywhere, exactly once, in the same order.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-54" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-54">How Does It Work (Plain Language)</h4>
<p>Zab builds on the leader-follower model but extends it to guarantee total order broadcast and durable recovery. It works in three major phases:</p>
<section id="discovery-phase" class="level5">
<h5 class="anchored" data-anchor-id="discovery-phase">1. Discovery Phase</h5>
<ul>
<li>A new leader is elected (using an external mechanism like Fast Leader Election).</li>
<li>The leader determines the latest committed transaction ID (zxid) among servers.</li>
<li>The leader chooses the most up-to-date history as the system’s official prefix.</li>
</ul>
</section>
<section id="synchronization-phase" class="level5">
<h5 class="anchored" data-anchor-id="synchronization-phase">2. Synchronization Phase</h5>
<ul>
<li>The leader synchronizes followers’ logs to match the chosen prefix.</li>
<li>Followers truncate or fill in missing proposals to align with the leader’s state.</li>
<li>Once synchronized, followers move to the broadcast phase.</li>
</ul>
</section>
<section id="broadcast-phase" class="level5">
<h5 class="anchored" data-anchor-id="broadcast-phase">3. Broadcast Phase</h5>
<ul>
<li>The leader receives client transactions, assigns a new zxid (monotonically increasing ID), and sends a PROPOSAL to followers.</li>
<li>Followers persist the proposal to disk and reply with ACK.</li>
<li>When a quorum acknowledges, the leader sends a COMMIT message.</li>
<li>All followers apply the transaction in order.</li>
</ul>
</section>
</section>
<section id="example-timeline-5" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-5">Example Timeline</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Phase</th>
<th>Message</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Discovery</td>
<td>Leader election</td>
<td>New leader collects latest zxids</td>
</tr>
<tr class="even">
<td>Sync</td>
<td>PROPOSAL sync</td>
<td>Aligns logs among followers</td>
</tr>
<tr class="odd">
<td>Broadcast</td>
<td>PROPOSAL/ACK/COMMIT</td>
<td>Steady-state replication</td>
</tr>
</tbody>
</table>
<p>If the leader crashes mid-commit, the next leader uses the discovery phase to find the most advanced log, ensuring no committed transaction is lost or replayed.</p>
</section>
<section id="tiny-code-simplified-python-model" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-model">Tiny Code (Simplified Python Model)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Server:</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>):</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.zxid <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_leader <span class="op">=</span> <span class="va">False</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> propose(<span class="va">self</span>, data):</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.is_leader:</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.zxid <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>        proposal <span class="op">=</span> (<span class="va">self</span>.zxid, data)</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> proposal</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ack(<span class="va">self</span>, proposal):</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>        zxid, data <span class="op">=</span> proposal</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log.append((zxid, data))</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> zxid</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> commit(<span class="va">self</span>, zxid):</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Committed zxid=</span><span class="sc">{</span>zxid<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This simplified model shows how proposals are acknowledged and then committed in strict zxid order.</p>
</section>
<section id="why-it-matters-54" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-54">Why It Matters</h4>
<ul>
<li>Crash recovery: Survives leader failures without losing committed data.</li>
<li>Total ordering: All replicas process updates in the same sequence.</li>
<li>Efficiency: One leader handles all writes, followers read-only.</li>
<li>Used in: Apache Zookeeper, Kafka’s controller quorum, and similar metadata services.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Single leader becomes a bottleneck under heavy write load.</li>
<li>Requires stable quorum for progress.</li>
<li>Reads may lag slightly behind the leader (depending on sync policy).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-45" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-45">A Gentle Proof (Why It Works)</h4>
<p>Zab ensures atomic broadcast through prefix agreement and commit durability.</p>
<p>Let <span class="math inline">\(L\)</span> be the leader, and <span class="math inline">\(F_i\)</span> followers.</p>
<ul>
<li>Each transaction <span class="math inline">\(T_k\)</span> has a unique zxid <span class="math inline">\((epoch, counter)\)</span>.</li>
<li>Commit rule: <span class="math inline">\(T_k\)</span> is committed once a quorum ACKs its proposal.</li>
<li>Because all followers must ACK before commit, any new leader elected later must include all transactions up to the highest committed zxid.</li>
</ul>
<p>Formally: <span class="math display">\[
\forall T_i, T_j: zxid(T_i) &lt; zxid(T_j) \Rightarrow \text{deliver}(T_i) \text{ before } \text{deliver}(T_j)
\]</span></p>
<p>and <span class="math display">\[
\text{If } T_i \text{ committed in epoch } e, \text{ then all future epochs } e' &gt; e \text{ contain } T_i
\]</span></p>
<p>Hence, atomicity and total order are preserved across view changes.</p>
</section>
<section id="try-it-yourself-54" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-54">Try It Yourself</h4>
<ol type="1">
<li>Simulate three servers: one leader, two followers.</li>
<li>Let the leader propose transactions (T1, T2, T3).</li>
<li>Kill the leader after committing T2, start a new leader.</li>
<li>Observe how T3 (uncommitted) is discarded, but T1–T2 persist.</li>
<li>Replay the process and verify all nodes converge to identical logs.</li>
</ol>
</section>
<section id="test-cases-54" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-54">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 40%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Normal broadcast</td>
<td>Leader proposes, quorum ACKs</td>
<td>Total order commit</td>
</tr>
<tr class="even">
<td>Leader crash after commit</td>
<td>Recovery preserves state</td>
<td>No rollback</td>
</tr>
<tr class="odd">
<td>Leader crash before commit</td>
<td>Uncommitted proposal dropped</td>
<td>No duplication</td>
</tr>
<tr class="even">
<td>Log divergence</td>
<td>New leader syncs highest prefix</td>
<td>Consistency restored</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-54" class="level4">
<h4 class="anchored" data-anchor-id="complexity-54">Complexity</h4>
<ul>
<li>Message rounds: 2 (proposal + commit)</li>
<li>Message complexity: <span class="math inline">\(O(N)\)</span> per transaction</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ failures</li>
<li>Storage: log entries + zxid sequence</li>
<li>Latency: 2 network RTTs per transaction</li>
</ul>
<p>Zab is the quiet metronome behind Zookeeper’s reliability, a single leader broadcasting heartbeat and order, ensuring that every replica, everywhere, hears the same story in the same rhythm.</p>
</section>
</section>
<section id="epaxos-egalitarian-paxos" class="level3">
<h3 class="anchored" data-anchor-id="epaxos-egalitarian-paxos">857 EPaxos (Egalitarian Paxos)</h3>
<p>EPaxos, short for Egalitarian Paxos, is a fast, leaderless consensus algorithm that generalizes Paxos to allow <em>any</em> replica to propose and commit commands concurrently, without waiting for a fixed leader. It optimizes latency and throughput by exploiting command commutativity (independent operations that can execute in any order) and fast quorum commits.</p>
<section id="what-problem-are-we-solving-55" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-55">What Problem Are We Solving?</h4>
<p>In leader-based protocols (like Paxos, Raft, Zab):</p>
<ul>
<li>One node (the leader) coordinates every command.</li>
<li>This creates a bottleneck and extra latency (2 RTTs to commit).</li>
</ul>
<p>EPaxos eliminates the leader and lets multiple nodes propose concurrently. It still guarantees total order of non-commuting operations while skipping coordination for independent ones.</p>
<blockquote class="blockquote">
<p>“If commands don’t conflict, why make them wait in line?”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-55" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-55">How Does It Work (Plain Language)</h4>
<p>EPaxos generalizes Paxos’s quorum logic with dependency tracking. Each replica can propose commands, and dependencies determine ordering.</p>
<section id="key-components" class="level5">
<h5 class="anchored" data-anchor-id="key-components">Key Components</h5>
<ol type="1">
<li><p>Command</p>
<ul>
<li>Each client request: a command <code>C</code> with unique ID and operation.</li>
</ul></li>
<li><p>Dependencies</p>
<ul>
<li>Each command tracks a set of conflicting commands that must precede it.</li>
<li>Two commands commute if they don’t access overlapping keys or objects.</li>
</ul></li>
<li><p>Quorums</p>
<ul>
<li>EPaxos uses fast quorums, slightly larger than a majority, to commit in 1 RTT when there’s no conflict.</li>
</ul></li>
</ol>
</section>
</section>
<section id="protocol-overview" class="level4">
<h4 class="anchored" data-anchor-id="protocol-overview">Protocol Overview</h4>
<section id="propose-phase" class="level5">
<h5 class="anchored" data-anchor-id="propose-phase">1. Propose Phase</h5>
<ul>
<li>A replica receives a client command <code>C</code>.</li>
<li>It sends a PreAccept(C, deps) message to all others with an initial dependency set (empty or guessed).</li>
<li>Each replica adds conflicting commands it knows of, returning an updated dependency set.</li>
</ul>
</section>
<section id="fast-path-no-conflicts" class="level5">
<h5 class="anchored" data-anchor-id="fast-path-no-conflicts">2. Fast Path (no conflicts)</h5>
<ul>
<li><p>If all responses agree on the same dependency set:</p>
<ul>
<li>The command is committed immediately in one round-trip (fast path).</li>
</ul></li>
<li><p>Otherwise, proceed to the slow path.</p></li>
</ul>
</section>
<section id="slow-path-conflicts" class="level5">
<h5 class="anchored" data-anchor-id="slow-path-conflicts">3. Slow Path (conflicts)</h5>
<ul>
<li>The proposer collects responses and picks the maximum dependency set.</li>
<li>Sends an Accept message to ensure quorum agreement.</li>
<li>Once a quorum of Accepts is received, the command is committed.</li>
</ul>
</section>
<section id="execution" class="level5">
<h5 class="anchored" data-anchor-id="execution">4. Execution</h5>
<ul>
<li><p>Commands are executed respecting the dependency graph (a partial order).</p>
<ul>
<li>If A depends on B, execute B before A.</li>
</ul></li>
</ul>
</section>
</section>
<section id="example-timeline-5-replicas-fast-quorum-3" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-5-replicas-fast-quorum-3">Example Timeline (5 replicas, fast quorum = 3)</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 48%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Replica</th>
<th>Action</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>R1</td>
<td>PreAccept(C1, {})</td>
<td>Propose command C1</td>
</tr>
<tr class="even">
<td>2</td>
<td>R2, R3</td>
<td>Reply with same deps</td>
<td>No conflicts</td>
</tr>
<tr class="odd">
<td>3</td>
<td>R1</td>
<td>Fast commit (1 RTT)</td>
<td>Command C1 committed</td>
</tr>
<tr class="even">
<td>4</td>
<td>R4</td>
<td>PreAccept(C2, {C1})</td>
<td>Conflicting command</td>
</tr>
<tr class="odd">
<td>5</td>
<td>R2, R5</td>
<td>Add dependency</td>
<td>Requires slow path</td>
</tr>
<tr class="even">
<td>6</td>
<td>R4</td>
<td>Commit C2 after quorum Accept</td>
<td>Ordered after C1</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-simplified-python-sketch" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-sketch">Tiny Code (Simplified Python Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EPaxosReplica:</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>):</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps <span class="op">=</span> {}</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> {}</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preaccept(<span class="va">self</span>, cmd, deps):</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deps[cmd] <span class="op">=</span> deps.copy()</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add local conflicts</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="va">self</span>.log:</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.conflicts(cmd, c):</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.deps[cmd].add(c)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.deps[cmd]</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> conflicts(<span class="va">self</span>, c1, c2):</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># simple key-based conflict detection</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c1.key <span class="op">==</span> c2.key</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each replica maintains dependencies and merges them to form a global partial order.</p>
</section>
<section id="why-it-matters-55" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-55">Why It Matters</h4>
<ul>
<li>Leaderless: No single coordinator or bottleneck.</li>
<li>Low latency: One RTT commit in the common case.</li>
<li>Parallelism: Multiple replicas propose and commit concurrently.</li>
<li>Consistency: Serializability for dependent commands, commutativity for independent ones.</li>
<li>High availability: Survives up to ⌊(N−1)/2⌋ failures.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>More complex dependency tracking and message state.</li>
<li>Fast path requires more replicas than majority quorum.</li>
<li>Log recovery (after crash) is trickier.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-46" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-46">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(Q_f\)</span> be a fast quorum, <span class="math inline">\(Q_s\)</span> a slow quorum, and <span class="math inline">\(N\)</span> replicas.</p>
<ul>
<li><span class="math inline">\(|Q_f| + |Q_s| &gt; N\)</span> ensures intersection.</li>
<li>Any two quorums intersect in at least one correct replica, ensuring agreement.</li>
</ul>
<p>For each command <span class="math inline">\(C\)</span>:</p>
<ul>
<li>The dependency set <span class="math inline">\(\text{deps}(C)\)</span> defines a partial order <span class="math inline">\(&lt;\)</span>.</li>
<li>If <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> conflict, then either <span class="math inline">\(C_1 &lt; C_2\)</span> or <span class="math inline">\(C_2 &lt; C_1\)</span> is enforced via dependencies.</li>
</ul>
<p>Hence, the execution order: <span class="math display">\[
C_i &lt; C_j ;\Rightarrow; \text{execute}(C_i) \text{ before } \text{execute}(C_j)
\]</span> maintains linearizability for conflicting commands and high concurrency for independent ones.</p>
</section>
<section id="try-it-yourself-55" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-55">Try It Yourself</h4>
<ol type="1">
<li>Simulate 5 replicas; let two propose commands on disjoint keys concurrently.</li>
<li>Observe both commit in 1 RTT (fast path).</li>
<li>Introduce a conflicting command; watch it fall back to the 2-phase slow path.</li>
<li>Draw the dependency graph and verify topological execution order.</li>
<li>Fail one replica and confirm quorum intersection still ensures agreement.</li>
</ol>
</section>
<section id="test-cases-55" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-55">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 26%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Independent commands</td>
<td>Fast path</td>
<td>1 RTT commit</td>
</tr>
<tr class="even">
<td>Conflicting commands</td>
<td>Slow path</td>
<td>2 RTT commit</td>
</tr>
<tr class="odd">
<td>Replica crash</td>
<td>Quorum intersection</td>
<td>Safety preserved</td>
</tr>
<tr class="even">
<td>Multiple concurrent proposals</td>
<td>Dependency merge</td>
<td>Deterministic total order</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-55" class="level4">
<h4 class="anchored" data-anchor-id="complexity-55">Complexity</h4>
<ul>
<li>Fast path: 1 RTT</li>
<li>Slow path: 2 RTTs</li>
<li>Message complexity: <span class="math inline">\(O(N^2)\)</span> (PreAccept + Accept)</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ failures</li>
<li>Dependency tracking: <span class="math inline">\(O(K)\)</span> per command (for K conflicts)</li>
</ul>
<p>EPaxos makes consensus truly egalitarian, no single leader, no fixed rhythm, just replicas cooperating in harmony, deciding together, each aware of dependencies, yet free to move fast when they can.</p>
</section>
</section>
<section id="vrr-virtual-ring-replication" class="level3">
<h3 class="anchored" data-anchor-id="vrr-virtual-ring-replication">858 VRR (Virtual Ring Replication)</h3>
<p>Virtual Ring Replication (VRR) is a distributed consensus and replication protocol that organizes replicas into a logical ring to provide high-throughput, fault-tolerant log replication with a simpler structure than fully connected quorum systems. It ensures that all replicas deliver updates in the same order while efficiently handling failures and recovery.</p>
<section id="what-problem-are-we-solving-56" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-56">What Problem Are We Solving?</h4>
<p>Traditional replication protocols like Paxos or Raft rely on majority quorums and broadcast communication, which can become expensive as the cluster grows. VRR instead arranges replicas into a virtual ring where messages flow in one direction, reducing coordination overhead.</p>
<p>The goal is:</p>
<ol type="1">
<li>Consistent state replication across all replicas.</li>
<li>Efficient communication using ring topology.</li>
<li>Fault tolerance through virtual successor and predecessor mapping.</li>
</ol>
<blockquote class="blockquote">
<p>“Rather than shouting to everyone, VRR whispers around the circle, and the message still reaches all.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-56" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-56">How Does It Work (Plain Language)</h4>
<p>VRR extends the primary-backup model with a <em>logical ring overlay</em> among replicas.</p>
<section id="components" class="level5">
<h5 class="anchored" data-anchor-id="components">Components</h5>
<ul>
<li>Primary replica: initiates client requests and broadcasts updates around the ring.</li>
<li>Backups: relay and confirm messages along the ring.</li>
<li>Ring order: determines the sequence of replication and acknowledgment.</li>
<li>View number: identifies the current configuration (like a Paxos term).</li>
</ul>
</section>
<section id="phases" class="level5">
<h5 class="anchored" data-anchor-id="phases">Phases</h5>
<ol type="1">
<li><p>Normal Operation</p>
<ul>
<li>The primary receives a client request.</li>
<li>It assigns a sequence number <code>n</code> and sends an UPDATE(n, op) to its successor on the ring.</li>
<li>Each node forwards the message to its successor until it completes a full circle.</li>
<li>When the update returns to the primary, it is committed.</li>
<li>Every node applies the operation in order.</li>
</ul></li>
<li><p>Failure Handling</p>
<ul>
<li>If a node fails to forward the update, its successor detects timeout and initiates a view change.</li>
<li>The next node in the ring becomes the new primary and continues operation.</li>
<li>The ring is <em>virtually rewired</em> to skip failed nodes.</li>
</ul></li>
<li><p>Recovery</p>
<ul>
<li>Failed nodes can rejoin later by replaying missed updates from the ring or a checkpoint.</li>
</ul></li>
</ol>
</section>
</section>
<section id="example-timeline-6" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-6">Example Timeline</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 16%">
<col style="width: 76%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Phase</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Normal</td>
<td>Primary P1 sends UPDATE(n=1, X) to P2</td>
</tr>
<tr class="even">
<td>2</td>
<td>Normal</td>
<td>P2 → P3 → P4 (update circulates)</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Normal</td>
<td>P4 → P1 (full ring)</td>
</tr>
<tr class="even">
<td>4</td>
<td>Normal</td>
<td>P1 commits X</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Failure</td>
<td>P3 crashes; P4 times out</td>
</tr>
<tr class="even">
<td>6</td>
<td>View Change</td>
<td>P4 becomes new primary, rebuilds ring excluding P3</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-simplified-python-simulation-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-simulation-3">Tiny Code (Simplified Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Replica:</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>, successor<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.successor <span class="op">=</span> successor</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(<span class="va">self</span>, seq, op):</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log.append((seq, op))</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> applied op </span><span class="sc">{</span>op<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.successor:</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.successor.update(seq, op)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This model demonstrates circular propagation of updates through a virtual ring.</p>
</section>
<section id="why-it-matters-56" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-56">Why It Matters</h4>
<ul>
<li>Low communication overhead: Only one message per hop, not all-to-all.</li>
<li>High throughput: Ideal for stable, low-failure environments.</li>
<li>Scalable: Works well with many replicas.</li>
<li>Fault-tolerant: Handles failures by rerouting around missing nodes.</li>
<li>Foundation: Inspired later protocols like Corfu and chain replication.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slightly higher latency (depends on ring length).</li>
<li>Single primary at a time, reconfiguration cost on failure.</li>
<li>Requires stable network connectivity between ring neighbors.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-47" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-47">A Gentle Proof (Why It Works)</h4>
<p>Let replicas be arranged in a ring <span class="math inline">\(R = [r_1, r_2, \dots, r_N]\)</span>. Each operation <span class="math inline">\(op_i\)</span> is assigned a sequence number <span class="math inline">\(n_i\)</span> by the primary <span class="math inline">\(r_p\)</span>.</p>
<ul>
<li>Total order: updates circulate the ring in the same order for all.</li>
<li>Durability: a commit is acknowledged after returning to the primary, ensuring that all replicas have applied the update.</li>
<li>Fault tolerance: when a node fails, a new ring <span class="math inline">\(R'\)</span> is formed excluding it.</li>
</ul>
<p>For any two updates <span class="math inline">\(op_i, op_j\)</span>, <span class="math display">\[
n_i &lt; n_j \Rightarrow \text{deliver}(op_i) \text{ before } \text{deliver}(op_j)
\]</span> and <span class="math display">\[
\forall R', R'': \text{prefix}(R') = \text{prefix}(R'') \Rightarrow \text{consistent state}
\]</span></p>
<p>This preserves total order and prefix consistency under failures.</p>
</section>
<section id="try-it-yourself-56" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-56">Try It Yourself</h4>
<ol type="1">
<li>Create a ring of four replicas (A → B → C → D → A).</li>
<li>Let A be primary and broadcast updates (1, 2, 3).</li>
<li>Kill C mid-update, observe timeout and view change.</li>
<li>Rebuild ring as A → B → D → A, continue replication.</li>
<li>Reintroduce C, synchronize from D’s log.</li>
</ol>
</section>
<section id="test-cases-56" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-56">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Normal operation</td>
<td>Sequential forwarding</td>
<td>Ordered replication</td>
</tr>
<tr class="even">
<td>One node crash</td>
<td>View change</td>
<td>Ring reformed</td>
</tr>
<tr class="odd">
<td>Late node recovery</td>
<td>Log replay</td>
<td>Full synchronization</td>
</tr>
<tr class="even">
<td>Network delay</td>
<td>Sequential consistency</td>
<td>Eventual delivery</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-56" class="level4">
<h4 class="anchored" data-anchor-id="complexity-56">Complexity</h4>
<ul>
<li>Message rounds: <span class="math inline">\(O(N)\)</span> per update (one hop per replica)</li>
<li>Message complexity: <span class="math inline">\(O(N)\)</span></li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ via reformation</li>
<li>Storage: log per node + checkpoint</li>
<li>Latency: proportional to ring length</li>
</ul>
<p>Virtual Ring Replication is like a well-choreographed relay race, each runner passes the baton in perfect sequence, and even if one stumbles, the circle reforms and the race goes on.</p>
</section>
</section>
<section id="two-phase-commit-with-consensus" class="level3">
<h3 class="anchored" data-anchor-id="two-phase-commit-with-consensus">859 Two-Phase Commit with Consensus</h3>
<p>Two-Phase Commit with Consensus (2PC+C) merges two powerful mechanisms, the atomic commit protocol from databases and distributed consensus from Paxos/Raft, to achieve fault-tolerant transactional commits across multiple nodes or services. It ensures that a transaction is either committed by <em>all</em> participants or aborted by <em>all</em>, even in the presence of failures or partitions.</p>
<section id="what-problem-are-we-solving-57" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-57">What Problem Are We Solving?</h4>
<p>The classic Two-Phase Commit (2PC) protocol coordinates distributed transactions across nodes, but it has a fatal flaw:</p>
<ul>
<li>If the coordinator fails after participants vote <em>yes</em> but before announcing <em>commit</em>, all participants block indefinitely.</li>
</ul>
<p>To fix this, 2PC needs consensus, a way for participants to agree on the outcome (commit or abort) even if the coordinator dies.</p>
<p>2PC+C integrates consensus (like Paxos or Raft) to make the decision durable, available, and recoverable.</p>
<blockquote class="blockquote">
<p>“If one node falls silent, consensus finishes the sentence.”</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-57" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-57">How Does It Work (Plain Language)</h4>
<p>The protocol has two main roles:</p>
<ul>
<li>Coordinator: orchestrates the transaction (can be replicated using consensus).</li>
<li>Participants: local databases or services that prepare and commit work.</li>
</ul>
<p>The algorithm proceeds in two logical phases, each made reliable by consensus.</p>
<section id="prepare-phase-voting" class="level5">
<h5 class="anchored" data-anchor-id="prepare-phase-voting">1. Prepare Phase (Voting)</h5>
<ol type="1">
<li><p>Coordinator proposes a transaction <code>T</code>.</p></li>
<li><p>Sends <code>PREPARE(T)</code> to all participants.</p></li>
<li><p>Each participant:</p>
<ul>
<li>Validates local constraints.</li>
<li>Logs <code>READY(T)</code> to durable storage.</li>
<li>Replies <code>YES</code> (ready to commit) or <code>NO</code> (abort).</li>
</ul></li>
<li><p>Coordinator collects votes.</p>
<ul>
<li>If any <code>NO</code> → outcome = ABORT.</li>
<li>If all <code>YES</code> → outcome = COMMIT.</li>
</ul></li>
</ol>
</section>
<section id="commit-phase-decision-via-consensus" class="level5">
<h5 class="anchored" data-anchor-id="commit-phase-decision-via-consensus">2. Commit Phase (Decision via Consensus)</h5>
<ol start="5" type="1">
<li><p>Coordinator proposes the final decision (<code>COMMIT</code> or <code>ABORT</code>) via consensus.</p></li>
<li><p>Once a majority of nodes in the consensus group agree:</p>
<ul>
<li>Decision is replicated and durable.</li>
</ul></li>
<li><p>All participants are informed of the final result and apply it locally.</p></li>
</ol>
<p>This way, even if the coordinator crashes mid-decision, another node can recover the log and complete the transaction safely.</p>
</section>
</section>
<section id="example-timeline-7" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-7">Example Timeline</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 19%">
<col style="width: 41%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Phase</th>
<th>Action</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Prepare</td>
<td>Coordinator sends <code>PREPARE(T)</code></td>
<td>Participants vote</td>
</tr>
<tr class="even">
<td>2</td>
<td>Prepare</td>
<td>All reply <code>YES</code></td>
<td>Decision: commit</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Consensus</td>
<td>Decision proposed via Paxos</td>
<td>Majority accept</td>
</tr>
<tr class="even">
<td>4</td>
<td>Commit</td>
<td>Decision broadcast</td>
<td>All commit</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Crash recovery</td>
<td>Coordinator restarts</td>
<td>Learns decision from log</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-simplified-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-pseudocode">Tiny Code (Simplified Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Participant:</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"INIT"</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare(<span class="va">self</span>, tx):</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.can_commit(tx):</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.state <span class="op">=</span> <span class="st">"READY"</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"YES"</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.state <span class="op">=</span> <span class="st">"ABORT"</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"NO"</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> commit(<span class="va">self</span>):</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">"READY"</span>:</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.state <span class="op">=</span> <span class="st">"COMMIT"</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Committed"</span>)</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Aborted"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The coordinator’s decision (commit or abort) is stored via consensus among replicas, ensuring fault tolerance.</p>
</section>
<section id="why-it-matters-57" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-57">Why It Matters</h4>
<ul>
<li>No blocking: coordinator failure doesn’t stall participants.</li>
<li>Atomicity: all-or-nothing commit across distributed systems.</li>
<li>Durability: decisions survive crashes and restarts.</li>
<li>Integrates databases + consensus systems: basis for Spanner, CockroachDB, TiDB, Yugabyte, etc.</li>
<li>General-purpose: works across heterogeneous services (microservices, key-value stores, message queues).</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>More message complexity (adds consensus layer).</li>
<li>Slightly higher latency.</li>
<li>Consensus replicas must remain available (quorum required).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-48" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-48">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(D \in {\text{COMMIT}, \text{ABORT}}\)</span> be the global decision.</p>
<ul>
<li>All participants vote and log their decisions durably.</li>
<li>The coordinator uses consensus to record <span class="math inline">\(D\)</span> on a majority of replicas.</li>
<li>Any recovery process consults the consensus log: <span class="math display">\[
\text{learn}(D) = \text{argmax}_n(\text{accepted}_n)
\]</span> ensuring that all replicas converge on the same outcome.</li>
</ul>
<p>Because consensus ensures a single agreed value, no two participants can observe conflicting decisions.</p>
<p>Safety: <span class="math display">\[
\text{If one node commits } T, \text{ then every node eventually commits } T
\]</span></p>
<p>Liveness (under partial synchrony): <span class="math display">\[
\text{If quorum available and all vote YES, } T \text{ eventually commits.}
\]</span></p>
</section>
<section id="try-it-yourself-57" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-57">Try It Yourself</h4>
<ol type="1">
<li>Simulate three participants and one consensus cluster (3 nodes).</li>
<li>Let all vote <code>YES</code>. Commit via consensus → durable success.</li>
<li>Crash coordinator mid-phase → restart → read outcome from log.</li>
<li>Try with one participant voting <code>NO</code> → global abort.</li>
<li>Observe that no node blocks indefinitely.</li>
</ol>
</section>
<section id="test-cases-57" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-57">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 34%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>All participants vote YES</td>
<td>Commit via consensus</td>
<td>Consistent commit</td>
</tr>
<tr class="even">
<td>One participant votes NO</td>
<td>Global abort</td>
<td>Safe abort</td>
</tr>
<tr class="odd">
<td>Coordinator crash mid-commit</td>
<td>Recovery via consensus log</td>
<td>No blocking</td>
</tr>
<tr class="even">
<td>Network partition</td>
<td>Majority side decides</td>
<td>Consistency preserved</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-57" class="level4">
<h4 class="anchored" data-anchor-id="complexity-57">Complexity</h4>
<ul>
<li>Message rounds: 2PC (2) + Consensus (2) = 4 in total</li>
<li>Message complexity: <span class="math inline">\(O(N + M)\)</span> for N participants, M replicas in consensus</li>
<li>Fault tolerance: up to ⌊(M−1)/2⌋ coordinator replica failures</li>
<li>Storage: logs for votes and decisions</li>
</ul>
<p>2PC with Consensus turns the fragile “yes/no” dance of distributed transactions into a robust orchestration, where even silence, failure, or chaos cannot stop the system from deciding, together, and forever.</p>
</section>
</section>
<section id="chain-replication" class="level3">
<h3 class="anchored" data-anchor-id="chain-replication">860 Chain Replication</h3>
<p>Chain Replication is a fault-tolerant replication technique that arranges servers in a linear chain, ensuring strong consistency, high throughput, and predictable failure recovery. It’s widely used in large-scale storage systems and coordination services where updates must be processed in total order without requiring all-to-all communication.</p>
<section id="what-problem-are-we-solving-58" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-58">What Problem Are We Solving?</h4>
<p>Traditional quorum-based replication (like Paxos or Raft) requires majority acknowledgments, which can increase latency. In contrast, Chain Replication guarantees:</p>
<ul>
<li>Linearizability (same order of operations on all replicas)</li>
<li>High throughput by pipelining updates down a chain</li>
<li>Low latency for reads (served from the tail)</li>
</ul>
<p>The key idea:</p>
<blockquote class="blockquote">
<p>Arrange replicas in a chain: head → middle → tail. Writes flow forward, reads flow backward.</p>
</blockquote>
</section>
<section id="how-does-it-work-plain-language-58" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-58">How Does It Work (Plain Language)</h4>
<section id="setup" class="level5">
<h5 class="anchored" data-anchor-id="setup">Setup</h5>
<p>A cluster has <span class="math inline">\(N\)</span> replicas, ordered logically: <span class="math display">\[
r_1 \rightarrow r_2 \rightarrow r_3 \rightarrow \dots \rightarrow r_N
\]</span></p>
<ul>
<li>Head: handles all client write requests.</li>
<li>Tail: handles all client read requests.</li>
<li>Middle nodes: forward writes and acknowledgments.</li>
</ul>
</section>
<section id="write-path" class="level5">
<h5 class="anchored" data-anchor-id="write-path">Write Path</h5>
<ol type="1">
<li>Client sends WRITE(x, v) to the head.</li>
<li>The head applies the update locally and forwards it to its successor.</li>
<li>Each node applies the update and forwards it down the chain.</li>
<li>The tail applies the update, sends ACK upstream.</li>
<li>Once the head receives ACK, the write is committed and acknowledged to the client.</li>
</ol>
</section>
<section id="read-path" class="level5">
<h5 class="anchored" data-anchor-id="read-path">Read Path</h5>
<ul>
<li>Client sends READ(x) to the tail, which has the most up-to-date committed state.</li>
</ul>
</section>
</section>
<section id="example-timeline-3-node-chain" class="level4">
<h4 class="anchored" data-anchor-id="example-timeline-3-node-chain">Example Timeline (3-node chain)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Node</th>
<th>Action</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Head</td>
<td>WRITE(x=5)</td>
<td>Apply locally</td>
</tr>
<tr class="even">
<td>2</td>
<td>Head → Mid</td>
<td>Forward update</td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>Mid</td>
<td>Apply, forward to Tail</td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td>Tail</td>
<td>Apply, send ACK</td>
<td>Commit point</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Mid → Head</td>
<td>ACKs propagate back</td>
<td></td>
</tr>
<tr class="even">
<td>6</td>
<td>Head</td>
<td>Confirms to client</td>
<td>Commit complete</td>
</tr>
</tbody>
</table>
</section>
<section id="failure-handling" class="level4">
<h4 class="anchored" data-anchor-id="failure-handling">Failure Handling</h4>
<ol type="1">
<li><p>Head Failure: next node becomes new head.</p></li>
<li><p>Tail Failure: previous node becomes new tail.</p></li>
<li><p>Middle Failure: chain is reconnected, skipping the failed node.</p>
<ul>
<li>The coordinator or control service reconfigures the chain dynamically.</li>
</ul></li>
<li><p>Recovery: a restarted node can rejoin by fetching the tail’s state and reentering the chain.</p></li>
</ol>
<p>Failures never violate consistency, only temporarily reduce availability.</p>
</section>
<section id="tiny-code-simplified-python-sketch-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-simplified-python-sketch-1">Tiny Code (Simplified Python Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node:</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>, successor<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state <span class="op">=</span> {}</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.successor <span class="op">=</span> successor</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, key, value):</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state[key] <span class="op">=</span> value</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.successor:</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.successor.write(key, value)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"ACK"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This demonstrates the write propagation along the chain.</p>
</section>
<section id="why-it-matters-58" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-58">Why It Matters</h4>
<ul>
<li>Strong consistency: total ordering of all updates.</li>
<li>High throughput: pipelined forwarding and commit acknowledgment.</li>
<li>Low latency reads: tail always has the latest committed data.</li>
<li>Simplicity: deterministic structure (head, middle, tail).</li>
<li>Used in: Microsoft’s FAWN-KV, Ceph RADOS, Azure Cosmos DB, and more.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Single chain per data partition, not suitable for high contention global writes.</li>
<li>Reconfiguration during failures adds brief downtime.</li>
<li>Requires external coordination (e.g., Zookeeper) to manage membership.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-49" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-49">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(U = {u_1, u_2, \dots, u_n}\)</span> be a sequence of updates applied along the chain.</p>
<p>Each update <span class="math inline">\(u_i\)</span> is:</p>
<ul>
<li>Applied in order at each node (FIFO forwarding).</li>
<li>Committed when acknowledged by the tail.</li>
</ul>
<p>Linearizability: For any two operations <span class="math inline">\(u_i\)</span> and <span class="math inline">\(u_j\)</span>: <span class="math display">\[
u_i \text{ completes before } u_j \text{ begins} \Rightarrow u_i \text{ visible before } u_j
\]</span></p>
<p>All nodes see writes in identical order because forwarding is sequential: <span class="math display">\[
\text{order}(r_1) = \text{order}(r_2) = \dots = \text{order}(r_N)
\]</span></p>
<p>Hence, reads from the tail always reflect the latest committed value.</p>
</section>
<section id="try-it-yourself-58" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-58">Try It Yourself</h4>
<ol type="1">
<li>Simulate a chain of three replicas.</li>
<li>Send sequential writes to the head.</li>
<li>Verify that each node applies updates in the same order.</li>
<li>Crash the middle node, reconnect chain (head → tail).</li>
<li>Confirm that consistency is preserved.</li>
<li>Restart the failed node and resynchronize it.</li>
</ol>
</section>
<section id="test-cases-58" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-58">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Behavior</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sequential writes</td>
<td>Ordered propagation</td>
<td>Strong consistency</td>
</tr>
<tr class="even">
<td>Tail read after commit</td>
<td>Latest value visible</td>
<td>Linearizable</td>
</tr>
<tr class="odd">
<td>Middle node crash</td>
<td>Chain reconfigures</td>
<td>No inconsistency</td>
</tr>
<tr class="even">
<td>Simultaneous writes</td>
<td>FIFO at head</td>
<td>Deterministic order</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-58" class="level4">
<h4 class="anchored" data-anchor-id="complexity-58">Complexity</h4>
<ul>
<li>Write latency: proportional to chain length (<span class="math inline">\(O(N)\)</span> hops)</li>
<li>Read latency: <span class="math inline">\(O(1)\)</span> (tail only)</li>
<li>Message complexity: <span class="math inline">\(2N\)</span> per write (forward + ack)</li>
<li>Fault tolerance: up to ⌊(N−1)/2⌋ with reconfiguration</li>
<li>Storage: full state replica per node</li>
</ul>
<p>Chain Replication is the assembly line of consistency, each node adds reliability in sequence, the message flows down the line, and the final product is a perfectly ordered, fault-tolerant log of truth.</p>
</section>
</section>
</section>
<section id="section-87.-load-balancing-and-rate-limiting" class="level1">
<h1>Section 87. Load Balancing and Rate Limiting</h1>
<section id="round-robin-load-balancing" class="level3">
<h3 class="anchored" data-anchor-id="round-robin-load-balancing">861 Round Robin Load Balancing</h3>
<p>Round Robin Load Balancing is one of the simplest and most widely used methods for distributing requests among multiple servers. It cycles through a list of servers in order, sending each incoming request to the next server in line. Once the end of the list is reached, it starts again from the beginning.</p>
<p>This algorithm is deterministic, fair, and stateless, ideal for evenly spreading load when servers have similar capacities.</p>
<section id="what-problem-are-we-solving-59" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-59">What Problem Are We Solving?</h4>
<p>In distributed systems and web architectures, a single server cannot handle all incoming traffic. We need a load balancer that divides requests among multiple servers so that:</p>
<ul>
<li>No single server becomes overloaded</li>
<li>Requests are processed efficiently</li>
<li>The system remains scalable and responsive</li>
</ul>
<p>Round Robin provides a simple way to achieve fair load distribution without tracking server state or performance.</p>
</section>
<section id="how-does-it-work-plain-language-59" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-59">How Does It Work (Plain Language)</h4>
<p>Imagine you have three servers: S1, S2, S3. Requests arrive as R1, R2, R3, R4, R5, R6.</p>
<p>The Round Robin balancer routes them like this:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Request</th>
<th>Server</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>R1</td>
<td>S1</td>
</tr>
<tr class="even">
<td>R2</td>
<td>S2</td>
</tr>
<tr class="odd">
<td>R3</td>
<td>S3</td>
</tr>
<tr class="even">
<td>R4</td>
<td>S1</td>
</tr>
<tr class="odd">
<td>R5</td>
<td>S2</td>
</tr>
<tr class="even">
<td>R6</td>
<td>S3</td>
</tr>
</tbody>
</table>
<p>Each server receives requests in turn, producing a smooth rotation of work.</p>
<p>If a server fails, it is removed from the rotation until it recovers.</p>
</section>
<section id="tiny-code-python-example" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> [<span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S3"</span>]</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_server():</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> index</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    server <span class="op">=</span> servers[index]</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> (index <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="bu">len</span>(servers)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> server</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate incoming requests</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">7</span>):</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>r<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>get_server()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Request 1 → S1
Request 2 → S2
Request 3 → S3
Request 4 → S1
Request 5 → S2
Request 6 → S3</code></pre>
</section>
<section id="tiny-code-c-version" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb102"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"S1"</span><span class="op">,</span> <span class="st">"S2"</span><span class="op">,</span> <span class="st">"S3"</span><span class="op">};</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> r <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> r <span class="op">&lt;=</span> <span class="dv">6</span><span class="op">;</span> r<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st"> → </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> r<span class="op">,</span> servers<span class="op">[</span>index<span class="op">]);</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> <span class="op">(</span>index <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> n<span class="op">;</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-59" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-59">Why It Matters</h4>
<ul>
<li>Simplicity: No need to track metrics or states.</li>
<li>Fairness: Every server gets roughly the same number of requests.</li>
<li>Scalability: Easy to extend, just add servers to the list.</li>
<li>Statelessness: Load balancer doesn’t need session memory.</li>
</ul>
<p>Common Use Cases:</p>
<ul>
<li>DNS round robin</li>
<li>HTTP load balancers (NGINX, HAProxy)</li>
<li>Task queues and job schedulers</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Does not account for server load differences.</li>
<li>May overload slow or busy servers if they vary in capacity.</li>
<li>Works best when all servers are homogeneous.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-50" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-50">A Gentle Proof (Why It Works)</h4>
<p>Let there be <span class="math inline">\(n\)</span> servers and <span class="math inline">\(m\)</span> requests. Each request <span class="math inline">\(r_i\)</span> is assigned to a server according to:</p>
<p><span class="math display">\[
\text{server}(r_i) = S_{(i \bmod n)}
\]</span></p>
<p>The total number of requests per server is:</p>
<p><span class="math display">\[
\text{load}(S_j) = \left\lfloor \frac{m}{n} \right\rfloor \text{ or } \left\lceil \frac{m}{n} \right\rceil
\]</span></p>
<p>Thus, the difference between any two servers’ loads is at most one request, ensuring near-perfect balance for homogeneous servers.</p>
</section>
<section id="try-it-yourself-59" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-59">Try It Yourself</h4>
<ol type="1">
<li>Implement the Python or C version above.</li>
<li>Add or remove servers and observe the assignment pattern.</li>
<li>Introduce random delays on one server and note that Round Robin doesn’t adapt, that’s where Weighted or Least-Connections algorithms come in.</li>
<li>Visualize requests on a timeline, notice the perfect rotation.</li>
</ol>
</section>
<section id="test-cases-59" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-59">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 14%">
<col style="width: 29%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Input</th>
<th>Behavior</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3 servers, 6 requests</td>
<td>S1, S2, S3</td>
<td>Perfect rotation</td>
<td>S1,S2,S3,S1,S2,S3</td>
</tr>
<tr class="even">
<td>Add 4th server</td>
<td>S1..S4</td>
<td>Repeats every 4</td>
<td>S1,S2,S3,S4,S1,S2</td>
</tr>
<tr class="odd">
<td>Remove server S2</td>
<td>S1,S3</td>
<td>Alternate between 2</td>
<td>S1,S3,S1,S3</td>
</tr>
<tr class="even">
<td>Unequal processing time</td>
<td>S1 slow</td>
<td>Still evenly assigned</td>
<td>S1 overloads</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-59" class="level4">
<h4 class="anchored" data-anchor-id="complexity-59">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (simple modulo arithmetic)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> for the list of servers</li>
<li>Fairness error: ≤ 1 request difference</li>
<li>Fault tolerance: depends on health check logic</li>
</ul>
<p>Round Robin is the clockwork of load balancing, simple, rhythmic, and predictable. It may not be clever, but it is reliable, and in distributed systems, reliability is often the most elegant solution of all.</p>
</section>
</section>
<section id="weighted-round-robin" class="level3">
<h3 class="anchored" data-anchor-id="weighted-round-robin">862 Weighted Round Robin</h3>
<p>Weighted Round Robin (WRR) is an extension of simple Round Robin that assigns different weights to servers based on their capacity or performance. Instead of treating all servers equally, it proportionally distributes requests so that faster or more capable servers receive more load.</p>
<p>This algorithm is widely used in web servers, load balancers, and content delivery systems to handle heterogeneous clusters efficiently.</p>
<section id="what-problem-are-we-solving-60" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-60">What Problem Are We Solving?</h4>
<p>Classic Round Robin assumes that every server has the same capacity. But in reality:</p>
<ul>
<li>Some servers have more CPU cores or memory.</li>
<li>Some are located closer to clients (less latency).</li>
<li>Some might be replicas handling read-heavy workloads.</li>
</ul>
<p>Weighted Round Robin ensures that each server receives load proportional to its weight, keeping utilization balanced and throughput optimal.</p>
</section>
<section id="how-does-it-work-plain-language-60" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-60">How Does It Work (Plain Language)</h4>
<p>Each server has a weight <span class="math inline">\(w_i\)</span> that represents how many requests it should handle per cycle. The algorithm cycles through the server list, but repeats each server according to its weight.</p>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Server</th>
<th>Weight</th>
<th>Assigned Requests (per cycle)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td>S2</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<td>S3</td>
<td>3</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>For 6 requests: Sequence → S1, S2, S2, S3, S3, S3</p>
<p>This ensures heavier servers receive proportionally more traffic.</p>
</section>
<section id="tiny-code-python-example-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-1">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> [(<span class="st">"S1"</span>, <span class="dv">1</span>), (<span class="st">"S2"</span>, <span class="dv">2</span>), (<span class="st">"S3"</span>, <span class="dv">3</span>)]</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weighted_round_robin(requests):</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    schedule <span class="op">=</span> []</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(requests):</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s, w <span class="kw">in</span> servers:</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>            schedule.extend([s] <span class="op">*</span> w)</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> schedule[:requests]</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 6 requests</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(weighted_round_robin(<span class="dv">6</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>['S1', 'S2', 'S2', 'S3', 'S3', 'S3']</code></pre>
</section>
<section id="tiny-code-c-version-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-1">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb105"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> weight<span class="op">;</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Server<span class="op">;</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    Server servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{{</span><span class="st">"S1"</span><span class="op">,</span> <span class="dv">1</span><span class="op">},</span> <span class="op">{</span><span class="st">"S2"</span><span class="op">,</span> <span class="dv">2</span><span class="op">},</span> <span class="op">{</span><span class="st">"S3"</span><span class="op">,</span> <span class="dv">3</span><span class="op">}};</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> total <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>count <span class="op">&lt;</span> total<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">&amp;&amp;</span> count <span class="op">&lt;</span> total<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> w <span class="op">&lt;</span> servers<span class="op">[</span>i<span class="op">].</span>weight <span class="op">&amp;&amp;</span> count <span class="op">&lt;</span> total<span class="op">;</span> w<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>                printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st"> → </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> count <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> servers<span class="op">[</span>i<span class="op">].</span>name<span class="op">);</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>                count<span class="op">++;</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-60" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-60">Why It Matters</h4>
<p>Weighted Round Robin is ideal when:</p>
<ul>
<li>Servers have different capacities.</li>
<li>Some nodes should preferentially handle more requests.</li>
<li>The environment remains mostly stable (no rapid load shifts).</li>
</ul>
<p>Advantages:</p>
<ul>
<li>Simple and deterministic.</li>
<li>Adapts to heterogeneous clusters.</li>
<li>Easy to implement and reason about.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Still static, does not react to real-time load or queue length.</li>
<li>Requires periodic weight tuning based on performance metrics.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-51" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-51">A Gentle Proof (Why It Works)</h4>
<p>Let servers <span class="math inline">\(S_1, S_2, \dots, S_n\)</span> have weights <span class="math inline">\(w_1, w_2, \dots, w_n\)</span>. Define total weight: <span class="math display">\[
W = \sum_{i=1}^n w_i
\]</span></p>
<p>Each server <span class="math inline">\(S_i\)</span> should handle: <span class="math display">\[
f_i = \frac{w_i}{W} \times m
\]</span> where <span class="math inline">\(m\)</span> is the total number of requests.</p>
<p>Over a full cycle, the algorithm ensures: <span class="math display">\[
|\text{load}(S_i) - f_i| \le 1
\]</span></p>
<p>Thus, the load deviation between actual and ideal distribution is bounded by 1 request, maintaining fairness proportional to capacity.</p>
</section>
<section id="try-it-yourself-60" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-60">Try It Yourself</h4>
<ol type="1">
<li>Assign weights to three servers: 1, 2, 3.</li>
<li>Generate 12 requests and observe the distribution pattern.</li>
<li>Increase S3’s weight to 5, notice how most requests now go there.</li>
<li>Implement a dynamic version that adjusts weights based on latency or CPU load.</li>
</ol>
</section>
<section id="test-cases-60" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-60">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 13%">
<col style="width: 11%">
<col style="width: 17%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Weights</th>
<th>Requests</th>
<th>Distribution</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Equal weights</td>
<td>[1,1,1]</td>
<td>6</td>
<td>2,2,2</td>
<td>Same as Round Robin</td>
</tr>
<tr class="even">
<td>Unequal weights</td>
<td>[1,2,3]</td>
<td>6</td>
<td>1,2,3</td>
<td>Proportional</td>
</tr>
<tr class="odd">
<td>Add server</td>
<td>[1,2,3,1]</td>
<td>7</td>
<td>1,2,3,1</td>
<td>Fair rotation</td>
</tr>
<tr class="even">
<td>Remove slow server</td>
<td>[0,2,3]</td>
<td>5</td>
<td>0,2,3</td>
<td>Load shifts to others</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-60" class="level4">
<h4 class="anchored" data-anchor-id="complexity-60">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (precomputed sequence possible)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> for servers and weights</li>
<li>Fairness error: ≤ 1 request difference</li>
<li>Scalability: excellent for up to hundreds of servers</li>
</ul>
<p>Weighted Round Robin is like an orchestra conductor assigning musical phrases to instruments, each plays according to its strength, creating harmony instead of overload.</p>
</section>
</section>
<section id="least-connections" class="level3">
<h3 class="anchored" data-anchor-id="least-connections">863 Least Connections</h3>
<p>Least Connections is a dynamic load balancing algorithm that always sends a new request to the server with the fewest active connections. Unlike Round Robin or Weighted Round Robin, it reacts to <em>real-time load</em> rather than assuming all servers are equally busy.</p>
<p>This makes it one of the most efficient algorithms for systems with variable request times, for example, when some requests last much longer than others.</p>
<section id="what-problem-are-we-solving-61" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-61">What Problem Are We Solving?</h4>
<p>In practice, not all requests are equal:</p>
<ul>
<li>Some complete in milliseconds, others take seconds or minutes.</li>
<li>Some servers may be temporarily overloaded.</li>
<li>Round Robin might keep sending requests to a busy server.</li>
</ul>
<p>Least Connections solves this by dynamically picking the least busy node each time, balancing <em>current</em> load rather than static assumptions.</p>
</section>
<section id="how-does-it-work-plain-language-61" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-61">How Does It Work (Plain Language)</h4>
<p>At any given moment, the load balancer keeps track of the number of active connections per server.</p>
<p>When a new request arrives:</p>
<ol type="1">
<li>The balancer checks all servers’ active connection counts.</li>
<li>It chooses the one with the fewest ongoing connections.</li>
<li>When a request completes, the count for that server decreases.</li>
</ol>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Server</th>
<th>Active Connections</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S1</td>
<td>5</td>
</tr>
<tr class="even">
<td>S2</td>
<td>2</td>
</tr>
<tr class="odd">
<td>S3</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>→ New request goes to S2, because it has the fewest active connections.</p>
</section>
<section id="tiny-code-python-example-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-2">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> {<span class="st">"S1"</span>: <span class="dv">5</span>, <span class="st">"S2"</span>: <span class="dv">2</span>, <span class="st">"S3"</span>: <span class="dv">3</span>}</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> least_connections(servers):</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">min</span>(servers, key<span class="op">=</span>servers.get)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose next server</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>next_server <span class="op">=</span> least_connections(servers)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Next request →"</span>, next_server)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Next request → S2</code></pre>
<p>When S2 finishes a request, its count decreases, the load constantly rebalances.</p>
</section>
<section id="tiny-code-c-version-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-2">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb108"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> connections<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">5</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"S1"</span><span class="op">,</span> <span class="st">"S2"</span><span class="op">,</span> <span class="st">"S3"</span><span class="op">};</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> min_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>connections<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;</span> connections<span class="op">[</span>min_idx<span class="op">])</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>            min_idx <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Next request → </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> servers<span class="op">[</span>min_idx<span class="op">]);</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-61" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-61">Why It Matters</h4>
<ul>
<li>Adapts dynamically to load, ideal for uneven workloads.</li>
<li>Reduces tail latency, prevents overloading slower nodes.</li>
<li>Improves throughput by keeping all servers equally busy.</li>
<li>Commonly used in load balancers such as NGINX, HAProxy, Envoy.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slightly higher overhead, requires connection tracking.</li>
<li>Can oscillate if all servers frequently change load.</li>
<li>Needs thread-safe counters in distributed settings.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-52" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-52">A Gentle Proof (Why It Works)</h4>
<p>Let there be <span class="math inline">\(n\)</span> servers with active connection counts <span class="math inline">\(c_1, c_2, \dots, c_n\)</span>. When a new connection arrives, it is assigned to:</p>
<p><span class="math display">\[
S_k = \arg\min_{i}(c_i)
\]</span></p>
<p>After assignment:</p>
<p><span class="math display">\[
c_k \leftarrow c_k + 1
\]</span></p>
<p>Over time, the difference between any two servers’ loads satisfies:</p>
<p><span class="math display">\[
|c_i - c_j| \le 1
\]</span></p>
<p>under the assumption that connection durations follow similar distributions. This ensures that the variance in connection counts remains minimal, leading to even utilization.</p>
</section>
<section id="try-it-yourself-61" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-61">Try It Yourself</h4>
<ol type="1">
<li>Start with servers: S1=5, S2=3, S3=3.</li>
<li>Assign 10 random requests using the “least connections” rule.</li>
<li>Simulate completion (subtract counts).</li>
<li>Compare with Round Robin, notice smoother balancing.</li>
<li>Add weight support (Weighted Least Connections) and observe improvements.</li>
</ol>
</section>
<section id="test-cases-61" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-61">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 29%">
<col style="width: 23%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Initial Connections</th>
<th>Next Target</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Equal load</td>
<td>[2,2,2]</td>
<td>Any</td>
<td>Tie-breaking</td>
</tr>
<tr class="even">
<td>Unequal load</td>
<td>[5,2,3]</td>
<td>S2</td>
<td>Chooses least busy</td>
</tr>
<tr class="odd">
<td>Dynamic</td>
<td>[3,4,5]</td>
<td>S1</td>
<td>Always lowest</td>
</tr>
<tr class="even">
<td>Completion</td>
<td>S2 finishes</td>
<td>Count decreases</td>
<td>Balances load</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-61" class="level4">
<h4 class="anchored" data-anchor-id="complexity-61">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> per request (scan servers)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> (store active counts)</li>
<li>Adaptivity: dynamic, reacts to real-time load</li>
<li>Fairness: excellent under varying workloads</li>
</ul>
<p>Optimized implementations use heaps or priority queues for <span class="math inline">\(O(\log n)\)</span> selection.</p>
<p>Least Connections is the <em>smart intuition</em> of load balancing, it doesn’t just count servers, it <em>listens</em> to them. By watching who’s busiest and who’s free, it quietly keeps the system in perfect rhythm.</p>
</section>
</section>
<section id="consistent-hashing" class="level3">
<h3 class="anchored" data-anchor-id="consistent-hashing">864 Consistent Hashing</h3>
<p>Consistent Hashing is a clever technique for distributing data or requests across many servers while minimizing movement when nodes are added or removed. It’s the backbone of scalable systems like CDNs, distributed caches (Memcached, Redis Cluster), and distributed hash tables (DHTs) in systems like Cassandra or DynamoDB.</p>
<p>Instead of rebalancing everything when a server joins or leaves, consistent hashing ensures that only a small fraction of keys move, keeping the system stable and efficient.</p>
<section id="what-problem-are-we-solving-62" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-62">What Problem Are We Solving?</h4>
<p>Traditional modulo-based hashing looks simple but fails under scaling:</p>
<p><span class="math display">\[
\text{server} = \text{hash}(key) \bmod N
\]</span></p>
<p>When the number of servers <span class="math inline">\(N\)</span> changes, almost all keys are remapped, a disaster for cache systems or large databases.</p>
<p>Consistent hashing fixes this by making the hash space independent of the number of servers and mapping both keys and servers into the same space.</p>
</section>
<section id="how-does-it-work-plain-language-62" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-62">How Does It Work (Plain Language)</h4>
<p>Think of a hash space arranged in a circle from 0 to <span class="math inline">\(2^{32}-1\)</span> (a ring).</p>
<ul>
<li>Each server is assigned a position on the ring (via hashing its name or ID).</li>
<li>Each key is hashed to a point on the same ring.</li>
<li>The key is stored at the first server clockwise from its position.</li>
</ul>
<p>If a server leaves or joins, only the keys between its predecessor and itself move, the rest remain untouched.</p>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Server</th>
<th>Hash Position</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S1</td>
<td>0.1</td>
</tr>
<tr class="even">
<td>S2</td>
<td>0.4</td>
</tr>
<tr class="odd">
<td>S3</td>
<td>0.8</td>
</tr>
</tbody>
</table>
<p>A key hashed to 0.35 goes to S2. A key hashed to 0.75 goes to S3.</p>
<p>When S2 leaves, only keys from 0.1 to 0.4 shift to S3, others stay put.</p>
</section>
<section id="tiny-code-python-example-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-3">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hash_key(key):</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>(hashlib.md5(key.encode()).hexdigest(), <span class="dv">16</span>) <span class="op">%</span> <span class="dv">360</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> [<span class="dv">30</span>, <span class="dv">150</span>, <span class="dv">270</span>]  <span class="co"># positions on the ring</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_server(key):</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> hash_key(key)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">sorted</span>(servers):</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> h <span class="op">&lt;</span> s:</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> s</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> servers[<span class="dv">0</span>]  <span class="co"># wrap around</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Key 'apple' → Server"</span>, get_server(<span class="st">"apple"</span>))</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Key 'banana' → Server"</span>, get_server(<span class="st">"banana"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This maps keys around a circular ring of hash values.</p>
</section>
<section id="tiny-code-c-version-simplified" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-simplified">Tiny Code (C Version, Simplified)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb110"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> hash<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>key<span class="op">)</span> <span class="op">{</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> h <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>key<span class="op">)</span> h <span class="op">=</span> <span class="op">(</span>h <span class="op">*</span> <span class="dv">31</span> <span class="op">+</span> <span class="op">*</span>key<span class="op">++)</span> <span class="op">%</span> <span class="dv">360</span><span class="op">;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> h<span class="op">;</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">30</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">270</span><span class="op">};</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>keys<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"apple"</span><span class="op">,</span> <span class="st">"banana"</span><span class="op">,</span> <span class="st">"peach"</span><span class="op">};</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> h <span class="op">=</span> hash<span class="op">(</span>keys<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> chosen <span class="op">=</span> servers<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>h <span class="op">&lt;</span> servers<span class="op">[</span>j<span class="op">])</span> <span class="op">{</span> chosen <span class="op">=</span> servers<span class="op">[</span>j<span class="op">];</span> <span class="cf">break</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Key </span><span class="sc">%s</span><span class="st"> → Server </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> keys<span class="op">[</span>i<span class="op">],</span> chosen<span class="op">);</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-62" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-62">Why It Matters</h4>
<p>Consistent hashing is essential for large distributed systems because:</p>
<ul>
<li>It reduces data movement to <span class="math inline">\(O(1/N)\)</span> when scaling.</li>
<li>It naturally supports horizontal scalability.</li>
<li>It eliminates single points of failure when combined with replication.</li>
<li>It powers load-balanced request routing, sharded databases, and distributed caches.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Load imbalance if servers are unevenly spaced, solved by “virtual nodes.”</li>
<li>Slight overhead in maintaining the ring and hash lookups.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-53" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-53">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(K\)</span> be the total number of keys and <span class="math inline">\(N\)</span> servers. Each key is assigned to the next server clockwise on the ring. When a new server joins, it takes responsibility for only a fraction:</p>
<p><span class="math display">\[
\frac{K}{N+1}
\]</span></p>
<p>of the keys, not all of them.</p>
<p>Expected remapping cost is:</p>
<p><span class="math display">\[
O\left(\frac{1}{N}\right)
\]</span></p>
<p>so as <span class="math inline">\(N\)</span> grows, rebalancing becomes negligible.</p>
<p>When servers are distributed uniformly (or via virtual nodes), the load per server is approximately equal:</p>
<p><span class="math display">\[
\text{Expected load} \approx \frac{K}{N}
\]</span></p>
</section>
<section id="try-it-yourself-62" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-62">Try It Yourself</h4>
<ol type="1">
<li>Create 3 servers: S1, S2, S3 on a 360-degree ring.</li>
<li>Hash 10 keys and assign them.</li>
<li>Add S4 at position 90, recalculate.</li>
<li>Count how many keys moved (only those between 30 and 90).</li>
<li>Add “virtual nodes”, hash each server multiple times to smooth load.</li>
</ol>
</section>
<section id="test-cases-62" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-62">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 23%">
<col style="width: 16%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Servers</th>
<th>Keys Moved</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Add new server</td>
<td>3 → 4</td>
<td>~25%</td>
<td>Minimal rebalance</td>
</tr>
<tr class="even">
<td>Remove server</td>
<td>4 → 3</td>
<td>~25%</td>
<td>Controlled movement</td>
</tr>
<tr class="odd">
<td>Hash ring skew</td>
<td>Uneven spacing</td>
<td>Unbalanced</td>
<td>Fix with virtual nodes</td>
</tr>
<tr class="even">
<td>Uniform ring</td>
<td>Equal spacing</td>
<td>Balanced</td>
<td>Ideal distribution</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-62" class="level4">
<h4 class="anchored" data-anchor-id="complexity-62">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(\log N)\)</span> per lookup (binary search on ring)</li>
<li>Space: <span class="math inline">\(O(N)\)</span> for ring structure</li>
<li>Data movement: <span class="math inline">\(O(1/N)\)</span> per server join/leave</li>
<li>Scalability: excellent, used in web-scale systems</li>
</ul>
<p>Consistent Hashing is the geometry of scalability, a simple circle that turns chaos into balance. Every node finds its place, every key its home, and the system keeps spinning, smoothly, indefinitely.</p>
</section>
</section>
<section id="power-of-two-choices" class="level3">
<h3 class="anchored" data-anchor-id="power-of-two-choices">865 Power of Two Choices</h3>
<p>Power of Two Choices is a probabilistic load balancing algorithm that dramatically improves load distribution with minimal overhead. Instead of checking <em>all</em> servers like Least Connections, it randomly samples just two and sends the request to the less loaded one.</p>
<p>This tiny tweak, from one random choice to two, reduces imbalance exponentially, making it one of the most elegant results in distributed systems.</p>
<section id="what-problem-are-we-solving-63" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-63">What Problem Are We Solving?</h4>
<p>Pure random load balancing (like uniform random choice) can produce uneven load:</p>
<ul>
<li>Some servers get overloaded by chance.</li>
<li>The imbalance worsens as the number of servers increases.</li>
</ul>
<p>But checking all servers (like Least Connections) is expensive. The Power of Two Choices gives you almost the same balance as checking <em>every server</em>, while inspecting only two, a brilliant compromise.</p>
</section>
<section id="how-does-it-work-plain-language-63" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-63">How Does It Work (Plain Language)</h4>
<p>When a new request arrives:</p>
<ol type="1">
<li>Randomly pick two servers (or more generally, <em>d</em> servers).</li>
<li>Compare their current loads (active connections, queue length, etc.).</li>
<li>Assign the request to the one with fewer connections.</li>
</ol>
<p>That’s it, the algorithm self-balances with almost no coordination.</p>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Server</th>
<th>Active Connections</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S1</td>
<td>10</td>
</tr>
<tr class="even">
<td>S2</td>
<td>12</td>
</tr>
<tr class="odd">
<td>S3</td>
<td>15</td>
</tr>
<tr class="even">
<td>S4</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>If we pick S2 and S4 randomly, S4 wins because it has fewer active connections.</p>
</section>
<section id="tiny-code-python-example-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-4">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> {<span class="st">"S1"</span>: <span class="dv">10</span>, <span class="st">"S2"</span>: <span class="dv">12</span>, <span class="st">"S3"</span>: <span class="dv">15</span>, <span class="st">"S4"</span>: <span class="dv">8</span>}</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_of_two(servers):</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    choices <span class="op">=</span> random.sample(<span class="bu">list</span>(servers.keys()), <span class="dv">2</span>)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    best <span class="op">=</span> <span class="bu">min</span>(choices, key<span class="op">=</span><span class="kw">lambda</span> s: servers[s])</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Next request →"</span>, power_of_two(servers))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each decision compares only two servers, but over time, the load evens out beautifully.</p>
</section>
<section id="tiny-code-c-version-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-3">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb112"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    srand<span class="op">(</span>time<span class="op">(</span>NULL<span class="op">));</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> connections<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">10</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">8</span><span class="op">};</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"S1"</span><span class="op">,</span> <span class="st">"S2"</span><span class="op">,</span> <span class="st">"S3"</span><span class="op">,</span> <span class="st">"S4"</span><span class="op">};</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> <span class="dv">4</span><span class="op">,</span> b <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> chosen <span class="op">=</span> <span class="op">(</span>connections<span class="op">[</span>a<span class="op">]</span> <span class="op">&lt;=</span> connections<span class="op">[</span>b<span class="op">])</span> <span class="op">?</span> a <span class="op">:</span> b<span class="op">;</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Next request → </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> servers<span class="op">[</span>chosen<span class="op">]);</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-63" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-63">Why It Matters</h4>
<ul>
<li>Almost optimal balance with minimal computation.</li>
<li>Scales gracefully to thousands of servers.</li>
<li>Used in systems like Google Maglev, AWS ELB, Kubernetes, and distributed hash tables.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slight randomness may cause short-term fluctuations.</li>
<li>Needs visibility of basic per-server metrics (connection count).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-54" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-54">A Gentle Proof (Why It Works)</h4>
<p>Let there be <span class="math inline">\(n\)</span> servers and <span class="math inline">\(m\)</span> requests. Each request chooses two random servers and selects the one with the smaller load.</p>
<p>Research by Mitzenmacher and colleagues shows that:</p>
<ul>
<li>For random assignment (1 choice), maximum load ≈ <span class="math inline">\(\frac{\log n}{\log \log n}\)</span>.</li>
<li>For two choices, maximum load ≈ <span class="math inline">\(\log \log n\)</span>, an exponential improvement.</li>
</ul>
<p>Formally, the gap between the most and least loaded server shrinks dramatically: <span class="math display">\[
E[\text{max load}] = \frac{\log \log n}{\log d} + O(1)
\]</span> where <span class="math inline">\(d\)</span> is the number of random choices (usually 2).</p>
<p>This is one of the most striking results in randomized algorithms.</p>
</section>
<section id="try-it-yourself-63" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-63">Try It Yourself</h4>
<ol type="1">
<li>Simulate 100 requests over 10 servers.</li>
<li>Compare Random vs Power of Two Choices balancing.</li>
<li>Plot number of connections per server after assignment.</li>
<li>Observe that “Power of Two” produces a far tighter spread.</li>
</ol>
<p>Optional: experiment with <em>d = 3</em> or <em>d = 4</em>, diminishing returns but even better balance.</p>
</section>
<section id="test-cases-63" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-63">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 13%">
<col style="width: 32%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Servers</th>
<th>Policy</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10 servers, 100 requests</td>
<td>Random</td>
<td>High imbalance</td>
<td>Uneven load</td>
</tr>
<tr class="even">
<td>10 servers, 100 requests</td>
<td>Power of 2</td>
<td>Balanced</td>
<td>Small deviation</td>
</tr>
<tr class="odd">
<td>1000 servers, 10k requests</td>
<td>Random</td>
<td><span class="math inline">\(\max - \min \approx 20\)</span></td>
<td>Unbalanced</td>
</tr>
<tr class="even">
<td>1000 servers, 10k requests</td>
<td>Power of 2</td>
<td><span class="math inline">\(\max - \min \approx 3\)</span></td>
<td>Near-optimal</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-63" class="level4">
<h4 class="anchored" data-anchor-id="complexity-63">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> (just two random lookups)</li>
<li>Space: <span class="math inline">\(O(n)\)</span> (track connection counts)</li>
<li>Balance quality: exponential improvement over random</li>
<li>Scalability: excellent for distributed environments</li>
</ul>
<p>Power of Two Choices is what happens when mathematics meets elegance, a single extra glance, and chaos becomes order. It’s proof that sometimes, just two options are all you need for balance.</p>
</section>
</section>
<section id="random-load-balancing" class="level3">
<h3 class="anchored" data-anchor-id="random-load-balancing">866 Random Load Balancing</h3>
<p>Random Load Balancing assigns each incoming request to a server chosen uniformly at random. It’s the simplest possible algorithm, no tracking, no weights, no metrics, yet surprisingly effective for large homogeneous systems.</p>
<p>Think of it as the “coin toss” approach to distributing work: easy to implement, statistically fair in the long run, and fast enough to handle millions of requests per second.</p>
<section id="what-problem-are-we-solving-64" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-64">What Problem Are We Solving?</h4>
<p>When a cluster has many servers and requests arrive rapidly, the balancer must decide where to send each request.</p>
<p>Random load balancing solves this with minimal computation:</p>
<ul>
<li>No connection state</li>
<li>No server monitoring</li>
<li>O(1) decision time</li>
</ul>
<p>It’s ideal for systems where all servers are identical and request times are short and uniform, for example, stateless web servers or content delivery nodes.</p>
</section>
<section id="how-does-it-work-plain-language-64" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-64">How Does It Work (Plain Language)</h4>
<p>When a request arrives:</p>
<ol type="1">
<li>Randomly pick one server index between <span class="math inline">\(0\)</span> and <span class="math inline">\(N - 1\)</span>.</li>
<li>Send the request to that server.</li>
<li>Repeat for every new request.</li>
</ol>
<p>Example with 3 servers (S1, S2, S3):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Request</th>
<th>Random Server</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>R1</td>
<td>S2</td>
</tr>
<tr class="even">
<td>R2</td>
<td>S3</td>
</tr>
<tr class="odd">
<td>R3</td>
<td>S1</td>
</tr>
<tr class="even">
<td>R4</td>
<td>S3</td>
</tr>
<tr class="odd">
<td>R5</td>
<td>S2</td>
</tr>
</tbody>
</table>
<p>Over time, each server gets roughly the same number of requests.</p>
</section>
<section id="tiny-code-python-example-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-5">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>servers <span class="op">=</span> [<span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S3"</span>]</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_load_balance():</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> random.choice(servers)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>random_load_balance()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (example):</p>
<pre><code>Request 1 → S2
Request 2 → S3
Request 3 → S1
Request 4 → S3
Request 5 → S2</code></pre>
</section>
<section id="tiny-code-c-version-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-4">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb115"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    srand<span class="op">(</span>time<span class="op">(</span>NULL<span class="op">));</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>servers<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"S1"</span><span class="op">,</span> <span class="st">"S2"</span><span class="op">,</span> <span class="st">"S3"</span><span class="op">};</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> r <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> r <span class="op">&lt;=</span> <span class="dv">5</span><span class="op">;</span> r<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> idx <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> n<span class="op">;</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st"> → </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> r<span class="op">,</span> servers<span class="op">[</span>idx<span class="op">]);</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-64" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-64">Why It Matters</h4>
<ul>
<li>Fast and simple: ideal for large-scale, stateless systems.</li>
<li>No state tracking: works without shared memory or coordination.</li>
<li>Statistically fair: each server gets approximately equal load over time.</li>
</ul>
<p>Used in:</p>
<ul>
<li>DNS-level load balancing (round-robin or random DNS replies).</li>
<li>CDNs and caching systems (e.g., selecting edge nodes).</li>
<li>Cloud routing services when servers are uniform.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Can be unbalanced in the short term.</li>
<li>Not adaptive to real-time server load.</li>
<li>Performs poorly when requests have variable duration or cost.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-55" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-55">A Gentle Proof (Why It Works)</h4>
<p>Let there be <span class="math inline">\(N\)</span> servers and <span class="math inline">\(M\)</span> requests. Each request is assigned independently and uniformly:</p>
<p><span class="math display">\[
P(\text{request on } S_i) = \frac{1}{N}
\]</span></p>
<p>Expected number of requests per server:</p>
<p><span class="math display">\[
E[L_i] = \frac{M}{N}
\]</span></p>
<p>By the law of large numbers, as <span class="math inline">\(M \to \infty\)</span>:</p>
<p><span class="math display">\[
L_i \to \frac{M}{N}
\]</span></p>
<p>Variance of load between servers shrinks as <span class="math inline">\(\sigma^2 = \frac{M}{N}(1 - \frac{1}{N})\)</span>, meaning imbalance becomes negligible in large systems.</p>
</section>
<section id="try-it-yourself-64" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-64">Try It Yourself</h4>
<ol type="1">
<li>Simulate 10,000 requests across 10 servers.</li>
<li>Count how many requests each gets.</li>
<li>Compute variance, notice how small it is.</li>
<li>Add random request durations to see when imbalance starts to matter.</li>
</ol>
</section>
<section id="test-cases-64" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-64">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Scenario</th>
<th>Servers</th>
<th>Requests</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3 servers</td>
<td>6</td>
<td>Roughly 2 each</td>
<td>Balanced</td>
</tr>
<tr class="even">
<td>5 servers</td>
<td>1000</td>
<td>±20 deviation</td>
<td>Acceptable</td>
</tr>
<tr class="odd">
<td>10 servers</td>
<td>10000</td>
<td>±1% deviation</td>
<td>Smooth</td>
</tr>
<tr class="even">
<td>Mixed latency</td>
<td>uneven</td>
<td>Unbalanced</td>
<td>Poor under skew</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-64" class="level4">
<h4 class="anchored" data-anchor-id="complexity-64">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (single random draw)</li>
<li>Space: <span class="math inline">\(O(1)\)</span></li>
<li>Fairness: long-term statistical balance</li>
<li>Adaptivity: none, purely random</li>
</ul>
<p>Random Load Balancing is the coin toss of distributed systems, simple, fair, and surprisingly powerful when chaos is your ally. It reminds us that sometimes, randomness is the cleanest form of order.</p>
</section>
</section>
<section id="token-bucket" class="level3">
<h3 class="anchored" data-anchor-id="token-bucket">867 Token Bucket</h3>
<p>Token Bucket is a rate-limiting algorithm that allows bursts of traffic up to a defined capacity while maintaining a steady average rate over time. It’s widely used in networking, APIs, and operating systems to control request rates, bandwidth, and fairness between clients.</p>
<section id="what-problem-are-we-solving-65" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-65">What Problem Are We Solving?</h4>
<p>Without rate control, clients can:</p>
<ul>
<li>Flood a server with too many requests.</li>
<li>Consume unfair amounts of shared bandwidth.</li>
<li>Cause latency spikes or denial of service.</li>
</ul>
<p>We need a mechanism to allow short bursts (for responsiveness) but enforce a limit on long-term request rates.</p>
<p>That’s exactly what the Token Bucket algorithm provides.</p>
</section>
<section id="how-does-it-work-plain-language-65" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-65">How Does It Work (Plain Language)</h4>
<p>Imagine a bucket that fills with tokens at a fixed rate, say <span class="math inline">\(r\)</span> tokens per second. Each request consumes one token. If the bucket is empty, the request must wait (or be rejected).</p>
<p>Key parameters:</p>
<ul>
<li>Rate <span class="math inline">\(r\)</span>: how fast tokens are added.</li>
<li>Capacity <span class="math inline">\(C\)</span>: maximum number of tokens the bucket can hold (the burst size).</li>
</ul>
<p>At any time:</p>
<ul>
<li>If tokens are available → allow the request and remove one.</li>
<li>If no tokens → throttle or drop the request.</li>
</ul>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Time (s)</th>
<th>Tokens Available</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>5</td>
<td>Request served</td>
</tr>
<tr class="even">
<td>1</td>
<td>4</td>
<td>Request served</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3</td>
<td>Request served</td>
</tr>
<tr class="even">
<td>3</td>
<td>0</td>
<td>Request blocked</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1</td>
<td>Request allowed again</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-example-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-6">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TokenBucket:</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, rate, capacity):</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rate <span class="op">=</span> rate              <span class="co"># tokens per second</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.capacity <span class="op">=</span> capacity</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tokens <span class="op">=</span> capacity</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last_time <span class="op">=</span> time.time()</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> allow(<span class="va">self</span>):</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>        now <span class="op">=</span> time.time()</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> now <span class="op">-</span> <span class="va">self</span>.last_time</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tokens <span class="op">=</span> <span class="bu">min</span>(<span class="va">self</span>.capacity, <span class="va">self</span>.tokens <span class="op">+</span> elapsed <span class="op">*</span> <span class="va">self</span>.rate)</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last_time <span class="op">=</span> now</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.tokens <span class="op">&gt;=</span> <span class="dv">1</span>:</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.tokens <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> TokenBucket(rate<span class="op">=</span><span class="dv">1</span>, capacity<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="st">'Allowed'</span> <span class="cf">if</span> bucket<span class="sc">.</span>allow() <span class="cf">else</span> <span class="st">'Blocked'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-version-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-5">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb117"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> rate<span class="op">,</span> capacity<span class="op">,</span> tokens<span class="op">;</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> last_time<span class="op">;</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> TokenBucket<span class="op">;</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> now<span class="op">()</span> <span class="op">{</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>clock<span class="op">()</span> <span class="op">/</span> CLOCKS_PER_SEC<span class="op">;</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> allow<span class="op">(</span>TokenBucket <span class="op">*</span>b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> t <span class="op">=</span> now<span class="op">();</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> elapsed <span class="op">=</span> t <span class="op">-</span> b<span class="op">-&gt;</span>last_time<span class="op">;</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    b<span class="op">-&gt;</span>tokens <span class="op">+=</span> elapsed <span class="op">*</span> b<span class="op">-&gt;</span>rate<span class="op">;</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>b<span class="op">-&gt;</span>tokens <span class="op">&gt;</span> b<span class="op">-&gt;</span>capacity<span class="op">)</span> b<span class="op">-&gt;</span>tokens <span class="op">=</span> b<span class="op">-&gt;</span>capacity<span class="op">;</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>    b<span class="op">-&gt;</span>last_time <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>b<span class="op">-&gt;</span>tokens <span class="op">&gt;=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>        b<span class="op">-&gt;</span>tokens <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>    TokenBucket b <span class="op">=</span> <span class="op">{</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">5.0</span><span class="op">,</span> <span class="fl">5.0</span><span class="op">,</span> now<span class="op">()};</span></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> allow<span class="op">(&amp;</span>b<span class="op">)</span> <span class="op">?</span> <span class="st">"Allowed"</span> <span class="op">:</span> <span class="st">"Blocked"</span><span class="op">);</span></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> timespec ts <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">500000000</span><span class="op">};</span></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>        nanosleep<span class="op">(&amp;</span>ts<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-65" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-65">Why It Matters</h4>
<ul>
<li><p>Smooths out bursts: allows short-term spikes while maintaining long-term control.</p></li>
<li><p>Used in:</p>
<ul>
<li>Network traffic shaping (routers, Linux tc).</li>
<li>API rate limiting (NGINX, Cloudflare, AWS).</li>
<li>Distributed systems (fair request scheduling).</li>
</ul></li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Requires time tracking and floating-point precision.</li>
<li>Needs synchronization when used across distributed nodes.</li>
<li>For strict control, combine with <em>Leaky Bucket</em> or <em>Sliding Window Counter</em>.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-56" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-56">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(r\)</span> = refill rate (tokens per second)</li>
<li><span class="math inline">\(C\)</span> = capacity (max tokens)</li>
<li><span class="math inline">\(\Delta t\)</span> = elapsed time since last check</li>
</ul>
<p>Token count update rule: <span class="math display">\[
T(t) = \min(C, T(t - \Delta t) + r \cdot \Delta t)
\]</span></p>
<p>A request is allowed iff <span class="math inline">\(T(t) \ge 1\)</span>.</p>
<p>Thus, over any long time period <span class="math inline">\(\tau\)</span>: <span class="math display">\[
\text{Requests allowed} \le r \tau + C
\]</span></p>
<p>This guarantees that the average rate never exceeds <span class="math inline">\(r\)</span>, while up to <span class="math inline">\(C\)</span> requests can burst instantly, providing both control and flexibility.</p>
</section>
<section id="try-it-yourself-65" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-65">Try It Yourself</h4>
<ol type="1">
<li>Set <code>rate=2</code>, <code>capacity=5</code>.</li>
<li>Send 10 requests at 0.2-second intervals.</li>
<li>Observe how early requests are allowed (tokens available), then throttling begins.</li>
<li>Slow down the request rate, see how tokens accumulate again.</li>
<li>Adjust <code>capacity</code> to experiment with burst tolerance.</li>
</ol>
</section>
<section id="test-cases-65" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-65">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Rate</th>
<th>Capacity</th>
<th>Request Interval</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1/s</td>
<td>5</td>
<td>0.5s</td>
<td>Bursts allowed, steady later</td>
</tr>
<tr class="even">
<td>2/s</td>
<td>2</td>
<td>0.1s</td>
<td>Frequent throttling</td>
</tr>
<tr class="odd">
<td>5/s</td>
<td>10</td>
<td>0.1s</td>
<td>Smooth flow</td>
</tr>
<tr class="even">
<td>1/s</td>
<td>1</td>
<td>1s</td>
<td>Strict rate limit</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-65" class="level4">
<h4 class="anchored" data-anchor-id="complexity-65">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (constant-time update)</li>
<li>Space: <span class="math inline">\(O(1)\)</span> (track rate, capacity, timestamp)</li>
<li>Fairness: high for bursty workloads</li>
<li>Adaptivity: excellent for variable request rates</li>
</ul>
<p>Token Bucket is the heartbeat of rate limiting, it doesn’t block the pulse, it regulates the rhythm, allowing bursts of life while keeping the system calm and steady.</p>
</section>
</section>
<section id="leaky-bucket" class="level3">
<h3 class="anchored" data-anchor-id="leaky-bucket">868 Leaky Bucket</h3>
<p>Leaky Bucket is a classic rate-limiting and traffic-shaping algorithm that enforces a fixed output rate, smoothing bursts of incoming requests or packets. It’s widely used in network routers, API gateways, and distributed systems to maintain predictable performance under fluctuating load.</p>
<section id="what-problem-are-we-solving-66" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-66">What Problem Are We Solving?</h4>
<p>Real-world traffic is rarely steady, it comes in bursts. Without control, bursts can cause:</p>
<ul>
<li>Queue overflows</li>
<li>Latency spikes</li>
<li>Packet drops or request failures</li>
</ul>
<p>We need a way to turn bursty traffic into steady flow, like water leaking at a constant rate from a bucket with unpredictable inflow.</p>
<p>That’s the idea behind the Leaky Bucket.</p>
</section>
<section id="how-does-it-work-plain-language-66" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-66">How Does It Work (Plain Language)</h4>
<p>Picture a bucket with a small hole at the bottom:</p>
<ul>
<li>Incoming requests (or packets) are poured into the bucket.</li>
<li>The bucket leaks at a fixed rate <span class="math inline">\(r\)</span>, representing processing or sending capacity.</li>
<li>If the bucket overflows (more incoming than it can hold), excess requests are dropped.</li>
</ul>
<p>Parameters:</p>
<ul>
<li>Leak rate <span class="math inline">\(r\)</span>: how fast tokens (or packets) leave the bucket.</li>
<li>Capacity <span class="math inline">\(C\)</span>: maximum number of pending requests the bucket can hold.</li>
</ul>
<p>Rules:</p>
<ul>
<li><p>On each incoming request:</p>
<ul>
<li>If the bucket is not full → enqueue the request.</li>
<li>If full → drop or delay it.</li>
</ul></li>
<li><p>A scheduler continuously leaks (processes) requests at rate <span class="math inline">\(r\)</span>.</p></li>
</ul>
</section>
<section id="example-1" class="level4">
<h4 class="anchored" data-anchor-id="example-1">Example</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Time</th>
<th>Incoming</th>
<th>Bucket Size</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0s</td>
<td>3</td>
<td>3</td>
<td>Added</td>
</tr>
<tr class="even">
<td>1s</td>
<td>2</td>
<td>3</td>
<td>1 leaked, 2 added</td>
</tr>
<tr class="odd">
<td>2s</td>
<td>5</td>
<td>3</td>
<td>Overflow → drop 3</td>
</tr>
<tr class="even">
<td>3s</td>
<td>0</td>
<td>2</td>
<td>Leaked steady</td>
</tr>
</tbody>
</table>
<p>The flow out of the bucket remains constant at rate <span class="math inline">\(r\)</span>, even if inputs fluctuate.</p>
</section>
<section id="tiny-code-python-example-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-7">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> deque</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LeakyBucket:</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, rate, capacity):</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rate <span class="op">=</span> rate              <span class="co"># leaks per second</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.capacity <span class="op">=</span> capacity</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.queue <span class="op">=</span> deque()</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last_check <span class="op">=</span> time.time()</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> allow(<span class="va">self</span>, request):</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>        now <span class="op">=</span> time.time()</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> now <span class="op">-</span> <span class="va">self</span>.last_check</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        leaked <span class="op">=</span> <span class="bu">int</span>(elapsed <span class="op">*</span> <span class="va">self</span>.rate)</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(leaked):</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.queue:</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.queue.popleft()</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last_check <span class="op">=</span> now</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.queue) <span class="op">&lt;</span> <span class="va">self</span>.capacity:</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.queue.append(request)</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> LeakyBucket(rate<span class="op">=</span><span class="dv">1</span>, capacity<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="st">'Accepted'</span> <span class="cf">if</span> bucket<span class="sc">.</span>allow(i) <span class="cf">else</span> <span class="st">'Dropped'</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-version-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-6">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb119"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> rate<span class="op">;</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> capacity<span class="op">;</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> size<span class="op">;</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> last_time<span class="op">;</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> LeakyBucket<span class="op">;</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> now<span class="op">()</span> <span class="op">{</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>clock<span class="op">()</span> <span class="op">/</span> CLOCKS_PER_SEC<span class="op">;</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> allow<span class="op">(</span>LeakyBucket <span class="op">*</span>b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> t <span class="op">=</span> now<span class="op">();</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> elapsed <span class="op">=</span> t <span class="op">-</span> b<span class="op">-&gt;</span>last_time<span class="op">;</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leaked <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>elapsed <span class="op">*</span> b<span class="op">-&gt;</span>rate<span class="op">);</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>leaked <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>        b<span class="op">-&gt;</span>size <span class="op">-=</span> leaked<span class="op">;</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>b<span class="op">-&gt;</span>size <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> b<span class="op">-&gt;</span>size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>        b<span class="op">-&gt;</span>last_time <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>b<span class="op">-&gt;</span>size <span class="op">&lt;</span> b<span class="op">-&gt;</span>capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>        b<span class="op">-&gt;</span>size<span class="op">++;</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>    LeakyBucket b <span class="op">=</span> <span class="op">{</span><span class="fl">1.0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> now<span class="op">()};</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> allow<span class="op">(&amp;</span>b<span class="op">)</span> <span class="op">?</span> <span class="st">"Accepted"</span> <span class="op">:</span> <span class="st">"Dropped"</span><span class="op">);</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>        usleep<span class="op">(</span><span class="dv">500000</span><span class="op">);</span> <span class="co">// 0.5 seconds</span></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-66" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-66">Why It Matters</h4>
<ul>
<li>Smooths out traffic: converts bursty input to uniform output.</li>
<li>Simple control: just rate + capacity parameters.</li>
<li>Widely used: network routers, API gateways, and OS schedulers.</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Strict fixed rate, doesn’t allow short bursts like Token Bucket.</li>
<li>Can underutilize system if incoming rate is slightly below <span class="math inline">\(r\)</span>.</li>
<li>Less flexible for elastic workloads.</li>
</ul>
<p>Used in:</p>
<ul>
<li>Traffic shaping: routers and switches.</li>
<li>QoS enforcement: telecom networks.</li>
<li>Rate limiting: APIs requiring strict throughput caps.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-57" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-57">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(I(t)\)</span> be incoming requests per second, <span class="math inline">\(L(t)\)</span> be leak rate, and <span class="math inline">\(B(t)\)</span> be bucket fill level.</p>
<p>The bucket’s evolution over time is:</p>
<p><span class="math display">\[
\frac{dB(t)}{dt} = I(t) - L(t)
\]</span></p>
<p>subject to bounds: <span class="math display">\[
0 \le B(t) \le C
\]</span></p>
<p>and constant leak rate: <span class="math display">\[
L(t) = r
\]</span></p>
<p>Hence, the output rate is always constant, independent of burstiness in <span class="math inline">\(I(t)\)</span>, as long as the bucket doesn’t empty. If <span class="math inline">\(B(t)\)</span> exceeds capacity <span class="math inline">\(C\)</span>, overflow requests are dropped, enforcing a hard rate limit.</p>
</section>
<section id="try-it-yourself-66" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-66">Try It Yourself</h4>
<ol type="1">
<li>Set <code>rate=1</code>, <code>capacity=3</code>.</li>
<li>Send 10 requests per second. Watch how the bucket overflows.</li>
<li>Lower input rate to 1 per second, stable flow.</li>
<li>Compare with Token Bucket to see how one allows bursts and the other smooths them out.</li>
</ol>
</section>
<section id="test-cases-66" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-66">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Rate</th>
<th>Capacity</th>
<th>Request Rate</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1/s</td>
<td>3</td>
<td>0.5/s</td>
<td>No overflow</td>
</tr>
<tr class="even">
<td>1/s</td>
<td>3</td>
<td>2/s</td>
<td>Frequent drops</td>
</tr>
<tr class="odd">
<td>2/s</td>
<td>5</td>
<td>2/s</td>
<td>Smooth flow</td>
</tr>
<tr class="even">
<td>1/s</td>
<td>2</td>
<td>3/s</td>
<td>Bursty traffic flattened</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-66" class="level4">
<h4 class="anchored" data-anchor-id="complexity-66">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (constant-time update)</li>
<li>Space: <span class="math inline">\(O(1)\)</span> (track bucket size, timestamps)</li>
<li>Stability: high, fixed leak rate ensures predictability</li>
<li>Fairness: deterministic</li>
</ul>
<p>Leaky Bucket is the metronome of flow control, steady, unwavering, and disciplined. It doesn’t chase bursts; it keeps the rhythm, ensuring the system moves in time with its true capacity.</p>
</section>
</section>
<section id="sliding-window-counter" class="level3">
<h3 class="anchored" data-anchor-id="sliding-window-counter">869 Sliding Window Counter</h3>
<p>Sliding Window Counter is a rate-limiting algorithm that maintains a dynamic count of recent events within a rolling time window, rather than resetting at fixed intervals. It’s a more accurate version of the fixed window approach and is often used in APIs, authentication systems, and distributed gateways to enforce fair usage policies while avoiding burst unfairness near window boundaries.</p>
<section id="what-problem-are-we-solving-67" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-67">What Problem Are We Solving?</h4>
<p>A fixed window counter resets at exact intervals, say, every 60 seconds. That can lead to unfairness:</p>
<ul>
<li>A client could send 100 requests at the <em>end</em> of one window and 100 more at the <em>start</em> of the next → 200 requests in a few seconds.</li>
</ul>
<p>We need a smoother, time-aware limit that counts requests within the <em>last N seconds</em>, not just since the last clock tick.</p>
<p>That’s the Sliding Window Counter.</p>
</section>
<section id="how-does-it-work-plain-language-67" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-67">How Does It Work (Plain Language)</h4>
<p>Instead of resetting periodically, this algorithm:</p>
<ol type="1">
<li>Tracks timestamps of each incoming request.</li>
<li>On each new request, it removes timestamps older than the window size (e.g., 60 seconds).</li>
<li>If the number of timestamps still inside the window is below the limit, the new request is accepted; otherwise, it’s rejected.</li>
</ol>
<p>So the window “slides” continuously with time.</p>
<p>Example: 60-second window, limit = 100 requests</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Time (s)</th>
<th>Request Count</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0–58</td>
<td>80</td>
<td>Allowed</td>
</tr>
<tr class="even">
<td>59</td>
<td>+10</td>
<td>Still allowed</td>
</tr>
<tr class="odd">
<td>61</td>
<td>Old requests expire, count drops to 50</td>
<td>Window slides</td>
</tr>
<tr class="even">
<td>62</td>
<td>+10 more</td>
<td>Allowed again</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-example-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-8">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> deque</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SlidingWindowCounter:</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, window_size, limit):</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.window_size <span class="op">=</span> window_size</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.limit <span class="op">=</span> limit</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.requests <span class="op">=</span> deque()</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> allow(<span class="va">self</span>):</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>        now <span class="op">=</span> time.time()</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove timestamps outside the window</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">self</span>.requests <span class="kw">and</span> now <span class="op">-</span> <span class="va">self</span>.requests[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="va">self</span>.window_size:</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.requests.popleft()</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.requests) <span class="op">&lt;</span> <span class="va">self</span>.limit:</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.requests.append(now)</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>window <span class="op">=</span> SlidingWindowCounter(window_size<span class="op">=</span><span class="dv">60</span>, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="st">'Allowed'</span> <span class="cf">if</span> window<span class="sc">.</span>allow() <span class="cf">else</span> <span class="st">'Blocked'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-version-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-7">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb121"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LIMIT </span><span class="dv">5</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define WINDOW </span><span class="dv">60</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> requests<span class="op">[</span>LIMIT<span class="op">];</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> allow<span class="op">()</span> <span class="op">{</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> now <span class="op">=</span> time<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> new_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> count<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>now <span class="op">-</span> requests<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;=</span> WINDOW<span class="op">)</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>            requests<span class="op">[</span>new_count<span class="op">++]</span> <span class="op">=</span> requests<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> new_count<span class="op">;</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count <span class="op">&lt;</span> LIMIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>        requests<span class="op">[</span>count<span class="op">++]</span> <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> allow<span class="op">()</span> <span class="op">?</span> <span class="st">"Allowed"</span> <span class="op">:</span> <span class="st">"Blocked"</span><span class="op">);</span></span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-67" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-67">Why It Matters</h4>
<ul>
<li><p>Smooth rate limiting: avoids reset bursts at window boundaries.</p></li>
<li><p>Precise control: always enforces “N requests per second/minute” continuously.</p></li>
<li><p>Used in:</p>
<ul>
<li>API gateways (AWS, Cloudflare, Google).</li>
<li>Authentication systems (login attempt throttling).</li>
<li>Distributed systems enforcing fairness or quotas.</li>
</ul></li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Slightly more complex than fixed counters.</li>
<li>Requires storing recent request timestamps.</li>
<li>Memory usage grows with request rate (bounded by limit).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-58" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-58">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(t_i\)</span> be the timestamp of the <span class="math inline">\(i\)</span>-th request. At time <span class="math inline">\(t\)</span>, define active requests as:</p>
<p><span class="math display">\[
R(t) = { t_i \mid t - t_i \le W }
\]</span></p>
<p>A request is allowed if:</p>
<p><span class="math display">\[
|R(t)| &lt; L
\]</span></p>
<p>where <span class="math inline">\(W\)</span> is the window size and <span class="math inline">\(L\)</span> the limit.</p>
<p>Since <span class="math inline">\(R(t)\)</span> continuously updates with time, the constraint holds for <em>every possible interval of length W</em>, not just fixed ones, ensuring true sliding-window fairness.</p>
<p>This prevents burst spikes that could occur in fixed windows, while maintaining the same long-term rate.</p>
</section>
<section id="try-it-yourself-67" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-67">Try It Yourself</h4>
<ol type="1">
<li>Set <code>window_size = 60</code>, <code>limit = 5</code>.</li>
<li>Send requests at 10-second intervals, all should be allowed.</li>
<li>Send 6 requests in rapid succession, the 6th should be blocked.</li>
<li>Wait for 60 seconds, old timestamps expire, and new requests are accepted again.</li>
<li>Visualize the number of requests in the active window over time.</li>
</ol>
</section>
<section id="test-cases-67" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-67">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Window</th>
<th>Limit</th>
<th>Pattern</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>60s</td>
<td>5</td>
<td>1 per 10s</td>
<td>All allowed</td>
</tr>
<tr class="even">
<td>60s</td>
<td>5</td>
<td>6 in 2s</td>
<td>6th blocked</td>
</tr>
<tr class="odd">
<td>10s</td>
<td>3</td>
<td>1 per 5s</td>
<td>Smooth rotation</td>
</tr>
<tr class="even">
<td>60s</td>
<td>100</td>
<td>200 at start</td>
<td>Half blocked</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-67" class="level4">
<h4 class="anchored" data-anchor-id="complexity-67">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> amortized (pop old timestamps)</li>
<li>Space: <span class="math inline">\(O(L)\)</span> for recent request timestamps</li>
<li>Precision: exact within window</li>
<li>Adaptivity: high, continuous enforcement</li>
</ul>
<p>Sliding Window Counter is the chronometer of rate limiting, it doesn’t count by the clock, but by the moment, ensuring fairness second by second, without the jagged edges of time.</p>
</section>
</section>
<section id="fixed-window-counter" class="level3">
<h3 class="anchored" data-anchor-id="fixed-window-counter">870 Fixed Window Counter</h3>
<p>Fixed Window Counter is one of the simplest rate-limiting algorithms. It divides time into equal-sized windows (like 1 second or 1 minute) and counts how many requests arrive within the current window. Once the count exceeds a limit, new requests are blocked until the next window begins.</p>
<p>It’s easy to implement and efficient, but it has one flaw, bursts near window boundaries can briefly double the allowed rate. Still, for many applications, simplicity wins.</p>
<section id="what-problem-are-we-solving-68" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-68">What Problem Are We Solving?</h4>
<p>Systems need a way to control request frequency, for example:</p>
<ul>
<li>Limit each user to 100 API calls per minute.</li>
<li>Prevent brute-force login attempts.</li>
<li>Control event emission rates in distributed pipelines.</li>
</ul>
<p>A fixed counter approach provides an efficient and predictable method of enforcing these limits.</p>
</section>
<section id="how-does-it-work-plain-language-68" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-68">How Does It Work (Plain Language)</h4>
<p>Time is split into fixed-length windows of size <span class="math inline">\(W\)</span> (for example, 60 seconds). For each window, we maintain a counter of how many requests have been received.</p>
<p>Algorithm steps:</p>
<ol type="1">
<li>Determine the current time window (e.g., using integer division of current time by <span class="math inline">\(W\)</span>).</li>
<li>Increment the counter for that window.</li>
<li>If the count exceeds the limit, reject the request.</li>
<li>When time moves into the next window, reset the counter to zero.</li>
</ol>
<p>Example: Limit = 5 requests / 10 seconds</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Time (s)</th>
<th>Window</th>
<th>Requests</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0–9</td>
<td>#1</td>
<td>5</td>
<td>Allowed</td>
</tr>
<tr class="even">
<td>10–19</td>
<td>#2</td>
<td>5</td>
<td>Allowed</td>
</tr>
<tr class="odd">
<td>9th–10th boundary</td>
<td>–</td>
<td>10 requests in 2s</td>
<td>Burst possible</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-example-9" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-9">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FixedWindowCounter:</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, window_size, limit):</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.window_size <span class="op">=</span> window_size</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.limit <span class="op">=</span> limit</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.window_start <span class="op">=</span> <span class="bu">int</span>(time.time() <span class="op">/</span> window_size)</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> allow(<span class="va">self</span>):</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        current_window <span class="op">=</span> <span class="bu">int</span>(time.time() <span class="op">/</span> <span class="va">self</span>.window_size)</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_window <span class="op">!=</span> <span class="va">self</span>.window_start:</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.window_start <span class="op">=</span> current_window</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.count <span class="op">&lt;</span> <span class="va">self</span>.limit:</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>fw <span class="op">=</span> FixedWindowCounter(window_size<span class="op">=</span><span class="dv">10</span>, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Request </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="st">'Allowed'</span> <span class="cf">if</span> fw<span class="sc">.</span>allow() <span class="cf">else</span> <span class="st">'Blocked'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-version-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-version-8">Tiny Code (C Version)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb123"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> window_size<span class="op">;</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> limit<span class="op">;</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> count<span class="op">;</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> window_start<span class="op">;</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> FixedWindowCounter<span class="op">;</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> allow<span class="op">(</span>FixedWindowCounter <span class="op">*</span>f<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> now <span class="op">=</span> time<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> current_window <span class="op">=</span> now <span class="op">/</span> f<span class="op">-&gt;</span>window_size<span class="op">;</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>current_window <span class="op">!=</span> f<span class="op">-&gt;</span>window_start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>        f<span class="op">-&gt;</span>window_start <span class="op">=</span> current_window<span class="op">;</span></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>        f<span class="op">-&gt;</span>count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>f<span class="op">-&gt;</span>count <span class="op">&lt;</span> f<span class="op">-&gt;</span>limit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>        f<span class="op">-&gt;</span>count<span class="op">++;</span></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>    FixedWindowCounter fw <span class="op">=</span> <span class="op">{</span><span class="dv">10</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> time<span class="op">(</span>NULL<span class="op">)</span> <span class="op">/</span> <span class="dv">10</span><span class="op">};</span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Request </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">+</span><span class="dv">1</span><span class="op">,</span> allow<span class="op">(&amp;</span>fw<span class="op">)</span> <span class="op">?</span> <span class="st">"Allowed"</span> <span class="op">:</span> <span class="st">"Blocked"</span><span class="op">);</span></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-68" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-68">Why It Matters</h4>
<ul>
<li><p>Simplicity: fast, predictable, easy to implement in both centralized and distributed systems.</p></li>
<li><p>Efficiency: only a counter per window, no timestamp tracking needed.</p></li>
<li><p>Used in:</p>
<ul>
<li>API gateways and rate-limit middleware.</li>
<li>Authentication systems.</li>
<li>Network routers and firewalls.</li>
</ul></li>
</ul>
<p>Trade-offs:</p>
<ul>
<li>Allows short bursts across boundaries (double spending issue).</li>
<li>Doesn’t smooth out usage, use <em>Sliding Window</em> or <em>Token Bucket</em> for that.</li>
<li>Resets abruptly at window boundaries.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-59" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-59">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(W\)</span> = window size (seconds)</li>
<li><span class="math inline">\(L\)</span> = limit (requests per window)</li>
<li><span class="math inline">\(R(t)\)</span> = requests received at time <span class="math inline">\(t\)</span></li>
</ul>
<p>We allow a request at time <span class="math inline">\(t\)</span> if: <span class="math display">\[
C\left(\left\lfloor \frac{t}{W} \right\rfloor\right) &lt; L
\]</span> where <span class="math inline">\(C(k)\)</span> is the counter for window <span class="math inline">\(k\)</span>.</p>
<p>At the next boundary: <span class="math display">\[
C(k+1) = 0
\]</span></p>
<p>Thus, the algorithm enforces: <span class="math display">\[
\frac{\text{requests}}{\text{time}} \le \frac{L}{W}
\]</span> for most intervals, though bursts may occur across boundaries.</p>
</section>
<section id="try-it-yourself-68" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-68">Try It Yourself</h4>
<ol type="1">
<li>Set <code>window_size = 10</code>, <code>limit = 5</code>.</li>
<li>Send 5 requests quickly, all accepted.</li>
<li>Wait until the window resets, the counter clears.</li>
<li>Send 5 more immediately, all accepted again (burst effect).</li>
<li>Combine with <em>Sliding Window Counter</em> to fix the boundary issue.</li>
</ol>
</section>
<section id="test-cases-68" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-68">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Window</th>
<th>Limit</th>
<th>Pattern</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10s</td>
<td>5</td>
<td>1 per 2s</td>
<td>Smooth, all allowed</td>
</tr>
<tr class="even">
<td>10s</td>
<td>5</td>
<td>6 in 5s</td>
<td>6th blocked</td>
</tr>
<tr class="odd">
<td>10s</td>
<td>5</td>
<td>5 before + 5 after boundary</td>
<td>Burst of 10</td>
</tr>
<tr class="even">
<td>60s</td>
<td>100</td>
<td>Uniform</td>
<td>Perfect enforcement</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-68" class="level4">
<h4 class="anchored" data-anchor-id="complexity-68">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(1)\)</span> per request (simple integer check)</li>
<li>Space: <span class="math inline">\(O(1)\)</span> per user or key</li>
<li>Precision: coarse, stepwise resets</li>
<li>Performance: extremely high</li>
</ul>
<p>Fixed Window Counter is the metronome of rate control, steady, reliable, and mechanical. It’s not graceful, but it’s predictable, and in distributed systems, predictability is gold.</p>
</section>
</section>
</section>
<section id="section-88.-search-and-indexing" class="level1">
<h1>Section 88. Search and Indexing</h1>
<section id="inverted-index-construction" class="level3">
<h3 class="anchored" data-anchor-id="inverted-index-construction">871 Inverted Index Construction</h3>
<p>An inverted index maps each term to the list of documents (and often positions) where it appears. It is the core data structure behind web search, log search, and code search engines.</p>
<section id="what-problem-are-we-solving-69" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-69">What Problem Are We Solving?</h4>
<p>Given a corpus of documents, we want to answer queries like <code>cat AND dog</code> or phrases like <code>"deep learning"</code>. Scanning all documents per query is too slow. An inverted index precomputes a term → postings list mapping so queries can jump directly to matching documents.</p>
</section>
<section id="how-does-it-work-plain-language-69" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-69">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Parse and normalize each document</p>
<ul>
<li>Tokenize text into terms</li>
<li>Lowercase, strip punctuation, optionally stem or lemmatize</li>
<li>Remove stopwords if desired</li>
</ul></li>
<li><p>Emit postings while scanning</p>
<ul>
<li><p>For each term <span class="math inline">\(t\)</span> found in document <span class="math inline">\(d\)</span>, record one of:</p>
<ul>
<li>Document-level: <span class="math inline">\((t \to d)\)</span></li>
<li>Positional-level: <span class="math inline">\((t \to (d, p))\)</span> where <span class="math inline">\(p\)</span> is the position</li>
</ul></li>
</ul></li>
<li><p>Group and sort</p>
<ul>
<li>Group postings by term</li>
<li>Sort each term’s postings by document id, then by position</li>
</ul></li>
<li><p>Compress and store</p>
<ul>
<li>Gap encode doc ids and positions</li>
<li>Apply integer compression (e.g., Variable Byte, VByte, or Elias–Gamma)</li>
<li>Persist dictionary (term lexicon) and postings</li>
</ul></li>
<li><p>Answering queries</p>
<ul>
<li>Boolean queries: intersect or union sorted postings</li>
<li>Ranked queries: fetch postings and compute scores (e.g., TF, IDF, BM25)</li>
</ul></li>
</ol>
</section>
<section id="example-walkthrough-42" class="level4">
<h4 class="anchored" data-anchor-id="example-walkthrough-42">Example Walkthrough</h4>
<p>Documents:</p>
<ul>
<li><span class="math inline">\(d_1\)</span>: <code>"to be or not to be"</code></li>
<li><span class="math inline">\(d_2\)</span>: <code>"to seek truth"</code></li>
</ul>
<p>Tokenize and normalize:</p>
<ul>
<li><span class="math inline">\(d_1\)</span>: [to, be, or, not, to, be]</li>
<li><span class="math inline">\(d_2\)</span>: [to, seek, truth]</li>
</ul>
<p>Postings (document-level):</p>
<ul>
<li>be: <span class="math inline">\({d_1}\)</span></li>
<li>not: <span class="math inline">\({d_1}\)</span></li>
<li>or: <span class="math inline">\({d_1}\)</span></li>
<li>seek: <span class="math inline">\({d_2}\)</span></li>
<li>to: <span class="math inline">\({d_1, d_2}\)</span></li>
<li>truth: <span class="math inline">\({d_2}\)</span></li>
</ul>
<p>Positional postings for <code>to</code>:</p>
<ul>
<li><code>to</code>: <span class="math inline">\({(d_1, 1), (d_1, 5), (d_2, 1)}\)</span> (assuming positions start at 1)</li>
</ul>
</section>
<section id="tiny-code-python-positional-index" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-positional-index">Tiny Code (Python, positional index)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tokenize(text):</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.findall(<span class="vs">r"</span><span class="pp">[a-z0-9]</span><span class="op">+</span><span class="vs">"</span>, text.lower())</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_inverted_index(docs):</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># docs: dict {doc_id: text}</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">list</span>))</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d, text <span class="kw">in</span> docs.items():</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        terms <span class="op">=</span> tokenize(text)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pos, term <span class="kw">in</span> <span class="bu">enumerate</span>(terms, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>            index[term][d].append(pos)</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to regular dicts and sort postings</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    final <span class="op">=</span> {}</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> term, posting <span class="kw">in</span> index.items():</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        final[term] <span class="op">=</span> {doc: <span class="bu">sorted</span>(pos_list) <span class="cf">for</span> doc, pos_list <span class="kw">in</span> <span class="bu">sorted</span>(posting.items())}</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> {</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"to be or not to be"</span>,</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"to seek truth"</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>inv <span class="op">=</span> build_inverted_index(docs)</span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> term <span class="kw">in</span> <span class="bu">sorted</span>(inv):</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(term, <span class="st">"-&gt;"</span>, inv[term])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output sketch:</p>
<pre><code>be -&gt; {1: [2, 6]}
not -&gt; {1: [4]}
or -&gt; {1: [3]}
seek -&gt; {2: [2]}
to -&gt; {1: [1, 5], 2: [1]}
truth -&gt; {2: [3]}</code></pre>
</section>
<section id="tiny-code-c-document-level-index-minimal" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-document-level-index-minimal">Tiny Code (C, document-level index, minimal)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb126"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ctype.h&gt;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_TERMS </span><span class="dv">1024</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_TERM_LEN </span><span class="dv">32</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_DOCS </span><span class="dv">128</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> term<span class="op">[</span>MAX_TERM_LEN<span class="op">];</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> docs<span class="op">[</span>MAX_DOCS<span class="op">];</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ndocs<span class="op">;</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Posting<span class="op">;</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>Posting index_<span class="op">[</span>MAX_TERMS<span class="op">];</span></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nterms <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> add_posting<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>term<span class="op">,</span> <span class="dt">int</span> doc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// find term</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nterms<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>index_<span class="op">[</span>i<span class="op">].</span>term<span class="op">,</span> term<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// add doc if new</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>index_<span class="op">[</span>i<span class="op">].</span>ndocs <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> index_<span class="op">[</span>i<span class="op">].</span>docs<span class="op">[</span>index_<span class="op">[</span>i<span class="op">].</span>ndocs <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">!=</span> doc<span class="op">)</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>                index_<span class="op">[</span>i<span class="op">].</span>docs<span class="op">[</span>index_<span class="op">[</span>i<span class="op">].</span>ndocs<span class="op">++]</span> <span class="op">=</span> doc<span class="op">;</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// new term</span></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>index_<span class="op">[</span>nterms<span class="op">].</span>term<span class="op">,</span> term<span class="op">,</span> MAX_TERM_LEN <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>docs<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> doc<span class="op">;</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>ndocs <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>    nterms<span class="op">++;</span></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> tokenize_and_add<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>text<span class="op">,</span> <span class="dt">int</span> doc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">256</span><span class="op">],</span> term<span class="op">[</span>MAX_TERM_LEN<span class="op">];</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> c <span class="op">=</span> text<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>isalnum<span class="op">(</span>c<span class="op">))</span> <span class="op">{</span></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>k <span class="op">&lt;</span> MAX_TERM_LEN <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> term<span class="op">[</span>k<span class="op">++]</span> <span class="op">=</span> tolower<span class="op">(</span>c<span class="op">);</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>k <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>                term<span class="op">[</span>k<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>                add_posting<span class="op">(</span>term<span class="op">,</span> doc<span class="op">);</span></span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>                k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>    tokenize_and_add<span class="op">(</span><span class="st">"to be or not to be"</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>    tokenize_and_add<span class="op">(</span><span class="st">"to seek truth"</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nterms<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> -&gt;"</span><span class="op">,</span> index_<span class="op">[</span>i<span class="op">].</span>term<span class="op">);</span></span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> index_<span class="op">[</span>i<span class="op">].</span>ndocs<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">" </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> index_<span class="op">[</span>i<span class="op">].</span>docs<span class="op">[</span>j<span class="op">]);</span></span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-69" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-69">Why It Matters</h4>
<ul>
<li>Speed: sublinear query time via direct term lookups</li>
<li>Scalability: supports billions of documents with compression and sharding</li>
<li>Flexibility: enables Boolean search, phrase queries, proximity, ranking (TF–IDF, BM25)</li>
<li>Extensible: can store payloads like term frequencies, positions, field ids</li>
</ul>
<p>Tradeoffs</p>
<ul>
<li>Build time and memory during indexing</li>
<li>Requires maintenance on updates (incremental or batch)</li>
<li>More complex storage formats for compression and skipping</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-60" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-60">A Gentle Proof (Why It Works)</h4>
<p>Let the corpus be <span class="math inline">\(D = {d_1, \dots, d_N}\)</span> and the vocabulary <span class="math inline">\(V = {t_1, \dots, t_M}\)</span>. Define the postings list for term <span class="math inline">\(t\)</span> as: <span class="math display">\[
P(t) = { (d, p_1, p_2, \dots) \mid t \text{ occurs in } d \text{ at positions } p_i }.
\]</span> For Boolean retrieval on a conjunctive query <span class="math inline">\(q = t_a \land t_b\)</span>, the result set is: <span class="math display">\[
R(q) = { d \mid d \in \pi_{\text{doc}}(P(t_a)) \cap \pi_{\text{doc}}(P(t_b)) }.
\]</span> Since document ids within each postings list are sorted, intersection runs in time proportional to the sum of postings lengths, which is sublinear in the total corpus size when terms are selective.</p>
<p>For phrase queries with positions, we additionally check position offsets, preserving correctness by requiring aligned positional gaps.</p>
</section>
<section id="try-it-yourself-69" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-69">Try It Yourself</h4>
<ol type="1">
<li>Extend the Python code to store term frequencies per document and compute <span class="math inline">\(tf\)</span> and <span class="math inline">\(df\)</span>.</li>
<li>Implement Boolean <code>AND</code> by intersecting sorted doc id lists.</li>
<li>Add phrase querying using positional lists: verify <code>"to be"</code> returns only <span class="math inline">\(d_1\)</span>.</li>
<li>Add gap encoding for doc ids and positions.</li>
<li>Benchmark intersection cost versus corpus size.</li>
</ol>
</section>
<section id="test-cases-69" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-69">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Query</th>
<th>Expected Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>to</code></td>
<td>Returns <span class="math inline">\(d_1, d_2\)</span> with correct positions</td>
</tr>
<tr class="even">
<td><code>be AND truth</code></td>
<td>Empty set</td>
</tr>
<tr class="odd">
<td><code>"to be"</code></td>
<td>Returns <span class="math inline">\(d_1\)</span> only</td>
</tr>
<tr class="even">
<td><code>seek OR truth</code></td>
<td>Returns <span class="math inline">\(d_2\)</span></td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-69" class="level4">
<h4 class="anchored" data-anchor-id="complexity-69">Complexity</h4>
<ul>
<li><p>Build time: <span class="math inline">\(O(\sum_d |d| \log Z)\)</span> if inserting into a balanced dictionary of size <span class="math inline">\(Z\)</span>, or <span class="math inline">\(O(\sum_d |d|)\)</span> with hashing plus a final sort per term</p></li>
<li><p>Space: <span class="math inline">\(O(T)\)</span> where <span class="math inline">\(T\)</span> is total term occurrences, reduced by compression</p></li>
<li><p>Query</p>
<ul>
<li>Boolean AND: <span class="math inline">\(O(|P(t_a)| + |P(t_b)|)\)</span> using galloping or merge</li>
<li>Phrase query: above cost plus positional merge</li>
</ul></li>
<li><p>I/O: reduced by skip lists, block posting, and compression (VByte, PForDelta, Elias–Gamma)</p></li>
</ul>
<p>An inverted index turns a pile of text into a fast lookup structure: terms become keys, documents become coordinates, and search becomes a matter of intersecting sorted lists instead of scanning the world.</p>
</section>
</section>
<section id="positional-index-build" class="level3">
<h3 class="anchored" data-anchor-id="positional-index-build">872 Positional Index Build</h3>
<p>A positional index extends the inverted index by storing the exact positions of terms in each document. This allows phrase queries (like <code>"machine learning"</code>) and proximity queries (like <code>"data" within 5 words of "model"</code>).</p>
<p>It’s the foundation of modern search engines, where relevance depends not only on term presence but also on their order and distance.</p>
<section id="what-problem-are-we-solving-70" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-70">What Problem Are We Solving?</h4>
<p>A standard inverted index can only answer “which documents contain a term.” But if a user searches for <code>"deep learning"</code>, we need documents where <em>deep</em> is immediately followed by <em>learning</em>. We also want to support queries like <code>"neural" NEAR/3 "network"</code>.</p>
<p>To do that, we must store term positions within documents.</p>
</section>
<section id="how-does-it-work-plain-language-70" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-70">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Tokenize documents and assign each word a position number (starting from 1).</li>
<li>For each term <span class="math inline">\(t\)</span> in document <span class="math inline">\(d\)</span>, record all positions <span class="math inline">\(p\)</span> where <span class="math inline">\(t\)</span> appears.</li>
<li>Store postings as: <span class="math inline">\(t \rightarrow [(d_1, [p_{11}, p_{12}, ...]), (d_2, [p_{21}, ...]), ...]\)</span></li>
<li>Use position alignment to evaluate phrase queries.</li>
</ol>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Doc ID</th>
<th>Text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>“to be or not to be”</td>
</tr>
<tr class="even">
<td>2</td>
<td>“to seek truth”</td>
</tr>
</tbody>
</table>
<p>Positional Index:</p>
<pre><code>be -&gt; {1: [2, 6]}
not -&gt; {1: [4]}
seek -&gt; {2: [2]}
to -&gt; {1: [1, 5], 2: [1]}
truth -&gt; {2: [3]}</code></pre>
<p>Phrase query <code>"to be"</code> checks for positions where <code>be.pos = to.pos + 1</code>.</p>
</section>
<section id="tiny-code-python-example-10" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-10">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tokenize(text):</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.findall(<span class="vs">r"</span><span class="pp">[a-z0-9]</span><span class="op">+</span><span class="vs">"</span>, text.lower())</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_positional_index(docs):</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: defaultdict(<span class="bu">list</span>))</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> doc_id, text <span class="kw">in</span> docs.items():</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>        terms <span class="op">=</span> tokenize(text)</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pos, term <span class="kw">in</span> <span class="bu">enumerate</span>(terms, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>            index[term][doc_id].append(pos)</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> index</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> {</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"to be or not to be"</span>,</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"to seek truth"</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> build_positional_index(docs)</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> term <span class="kw">in</span> <span class="bu">sorted</span>(index):</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(term, <span class="st">"-&gt;"</span>, index[term])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>be -&gt; {1: [2, 6]}
not -&gt; {1: [4]}
seek -&gt; {2: [2]}
to -&gt; {1: [1, 5], 2: [1]}
truth -&gt; {2: [3]}</code></pre>
</section>
<section id="phrase-query-example" class="level4">
<h4 class="anchored" data-anchor-id="phrase-query-example">Phrase Query (Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phrase_query(index, term1, term2):</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> term1 <span class="kw">not</span> <span class="kw">in</span> index <span class="kw">or</span> term2 <span class="kw">not</span> <span class="kw">in</span> index:</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> index[term1]:</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d <span class="kw">in</span> index[term2]:</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>            pos1 <span class="op">=</span> index[term1][d]</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>            pos2 <span class="op">=</span> index[term2][d]</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p1 <span class="kw">in</span> pos1:</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (p1 <span class="op">+</span> <span class="dv">1</span>) <span class="kw">in</span> pos2:</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>                    results.append(d)</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Phrase 'to be':"</span>, phrase_query(index, <span class="st">"to"</span>, <span class="st">"be"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>Phrase 'to be': [1]</code></pre>
</section>
<section id="tiny-code-c-simplified-concept" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-simplified-concept">Tiny Code (C, simplified concept)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb132"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;ctype.h&gt;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_DOCS </span><span class="dv">10</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_TERMS </span><span class="dv">100</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_POS </span><span class="dv">100</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_TERM_LEN </span><span class="dv">32</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> term<span class="op">[</span>MAX_TERM_LEN<span class="op">];</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> doc_id<span class="op">[</span>MAX_DOCS<span class="op">];</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> positions<span class="op">[</span>MAX_DOCS<span class="op">][</span>MAX_POS<span class="op">];</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> counts<span class="op">[</span>MAX_DOCS<span class="op">];</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ndocs<span class="op">;</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Posting<span class="op">;</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>Posting index_<span class="op">[</span>MAX_TERMS<span class="op">];</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nterms <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> add_posting<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>term<span class="op">,</span> <span class="dt">int</span> doc<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nterms<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>index_<span class="op">[</span>i<span class="op">].</span>term<span class="op">,</span> term<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> d <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> index_<span class="op">[</span>i<span class="op">].</span>ndocs<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>index_<span class="op">[</span>i<span class="op">].</span>doc_id<span class="op">[</span>j<span class="op">]</span> <span class="op">==</span> doc<span class="op">)</span></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a>                    d <span class="op">=</span> j<span class="op">;</span></span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>d <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>                d <span class="op">=</span> index_<span class="op">[</span>i<span class="op">].</span>ndocs<span class="op">++;</span></span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a>                index_<span class="op">[</span>i<span class="op">].</span>doc_id<span class="op">[</span>d<span class="op">]</span> <span class="op">=</span> doc<span class="op">;</span></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>                index_<span class="op">[</span>i<span class="op">].</span>counts<span class="op">[</span>d<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a>            index_<span class="op">[</span>i<span class="op">].</span>positions<span class="op">[</span>d<span class="op">][</span>index_<span class="op">[</span>i<span class="op">].</span>counts<span class="op">[</span>d<span class="op">]++]</span> <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>    strcpy<span class="op">(</span>index_<span class="op">[</span>nterms<span class="op">].</span>term<span class="op">,</span> term<span class="op">);</span></span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>ndocs <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>doc_id<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> doc<span class="op">;</span></span>
<span id="cb132-40"><a href="#cb132-40" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>positions<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> pos<span class="op">;</span></span>
<span id="cb132-41"><a href="#cb132-41" aria-hidden="true" tabindex="-1"></a>    index_<span class="op">[</span>nterms<span class="op">].</span>counts<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb132-42"><a href="#cb132-42" aria-hidden="true" tabindex="-1"></a>    nterms<span class="op">++;</span></span>
<span id="cb132-43"><a href="#cb132-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-70" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-70">Why It Matters</h4>
<ul>
<li>Enables phrase, proximity, and exact order queries.</li>
<li>Critical for web search, legal discovery, and code indexing.</li>
<li>Enables higher-quality ranking features (e.g., term proximity scoring).</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Larger storage (positions per occurrence).</li>
<li>Slower build time.</li>
<li>Higher compression complexity (position deltas).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-61" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-61">A Gentle Proof (Why It Works)</h4>
<p>Let term postings be: <span class="math display">\[
P(t) = {(d_i, [p_{i1}, p_{i2}, ...])}
\]</span></p>
<p>A phrase query of terms <span class="math inline">\(t_1, t_2, ..., t_k\)</span> matches document <span class="math inline">\(d\)</span> if: <span class="math display">\[
\exists p \in P(t_1, d): \forall j \in [2, k], (p + j - 1) \in P(t_j, d)
\]</span></p>
<p>The algorithm slides through position lists in increasing order, checking for consecutive offsets. Because positions are sorted, the check runs in <span class="math inline">\(O(|P(t_1,d)| + ... + |P(t_k,d)|)\)</span> time, efficient in practice.</p>
</section>
<section id="try-it-yourself-70" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-70">Try It Yourself</h4>
<ol type="1">
<li>Modify the Python version to support 3-word phrases (e.g., <code>"to be or"</code>).</li>
<li>Extend to proximity queries: <code>"data" NEAR/3 "model"</code>.</li>
<li>Compress positions using delta encoding.</li>
<li>Add document frequency statistics.</li>
<li>Measure query speed as the corpus grows.</li>
</ol>
</section>
<section id="test-cases-70" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-70">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Query</th>
<th>Expected</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>"to be"</code></td>
<td>doc 1</td>
<td>consecutive terms</td>
</tr>
<tr class="even">
<td><code>"to seek"</code></td>
<td>doc 2</td>
<td>valid</td>
</tr>
<tr class="odd">
<td><code>"be or not"</code></td>
<td>doc 1</td>
<td>triple phrase</td>
</tr>
<tr class="even">
<td><code>"truth be"</code></td>
<td>none</td>
<td>not consecutive</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-70" class="level4">
<h4 class="anchored" data-anchor-id="complexity-70">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 38%">
<col style="width: 25%">
<col style="width: 2%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Index build</td>
<td><span class="math inline">\(O(\sum_d                        | d                     | )\)</span></td>
<td><span class="math inline">\(O(T)\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Phrase query</td>
<td><span class="math inline">\(O(\sum_i                        | P(t_i)                | )\)</span></td>
<td><span class="math inline">\(O(T)\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Storage (uncompressed)</td>
<td>proportional to term occurrences</td>
<td>high but compressible</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>A positional index transforms plain search into structured understanding: not just <em>what</em> appears, but <em>where</em>. It captures the geometry of language, the shape of meaning in text.</p>
</section>
</section>
<section id="tfidf-scoring" class="level3">
<h3 class="anchored" data-anchor-id="tfidf-scoring">873 TF–IDF Scoring</h3>
<p>TF–IDF (Term Frequency–Inverse Document Frequency) is one of the most influential scoring models in information retrieval. It quantifies how <em>important</em> a word is to a document in a collection, balancing frequency within the document and rarity across the corpus.</p>
<section id="what-problem-are-we-solving-71" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-71">What Problem Are We Solving?</h4>
<p>In search, not all words are equal. Common terms like <em>the</em>, <em>is</em>, or <em>data</em> appear everywhere, while rare terms like <em>quantization</em> or <em>Bayes</em> carry much more meaning. We want a way to assign weights to words that reflect how well a document matches a query.</p>
<p>TF–IDF gives us exactly that balance.</p>
</section>
<section id="how-does-it-work-plain-language-71" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-71">How Does It Work (Plain Language)</h4>
<p>TF–IDF combines two simple ideas:</p>
<ol type="1">
<li><p>Term Frequency (TF): Measures how often a term appears in a document. The more times a word occurs, the more relevant it may be. <span class="math display">\[
TF(t, d) = \frac{f_{t,d}}{\max_k f_{k,d}}
\]</span> where <span class="math inline">\(f_{t,d}\)</span> is the raw count of term <span class="math inline">\(t\)</span> in document <span class="math inline">\(d\)</span>.</p></li>
<li><p>Inverse Document Frequency (IDF): Measures how rare the term is across all documents. Rare terms get higher weight. <span class="math display">\[
IDF(t, D) = \log \frac{N}{n_t}
\]</span> where <span class="math inline">\(N\)</span> is the total number of documents, and <span class="math inline">\(n_t\)</span> is the number of documents containing <span class="math inline">\(t\)</span>.</p></li>
<li><p>Combine: <span class="math display">\[
w_{t,d} = TF(t, d) \times IDF(t, D)
\]</span></p></li>
</ol>
<p>A query’s score for document <span class="math inline">\(d\)</span> is then: <span class="math display">\[
\text{score}(q, d) = \sum_{t \in q} TF(t, d) \times IDF(t, D)
\]</span></p>
</section>
<section id="example-2" class="level4">
<h4 class="anchored" data-anchor-id="example-2">Example</h4>
<p>Corpus:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Doc ID</th>
<th>Text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>“deep learning for vision”</td>
</tr>
<tr class="even">
<td>2</td>
<td>“deep learning for language”</td>
</tr>
<tr class="odd">
<td>3</td>
<td>“classical machine learning”</td>
</tr>
</tbody>
</table>
<p>Compute IDF for each term:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Appears In</th>
<th>IDF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep</td>
<td>2</td>
<td><span class="math inline">\(\log(3/2) = 0.176\)</span></td>
</tr>
<tr class="even">
<td>learning</td>
<td>3</td>
<td><span class="math inline">\(\log(3/3) = 0\)</span></td>
</tr>
<tr class="odd">
<td>vision</td>
<td>1</td>
<td><span class="math inline">\(\log(3/1) = 1.099\)</span></td>
</tr>
<tr class="even">
<td>language</td>
<td>1</td>
<td><span class="math inline">\(\log(3/1) = 1.099\)</span></td>
</tr>
<tr class="odd">
<td>classical</td>
<td>1</td>
<td><span class="math inline">\(\log(3/1) = 1.099\)</span></td>
</tr>
<tr class="even">
<td>machine</td>
<td>1</td>
<td><span class="math inline">\(\log(3/1) = 1.099\)</span></td>
</tr>
</tbody>
</table>
<p>Then TF–IDF for term “vision” in doc 1 (assuming TF = 1): <span class="math display">\[
w_{vision,1} = 1 \times 1.099 = 1.099
\]</span></p>
<p>A query “deep vision” ranks doc 1 highest because both terms appear and <em>vision</em> is rare.</p>
</section>
<section id="tiny-code-python" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tfidf(corpus):</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> <span class="bu">len</span>(corpus)</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    tf <span class="op">=</span> []</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> Counter()</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute term frequencies and document frequencies</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> text <span class="kw">in</span> corpus:</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>        words <span class="op">=</span> text.lower().split()</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>        counts <span class="op">=</span> Counter(words)</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>        tf.append(counts)</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> term <span class="kw">in</span> counts:</span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>            df[term] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>    idf <span class="op">=</span> {t: math.log(N <span class="op">/</span> df[t]) <span class="cf">for</span> t <span class="kw">in</span> df}</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine TF and IDF</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> []</span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> counts <span class="kw">in</span> tf:</span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> {t: counts[t] <span class="op">*</span> idf[t] <span class="cf">for</span> t <span class="kw">in</span> counts}</span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>        weights.append(w)</span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weights</span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> [</span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep learning for vision"</span>,</span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep learning for language"</span>,</span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"classical machine learning"</span></span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> tfidf(docs)</span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, w <span class="kw">in</span> <span class="bu">enumerate</span>(weights, <span class="dv">1</span>):</span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Doc </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-simplified" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-simplified">Tiny Code (C Simplified)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb134"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;math.h&gt;</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_TERMS </span><span class="dv">100</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_DOCS </span><span class="dv">10</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> terms<span class="op">[</span>MAX_TERMS<span class="op">][</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> df<span class="op">[</span>MAX_TERMS<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nterms <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> find_term<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nterms<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>terms<span class="op">[</span>i<span class="op">],</span> t<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>    strcpy<span class="op">(</span>terms<span class="op">[</span>nterms<span class="op">],</span> t<span class="op">);</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nterms<span class="op">++;</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> count_df<span class="op">(</span><span class="dt">char</span> docs<span class="op">[][</span><span class="dv">256</span><span class="op">],</span> <span class="dt">int</span> ndocs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> d <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> d <span class="op">&lt;</span> ndocs<span class="op">;</span> d<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> seen<span class="op">[</span>MAX_TERMS<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>tok <span class="op">=</span> strtok<span class="op">(</span>docs<span class="op">[</span>d<span class="op">],</span> <span class="st">" "</span><span class="op">);</span></span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>tok<span class="op">)</span> <span class="op">{</span></span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> i <span class="op">=</span> find_term<span class="op">(</span>tok<span class="op">);</span></span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>seen<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span> df<span class="op">[</span>i<span class="op">]++;</span> seen<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a>            tok <span class="op">=</span> strtok<span class="op">(</span>NULL<span class="op">,</span> <span class="st">" "</span><span class="op">);</span></span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb134-32"><a href="#cb134-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> docs<span class="op">[</span><span class="dv">3</span><span class="op">][</span><span class="dv">256</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb134-33"><a href="#cb134-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep learning for vision"</span><span class="op">,</span></span>
<span id="cb134-34"><a href="#cb134-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep learning for language"</span><span class="op">,</span></span>
<span id="cb134-35"><a href="#cb134-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"classical machine learning"</span></span>
<span id="cb134-36"><a href="#cb134-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb134-37"><a href="#cb134-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> N <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb134-38"><a href="#cb134-38" aria-hidden="true" tabindex="-1"></a>    count_df<span class="op">(</span>docs<span class="op">,</span> N<span class="op">);</span></span>
<span id="cb134-39"><a href="#cb134-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nterms<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb134-40"><a href="#cb134-40" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> -&gt; IDF=</span><span class="sc">%.3f\n</span><span class="st">"</span><span class="op">,</span> terms<span class="op">[</span>i<span class="op">],</span> log<span class="op">((</span><span class="dt">double</span><span class="op">)</span>N <span class="op">/</span> df<span class="op">[</span>i<span class="op">]));</span></span>
<span id="cb134-41"><a href="#cb134-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-71" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-71">Why It Matters</h4>
<ul>
<li>Core of modern ranking algorithms.</li>
<li>Foundation of vector space models and cosine similarity search.</li>
<li>Forms the basis of BM25, TF–IDF + embeddings, and hybrid search.</li>
<li>Efficient and interpretable, no training needed.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Doesn’t consider word order or semantics.</li>
<li>Can overemphasize long documents.</li>
<li>Simple, but remarkably effective for many tasks.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-62" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-62">A Gentle Proof (Why It Works)</h4>
<p>TF increases with term relevance within a document. IDF penalizes terms that appear in too many documents. Their product amplifies rare but frequent words within a document.</p>
<p>For a query <span class="math inline">\(q\)</span> and document <span class="math inline">\(d\)</span>:</p>
<p><span class="math display">\[
\text{score}(q,d) = \sum_{t \in q} TF(t,d) \cdot IDF(t,D)
\]</span></p>
<p>This is equivalent to projecting both <span class="math inline">\(q\)</span> and <span class="math inline">\(d\)</span> into a weighted vector space and computing their dot product. It approximates how <em>specific</em> the document is to the query’s rare words.</p>
</section>
<section id="try-it-yourself-71" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-71">Try It Yourself</h4>
<ol type="1">
<li>Compute TF–IDF for “machine learning” across your favorite research abstracts.</li>
<li>Compare ranking when using raw term counts vs.&nbsp;log-scaled TF.</li>
<li>Extend the formula to use cosine similarity: <span class="math display">\[
\cos(\theta) = \frac{\mathbf{v_q} \cdot \mathbf{v_d}}{||\mathbf{v_q}|| , ||\mathbf{v_d}||}
\]</span></li>
<li>Integrate stopword filtering and stemming to improve quality.</li>
<li>Plot top-weighted terms per document.</li>
</ol>
</section>
<section id="test-cases-71" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-71">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Doc 1</th>
<th>Doc 2</th>
<th>Doc 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep</td>
<td>0.176</td>
<td>0.176</td>
<td>0.000</td>
</tr>
<tr class="even">
<td>learning</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td>vision</td>
<td>1.099</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="even">
<td>language</td>
<td>0.000</td>
<td>1.099</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td>machine</td>
<td>0.000</td>
<td>0.000</td>
<td>1.099</td>
</tr>
<tr class="even">
<td>classical</td>
<td>0.000</td>
<td>0.000</td>
<td>1.099</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-71" class="level4">
<h4 class="anchored" data-anchor-id="complexity-71">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 19%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 4%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Time</th>
<th>Space</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Build DF</td>
<td><span class="math inline">\(O(\sum_d | d     | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Compute TF</td>
<td><span class="math inline">\(O(\sum_d | d     | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Query Scoring</td>
<td><span class="math inline">\(O(       | q     | \times | D      | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>TF–IDF turns plain text into numbers that speak, simple frequencies that reveal meaning, a bridge between counting words and understanding ideas.</p>
</section>
</section>
<section id="bm25-ranking" class="level3">
<h3 class="anchored" data-anchor-id="bm25-ranking">874 BM25 Ranking</h3>
<p>BM25 (Best Match 25) is the modern evolution of TF–IDF. It refines the scoring by introducing document length normalization and saturation control, making it the gold standard for keyword-based ranking in search engines like Lucene, Elasticsearch, and PostgreSQL full-text search.</p>
<section id="what-problem-are-we-solving-72" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-72">What Problem Are We Solving?</h4>
<p>TF–IDF treats all documents and frequencies equally, which leads to two main issues:</p>
<ol type="1">
<li>Long documents unfairly score higher because they naturally contain more terms.</li>
<li>Overfrequent terms (e.g., a word appearing 100 times) shouldn’t increase the score indefinitely.</li>
</ol>
<p>BM25 fixes both by dampening TF growth and adjusting for document length relative to the average.</p>
</section>
<section id="how-does-it-work-plain-language-72" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-72">How Does It Work (Plain Language)</h4>
<p>BM25 builds on TF–IDF with two key corrections:</p>
<ol type="1">
<li>Term frequency saturation – frequent terms give diminishing returns.</li>
<li>Length normalization – long documents are penalized relative to the average length.</li>
</ol>
<p>For a query <span class="math inline">\(q\)</span> and document <span class="math inline">\(d\)</span>:</p>
<p><span class="math display">\[
\text{score}(q, d) = \sum_{t \in q} IDF(t) \cdot \frac{f_{t,d} \cdot (k_1 + 1)}{f_{t,d} + k_1 \cdot (1 - b + b \cdot \frac{|d|}{avgdl})}
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(f_{t,d}\)</span> = term frequency of <span class="math inline">\(t\)</span> in document <span class="math inline">\(d\)</span></li>
<li><span class="math inline">\(|d|\)</span> = document length</li>
<li><span class="math inline">\(avgdl\)</span> = average document length</li>
<li><span class="math inline">\(k_1\)</span> = saturation parameter (commonly 1.2–2.0)</li>
<li><span class="math inline">\(b\)</span> = length normalization factor (commonly 0.75)</li>
</ul>
<p>IDF is defined as:</p>
<p><span class="math display">\[
IDF(t) = \log\frac{N - n_t + 0.5}{n_t + 0.5}
\]</span></p>
<p>where <span class="math inline">\(N\)</span> = total number of documents, <span class="math inline">\(n_t\)</span> = number containing <span class="math inline">\(t\)</span>.</p>
</section>
<section id="example-calculation" class="level4">
<h4 class="anchored" data-anchor-id="example-calculation">Example Calculation</h4>
<p>Suppose:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th><span class="math inline">\(f_{t,d}\)</span></th>
<th><span class="math inline">\(n_t\)</span></th>
<th><span class="math inline">\(N\)</span></th>
<th><span class="math inline">\(|d|\)</span></th>
<th><span class="math inline">\(avgdl\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>“vision”</td>
<td>3</td>
<td>10</td>
<td>1000</td>
<td>120</td>
<td>100</td>
</tr>
</tbody>
</table>
<p>Parameters: <span class="math inline">\(k_1 = 1.2\)</span>, <span class="math inline">\(b = 0.75\)</span></p>
<p>Compute:</p>
<p><span class="math display">\[
IDF(vision) = \log\frac{1000 - 10 + 0.5}{10 + 0.5} \approx 1.96
\]</span></p>
<p>and</p>
<p><span class="math display">\[
TF_{BM25} = \frac{3 \cdot (1.2 + 1)}{3 + 1.2 \cdot (1 - 0.75 + 0.75 \cdot \frac{120}{100})} \approx 1.87
\]</span></p>
<p>Then score contribution:</p>
<p><span class="math display">\[
w_{vision, d} = 1.96 \times 1.87 \approx 3.67
\]</span></p>
</section>
<section id="tiny-code-python-example-11" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-11">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bm25_score(query, docs, k1<span class="op">=</span><span class="fl">1.2</span>, b<span class="op">=</span><span class="fl">0.75</span>):</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> <span class="bu">len</span>(docs)</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    avgdl <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(d.split()) <span class="cf">for</span> d <span class="kw">in</span> docs) <span class="op">/</span> N</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build document frequencies</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> Counter()</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> docs:</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>        terms <span class="op">=</span> <span class="bu">set</span>(d.split())</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> terms:</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>            df[t] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> doc <span class="kw">in</span> docs:</span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>        words <span class="op">=</span> doc.split()</span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> Counter(words)</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> query.split():</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> t <span class="kw">not</span> <span class="kw">in</span> freq:</span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>            n_t <span class="op">=</span> df[t]</span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>            idf <span class="op">=</span> math.log((N <span class="op">-</span> n_t <span class="op">+</span> <span class="fl">0.5</span>) <span class="op">/</span> (n_t <span class="op">+</span> <span class="fl">0.5</span>))</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>            tf <span class="op">=</span> freq[t]</span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>            denom <span class="op">=</span> tf <span class="op">+</span> k1 <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> b <span class="op">+</span> b <span class="op">*</span> <span class="bu">len</span>(words) <span class="op">/</span> avgdl)</span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>            score <span class="op">+=</span> idf <span class="op">*</span> (tf <span class="op">*</span> (k1 <span class="op">+</span> <span class="dv">1</span>)) <span class="op">/</span> denom</span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>        scores.append(score)</span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scores</span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> [</span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep learning for vision"</span>,</span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep learning for language"</span>,</span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"machine learning for vision and robotics"</span></span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"learning vision"</span></span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> bm25_score(query, docs)</span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(scores, <span class="dv">1</span>):</span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Doc </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>s<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output (typical):</p>
<pre><code>Doc 1: 2.74
Doc 2: 1.96
Doc 3: 2.88</code></pre>
</section>
<section id="tiny-code-c-style-pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-style-pseudocode">Tiny Code (C-style Pseudocode)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb137"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> bm25_score<span class="op">(</span><span class="dt">double</span> tf<span class="op">,</span> <span class="dt">double</span> n_t<span class="op">,</span> <span class="dt">double</span> N<span class="op">,</span> <span class="dt">double</span> len_d<span class="op">,</span> <span class="dt">double</span> avgdl<span class="op">,</span> <span class="dt">double</span> k1<span class="op">,</span> <span class="dt">double</span> b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> idf <span class="op">=</span> log<span class="op">((</span>N <span class="op">-</span> n_t <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span>n_t <span class="op">+</span> <span class="fl">0.5</span><span class="op">));</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> denom <span class="op">=</span> tf <span class="op">+</span> k1 <span class="op">*</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> b <span class="op">+</span> b <span class="op">*</span> len_d <span class="op">/</span> avgdl<span class="op">);</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> idf <span class="op">*</span> <span class="op">(</span>tf <span class="op">*</span> <span class="op">(</span>k1 <span class="op">+</span> <span class="dv">1</span><span class="op">))</span> <span class="op">/</span> denom<span class="op">;</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-72" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-72">Why It Matters</h4>
<ul>
<li>Standard baseline for modern IR and search engines.</li>
<li>Handles document length naturally.</li>
<li>Provides excellent balance of simplicity, performance, and accuracy.</li>
<li>Works with sparse indexes and precomputed postings.</li>
</ul>
<p>Used in: Lucene, Elasticsearch, Solr, PostgreSQL FTS, Vespa, Whoosh, and OpenSearch.</p>
</section>
<section id="a-gentle-proof-why-it-works-63" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-63">A Gentle Proof (Why It Works)</h4>
<p>TF–IDF’s linear scaling overweights frequent terms. BM25 adds a saturation function that flattens TF growth and a normalization term that adjusts for document length.</p>
<p>As <span class="math inline">\(f_{t,d} \to \infty\)</span>:</p>
<p><span class="math display">\[
\frac{f_{t,d} (k_1 + 1)}{f_{t,d} + k_1(1 - b + b|d|/avgdl)} \to (k_1 + 1)
\]</span></p>
<p>This ensures bounded contribution per term, preventing dominance by repetition.</p>
<p>Meanwhile, for very long documents (<span class="math inline">\(|d| \gg avgdl\)</span>), the denominator grows, reducing effective weight, balancing precision and recall.</p>
</section>
<section id="try-it-yourself-72" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-72">Try It Yourself</h4>
<ol type="1">
<li>Implement BM25 on your own text dataset.</li>
<li>Experiment with <span class="math inline">\(b=0\)</span> (no length normalization) and <span class="math inline">\(b=1\)</span> (full normalization).</li>
<li>Compare BM25 and TF–IDF on queries with short vs.&nbsp;long documents.</li>
<li>Tune <span class="math inline">\(k_1\)</span> between 1.0 and 2.0 to observe TF saturation.</li>
<li>Visualize how the score changes as <span class="math inline">\(f_{t,d}\)</span> increases.</li>
</ol>
</section>
<section id="test-cases-72" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-72">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th><span class="math inline">\(f_{t,d}\)</span></th>
<th><span class="math inline">\(|d|\)</span></th>
<th><span class="math inline">\(avgdl\)</span></th>
<th>Score Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>short doc</td>
<td>avg</td>
<td>highest</td>
<td></td>
</tr>
<tr class="even">
<td>3</td>
<td>long doc</td>
<td>high</td>
<td>moderate</td>
<td></td>
</tr>
<tr class="odd">
<td>10</td>
<td>long doc</td>
<td>very high</td>
<td>flattens</td>
<td></td>
</tr>
<tr class="even">
<td>rare term</td>
<td>small <span class="math inline">\(n_t\)</span></td>
<td>,</td>
<td>boosts score</td>
<td></td>
</tr>
<tr class="odd">
<td>frequent term</td>
<td>large <span class="math inline">\(n_t\)</span></td>
<td>,</td>
<td>lowers score</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-72" class="level4">
<h4 class="anchored" data-anchor-id="complexity-72">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 39%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Time</th>
<th>Space</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Build DF</td>
<td><span class="math inline">\(O(\sum_d                    | d          | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Query Score</td>
<td><span class="math inline">\(O(                          | q          | \times | D      | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Tuning Impact</td>
<td><span class="math inline">\(k_1, b\)</span> affect balance only</td>
<td>negligible</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>BM25 is the sweet spot between mathematics and engineering, a compact formula that’s powered decades of search, where meaning meets ranking, and simplicity meets precision.</p>
</section>
</section>
<section id="boolean-retrieval" class="level3">
<h3 class="anchored" data-anchor-id="boolean-retrieval">875 Boolean Retrieval</h3>
<p>Boolean Retrieval is the simplest and oldest form of search logic, it treats documents as sets of words and queries as logical expressions using AND, OR, and NOT. It doesn’t rank results, a document either matches the query or it doesn’t. Yet this binary model is the foundation upon which all modern ranking models (like TF–IDF and BM25) were built.</p>
<section id="what-problem-are-we-solving-73" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-73">What Problem Are We Solving?</h4>
<p>Early information retrieval systems needed a precise way to find documents that exactly matched a combination of terms. For example:</p>
<ul>
<li>“machine AND learning” → documents that contain <em>both</em>.</li>
<li>“neural OR probabilistic” → documents that contain <em>either</em>.</li>
<li>“data AND NOT synthetic” → documents about <em>data</em> but excluding <em>synthetic</em>.</li>
</ul>
<p>This is fast, simple, and exact, ideal for legal search, filtering, or structured archives.</p>
</section>
<section id="how-does-it-work-plain-language-73" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-73">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Each document is represented by the set of words it contains.</li>
<li>We build an inverted index, mapping each term to the list of documents containing it.</li>
<li>The query is parsed into a logical expression tree of AND/OR/NOT operators.</li>
<li>We combine the posting lists according to the Boolean logic.</li>
</ol>
<p>Example:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Documents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>learning</td>
<td>1, 2, 3</td>
</tr>
<tr class="even">
<td>machine</td>
<td>1, 3</td>
</tr>
<tr class="odd">
<td>vision</td>
<td>2, 3</td>
</tr>
</tbody>
</table>
<p>Query:</p>
<pre><code>(machine AND learning) OR vision</code></pre>
<p>Step 1: machine AND learning → {1, 3} ∩ {1, 2, 3} = {1, 3} Step 2: {1, 3} OR vision → {1, 3} ∪ {2, 3} = {1, 2, 3}</p>
<p>All documents match.</p>
</section>
<section id="tiny-code-python-example-12" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-12">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Build inverted index</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> {</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"machine learning and vision"</span>,</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"deep learning for vision systems"</span>,</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"machine learning in robotics"</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> defaultdict(<span class="bu">set</span>)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> doc_id, text <span class="kw">in</span> docs.items():</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> term <span class="kw">in</span> text.lower().split():</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>        index[term].add(doc_id)</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> boolean_query(query):</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> query.lower().split()</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> []</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> token <span class="kw">in</span> tokens:</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> token <span class="op">==</span> <span class="st">"and"</span>:</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>            b, a <span class="op">=</span> stack.pop(), stack.pop()</span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>            stack.append(a <span class="op">&amp;</span> b)</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> token <span class="op">==</span> <span class="st">"or"</span>:</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>            b, a <span class="op">=</span> stack.pop(), stack.pop()</span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>            stack.append(a <span class="op">|</span> b)</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> token <span class="op">==</span> <span class="st">"not"</span>:</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>            a <span class="op">=</span> stack.pop()</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>            all_docs <span class="op">=</span> <span class="bu">set</span>(docs.keys())</span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>            stack.append(all_docs <span class="op">-</span> a)</span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>            stack.append(index.get(token, <span class="bu">set</span>()))</span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stack.pop()</span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(boolean_query(<span class="st">"machine and learning"</span>))</span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(boolean_query(<span class="st">"learning or vision"</span>))</span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(boolean_query(<span class="st">"learning and not vision"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>{1, 3}
{1, 2, 3}
{3}</code></pre>
</section>
<section id="tiny-code-c-simplified-concept-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-simplified-concept-1">Tiny Code (C Simplified Concept)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb141"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> machine<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> learning<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> vision<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> intersect<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">int</span> na<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>b<span class="op">,</span> <span class="dt">int</span> nb<span class="op">)</span> <span class="op">{</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> na<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>a<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> b<span class="op">[</span>j<span class="op">])</span> printf<span class="op">(</span><span class="st">"</span><span class="sc">%d</span><span class="st"> "</span><span class="op">,</span> a<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"machine AND learning: "</span><span class="op">);</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>    intersect<span class="op">(</span>machine<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> learning<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-73" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-73">Why It Matters</h4>
<ul>
<li>Foundation of IR: The earliest and simplest model.</li>
<li>Fast and deterministic: Ideal for structured queries or filtering.</li>
<li>Still widely used: Databases, Lucene filters, search engines, and information retrieval courses.</li>
<li>Transparent: Users know exactly why a document matches.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>No ranking, all results are equal.</li>
<li>Sensitive to exact terms (no fuzziness).</li>
<li>Returns empty results if terms are too strict.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-64" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-64">A Gentle Proof (Why It Works)</h4>
<p>Let:</p>
<ul>
<li><span class="math inline">\(D_t\)</span> be the set of documents containing term <span class="math inline">\(t\)</span>.</li>
<li>A Boolean query <span class="math inline">\(Q\)</span> is an expression built using <span class="math inline">\(\cup\)</span> (OR), <span class="math inline">\(\cap\)</span> (AND), and <span class="math inline">\(\setminus\)</span> (NOT).</li>
</ul>
<p>Then the retrieval result is defined recursively: <span class="math display">\[
R(Q) =
\begin{cases}
D_t, &amp; \text{if } Q = t \\
R(Q_1) \cap R(Q_2), &amp; \text{if } Q = Q_1 \text{ AND } Q_2 \\
R(Q_1) \cup R(Q_2), &amp; \text{if } Q = Q_1 \text{ OR } Q_2 \\
D - R(Q_1), &amp; \text{if } Q = \text{NOT } Q_1
\end{cases}
\]</span></p>
<p>This makes retrieval compositional and exact, each query maps deterministically to a document set.</p>
</section>
<section id="try-it-yourself-73" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-73">Try It Yourself</h4>
<ol type="1">
<li><p>Create your own inverted index for 5–10 sample documents.</p></li>
<li><p>Test queries like:</p>
<ul>
<li>“data AND algebra”</li>
<li>“distributed OR parallel”</li>
<li>“consistency AND NOT eventual”</li>
</ul></li>
<li><p>Extend to parentheses for precedence: <code>(A AND B) OR (C AND NOT D)</code>.</p></li>
<li><p>Implement ranked retrieval as a next step (TF–IDF or BM25).</p></li>
<li><p>Compare Boolean vs ranked results on the same corpus.</p></li>
</ol>
</section>
<section id="test-cases-73" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-73">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Query</th>
<th>Result</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>machine AND learning</td>
<td>{1, 3}</td>
<td>both words present</td>
</tr>
<tr class="even">
<td>learning OR vision</td>
<td>{1, 2, 3}</td>
<td>union of sets</td>
</tr>
<tr class="odd">
<td>learning AND NOT vision</td>
<td>{3}</td>
<td>exclude vision</td>
</tr>
<tr class="even">
<td>machine AND robotics</td>
<td>{3}</td>
<td>only document 3</td>
</tr>
<tr class="odd">
<td>deep AND vision</td>
<td>{2}</td>
<td>only document 2</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-73" class="level4">
<h4 class="anchored" data-anchor-id="complexity-73">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 44%">
<col style="width: 11%">
<col style="width: 2%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Build index</td>
<td><span class="math inline">\(O(\sum_d                        | d        | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>AND/OR/NOT</td>
<td><span class="math inline">\(O(                              | D_A      | +  | D_B    | )\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Query evaluation</td>
<td><span class="math inline">\(O(\text{length of expression})\)</span></td>
<td>constant</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Boolean Retrieval is search in its purest logic, simple sets, clean truth, no shades of ranking. It’s the algebra of information, the “zero” from which all modern search theory evolved.</p>
</section>
</section>
<section id="wand-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="wand-algorithm">876 WAND Algorithm</h3>
<p>The WAND (Weak AND) algorithm is an optimization for top-<span class="math inline">\(k\)</span> document retrieval. Instead of scoring <em>every</em> document for a query (which can be millions), it cleverly skips documents that cannot possibly reach the current top-<span class="math inline">\(k\)</span> threshold.</p>
<p>It’s the efficiency engine behind modern ranking systems, from Lucene and Elasticsearch to specialized IR engines in web-scale systems.</p>
<section id="what-problem-are-we-solving-74" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-74">What Problem Are We Solving?</h4>
<p>In ranking models like TF–IDF or BM25, a naive search engine must:</p>
<ol type="1">
<li>Compute a full score for every document containing any query term.</li>
<li>Sort all scores to return the top results.</li>
</ol>
<p>That’s wasteful, most documents have low or irrelevant scores. We need a way to avoid computing scores for documents that can’t possibly enter the top-<span class="math inline">\(k\)</span> list.</p>
<p>That’s what WAND does: it bounds the maximum possible score of each document and prunes the search early.</p>
</section>
<section id="how-does-it-work-plain-language-74" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-74">How Does It Work (Plain Language)</h4>
<p>Each query term has:</p>
<ul>
<li>a posting list of document IDs,</li>
<li>and a maximum possible term score (based on TF–IDF or BM25 upper bound).</li>
</ul>
<p>WAND iteratively moves pointers through posting lists in increasing docID order:</p>
<ol type="1">
<li>Maintain one pointer per term (sorted by current docID).</li>
<li>Maintain a current score threshold, the <span class="math inline">\(k\)</span>-th best score so far.</li>
<li>Compute an upper bound of the possible score for the document at the smallest docID across all lists.</li>
<li>If the upper bound is less than the current threshold, skip ahead, no need to compute.</li>
<li>Otherwise, fully evaluate the document’s score and update the threshold if it enters top-<span class="math inline">\(k\)</span>.</li>
</ol>
<p>This gives the same top-<span class="math inline">\(k\)</span> results as exhaustive scoring, but skips thousands of documents.</p>
</section>
<section id="example-3" class="level4">
<h4 class="anchored" data-anchor-id="example-3">Example</h4>
<p>Suppose query = “deep learning vision” and top-<span class="math inline">\(k = 2\)</span>.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Posting List</th>
<th>Max Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep</td>
<td>[2, 5, 9]</td>
<td>1.2</td>
</tr>
<tr class="even">
<td>learning</td>
<td>[1, 5, 9, 12]</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td>vision</td>
<td>[5, 10]</td>
<td>1.5</td>
</tr>
</tbody>
</table>
<ul>
<li>Start with smallest docID = 1 (from <em>learning</em>). Upper bound = 2.0 &lt; current threshold (0) → evaluate. Score(1) = 1.4 → add to heap, threshold = 1.4.</li>
<li>Move to next candidate docID = 2. Upper bound = 1.2 + 2.0 + 1.5 = 4.7 &gt; 1.4 → evaluate. Score(2) = 2.5 → update threshold = 1.4 (since top-2).</li>
<li>Later, skip docIDs whose bound &lt; current threshold.</li>
</ul>
<p>By continuously tightening the threshold, WAND skips irrelevant documents efficiently.</p>
</section>
<section id="tiny-code-python-example-13" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-13">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Posting:</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, doc_id, score):</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.doc_id <span class="op">=</span> doc_id</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.score <span class="op">=</span> score</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample postings (term -&gt; list of (doc_id, score))</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> {</span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep"</span>: [Posting(<span class="dv">2</span>, <span class="fl">1.2</span>), Posting(<span class="dv">5</span>, <span class="fl">1.0</span>), Posting(<span class="dv">9</span>, <span class="fl">0.8</span>)],</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning"</span>: [Posting(<span class="dv">1</span>, <span class="fl">1.4</span>), Posting(<span class="dv">5</span>, <span class="fl">1.6</span>), Posting(<span class="dv">9</span>, <span class="fl">1.5</span>), Posting(<span class="dv">12</span>, <span class="fl">0.7</span>)],</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vision"</span>: [Posting(<span class="dv">5</span>, <span class="fl">1.5</span>), Posting(<span class="dv">10</span>, <span class="fl">1.3</span>)]</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wand(query_terms, k):</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    heap <span class="op">=</span> []  <span class="co"># top-k min-heap</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>    pointers <span class="op">=</span> {t: <span class="dv">0</span> <span class="cf">for</span> t <span class="kw">in</span> query_terms}</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>    max_score <span class="op">=</span> {t: <span class="bu">max</span>(p.score <span class="cf">for</span> p <span class="kw">in</span> index[t]) <span class="cf">for</span> t <span class="kw">in</span> query_terms}</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get smallest docID among pointers</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>        current_docs <span class="op">=</span> [(index[t][pointers[t]].doc_id, t) <span class="cf">for</span> t <span class="kw">in</span> query_terms <span class="cf">if</span> pointers[t] <span class="op">&lt;</span> <span class="bu">len</span>(index[t])]</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> current_docs: <span class="cf">break</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>        current_docs.sort()</span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>        pivot_doc, pivot_term <span class="op">=</span> current_docs[<span class="dv">0</span>]</span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute upper bound for this doc</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>        ub <span class="op">=</span> <span class="bu">sum</span>(max_score[t] <span class="cf">for</span> t <span class="kw">in</span> query_terms)</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ub <span class="op">&lt;</span> threshold:</span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip ahead</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> pointers[t] <span class="op">&lt;</span> <span class="bu">len</span>(index[t]) <span class="kw">and</span> index[t][pointers[t]].doc_id <span class="op">&lt;=</span> pivot_doc:</span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>                    pointers[t] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute actual score</span></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>            postings <span class="op">=</span> index[t]</span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pointers[t] <span class="op">&lt;</span> <span class="bu">len</span>(postings) <span class="kw">and</span> postings[pointers[t]].doc_id <span class="op">==</span> pivot_doc:</span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>                score <span class="op">+=</span> postings[pointers[t]].score</span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>                pointers[t] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a>            heapq.heappush(heap, score)</span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(heap) <span class="op">&gt;</span> k:</span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>                heapq.heappop(heap)</span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a>                threshold <span class="op">=</span> <span class="bu">min</span>(heap)</span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> pointers[t] <span class="op">&lt;</span> <span class="bu">len</span>(index[t]) <span class="kw">and</span> index[t][pointers[t]].doc_id <span class="op">&lt;=</span> pivot_doc:</span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a>                    pointers[t] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(heap, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(wand([<span class="st">"deep"</span>, <span class="st">"learning"</span>, <span class="st">"vision"</span>], <span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-74" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-74">Why It Matters</h4>
<ul>
<li>Enables real-time ranked retrieval even for massive collections.</li>
<li>Used in Lucene, Elasticsearch, Vespa, and other production search engines.</li>
<li>Reduces computation by skipping low-potential documents.</li>
<li>Maintains exact correctness, same top-<span class="math inline">\(k\)</span> as exhaustive evaluation.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires per-term score upper bounds.</li>
<li>Slight implementation complexity.</li>
<li>Performs best when query has few high-weight terms.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-65" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-65">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S(d)\)</span> be the true score of document <span class="math inline">\(d\)</span>, and <span class="math inline">\(U(d)\)</span> be its computed upper bound. Let <span class="math inline">\(\theta\)</span> be the current top-<span class="math inline">\(k\)</span> threshold (the minimum score among top-<span class="math inline">\(k\)</span> results so far).</p>
<p>For any document <span class="math inline">\(d\)</span>: <span class="math display">\[
U(d) &lt; \theta \implies S(d) &lt; \theta
\]</span> Therefore, <span class="math inline">\(d\)</span> cannot enter the top-<span class="math inline">\(k\)</span>, so skipping it is safe. This invariant ensures exact top-<span class="math inline">\(k\)</span> correctness.</p>
<p>By monotonically tightening <span class="math inline">\(\theta\)</span>, WAND prunes an increasing number of documents efficiently.</p>
</section>
<section id="try-it-yourself-74" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-74">Try It Yourself</h4>
<ol type="1">
<li>Implement WAND on a small BM25 index.</li>
<li>Visualize how many documents are skipped as <span class="math inline">\(k\)</span> decreases.</li>
<li>Compare runtime with brute-force scoring.</li>
<li>Extend to Block-Max WAND (BMW), using block-level score bounds.</li>
<li>Add early termination when threshold stabilizes.</li>
</ol>
</section>
<section id="test-cases-74" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-74">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Query</th>
<th>k</th>
<th>Docs</th>
<th>Skipped</th>
<th>Matches</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep learning</td>
<td>2</td>
<td>10,000</td>
<td>80%</td>
<td>same as brute force</td>
</tr>
<tr class="even">
<td>data systems</td>
<td>5</td>
<td>5,000</td>
<td>60%</td>
<td>same</td>
</tr>
<tr class="odd">
<td>ai</td>
<td>10</td>
<td>1,000</td>
<td>minimal</td>
<td>same</td>
</tr>
<tr class="even">
<td>long query (10 terms)</td>
<td>3</td>
<td>50,000</td>
<td>90%</td>
<td>same</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-74" class="level4">
<h4 class="anchored" data-anchor-id="complexity-74">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 58%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Build index</td>
<td><span class="math inline">\(O\!\left(\sum_d d\right)\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="even">
<td>Query scoring</td>
<td><span class="math inline">\(O(k \log k + \text{\#evaluated docs})\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="odd">
<td>Pruning effect</td>
<td>60–95% fewer evaluations</td>
<td>negligible overhead</td>
</tr>
</tbody>
</table>
<p>The WAND algorithm is the art of knowing what <em>not</em> to compute. It’s the whisper of efficiency in large-scale search, scoring only the few that matter, and skipping the rest without missing a single answer.</p>
</section>
</section>
<section id="block-max-wand-bmw" class="level3">
<h3 class="anchored" data-anchor-id="block-max-wand-bmw">877 Block-Max WAND (BMW)</h3>
<p>Block-Max WAND (BMW) is an advanced refinement of the WAND algorithm that uses block-level score bounds to skip large chunks of posting lists at once. It’s one of the key optimizations behind high-performance search engines such as Lucene’s “BlockMax” scorer and Bing’s “Fat-WAND” system.</p>
<section id="what-problem-are-we-solving-75" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-75">What Problem Are We Solving?</h4>
<p>Even though WAND skips documents whose <em>upper bound</em> is too low, it still needs to visit every posting entry to check individual document IDs. That’s too slow when posting lists contain millions of entries.</p>
<p>BMW groups postings into fixed-size blocks (like 64 or 128 docIDs per block) and stores the maximum possible score per block. This allows the algorithm to skip entire blocks instead of individual docs when it knows none of them can reach the current threshold.</p>
</section>
<section id="how-does-it-work-plain-language-75" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-75">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Each term’s posting list is divided into blocks.</p></li>
<li><p>For each block, store:</p>
<ul>
<li>the maximum term score in that block, and</li>
<li>the max docID (the last document in that block).</li>
</ul></li>
<li><p>When evaluating a query:</p>
<ul>
<li>Use the block max scores to compute an upper bound for the <em>next possible block combination</em>.</li>
<li>If this upper bound is below the current threshold → skip entire blocks.</li>
<li>Otherwise, descend into the block and evaluate individual documents using standard scoring (like BM25).</li>
</ul></li>
</ol>
<p>This drastically reduces the number of document accesses while maintaining exact top-<span class="math inline">\(k\)</span> correctness.</p>
</section>
<section id="example-4" class="level4">
<h4 class="anchored" data-anchor-id="example-4">Example</h4>
<p>Suppose we have term “vision” with postings:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Block</th>
<th>DocIDs</th>
<th>Scores</th>
<th>Block Max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>[1, 3, 5, 7]</td>
<td>[0.4, 0.6, 0.5, 0.3]</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2</td>
<td>[10, 11, 13, 15]</td>
<td>[0.9, 0.8, 0.7, 0.5]</td>
<td>0.9</td>
</tr>
</tbody>
</table>
<p>If current threshold = 1.5 and other terms’ max blocks sum to 1.2, then Block 1 (0.6 + 1.2 &lt; 1.5) can be skipped entirely, and we jump directly to Block 2.</p>
</section>
<section id="tiny-code-python-example-14" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-14">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified postings: term -&gt; [(doc_id, score)], grouped into blocks</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> {</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep"</span>: [[(<span class="dv">1</span>, <span class="fl">0.3</span>), (<span class="dv">2</span>, <span class="fl">0.7</span>), (<span class="dv">3</span>, <span class="fl">0.4</span>)], [(<span class="dv">10</span>, <span class="fl">1.0</span>), (<span class="dv">11</span>, <span class="fl">0.8</span>)]],</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vision"</span>: [[(<span class="dv">2</span>, <span class="fl">0.4</span>), (<span class="dv">3</span>, <span class="fl">0.6</span>), (<span class="dv">4</span>, <span class="fl">0.5</span>)], [(<span class="dv">10</span>, <span class="fl">1.2</span>), (<span class="dv">11</span>, <span class="fl">1.1</span>)]]</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>block_max <span class="op">=</span> {</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep"</span>: [<span class="fl">0.7</span>, <span class="fl">1.0</span>],</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vision"</span>: [<span class="fl">0.6</span>, <span class="fl">1.2</span>]</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bm25_bmw(query_terms, k):</span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>    heap, threshold <span class="op">=</span> [], <span class="fl">0.0</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>    pointers <span class="op">=</span> {t: [<span class="dv">0</span>, <span class="dv">0</span>] <span class="cf">for</span> t <span class="kw">in</span> query_terms}  <span class="co"># [block_index, posting_index]</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>        current_docs <span class="op">=</span> []</span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>            b, p <span class="op">=</span> pointers[t]</span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> b <span class="op">&gt;=</span> <span class="bu">len</span>(index[t]): <span class="cf">continue</span></span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p <span class="op">&gt;=</span> <span class="bu">len</span>(index[t][b]):</span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>                pointers[t][<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>                pointers[t][<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>            current_docs.append((index[t][b][p][<span class="dv">0</span>], t))</span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> current_docs: <span class="cf">break</span></span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>        current_docs.sort()</span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>        doc, pivot_term <span class="op">=</span> current_docs[<span class="dv">0</span>]</span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute block-level upper bound</span></span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a>        ub <span class="op">=</span> <span class="bu">sum</span>(block_max[t][pointers[t][<span class="dv">0</span>]] <span class="cf">for</span> t <span class="kw">in</span> query_terms <span class="cf">if</span> pointers[t][<span class="dv">0</span>] <span class="op">&lt;</span> <span class="bu">len</span>(block_max[t]))</span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ub <span class="op">&lt;</span> threshold:</span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip entire blocks</span></span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>                b, _ <span class="op">=</span> pointers[t]</span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> b <span class="op">&lt;</span> <span class="bu">len</span>(index[t]) <span class="kw">and</span> block_max[t][b] <span class="op">+</span> ub <span class="op">&lt;</span> threshold:</span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>                    pointers[t][<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>                    pointers[t][<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a>                    b <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute actual score</span></span>
<span id="cb143-45"><a href="#cb143-45" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb143-46"><a href="#cb143-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb143-47"><a href="#cb143-47" aria-hidden="true" tabindex="-1"></a>            b, p <span class="op">=</span> pointers[t]</span>
<span id="cb143-48"><a href="#cb143-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> b <span class="op">&lt;</span> <span class="bu">len</span>(index[t]) <span class="kw">and</span> p <span class="op">&lt;</span> <span class="bu">len</span>(index[t][b]) <span class="kw">and</span> index[t][b][p][<span class="dv">0</span>] <span class="op">==</span> doc:</span>
<span id="cb143-49"><a href="#cb143-49" aria-hidden="true" tabindex="-1"></a>                score <span class="op">+=</span> index[t][b][p][<span class="dv">1</span>]</span>
<span id="cb143-50"><a href="#cb143-50" aria-hidden="true" tabindex="-1"></a>                pointers[t][<span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb143-51"><a href="#cb143-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb143-52"><a href="#cb143-52" aria-hidden="true" tabindex="-1"></a>            heapq.heappush(heap, score)</span>
<span id="cb143-53"><a href="#cb143-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(heap) <span class="op">&gt;</span> k:</span>
<span id="cb143-54"><a href="#cb143-54" aria-hidden="true" tabindex="-1"></a>                heapq.heappop(heap)</span>
<span id="cb143-55"><a href="#cb143-55" aria-hidden="true" tabindex="-1"></a>                threshold <span class="op">=</span> <span class="bu">min</span>(heap)</span>
<span id="cb143-56"><a href="#cb143-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb143-57"><a href="#cb143-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb143-58"><a href="#cb143-58" aria-hidden="true" tabindex="-1"></a>                b, p <span class="op">=</span> pointers[t]</span>
<span id="cb143-59"><a href="#cb143-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> b <span class="op">&lt;</span> <span class="bu">len</span>(index[t]) <span class="kw">and</span> p <span class="op">&lt;</span> <span class="bu">len</span>(index[t][b]) <span class="kw">and</span> index[t][b][p][<span class="dv">0</span>] <span class="op">&lt;=</span> doc:</span>
<span id="cb143-60"><a href="#cb143-60" aria-hidden="true" tabindex="-1"></a>                    pointers[t][<span class="dv">1</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb143-61"><a href="#cb143-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(heap, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb143-62"><a href="#cb143-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-63"><a href="#cb143-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bm25_bmw([<span class="st">"deep"</span>, <span class="st">"vision"</span>], <span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-75" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-75">Why It Matters</h4>
<ul>
<li>Block skipping reduces random memory access dramatically.</li>
<li>Enables near-real-time search in billion-document collections.</li>
<li>Integrates naturally with compressed posting lists.</li>
<li>Used in production systems like Lucene’s BlockMaxScore, Anserini, and Elasticsearch.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires storing per-block maxima (slightly more index size).</li>
<li>Performance depends on block size and term distribution.</li>
<li>More complex to implement correctly.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-66" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-66">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(B_t(i)\)</span> be the <span class="math inline">\(i\)</span>-th block for term <span class="math inline">\(t\)</span>, and let <span class="math inline">\(U_t(i)\)</span> be its maximum score. The upper bound for a combination of blocks is:</p>
<p><span class="math display">\[
U_B = \sum_{t \in Q} U_t(b_t)
\]</span></p>
<p>If <span class="math inline">\(U_B &lt; \theta\)</span> (the current top-<span class="math inline">\(k\)</span> threshold), then no document in those blocks can exceed <span class="math inline">\(\theta\)</span>, so it’s safe to skip them entirely.</p>
<p>Because <span class="math inline">\(U_t(i)\)</span> ≥ any document’s actual score within <span class="math inline">\(B_t(i)\)</span>, this bound preserves exactness while maximizing skipping efficiency.</p>
</section>
<section id="try-it-yourself-75" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-75">Try It Yourself</h4>
<ol type="1">
<li>Implement BMW on top of your WAND implementation.</li>
<li>Experiment with block sizes (e.g., 32, 64, 128), measure skipped docs.</li>
<li>Compare WAND vs BMW on a large dataset, count total doc evaluations.</li>
<li>Visualize score threshold growth over time.</li>
<li>Extend to “MaxScore” or “Exhaustive BMW” hybrid for early termination.</li>
</ol>
</section>
<section id="test-cases-75" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-75">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 25%">
<col style="width: 8%">
<col style="width: 15%">
<col style="width: 23%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th>Dataset</th>
<th>#Docs</th>
<th>Query</th>
<th>Algorithm</th>
<th>Evaluated Docs</th>
<th>Same Top-k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10k</td>
<td>“deep learning”</td>
<td>WAND</td>
<td>3,000</td>
<td>✅</td>
<td></td>
</tr>
<tr class="even">
<td>10k</td>
<td>“deep learning”</td>
<td>BMW</td>
<td>900</td>
<td>✅</td>
<td></td>
</tr>
<tr class="odd">
<td>1M</td>
<td>“neural vision”</td>
<td>WAND</td>
<td>70,000</td>
<td>✅</td>
<td></td>
</tr>
<tr class="even">
<td>1M</td>
<td>“neural vision”</td>
<td>BMW</td>
<td>12,000</td>
<td>✅</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-75" class="level4">
<h4 class="anchored" data-anchor-id="complexity-75">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 63%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Build index</td>
<td><span class="math inline">\(O\!\left(\sum_d d\right)\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="even">
<td>Query scoring</td>
<td><span class="math inline">\(O(k \log k + \text{\#visited blocks})\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="odd">
<td>Skip gain</td>
<td>3×–10× fewer postings visited</td>
<td>small overhead</td>
</tr>
</tbody>
</table>
<p>Block-Max WAND is efficiency at scale, where indexing meets geometry, and millions of postings melt into a few meaningful blocks.</p>
</section>
</section>
<section id="impact-ordered-indexing" class="level3">
<h3 class="anchored" data-anchor-id="impact-ordered-indexing">878 Impact-Ordered Indexing</h3>
<p>Impact-Ordered Indexing is a retrieval optimization that sorts postings by <em>impact score</em> (importance) instead of document ID. It allows the system to quickly find the most relevant documents first, without scanning all postings.</p>
<p>It’s a cornerstone of high-performance ranked retrieval, used in quantized BM25 systems, learning-to-rank engines, and neural hybrid search.</p>
<section id="what-problem-are-we-solving-76" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-76">What Problem Are We Solving?</h4>
<p>Traditional inverted indexes are sorted by docID, great for Boolean queries, but inefficient for ranked retrieval.</p>
<p>When ranking documents, we only need the top-<span class="math inline">\(k\)</span> highest-scoring results. Scanning every posting in docID order wastes time evaluating low-impact documents.</p>
<p>Impact ordering solves this by precomputing a <em>score estimate</em> for each posting and sorting postings by that score, so the engine can focus on the most promising ones first.</p>
</section>
<section id="how-does-it-work-plain-language-76" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-76">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Compute an impact score for each term–document pair, such as: <span class="math display">\[
I(t, d) = w_{t,d} = TF(t,d) \times IDF(t)
\]</span> (or its BM25 equivalent).</p></li>
<li><p>In the posting list for each term, store tuples <code>(impact, docID)</code> and sort them in descending order of impact.</p></li>
<li><p>During query evaluation:</p>
<ul>
<li>Iterate over each term’s postings in descending impact order.</li>
<li>Accumulate partial scores in a heap for top-<span class="math inline">\(k\)</span>.</li>
<li>Stop early when the sum of remaining maximum impacts can’t beat the current threshold.</li>
</ul></li>
</ol>
</section>
<section id="example-5" class="level4">
<h4 class="anchored" data-anchor-id="example-5">Example</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Postings (impact, docID)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep</td>
<td>(2.3, 9), (1.5, 3), (0.8, 10)</td>
</tr>
<tr class="even">
<td>learning</td>
<td>(2.8, 3), (1.9, 5), (0.7, 12)</td>
</tr>
<tr class="odd">
<td>vision</td>
<td>(3.1, 5), (2.5, 9), (1.2, 11)</td>
</tr>
</tbody>
</table>
<p>When evaluating query “deep learning vision”, the system processes the highest-impact postings first, e.g., (3.1,5), (2.8,3), (2.5,9), and can stop once the remaining possible contributions are below the top-<span class="math inline">\(k\)</span> threshold.</p>
</section>
<section id="tiny-code-python-example-15" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-15">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Example impact-ordered index</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> {</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep"</span>: [(<span class="fl">2.3</span>, <span class="dv">9</span>), (<span class="fl">1.5</span>, <span class="dv">3</span>), (<span class="fl">0.8</span>, <span class="dv">10</span>)],</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning"</span>: [(<span class="fl">2.8</span>, <span class="dv">3</span>), (<span class="fl">1.9</span>, <span class="dv">5</span>), (<span class="fl">0.7</span>, <span class="dv">12</span>)],</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vision"</span>: [(<span class="fl">3.1</span>, <span class="dv">5</span>), (<span class="fl">2.5</span>, <span class="dv">9</span>), (<span class="fl">1.2</span>, <span class="dv">11</span>)]</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impact_ordered_search(query_terms, k):</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    heap <span class="op">=</span> []  <span class="co"># top-k</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> {}</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>    pointers <span class="op">=</span> {t: <span class="dv">0</span> <span class="cf">for</span> t <span class="kw">in</span> query_terms}</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select next best impact posting</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>        next_term, best_doc, best_impact <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> query_terms:</span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> pointers[t]</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p <span class="op">&lt;</span> <span class="bu">len</span>(index[t]):</span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>                impact, doc <span class="op">=</span> index[t][p]</span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> impact <span class="op">&gt;</span> best_impact:</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>                    best_impact <span class="op">=</span> impact</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>                    best_doc <span class="op">=</span> doc</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>                    next_term <span class="op">=</span> t</span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> next_term:</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Accumulate score</span></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>        scores[best_doc] <span class="op">=</span> scores.get(best_doc, <span class="dv">0</span>) <span class="op">+</span> best_impact</span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>        pointers[next_term] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If new doc enters top-k</span></span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>        heapq.heappush(heap, scores[best_doc])</span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(heap) <span class="op">&gt;</span> k:</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>            heapq.heappop(heap)</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>            threshold <span class="op">=</span> <span class="bu">min</span>(heap)</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Early stop condition</span></span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>        remaining_max <span class="op">=</span> <span class="bu">sum</span>(index[t][p][<span class="dv">0</span>] <span class="cf">for</span> t, p <span class="kw">in</span> pointers.items() <span class="cf">if</span> p <span class="op">&lt;</span> <span class="bu">len</span>(index[t]))</span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> remaining_max <span class="op">&lt;</span> threshold:</span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(scores.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:k]</span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(impact_ordered_search([<span class="st">"deep"</span>, <span class="st">"learning"</span>, <span class="st">"vision"</span>], <span class="dv">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Output:</p>
<pre><code>[(5, 5.0), (9, 4.8), (3, 4.3)]</code></pre>
</section>
<section id="why-it-matters-76" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-76">Why It Matters</h4>
<ul>
<li>Processes high-value documents first.</li>
<li>Enables early termination once remaining potential can’t change the top-<span class="math inline">\(k\)</span>.</li>
<li>Works beautifully with compressed indexes and quantized BM25 (where scores are pre-bucketed).</li>
<li>Foundation for MaxScore, BMW, and learning-to-rank re-rankers.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Loses efficient Boolean filtering (no docID order).</li>
<li>Requires precomputing impacts (quantization step).</li>
<li>Memory overhead for storing and sorting postings by impact.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-67" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-67">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(I(t,d)\)</span> be the precomputed impact for term <span class="math inline">\(t\)</span> in document <span class="math inline">\(d\)</span>. Let <span class="math inline">\(U_t\)</span> be the maximum remaining impact for term <span class="math inline">\(t\)</span> not yet processed.</p>
<p>At any point, if: <span class="math display">\[
\sum_{t \in Q} U_t &lt; \theta
\]</span> (where <span class="math inline">\(\theta\)</span> is the current top-<span class="math inline">\(k\)</span> threshold), then no unseen document can exceed the current lowest top-<span class="math inline">\(k\)</span> score, so evaluation can stop safely without missing any top document.</p>
<p>This guarantees correctness under monotonic scoring functions (like BM25 or TF–IDF).</p>
</section>
<section id="try-it-yourself-76" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-76">Try It Yourself</h4>
<ol type="1">
<li>Build a small index of 10–20 documents with TF–IDF weights.</li>
<li>Sort postings by descending impact and run queries using early termination.</li>
<li>Compare runtime vs docID-ordered BM25 scoring.</li>
<li>Experiment with quantized (integer bucketed) impacts for compression.</li>
<li>Combine with WAND or BMW for hybrid skipping.</li>
</ol>
</section>
<section id="test-cases-76" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-76">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 35%">
<col style="width: 16%">
<col style="width: 14%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Query</th>
<th>Algorithm</th>
<th>Docs Scanned</th>
<th>Same Top-k</th>
<th>Speedup</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep learning</td>
<td>DocID order</td>
<td>1000</td>
<td>Yes</td>
<td>1×</td>
</tr>
<tr class="even">
<td>deep learning</td>
<td>Impact order</td>
<td>150</td>
<td>Yes</td>
<td>~6× faster</td>
</tr>
<tr class="odd">
<td>neural vision</td>
<td>Impact order + early stop</td>
<td>80</td>
<td>Yes</td>
<td>~10× faster</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-76" class="level4">
<h4 class="anchored" data-anchor-id="complexity-76">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 56%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Index build</td>
<td><span class="math inline">\(O\!\left(\sum_d d \log d\right)\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="even">
<td>Query scoring</td>
<td><span class="math inline">\(O(k + \text{\#high-impact postings})\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="odd">
<td>Early stop</td>
<td>80–95% postings skipped</td>
<td>minor metadata overhead</td>
</tr>
</tbody>
</table>
<p>Impact-Ordered Indexing is like sorting by importance before even starting the race, you reach the winners first, and stop running once you already know who they are.</p>
</section>
</section>
<section id="tiered-indexing" class="level3">
<h3 class="anchored" data-anchor-id="tiered-indexing">879 Tiered Indexing</h3>
<p>Tiered Indexing is a multi-layered organization of search indexes that prioritizes <em>high-quality</em> or <em>high-scoring</em> documents for early access. Instead of scanning all postings equally, it structures data into tiers so that the most promising documents are searched first, enabling faster top-<span class="math inline">\(k\)</span> retrieval.</p>
<p>This approach is fundamental in web search engines, large-scale retrieval systems, and vector + keyword hybrid engines, where response time is critical and partial results must arrive quickly.</p>
<section id="what-problem-are-we-solving-77" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-77">What Problem Are We Solving?</h4>
<p>Modern search engines index billions of documents. Scanning everything for each query is impossible within latency constraints.</p>
<p>We need a way to search progressively, starting from the most valuable (high-priority) subset, and expanding only if needed.</p>
<p>Tiered indexing does exactly that by partitioning the index into tiers based on document quality, rank potential, or access frequency.</p>
</section>
<section id="how-does-it-work-plain-language-77" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-77">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>During indexing, documents are ranked or scored by a quality metric (e.g., PageRank, authority, click-through rate, popularity).</p></li>
<li><p>The index is split into tiers:</p>
<ul>
<li>Tier 0 → high-quality, high-impact documents.</li>
<li>Tier 1, Tier 2, … → progressively lower priority.</li>
</ul></li>
<li><p>At query time:</p>
<ul>
<li>Start searching from Tier 0 using normal ranked retrieval.</li>
<li>If the top-<span class="math inline">\(k\)</span> results are not yet stable (score gap small), move to Tier 1, and so on.</li>
<li>Stop once the top-<span class="math inline">\(k\)</span> results are confident (remaining tiers cannot improve them).</li>
</ul></li>
</ol>
<p>This results in fast approximate answers that are often exact for most queries.</p>
</section>
<section id="example-6" class="level4">
<h4 class="anchored" data-anchor-id="example-6">Example</h4>
<p>Suppose you have 1 million documents ranked by quality. Divide them into tiers of 100k documents each.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Tier</th>
<th>Quality</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>top 10%</td>
<td>Wikipedia, official pages</td>
</tr>
<tr class="even">
<td>1</td>
<td>next 30%</td>
<td>trusted blogs, academic pages</td>
</tr>
<tr class="odd">
<td>2</td>
<td>next 60%</td>
<td>general web documents</td>
</tr>
</tbody>
</table>
<p>When processing a query “deep learning”, Tier 0 might already contain most of the top-ranked results. The system can skip Tier 1–2 unless needed for recall.</p>
</section>
<section id="tiny-code-python-example-16" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-16">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tiered_search(query_terms, tiers, k):</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tier_id, tier_index <span class="kw">in</span> <span class="bu">enumerate</span>(tiers):</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>        tier_results <span class="op">=</span> retrieve_from_index(query_terms, tier_index)</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>        results.extend(tier_results)</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>        results.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)  <span class="co"># sort by score</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results) <span class="op">&gt;</span> k:</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> results[:k]</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>            threshold <span class="op">=</span> results[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute upper bound of remaining tiers</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tier_id <span class="op">&lt;</span> <span class="bu">len</span>(tiers) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>            remaining_max <span class="op">=</span> <span class="bu">max</span>(tier_index.get_max_possible_score(query_terms))</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> remaining_max <span class="op">&lt;</span> threshold:</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span>  <span class="co"># stop early</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results[:k]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Here <code>retrieve_from_index</code> is any retrieval method (BM25, impact-ordered, WAND, etc.) applied within that tier. Each tier is a self-contained inverted index.</p>
</section>
<section id="why-it-matters-77" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-77">Why It Matters</h4>
<ul>
<li>Faster response: often the top results come from Tier 0 or Tier 1.</li>
<li>Better caching: higher tiers fit in memory or SSD; lower tiers can stay on disk.</li>
<li>Incremental refresh: new or high-traffic documents can be inserted into higher tiers dynamically.</li>
<li>Scalable hybrid search: vector indexes can mirror the same structure for approximate-nearest-neighbor retrieval.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires maintaining multiple indexes.</li>
<li>Risk of missing relevant but low-tier documents if thresholds are too strict.</li>
<li>Merging results across tiers adds coordination overhead.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-68" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-68">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S_i(d)\)</span> denote the score of document <span class="math inline">\(d\)</span> in tier <span class="math inline">\(i\)</span>, and let <span class="math inline">\(U_i\)</span> be the maximum possible score of any document in that tier.</p>
<p>If <span class="math inline">\(\theta\)</span> is the current top-<span class="math inline">\(k\)</span> threshold after searching tiers <span class="math inline">\(0 \dots i\)</span>, and if: <span class="math display">\[
\max_{j&gt;i} U_j &lt; \theta
\]</span> then no unseen document in lower tiers can enter the top-<span class="math inline">\(k\)</span>. This guarantees correctness under monotonic scoring.</p>
<p>Because high-quality documents concentrate in earlier tiers, this condition is reached early for most queries.</p>
</section>
<section id="try-it-yourself-77" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-77">Try It Yourself</h4>
<ol type="1">
<li>Split your dataset by document authority or click rate into 3 tiers.</li>
<li>Index each tier separately with BM25.</li>
<li>Run queries in order: Tier 0 → Tier 1 → Tier 2.</li>
<li>Measure how often Tier 0 already yields full top-<span class="math inline">\(k\)</span>.</li>
<li>Combine with WAND or Impact-Ordered Indexing for deeper efficiency.</li>
<li>Optionally, use ANN vector tiers (for embeddings) alongside keyword tiers.</li>
</ol>
</section>
<section id="test-cases-77" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-77">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 8%">
<col style="width: 21%">
<col style="width: 6%">
<col style="width: 35%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Dataset</th>
<th>Query</th>
<th>Tiers</th>
<th>% Queries Resolved in Tier 0</th>
<th>Accuracy vs Full Search</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Web 1M</td>
<td>“AI”</td>
<td>3</td>
<td>94%</td>
<td>99.8%</td>
</tr>
<tr class="even">
<td>Web 10M</td>
<td>“data systems”</td>
<td>3</td>
<td>90%</td>
<td>99.5%</td>
</tr>
<tr class="odd">
<td>News 1M</td>
<td>“latest election”</td>
<td>2</td>
<td>88%</td>
<td>99.9%</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-77" class="level4">
<h4 class="anchored" data-anchor-id="complexity-77">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 42%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Index build</td>
<td><span class="math inline">\(O(N)\)</span> per tier</td>
<td><span class="math inline">\(O(N)\)</span></td>
</tr>
<tr class="even">
<td>Query evaluation</td>
<td><span class="math inline">\(O(k + \text{\#tiers visited})\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
<tr class="odd">
<td>Early termination</td>
<td>often 1–2 tiers</td>
<td>minor metadata overhead</td>
</tr>
</tbody>
</table>
<p>Tiered Indexing is how large-scale systems stay responsive, searching the summit first, and descending deeper only when they must.</p>
</section>
</section>
<section id="daat-vs-saat-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="daat-vs-saat-evaluation">880 DAAT vs SAAT Evaluation</h3>
<p>DAAT (Document-at-a-Time) and SAAT (Score-at-a-Time) are two contrasting strategies for evaluating ranked retrieval queries. They define <em>how posting lists are traversed and combined</em> when computing document scores, a core decision in every search engine’s architecture.</p>
<p>Both reach the same results, but they make different tradeoffs between CPU efficiency, memory access, and early termination ability.</p>
<section id="what-problem-are-we-solving-78" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-78">What Problem Are We Solving?</h4>
<p>When multiple query terms appear in different posting lists, the engine must decide in what order to access them and how to merge their scores efficiently.</p>
<ul>
<li>Should we gather all contributions for one document before moving on to the next? (DAAT)</li>
<li>Or should we process one posting at a time from all terms, gradually refining scores? (SAAT)</li>
</ul>
<p>This distinction affects query latency, caching, parallelism, and even how compression and skipping work.</p>
</section>
<section id="how-it-works" class="level4">
<h4 class="anchored" data-anchor-id="how-it-works">How It Works</h4>
<ol type="1">
<li>DAAT (Document-at-a-Time)</li>
</ol>
<ul>
<li>Merge posting lists by document ID order.</li>
<li>For each document that appears in any posting list, compute its total score from all matching terms.</li>
<li>Once a document’s full score is known, it’s inserted into the top-<span class="math inline">\(k\)</span> heap.</li>
</ul>
<p>This is the approach used in WAND, BMW, and Lucene.</p>
<ol start="2" type="1">
<li>SAAT (Score-at-a-Time)</li>
</ol>
<ul>
<li>Process one posting (term–doc pair) at a time, sorted by impact or score.</li>
<li>Incrementally update partial document scores as high-impact postings arrive.</li>
<li>Stop when it’s provably impossible for any unseen posting to affect the top-<span class="math inline">\(k\)</span>.</li>
</ul>
<p>This is the model used in Impact-Ordered Indexing, MaxScore, and Quantized BM25 systems.</p>
</section>
<section id="example-7" class="level4">
<h4 class="anchored" data-anchor-id="example-7">Example</h4>
<p>Suppose we have query terms “deep” and “learning”.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Term</th>
<th>Postings (docID, score)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>deep</td>
<td>(1, 0.6), (2, 0.9), (4, 0.5)</td>
</tr>
<tr class="even">
<td>learning</td>
<td>(2, 0.8), (3, 0.7), (4, 0.6)</td>
</tr>
</tbody>
</table>
<p>DAAT traversal:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>docID</th>
<th>deep</th>
<th>learning</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>0.6</td>
<td>0</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2</td>
<td>2</td>
<td>0.9</td>
<td>0.8</td>
<td>1.7</td>
</tr>
<tr class="odd">
<td>3</td>
<td>3</td>
<td>0</td>
<td>0.7</td>
<td>0.7</td>
</tr>
<tr class="even">
<td>4</td>
<td>4</td>
<td>0.5</td>
<td>0.6</td>
<td>1.1</td>
</tr>
</tbody>
</table>
<p>SAAT traversal (sorted by score): Process postings by descending term–doc score: (2,0.9), (2,0.8), (4,0.6), (1,0.6), (3,0.7), (4,0.5)…</p>
<p>As partial scores accumulate, we can stop once remaining postings can’t affect the top-<span class="math inline">\(k\)</span>.</p>
</section>
<section id="tiny-code-python-example-17" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-17">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> daat(query_lists, k):</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge all docIDs in sorted order</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    all_docs <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>().union(<span class="op">*</span>[<span class="bu">dict</span>(pl).keys() <span class="cf">for</span> pl <span class="kw">in</span> query_lists]))</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> {}</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> doc <span class="kw">in</span> all_docs:</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">dict</span>(pl).get(doc, <span class="dv">0</span>) <span class="cf">for</span> pl <span class="kw">in</span> query_lists)</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>        scores[doc] <span class="op">=</span> total</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(scores.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:k]</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> saat(query_lists, k):</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process postings by descending score</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>    postings <span class="op">=</span> [(score, doc) <span class="cf">for</span> pl <span class="kw">in</span> query_lists <span class="cf">for</span> doc, score <span class="kw">in</span> pl]</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>    postings.sort(reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>    scores, heap, threshold <span class="op">=</span> {}, [], <span class="fl">0.0</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> score, doc <span class="kw">in</span> postings:</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>        scores[doc] <span class="op">=</span> scores.get(doc, <span class="dv">0</span>) <span class="op">+</span> score</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>        heapq.heappush(heap, (scores[doc], doc))</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(heap) <span class="op">&gt;</span> k:</span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>            heapq.heappop(heap)</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>            threshold <span class="op">=</span> heap[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>        remaining_max <span class="op">=</span> score  <span class="co"># Simplified upper bound</span></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> remaining_max <span class="op">&lt;</span> threshold:</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(scores.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:k]</span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>deep <span class="op">=</span> [(<span class="dv">1</span>, <span class="fl">0.6</span>), (<span class="dv">2</span>, <span class="fl">0.9</span>), (<span class="dv">4</span>, <span class="fl">0.5</span>)]</span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>learning <span class="op">=</span> [(<span class="dv">2</span>, <span class="fl">0.8</span>), (<span class="dv">3</span>, <span class="fl">0.7</span>), (<span class="dv">4</span>, <span class="fl">0.6</span>)]</span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DAAT:"</span>, daat([deep, learning], <span class="dv">2</span>))</span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SAAT:"</span>, saat([deep, learning], <span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-78" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-78">Why It Matters</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 26%">
<col style="width: 43%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>DAAT</th>
<th>SAAT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Traversal</td>
<td>docID order</td>
<td>score order</td>
</tr>
<tr class="even">
<td>Early termination</td>
<td>via WAND/BMW</td>
<td>via MaxScore</td>
</tr>
<tr class="odd">
<td>Skipping ability</td>
<td>strong (sorted docIDs)</td>
<td>weaker</td>
</tr>
<tr class="even">
<td>Cache locality</td>
<td>good</td>
<td>random</td>
</tr>
<tr class="odd">
<td>Parallelism</td>
<td>limited</td>
<td>high (posting-level)</td>
</tr>
<tr class="even">
<td>Compression friendliness</td>
<td>high</td>
<td>lower</td>
</tr>
<tr class="odd">
<td>Typical usage</td>
<td>Lucene, Elasticsearch</td>
<td>Terrier, Anserini, learned retrieval</td>
</tr>
</tbody>
</table>
<p>Both reach the same final ranking, but DAAT is better for CPU cache efficiency, while SAAT shines in GPU or vectorized environments.</p>
</section>
<section id="a-gentle-proof-why-both-are-correct" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-both-are-correct">A Gentle Proof (Why Both Are Correct)</h4>
<p>Let <span class="math inline">\(S(d)\)</span> be the total score of document <span class="math inline">\(d\)</span> for query <span class="math inline">\(Q\)</span>. Each algorithm computes:</p>
<p><span class="math display">\[
S(d) = \sum_{t \in Q} w_{t,d}
\]</span></p>
<p>Both DAAT and SAAT fully enumerate all <span class="math inline">\((t, d)\)</span> pairs, only in different orders. Because addition is commutative and associative, the final score set <span class="math inline">\({S(d)}\)</span> is identical.</p>
<p>Early termination preserves correctness under monotonic scoring when upper bounds are respected: <span class="math display">\[
\sum_{t \in Q} U_t &lt; \theta \implies \text{safe to stop}
\]</span></p>
<p>Thus, both are semantically equivalent, differing only in traversal order.</p>
</section>
<section id="try-it-yourself-78" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-78">Try It Yourself</h4>
<ol type="1">
<li>Implement DAAT and SAAT for TF–IDF on the same index.</li>
<li>Measure time per query and number of postings visited.</li>
<li>Add early stopping thresholds to both.</li>
<li>Try hybrid evaluation: DAAT for short queries, SAAT for long ones.</li>
<li>Visualize score accumulation curves to see how early termination differs.</li>
</ol>
</section>
<section id="test-cases-78" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-78">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Query</th>
<th>Algorithm</th>
<th>Docs Scanned</th>
<th>Same Top-k</th>
<th>Speedup</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>“deep learning”</td>
<td>DAAT</td>
<td>1,200</td>
<td>Yes</td>
<td>1×</td>
</tr>
<tr class="even">
<td>“deep learning”</td>
<td>SAAT</td>
<td>250</td>
<td>Yes</td>
<td>~5×</td>
</tr>
<tr class="odd">
<td>“neural vision”</td>
<td>DAAT</td>
<td>3,000</td>
<td>Yes</td>
<td>1×</td>
</tr>
<tr class="even">
<td>“neural vision”</td>
<td>SAAT</td>
<td>800</td>
<td>Yes</td>
<td>~4×</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-78" class="level4">
<h4 class="anchored" data-anchor-id="complexity-78">Complexity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 37%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>Stage</th>
<th>DAAT</th>
<th>SAAT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Merge cost</td>
<td><span class="math inline">\(O\!\left(\sum P_t\right)\)</span></td>
<td><span class="math inline">\(O\!\left(\sum P_t \log P_t\right)\)</span></td>
</tr>
<tr class="even">
<td>Early stop</td>
<td>via bound check</td>
<td>via score bound</td>
</tr>
<tr class="odd">
<td>Space</td>
<td><span class="math inline">\(O(V)\)</span></td>
<td><span class="math inline">\(O(V)\)</span></td>
</tr>
</tbody>
</table>
<p>DAAT vs SAAT captures the philosophy of retrieval engineering, DAAT merges by <em>documents</em>, SAAT by <em>importance</em>, both converging to the same truth from different directions.</p>
</section>
</section>
</section>
<section id="section-89.-compression-and-encoding-in-system" class="level1">
<h1>Section 89. Compression and Encoding in System</h1>
<section id="run-length-encoding-rle" class="level3">
<h3 class="anchored" data-anchor-id="run-length-encoding-rle">881 Run-Length Encoding (RLE)</h3>
<p>Run-Length Encoding (RLE) is a simple lossless compression method that replaces consecutive repetitions of the same symbol with a single symbol and a count. It is extremely effective on data with long runs, such as binary images, simple graphics, and sensor streams with repeated values.</p>
<section id="what-problem-are-we-solving-79" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-79">What Problem Are We Solving?</h4>
<p>Uncompressed data often contains repeated symbols:</p>
<ul>
<li>Images with long horizontal runs of the same pixel value</li>
<li>Logs or telemetry with repeated flags</li>
<li>Bitmaps and masks with large zero regions</li>
</ul>
<p>RLE encodes these runs compactly, reducing storage and transmission cost when repetitions dominate.</p>
</section>
<section id="how-does-it-work-plain-language-78" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-78">How Does It Work (Plain Language)</h4>
<p>Scan the sequence from left to right and group identical adjacent symbols into runs. Each run of symbol <span class="math inline">\(x\)</span> with length <span class="math inline">\(k\)</span> is written as a pair <span class="math inline">\((x, k)\)</span>.</p>
<p>Example:</p>
<ul>
<li>Input: <code>AAAABBCCDAA</code></li>
<li>Runs: <code>A×4, B×2, C×2, D×1, A×2</code></li>
<li>RLE: <code>(A,4)(B,2)(C,2)(D,1)(A,2)</code></li>
</ul>
<p>Two common layouts:</p>
<ol type="1">
<li>Symbol–count pairs: store both symbol and length.</li>
<li>Count–symbol pairs: store length first for byte-aligned formats.</li>
</ol>
<p>To decode, expand each pair by repeating the symbol <span class="math inline">\(k\)</span> times.</p>
</section>
<section id="tiny-code-python-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-1">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rle_encode(data: <span class="bu">str</span>):</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> data:</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> []</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    curr, count <span class="op">=</span> data[<span class="dv">0</span>], <span class="dv">1</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ch <span class="kw">in</span> data[<span class="dv">1</span>:]:</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ch <span class="op">==</span> curr <span class="kw">and</span> count <span class="op">&lt;</span> <span class="dv">255</span>:  <span class="co"># cap to one byte for demo</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>            count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>            out.append((curr, count))</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>            curr, count <span class="op">=</span> ch, <span class="dv">1</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    out.append((curr, count))</span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rle_decode(pairs):</span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(ch <span class="op">*</span> cnt <span class="cf">for</span> ch, cnt <span class="kw">in</span> pairs)</span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="st">"AAAABBCCDAA"</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> rle_encode(s)</span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pairs)            <span class="co"># [('A', 4), ('B', 2), ('C', 2), ('D', 1), ('A', 2)]</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rle_decode(pairs))  <span class="co"># AAAABBCCDAA</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-9" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-9">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb149"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> rle_encode<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> strlen<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">)</span> <span class="op">{</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> c <span class="op">=</span> s<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>j <span class="op">&lt;</span> n <span class="op">&amp;&amp;</span> s<span class="op">[</span>j<span class="op">]</span> <span class="op">==</span> c <span class="op">&amp;&amp;</span> j <span class="op">-</span> i <span class="op">&lt;</span> <span class="dv">255</span><span class="op">)</span> j<span class="op">++;</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"(</span><span class="sc">%c</span><span class="st">,</span><span class="sc">%d</span><span class="st">)"</span><span class="op">,</span> c<span class="op">,</span> j <span class="op">-</span> i<span class="op">);</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> j<span class="op">;</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>s <span class="op">=</span> <span class="st">"AAAABBCCDAA"</span><span class="op">;</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>    rle_encode<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-79" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-79">Why It Matters</h4>
<ul>
<li><p>Simplicity: tiny encoder and decoder, easy to implement in constrained systems</p></li>
<li><p>Speed: linear time, minimal CPU and memory</p></li>
<li><p>Interoperability: serves as a building block inside larger formats</p>
<ul>
<li>Fax Group 3/4 bitmaps</li>
<li>TIFF PackBits</li>
<li>Some sprite and tile map formats</li>
<li>Hardware framebuffers and FPGA streams</li>
</ul></li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Poor compression on high-entropy or highly alternating data</li>
<li>Worst case can expand size (e.g., <code>ABABAB...</code>)</li>
<li>Needs run caps and escape rules to handle edge cases</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-69" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-69">A Gentle Proof (Why It Works)</h4>
<p>Let the input be a sequence <span class="math inline">\(S = s_1 s_2 \dots s_n\)</span>. Partition <span class="math inline">\(S\)</span> into maximal runs <span class="math inline">\(R_1, R_2, \dots, R_m\)</span> where each run <span class="math inline">\(R_i\)</span> consists of a symbol <span class="math inline">\(x_i\)</span> repeated <span class="math inline">\(k_i\)</span> times and <span class="math inline">\(k_i \ge 1\)</span>. These runs are unique because each boundary occurs exactly where <span class="math inline">\(s_j \ne s_{j+1}\)</span>.</p>
<p>Encoding maps <span class="math inline">\(S\)</span> to the sequence of pairs: <span class="math display">\[
E(S) = \big((x_1, k_1), (x_2, k_2), \dots, (x_m, k_m)\big)
\]</span></p>
<p>Decoding is the inverse map: <span class="math display">\[
D(E(S)) = \underbrace{x_1 \dots x_1}*{k_1} \underbrace{x_2 \dots x_2}*{k_2} \dots \underbrace{x_m \dots x_m}_{k_m} = S
\]</span></p>
<p>Thus <span class="math inline">\(D \circ E\)</span> is the identity on the set of sequences, which proves lossless correctness.</p>
<p>Compression ratio depends on the number and lengths of runs. If average run length is <span class="math inline">\(\bar{k}\)</span> and the per-pair overhead is constant, then the compressed length scales as <span class="math inline">\(O(n / \bar{k})\)</span>.</p>
</section>
<section id="try-it-yourself-79" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-79">Try It Yourself</h4>
<ol type="1">
<li>Encode horizontal scanlines of a black and white image and compare size to raw.</li>
<li>Add a one-byte cap for counts and introduce an escape sequence to represent literal segments that are not compressible.</li>
<li>Measure worst-case expansion on random data.</li>
<li>Combine with delta encoding of pixel differences before RLE.</li>
<li>Compare RLE after sorting runs vs before on simple structured data.</li>
</ol>
</section>
<section id="test-cases-79" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-79">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 50%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Input</th>
<th>Encoded Pairs</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>AAAAA</code></td>
<td><code>(A,5)</code></td>
<td>single long run</td>
</tr>
<tr class="even">
<td><code>ABABAB</code></td>
<td><code>(A,1)(B,1)(A,1)(B,1)(A,1)(B,1)</code></td>
<td>expansion risk</td>
</tr>
<tr class="odd">
<td><code>0000011100</code></td>
<td><code>(0,5)(1,3)(0,2)</code></td>
<td>typical binary mask</td>
</tr>
<tr class="even">
<td>`<code>(empty)   |</code>[]<code>| edge case           | |</code>A<code>|</code>(A,1)`</td>
<td>minimal</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="variants-and-extensions" class="level4">
<h4 class="anchored" data-anchor-id="variants-and-extensions">Variants and Extensions</h4>
<ul>
<li>Run-length of bits: pack runs of 0s and 1s for bitmaps</li>
<li>PackBits: count byte with sign for literal vs run segments</li>
<li>RLE + entropy coding: RLE first, then Huffman on counts and symbols</li>
<li>RLE on deltas: compress repeated differences rather than raw values</li>
</ul>
</section>
<section id="complexity-79" class="level4">
<h4 class="anchored" data-anchor-id="complexity-79">Complexity</h4>
<ul>
<li>Time: <span class="math inline">\(O(n)\)</span> encode and decode</li>
<li>Space: <span class="math inline">\(O(1)\)</span> streaming, aside from output buffer</li>
<li>Compression: best when average run length <span class="math inline">\(\bar{k} \gg 1\)</span></li>
<li>Worst case size: can exceed input by a constant factor due to pair overhead</li>
</ul>
<p>When to use RLE: data with long homogeneous stretches, predictable symbols, or structured masks. When to avoid: noisy text, shuffled bytes, or randomized streams where runs are short.</p>
</section>
</section>
<section id="huffman-coding" class="level3">
<h3 class="anchored" data-anchor-id="huffman-coding">882 Huffman Coding</h3>
<p>Huffman Coding is a cornerstone of lossless data compression. It assigns shorter bit patterns to frequent symbols and longer bit patterns to rare symbols, achieving near-optimal compression when symbol frequencies are known. It’s the beating heart of ZIP, PNG, JPEG, and countless codecs.</p>
<section id="what-problem-are-we-solving-80" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-80">What Problem Are We Solving?</h4>
<p>Fixed-length encoding (like ASCII) wastes bits. If ‘E’ occurs 13% of the time and ‘Z’ only 0.1%, it makes no sense to use the same 8 bits for both.</p>
<p>We want to minimize total bit length while keeping the encoding uniquely decodable.</p>
</section>
<section id="how-does-it-work-plain-language-79" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-79">How Does It Work (Plain Language)</h4>
<p>Huffman coding builds a binary tree of symbols weighted by frequency:</p>
<ol type="1">
<li>Count frequencies for all symbols.</li>
<li>Put each symbol into a priority queue (min-heap) keyed by frequency.</li>
<li>Repeatedly remove the two least frequent nodes and merge them into a new parent node.</li>
<li>Continue until only one node remains, the root of the tree.</li>
<li>Assign <code>0</code> for one branch and <code>1</code> for the other. Each symbol’s bit code is its path from root to leaf.</li>
</ol>
<p>Frequent symbols end up closer to the root → shorter codes.</p>
</section>
<section id="example-8" class="level4">
<h4 class="anchored" data-anchor-id="example-8">Example</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Symbol</th>
<th>Frequency</th>
<th>Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>5</td>
<td>10</td>
</tr>
<tr class="even">
<td>B</td>
<td>2</td>
<td>110</td>
</tr>
<tr class="odd">
<td>C</td>
<td>1</td>
<td>111</td>
</tr>
<tr class="even">
<td>D</td>
<td>1</td>
<td>00</td>
</tr>
<tr class="odd">
<td>E</td>
<td>1</td>
<td>01</td>
</tr>
</tbody>
</table>
<p>Average bits per symbol ≈ weighted by frequency, much less than fixed 3-bit or 8-bit encodings.</p>
</section>
<section id="tiny-code-python-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-2">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> heapq</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> huffman_code(freqs):</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    heap <span class="op">=</span> [[w, [sym, <span class="st">""</span>]] <span class="cf">for</span> sym, w <span class="kw">in</span> freqs.items()]</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    heapq.heapify(heap)</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(heap) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>        lo <span class="op">=</span> heapq.heappop(heap)</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>        hi <span class="op">=</span> heapq.heappop(heap)</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pair <span class="kw">in</span> lo[<span class="dv">1</span>:]:</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>            pair[<span class="dv">1</span>] <span class="op">=</span> <span class="st">"0"</span> <span class="op">+</span> pair[<span class="dv">1</span>]</span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pair <span class="kw">in</span> hi[<span class="dv">1</span>:]:</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>            pair[<span class="dv">1</span>] <span class="op">=</span> <span class="st">"1"</span> <span class="op">+</span> pair[<span class="dv">1</span>]</span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>        heapq.heappush(heap, [lo[<span class="dv">0</span>] <span class="op">+</span> hi[<span class="dv">0</span>]] <span class="op">+</span> lo[<span class="dv">1</span>:] <span class="op">+</span> hi[<span class="dv">1</span>:])</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(heapq.heappop(heap)[<span class="dv">1</span>:], key<span class="op">=</span><span class="kw">lambda</span> p: (<span class="bu">len</span>(p[<span class="op">-</span><span class="dv">1</span>]), p))</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>freqs <span class="op">=</span> {<span class="st">"A"</span>: <span class="dv">5</span>, <span class="st">"B"</span>: <span class="dv">2</span>, <span class="st">"C"</span>: <span class="dv">1</span>, <span class="st">"D"</span>: <span class="dv">1</span>, <span class="st">"E"</span>: <span class="dv">1</span>}</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sym, code <span class="kw">in</span> huffman_code(freqs):</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(sym, code)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-10" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-10">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb151"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Node <span class="op">{</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> c<span class="op">;</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> f<span class="op">;</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Node <span class="op">*</span>left<span class="op">,</span> <span class="op">*</span>right<span class="op">;</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Node<span class="op">;</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>Node<span class="op">*</span> newNode<span class="op">(</span><span class="dt">char</span> c<span class="op">,</span> <span class="dt">int</span> f<span class="op">,</span> Node<span class="op">*</span> l<span class="op">,</span> Node<span class="op">*</span> r<span class="op">)</span> <span class="op">{</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    Node<span class="op">*</span> n <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Node<span class="op">));</span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    n<span class="op">-&gt;</span>c <span class="op">=</span> c<span class="op">;</span> n<span class="op">-&gt;</span>f <span class="op">=</span> f<span class="op">;</span> n<span class="op">-&gt;</span>left <span class="op">=</span> l<span class="op">;</span> n<span class="op">-&gt;</span>right <span class="op">=</span> r<span class="op">;</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n<span class="op">;</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> printCodes<span class="op">(</span>Node<span class="op">*</span> root<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> code<span class="op">,</span> <span class="dt">int</span> depth<span class="op">)</span> <span class="op">{</span></span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>root<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>root<span class="op">-&gt;</span>left <span class="op">&amp;&amp;</span> <span class="op">!</span>root<span class="op">-&gt;</span>right<span class="op">)</span> <span class="op">{</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>        code<span class="op">[</span>depth<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%c</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> root<span class="op">-&gt;</span>c<span class="op">,</span> code<span class="op">);</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>depth<span class="op">]</span> <span class="op">=</span> <span class="ch">'0'</span><span class="op">;</span></span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>    printCodes<span class="op">(</span>root<span class="op">-&gt;</span>left<span class="op">,</span> code<span class="op">,</span> depth <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>depth<span class="op">]</span> <span class="op">=</span> <span class="ch">'1'</span><span class="op">;</span></span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>    printCodes<span class="op">(</span>root<span class="op">-&gt;</span>right<span class="op">,</span> code<span class="op">,</span> depth <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-80" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-80">Why It Matters</h4>
<ul>
<li>Near-optimal entropy compression for independent symbols</li>
<li>Fast: single pass for encoding and decoding using lookup tables</li>
<li>Universal: foundation of DEFLATE, GZIP, PNG, JPEG, MP3, PDF text streams</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires prior knowledge of symbol frequencies</li>
<li>Inefficient for small alphabets or changing distributions</li>
<li>Generates prefix codes, decoding must follow tree paths</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-70" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-70">A Gentle Proof (Why It Works)</h4>
<p>Let each symbol <span class="math inline">\(i\)</span> have frequency <span class="math inline">\(p_i\)</span> and code length <span class="math inline">\(l_i\)</span>. Expected code length:</p>
<p><span class="math display">\[
L = \sum_i p_i l_i
\]</span></p>
<p>Huffman proves that for any prefix-free code,</p>
<p><span class="math display">\[
L_{\text{Huffman}} \le L_{\text{any other}}
\]</span></p>
<p>It’s optimal for any given distribution where symbol probabilities are fixed and independent.</p>
<p>Using Kraft’s inequality,</p>
<p><span class="math display">\[
\sum_i 2^{-l_i} \le 1
\]</span></p>
<p>Huffman coding finds the shortest integer lengths satisfying this constraint.</p>
</section>
<section id="try-it-yourself-80" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-80">Try It Yourself</h4>
<ol type="1">
<li>Encode the string <code>"MISSISSIPPI"</code> with Huffman coding.</li>
<li>Compare total bits vs fixed 8-bit ASCII.</li>
<li>Add adaptive Huffman coding (rebuild tree dynamically).</li>
<li>Apply to grayscale image data or sensor readings.</li>
<li>Explore canonical Huffman codes (used in DEFLATE).</li>
</ol>
</section>
<section id="test-cases-80" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-80">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Raw Bits (8-bit)</th>
<th>Huffman Bits</th>
<th>Compression</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>AAAAABBC</code></td>
<td>64</td>
<td>20</td>
<td>68.8%</td>
</tr>
<tr class="even">
<td><code>HELLO</code></td>
<td>40</td>
<td>23</td>
<td>42.5%</td>
</tr>
<tr class="odd">
<td><code>MISSISSIPPI</code></td>
<td>88</td>
<td>47</td>
<td>46.6%</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-80" class="level4">
<h4 class="anchored" data-anchor-id="complexity-80">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Tree build</td>
<td><span class="math inline">\(O(n \log n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Encode</td>
<td><span class="math inline">\(O(N)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="odd">
<td>Decode</td>
<td><span class="math inline">\(O(N)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
</tbody>
</table>
<p>Huffman Coding captures a simple truth, give more to the common, less to the rare, and in doing so, it built the backbone of modern compression.</p>
</section>
</section>
<section id="arithmetic-coding" class="level3">
<h3 class="anchored" data-anchor-id="arithmetic-coding">883 Arithmetic Coding</h3>
<p>Arithmetic Coding is a powerful lossless compression algorithm that represents an entire message as a single fractional number between 0 and 1. Unlike Huffman coding, which assigns discrete bit patterns per symbol, arithmetic coding encodes the whole sequence into a progressively refined interval, achieving near-entropy efficiency.</p>
<section id="what-problem-are-we-solving-81" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-81">What Problem Are We Solving?</h4>
<p>When symbol probabilities are not powers of ½, Huffman codes can’t perfectly match entropy limits. Arithmetic coding solves this by assigning a fractional number of bits per symbol, making it more efficient for skewed or adaptive distributions.</p>
</section>
<section id="how-does-it-work-plain-language-80" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-80">How Does It Work (Plain Language)</h4>
<p>The algorithm treats the entire message as a single real number in the interval <span class="math inline">\([0,1)\)</span>, subdivided according to symbol probabilities. At each step, it narrows the interval to the subrange corresponding to the next symbol.</p>
<p>Let’s say symbols <code>A, B, C</code> have probabilities 0.5, 0.3, 0.2.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Symbol</th>
<th>Range</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>[0.0, 0.5)</td>
</tr>
<tr class="even">
<td>B</td>
<td>[0.5, 0.8)</td>
</tr>
<tr class="odd">
<td>C</td>
<td>[0.8, 1.0)</td>
</tr>
</tbody>
</table>
<p>Encode “BA”:</p>
<ol type="1">
<li><p>Start with <span class="math inline">\([0, 1)\)</span></p></li>
<li><p>Symbol <code>B</code> → <span class="math inline">\([0.5, 0.8)\)</span></p></li>
<li><p>Symbol <code>A</code> → subdivide <span class="math inline">\([0.5, 0.8)\)</span> using same probabilities:</p>
<ul>
<li>New A range = <span class="math inline">\([0.5, 0.65)\)</span></li>
<li>New B range = <span class="math inline">\([0.65, 0.74)\)</span></li>
<li>New C range = <span class="math inline">\([0.74, 0.8)\)</span></li>
</ul></li>
<li><p>Final interval = <span class="math inline">\([0.5, 0.65)\)</span></p></li>
</ol>
<p>Any number inside represents “BA”, e.g.&nbsp;0.6.</p>
<p>Decoding reverses the process by repeatedly identifying which subinterval the number falls into.</p>
</section>
<section id="tiny-code-python-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-3">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> arithmetic_encode(symbols, probs):</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    low, high <span class="op">=</span> <span class="fl">0.0</span>, <span class="fl">1.0</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> symbols:</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>        span <span class="op">=</span> high <span class="op">-</span> low</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> sym, (p_low, p_high) <span class="kw">in</span> probs.items():</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sym <span class="op">==</span> s:</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>                high <span class="op">=</span> low <span class="op">+</span> span <span class="op">*</span> p_high</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>                low <span class="op">=</span> low <span class="op">+</span> span <span class="op">*</span> p_low</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (low <span class="op">+</span> high) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> arithmetic_decode(code, n, probs):</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> sym, (p_low, p_high) <span class="kw">in</span> probs.items():</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p_low <span class="op">&lt;=</span> code <span class="op">&lt;</span> p_high:</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>                result.append(sym)</span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>                code <span class="op">=</span> (code <span class="op">-</span> p_low) <span class="op">/</span> (p_high <span class="op">-</span> p_low)</span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(result)</span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> {<span class="st">"A"</span>: (<span class="fl">0.0</span>, <span class="fl">0.5</span>), <span class="st">"B"</span>: (<span class="fl">0.5</span>, <span class="fl">0.8</span>), <span class="st">"C"</span>: (<span class="fl">0.8</span>, <span class="fl">1.0</span>)}</span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> arithmetic_encode(<span class="st">"BA"</span>, probs)</span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoded value:"</span>, encoded)</span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Decoded:"</span>, arithmetic_decode(encoded, <span class="dv">2</span>, probs))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-81" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-81">Why It Matters</h4>
<ul>
<li>Closer to entropy limit: can achieve fractional-bit compression.</li>
<li>Adaptable: works with dynamically updated probabilities.</li>
<li>Used in: JPEG2000, H.264, AV1, Bzip2, and modern AI model quantization.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Arithmetic precision must be controlled (floating-point drift).</li>
<li>Implementation complexity is higher than Huffman’s.</li>
<li>Needs renormalization and bitstream encoding for real-world use.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-71" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-71">A Gentle Proof (Why It Works)</h4>
<p>If a message <span class="math inline">\(S = s_1 s_2 \dots s_n\)</span> is encoded to the interval <span class="math inline">\([L, H)\)</span>, then</p>
<p><span class="math display">\[
H - L = \prod_{i=1}^{n} P(s_i)
\]</span></p>
<p>Thus, the total number of bits needed is approximately</p>
<p><span class="math display">\[
-\log_2(H - L) = -\sum_{i=1}^{n} \log_2 P(s_i)
\]</span></p>
<p>This equals the Shannon information content, achieving optimal entropy coding under ideal arithmetic precision.</p>
</section>
<section id="try-it-yourself-81" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-81">Try It Yourself</h4>
<ol type="1">
<li>Encode “ABBA” with probabilities A:0.6, B:0.4.</li>
<li>Visualize shrinking intervals per symbol.</li>
<li>Add renormalization to emit bits progressively (range coder).</li>
<li>Compare compression ratio vs Huffman on skewed text.</li>
<li>Implement adaptive probabilities (update after each symbol).</li>
</ol>
</section>
<section id="test-cases-81" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-81">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 31%">
<col style="width: 27%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Input</th>
<th>Probabilities</th>
<th>Bits</th>
<th>Compression</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>“AAAA”</td>
<td>A:1.0</td>
<td>~0 bits</td>
<td>Perfect</td>
</tr>
<tr class="even">
<td>“ABAB”</td>
<td>A:0.9, B:0.1</td>
<td>~1.37 bits/symbol</td>
<td>Better than Huffman</td>
</tr>
<tr class="odd">
<td>“ABC”</td>
<td>A:0.5, B:0.3, C:0.2</td>
<td>~1.49 bits/symbol</td>
<td>Near entropy</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-81" class="level4">
<h4 class="anchored" data-anchor-id="complexity-81">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encoding</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decoding</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="odd">
<td>Precision</td>
<td>depends on bit width</td>
<td></td>
</tr>
</tbody>
</table>
<p>Arithmetic coding captures the continuity of information, it doesn’t think in symbols, but in probability space. Every message becomes a unique slice of the unit interval.</p>
</section>
</section>
<section id="delta-encoding" class="level3">
<h3 class="anchored" data-anchor-id="delta-encoding">884 Delta Encoding</h3>
<p>Delta Encoding compresses data by storing the <em>difference</em> between successive values rather than the values themselves. It is simple, fast, and incredibly effective for datasets with strong local correlation, such as timestamps, counters, audio samples, or sensor readings.</p>
<section id="what-problem-are-we-solving-82" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-82">What Problem Are We Solving?</h4>
<p>Many real-world sequences change slowly. For example: <code>[1000, 1001, 1002, 1005, 1006]</code></p>
<p>Instead of storing every full number, we can store only the differences: <code>[1000, +1, +1, +3, +1]</code></p>
<p>This reduces magnitude, variance, and entropy, making the sequence easier for secondary compression (like Huffman or arithmetic coding).</p>
</section>
<section id="how-does-it-work-plain-language-81" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-81">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Take a sequence of numeric values: <span class="math inline">\(x_1, x_2, x_3, \dots, x_n\)</span></li>
<li>Choose a reference (usually the first value).</li>
<li>Store the sequence of deltas: <span class="math inline">\(d_i = x_i - x_{i-1}\)</span> for <span class="math inline">\(i &gt; 1\)</span></li>
<li>To reconstruct, perform a cumulative sum: <span class="math inline">\(x_i = x_{i-1} + d_i\)</span></li>
</ol>
<p>If the sequence changes gradually, most <span class="math inline">\(d_i\)</span> will be small and compressible with fewer bits.</p>
</section>
<section id="example-9" class="level4">
<h4 class="anchored" data-anchor-id="example-9">Example</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Original</th>
<th>Delta</th>
<th>Reconstructed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1000</td>
<td>,</td>
<td>1000</td>
</tr>
<tr class="even">
<td>1001</td>
<td>+1</td>
<td>1001</td>
</tr>
<tr class="odd">
<td>1002</td>
<td>+1</td>
<td>1002</td>
</tr>
<tr class="even">
<td>1005</td>
<td>+3</td>
<td>1005</td>
</tr>
<tr class="odd">
<td>1006</td>
<td>+1</td>
<td>1006</td>
</tr>
</tbody>
</table>
<p>The deltas use fewer bits than full integers and can be encoded with variable-length or entropy coding afterward.</p>
</section>
<section id="tiny-code-python-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-4">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delta_encode(values):</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> values:</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    deltas <span class="op">=</span> [values[<span class="dv">0</span>]]</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(values)):</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>        deltas.append(values[i] <span class="op">-</span> values[i <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> deltas</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delta_decode(deltas):</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> deltas:</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> [deltas[<span class="dv">0</span>]]</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(deltas)):</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>        values.append(values[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> deltas[i])</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> values</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>nums <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">1001</span>, <span class="dv">1002</span>, <span class="dv">1005</span>, <span class="dv">1006</span>]</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> delta_encode(nums)</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Delta Encoded:"</span>, encoded)</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Decoded:"</span>, delta_decode(encoded))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-11" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-11">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb154"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> delta_encode<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>out<span class="op">,</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    out<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> data<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>        out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> data<span class="op">[</span>i<span class="op">]</span> <span class="op">-</span> data<span class="op">[</span>i <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> delta_decode<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>deltas<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>out<span class="op">,</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    out<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> deltas<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>        out<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> out<span class="op">[</span>i <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">+</span> deltas<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-82" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-82">Why It Matters</h4>
<ul>
<li>Compression synergy: smaller deltas → better Huffman or arithmetic compression.</li>
<li>Hardware efficiency: used in video (frame deltas), telemetry, time-series DBs, audio coding, and binary diffs.</li>
<li>Streaming-friendly: supports incremental updates with minimal state.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Sensitive to noise (large random jumps break efficiency).</li>
<li>Needs base frame or checkpoint for random access.</li>
<li>Must handle signed deltas safely.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-72" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-72">A Gentle Proof (Why It Works)</h4>
<p>Let the input sequence be <span class="math inline">\(x_1, x_2, \dots, x_n\)</span> and output deltas <span class="math inline">\(d_1, \dots, d_n\)</span> defined by</p>
<p><span class="math display">\[
d_1 = x_1, \quad d_i = x_i - x_{i-1} \text{ for } i &gt; 1
\]</span></p>
<p>Decoding is the inverse mapping:</p>
<p><span class="math display">\[
x_i = d_1 + \sum_{j=2}^{i} d_j
\]</span></p>
<p>Since addition and subtraction are invertible over integers, the transform is lossless. The entropy of <span class="math inline">\({d_i}\)</span> is lower when <span class="math inline">\(x_i\)</span> are locally correlated, allowing secondary encoders to exploit the reduced variance.</p>
</section>
<section id="try-it-yourself-82" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-82">Try It Yourself</h4>
<ol type="1">
<li>Encode temperature readings or stock prices, plot value vs delta distribution.</li>
<li>Combine with variable-byte encoding for integer streams.</li>
<li>Add periodic “reset” values for random access.</li>
<li>Use second-order deltas (<span class="math inline">\(d_i = d_i - d_{i-1}\)</span>) for smoother signals.</li>
<li>Compare compression with and without delta preprocessing using gzip or zstd.</li>
</ol>
</section>
<section id="test-cases-82" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-82">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Delta Encoded</th>
<th>Reconstructed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>[5, 7, 9, 12]</td>
<td>[5, 2, 2, 3]</td>
<td>[5, 7, 9, 12]</td>
</tr>
<tr class="even">
<td>[10, 10, 10, 10]</td>
<td>[10, 0, 0, 0]</td>
<td>[10, 10, 10, 10]</td>
</tr>
<tr class="odd">
<td>[1, 5, 2]</td>
<td>[1, 4, -3]</td>
<td>[1, 5, 2]</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-82" class="level4">
<h4 class="anchored" data-anchor-id="complexity-82">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encode</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decode</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Delta encoding is the essence of compression through <em>change awareness</em>, it ignores what stays the same and focuses only on how things move.</p>
</section>
</section>
<section id="variable-byte-encoding" class="level3">
<h3 class="anchored" data-anchor-id="variable-byte-encoding">885 Variable Byte Encoding</h3>
<p>Variable Byte (VB) Encoding is a simple and widely used integer compression technique that stores small numbers in fewer bytes and large numbers in more bytes. It’s especially popular in search engines and inverted indexes where posting lists contain large numbers of document IDs or gaps.</p>
<section id="what-problem-are-we-solving-83" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-83">What Problem Are We Solving?</h4>
<p>If you store every integer using a fixed 4 bytes, small numbers waste space. But most data (like docID gaps) are small integers. VB encoding uses as few bytes as necessary to store each number.</p>
<p>It’s fast, byte-aligned, and easy to decode, perfect for systems like Lucene, Zettair, or SQLite.</p>
</section>
<section id="how-does-it-work-plain-language-82" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-82">How Does It Work (Plain Language)</h4>
<p>Each integer is split into 7-bit chunks (base 128 representation). The highest bit in each byte is a continuation flag:</p>
<ul>
<li><code>1</code> means <em>more bytes follow</em>.</li>
<li><code>0</code> means <em>this is the last byte of the number</em>.</li>
</ul>
<p>This makes decoding trivial: keep reading until a byte with a leading <code>0</code> is found.</p>
<p>Example: encode <code>300</code></p>
<ul>
<li><p>Binary: <code>100101100</code></p></li>
<li><p>Split into 7-bit chunks: <code>[0010110] [00101100]</code></p></li>
<li><p>Encode:</p>
<ul>
<li>Lower 7 bits: <code>00101100</code> (0x2C)</li>
<li>Upper bits: <code>0000010</code> (0x02)</li>
<li>Set continuation on first: <code>100101100</code> → bytes <code>[0x82, 0x2C]</code></li>
</ul></li>
</ul>
</section>
<section id="example-table" class="level4">
<h4 class="anchored" data-anchor-id="example-table">Example Table</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Integer</th>
<th>Binary</th>
<th>Encoded Bytes (binary)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>00000001</code></td>
<td><code>00000001</code></td>
</tr>
<tr class="even">
<td>128</td>
<td><code>10000000</code></td>
<td><code>10000001 00000000</code></td>
</tr>
<tr class="odd">
<td>300</td>
<td><code>100101100</code></td>
<td><code>10000010 00101100</code></td>
</tr>
<tr class="even">
<td>16384</td>
<td><code>010000000000000</code></td>
<td><code>10000001 10000000 00000000</code></td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-5">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vb_encode_number(n):</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    bytes_out <span class="op">=</span> []</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>        bytes_out.insert(<span class="dv">0</span>, n <span class="op">%</span> <span class="dv">128</span>)</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">128</span>:</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>        n <span class="op">//=</span> <span class="dv">128</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    bytes_out[<span class="op">-</span><span class="dv">1</span>] <span class="op">+=</span> <span class="dv">128</span>  <span class="co"># set stop bit (MSB=1)</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bytes_out</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vb_encode_list(numbers):</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n <span class="kw">in</span> numbers:</span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>        result.extend(vb_encode_number(n))</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bytes</span>(result)</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vb_decode(data):</span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>    n, out <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> b <span class="kw">in</span> data:</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> b <span class="op">&lt;</span> <span class="dv">128</span>:</span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="dv">128</span> <span class="op">*</span> n <span class="op">+</span> b</span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="dv">128</span> <span class="op">*</span> n <span class="op">+</span> (b <span class="op">-</span> <span class="dv">128</span>)</span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>            out.append(n)</span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>nums <span class="op">=</span> [<span class="dv">824</span>, <span class="dv">5</span>, <span class="dv">300</span>]</span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> vb_encode_list(nums)</span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(encoded))</span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vb_decode(encoded))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-12" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-12">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb156"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> vb_encode<span class="op">(</span><span class="dt">uint32_t</span> n<span class="op">,</span> <span class="dt">uint8_t</span> <span class="op">*</span>out<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> buf<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>        buf<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> n <span class="op">%</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>        n <span class="op">/=</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    buf<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+=</span> <span class="dv">128</span><span class="op">;</span>  <span class="co">// set continuation bit</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> j<span class="op">--)</span> out<span class="op">[</span>i <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> j<span class="op">]</span> <span class="op">=</span> buf<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> vb_decode<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>in<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>pos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> b<span class="op">;</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> in<span class="op">[(*</span>pos<span class="op">)++];</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>b <span class="op">&gt;=</span> <span class="dv">128</span><span class="op">)</span> n <span class="op">=</span> <span class="dv">128</span> <span class="op">*</span> n <span class="op">+</span> <span class="op">(</span>b <span class="op">-</span> <span class="dv">128</span><span class="op">);</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> n <span class="op">=</span> <span class="dv">128</span> <span class="op">*</span> n <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>b <span class="op">&lt;</span> <span class="dv">128</span><span class="op">);</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n<span class="op">;</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-83" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-83">Why It Matters</h4>
<ul>
<li>Used in IR systems: to compress posting lists (docID gaps, term frequencies).</li>
<li>Compact + fast: byte-aligned, simple bitwise ops, good for CPU caching.</li>
<li>Perfect for delta-encoded integers (follows Algorithm 884).</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Less dense than bit-packing or Frame-of-Reference compression.</li>
<li>Not SIMD-friendly (irregular length).</li>
<li>Needs extra byte per 7 bits for long numbers.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-73" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-73">A Gentle Proof (Why It Works)</h4>
<p>Let each number <span class="math inline">\(x\)</span> be decomposed in base <span class="math inline">\(128\)</span>:</p>
<p><span class="math display">\[
x = a_0 + 128 a_1 + 128^2 a_2 + \dots + 128^{k-1} a_{k-1}
\]</span></p>
<p>Each chunk <span class="math inline">\(a_i\)</span> fits in 7 bits <span class="math inline">\((0 \le a_i &lt; 128)\)</span>. The encoding appends bytes in reverse order with the high bit of the <em>last byte</em> set to 1. Decoding reverses this process by multiplying partial sums by 128 until a terminating byte appears.</p>
<p>The bijection between <span class="math inline">\(\mathbb{N}\)</span> and valid byte sequences guarantees correctness and prefix-freeness.</p>
</section>
<section id="try-it-yourself-83" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-83">Try It Yourself</h4>
<ol type="1">
<li>Combine with delta encoding for document IDs: store <code>gap[i] = doc[i] - doc[i-1]</code>.</li>
<li>Benchmark encoding and decoding throughput vs plain integers.</li>
<li>Visualize how numbers of different sizes consume variable bytes.</li>
<li>Add a SIMD-like unrolled decoder for fixed batch size.</li>
<li>Apply to time-series or integer streams from logs.</li>
</ol>
</section>
<section id="test-cases-83" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-83">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Encoded Bytes</th>
<th>Decoded</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>[1]</td>
<td><code>[129]</code></td>
<td>[1]</td>
</tr>
<tr class="even">
<td>[128]</td>
<td><code>[1, 128]</code></td>
<td>[128]</td>
</tr>
<tr class="odd">
<td>[300]</td>
<td><code>[2, 172]</code></td>
<td>[300]</td>
</tr>
<tr class="even">
<td>[824, 5, 300]</td>
<td><code>[6, 136, 5, 2, 172]</code></td>
<td>[824, 5, 300]</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-83" class="level4">
<h4 class="anchored" data-anchor-id="complexity-83">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encode</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Decode</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="odd">
<td>Compression ratio</td>
<td>depends on data magnitude</td>
<td></td>
</tr>
</tbody>
</table>
<p>Variable Byte Encoding is the compression workhorse of information retrieval, small, fast, byte-aligned, and perfectly tuned for integers that love to shrink.</p>
</section>
</section>
<section id="elias-gamma-coding" class="level3">
<h3 class="anchored" data-anchor-id="elias-gamma-coding">886 Elias Gamma Coding</h3>
<p>Elias Gamma Coding is a universal code for positive integers that encodes numbers using a variable number of bits without requiring a known upper bound. It is elegant, prefix-free, and forms the foundation for other universal codes such as Delta and Rice coding.</p>
<section id="what-problem-are-we-solving-84" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-84">What Problem Are We Solving?</h4>
<p>When compressing integer sequences of unknown range, fixed-length codes are wasteful. We want a self-delimiting, bit-level code that efficiently represents both small and large numbers without a predefined limit.</p>
<p>Elias Gamma achieves this using logarithmic bit-length encoding, making it ideal for systems that store gaps, counts, or ranks in compressed indexes.</p>
</section>
<section id="how-does-it-work-plain-language-83" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-83">How Does It Work (Plain Language)</h4>
<p>To encode a positive integer <span class="math inline">\(x\)</span>:</p>
<ol type="1">
<li>Write <span class="math inline">\(x\)</span> in binary. Let <span class="math inline">\(b = \lfloor \log_2 x \rfloor\)</span>.</li>
<li>Write <span class="math inline">\(b\)</span> zeros (unary prefix).</li>
<li>Write the binary representation of <span class="math inline">\(x\)</span>.</li>
</ol>
<p>For example, to encode 10:</p>
<ul>
<li>Binary(10) = <code>1010</code>, length = 4 bits → prefix = <code>000</code> (3 zeros).</li>
<li>Output: <code>0001010</code>.</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Number</th>
<th>Binary</th>
<th>Prefix</th>
<th>Gamma Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>1</code></td>
<td>(none)</td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td>2</td>
<td><code>10</code></td>
<td><code>0</code></td>
<td><code>010</code></td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>11</code></td>
<td><code>0</code></td>
<td><code>011</code></td>
</tr>
<tr class="even">
<td>4</td>
<td><code>100</code></td>
<td><code>00</code></td>
<td><code>00100</code></td>
</tr>
<tr class="odd">
<td>5</td>
<td><code>101</code></td>
<td><code>00</code></td>
<td><code>00101</code></td>
</tr>
<tr class="even">
<td>10</td>
<td><code>1010</code></td>
<td><code>000</code></td>
<td><code>0001010</code></td>
</tr>
</tbody>
</table>
</section>
<section id="example-decoding" class="level4">
<h4 class="anchored" data-anchor-id="example-decoding">Example (Decoding)</h4>
<p>To decode, count the number of leading zeros (<span class="math inline">\(b\)</span>), then read the next <span class="math inline">\(b+1\)</span> bits as the binary value.</p>
<p>Example: <code>0001010</code> → leading zeros = 3 → read 4 bits → <code>1010</code> = 10.</p>
</section>
<section id="tiny-code-python-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-6">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> elias_gamma_encode(n):</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Elias gamma only encodes positive integers"</span>)</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    binary <span class="op">=</span> <span class="bu">bin</span>(n)[<span class="dv">2</span>:]</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    prefix <span class="op">=</span> <span class="st">'0'</span> <span class="op">*</span> (<span class="bu">len</span>(binary) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prefix <span class="op">+</span> binary</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> elias_gamma_decode(code):</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(code) <span class="kw">and</span> code[i] <span class="op">==</span> <span class="st">'0'</span>:</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>    length <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> <span class="bu">int</span>(code[i:i<span class="op">+</span>length], <span class="dv">2</span>)</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>nums <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">10</span>]</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>codes <span class="op">=</span> [elias_gamma_encode(n) <span class="cf">for</span> n <span class="kw">in</span> nums]</span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(<span class="bu">zip</span>(nums, codes)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-13" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-13">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb158"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;math.h&gt;</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> elias_gamma_encode<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> b <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>floor<span class="op">(</span>log2<span class="op">(</span>x<span class="op">));</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> b<span class="op">;</span> i<span class="op">++)</span> printf<span class="op">(</span><span class="st">"0"</span><span class="op">);</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> b<span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">--)</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> <span class="op">(</span>x <span class="op">&gt;&gt;</span> i<span class="op">)</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%2d</span><span class="st">: "</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>        elias_gamma_encode<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-84" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-84">Why It Matters</h4>
<ul>
<li><p>Universal: works for any positive integer without fixed range.</p></li>
<li><p>Prefix-free: every codeword can be parsed unambiguously.</p></li>
<li><p>Compact for small numbers: cost grows as <span class="math inline">\(2 \lfloor \log_2 n \rfloor + 1\)</span> bits.</p></li>
<li><p>Used in:</p>
<ul>
<li>Inverted indexes for docID gaps</li>
<li>Graph adjacency lists</li>
<li>Compact dictionaries and rank/select structures</li>
</ul></li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Bit-level (not byte-aligned) → slower to decode than variable-byte.</li>
<li>Not ideal for large integers (code length grows logarithmically).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-74" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-74">A Gentle Proof (Why It Works)</h4>
<p>Each number <span class="math inline">\(n\)</span> is encoded using: <span class="math display">\[
\text{length} = 2\lfloor \log_2 n \rfloor + 1
\]</span></p>
<p>Since each binary code has a unique unary prefix length, the code satisfies Kraft’s inequality: <span class="math display">\[
\sum_{n=1}^\infty 2^{-\text{length}(n)} \le 1
\]</span></p>
<p>Thus, the code is prefix-free and decodable. The redundancy (extra bits over <span class="math inline">\(-\log_2 n\)</span>) is bounded by 1 bit per symbol.</p>
</section>
<section id="try-it-yourself-84" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-84">Try It Yourself</h4>
<ol type="1">
<li>Encode the sequence <code>[1, 3, 7, 15]</code> and count total bits.</li>
<li>Compare compression vs variable-byte encoding for small gaps.</li>
<li>Implement Elias Delta coding (adds Gamma on length).</li>
<li>Visualize prefix length growth vs number magnitude.</li>
<li>Measure speed for bitstream decoding on random data.</li>
</ol>
</section>
<section id="test-cases-84" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-84">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Number</th>
<th>Gamma Code</th>
<th>Bits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>1</code></td>
<td>1</td>
</tr>
<tr class="even">
<td>2</td>
<td><code>010</code></td>
<td>3</td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>011</code></td>
<td>3</td>
</tr>
<tr class="even">
<td>4</td>
<td><code>00100</code></td>
<td>5</td>
</tr>
<tr class="odd">
<td>5</td>
<td><code>00101</code></td>
<td>5</td>
</tr>
<tr class="even">
<td>10</td>
<td><code>0001010</code></td>
<td>7</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-84" class="level4">
<h4 class="anchored" data-anchor-id="complexity-84">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encode</td>
<td><span class="math inline">\(O(\log n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decode</td>
<td><span class="math inline">\(O(\log n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Elias Gamma Coding is a model of elegant simplicity, a self-delimiting whisper of bits that expands just enough to hold a number’s size and no more.</p>
</section>
</section>
<section id="rice-coding" class="level3">
<h3 class="anchored" data-anchor-id="rice-coding">887 Rice Coding</h3>
<p>Rice Coding (or Golomb–Rice Coding) is a practical and efficient method for compressing non-negative integers, particularly when smaller values occur much more frequently than larger ones. It’s a simplified form of Golomb coding that uses a power-of-two divisor, enabling extremely fast bit-level encoding and decoding.</p>
<section id="what-problem-are-we-solving-85" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-85">What Problem Are We Solving?</h4>
<p>When encoding counts, run lengths, or residuals (like deltas), we often have geometrically distributed data, small numbers are common, big ones rare. Rice coding exploits this skew efficiently, using one parameter <span class="math inline">\(k\)</span> that controls how many bits are allocated to the remainder.</p>
<p>It’s simple, lossless, and widely used in FLAC, H.264, and LZMA for integer compression.</p>
</section>
<section id="how-does-it-work-plain-language-84" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-84">How Does It Work (Plain Language)</h4>
<p>Rice coding divides an integer <span class="math inline">\(x\)</span> into two parts:</p>
<ul>
<li>Quotient: <span class="math inline">\(q = \lfloor x / 2^k \rfloor\)</span></li>
<li>Remainder: <span class="math inline">\(r = x \bmod 2^k\)</span></li>
</ul>
<p>Then:</p>
<ol type="1">
<li>Encode <span class="math inline">\(q\)</span> in unary (a series of <code>q</code> ones followed by a zero).</li>
<li>Encode <span class="math inline">\(r\)</span> in binary using exactly <span class="math inline">\(k\)</span> bits.</li>
</ol>
<p>So, Rice<span class="math inline">\((x, k)\)</span> = <code>111...10 + (r in k bits)</code></p>
</section>
<section id="example-10" class="level4">
<h4 class="anchored" data-anchor-id="example-10">Example</h4>
<p>Let <span class="math inline">\(k = 2\)</span> (divisor <span class="math inline">\(= 4\)</span>):</p>
<table class="caption-top table">
<colgroup>
<col style="width: 4%">
<col style="width: 40%">
<col style="width: 24%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th><span class="math inline">\(x\)</span></th>
<th><span class="math inline">\(q = \lfloor x/4 \rfloor\)</span></th>
<th><span class="math inline">\(r = x \bmod 4\)</span></th>
<th>Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>0</td>
<td><code>0 00</code> → <code>000</code></td>
</tr>
<tr class="even">
<td>1</td>
<td>0</td>
<td>1</td>
<td><code>0 01</code> → <code>001</code></td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
<td>2</td>
<td><code>0 10</code> → <code>010</code></td>
</tr>
<tr class="even">
<td>3</td>
<td>0</td>
<td>3</td>
<td><code>0 11</code> → <code>011</code></td>
</tr>
<tr class="odd">
<td>4</td>
<td>1</td>
<td>0</td>
<td><code>10 00</code> → <code>1000</code></td>
</tr>
<tr class="even">
<td>5</td>
<td>1</td>
<td>1</td>
<td><code>10 01</code> → <code>1001</code></td>
</tr>
<tr class="odd">
<td>7</td>
<td>1</td>
<td>3</td>
<td><code>10 11</code> → <code>1011</code></td>
</tr>
<tr class="even">
<td>8</td>
<td>2</td>
<td>0</td>
<td><code>110 00</code> → <code>11000</code></td>
</tr>
</tbody>
</table>
<p>Unary encodes quotient; binary encodes remainder.</p>
</section>
<section id="tiny-code-python-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-7">Tiny Code (Python)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rice_encode(x, k):</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> x <span class="op">&gt;&gt;</span> k</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> x <span class="op">&amp;</span> ((<span class="dv">1</span> <span class="op">&lt;&lt;</span> k) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    unary <span class="op">=</span> <span class="st">"1"</span> <span class="op">*</span> q <span class="op">+</span> <span class="st">"0"</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    binary <span class="op">=</span> <span class="bu">format</span>(r, <span class="ss">f"0</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">b"</span>)</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unary <span class="op">+</span> binary</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rice_decode(code, k):</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> code.find(<span class="st">"0"</span>)</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="bu">int</span>(code[q <span class="op">+</span> <span class="dv">1</span>:q <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> k], <span class="dv">2</span>)</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (q <span class="op">&lt;&lt;</span> k) <span class="op">+</span> r</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">9</span>):</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> rice_encode(x, <span class="dv">2</span>)</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x, code)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-14" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-14">Tiny Code (C)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb160"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> rice_encode<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> k<span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> q <span class="op">=</span> x <span class="op">&gt;&gt;</span> k<span class="op">;</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> r <span class="op">=</span> x <span class="op">&amp;</span> <span class="op">((</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> k<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> q<span class="op">;</span> i<span class="op">++)</span> putchar<span class="op">(</span><span class="ch">'1'</span><span class="op">);</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>    putchar<span class="op">(</span><span class="ch">'0'</span><span class="op">);</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> k <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">--)</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>        putchar<span class="op">((</span>r <span class="op">&gt;&gt;</span> i<span class="op">)</span> <span class="op">&amp;</span> <span class="dv">1</span> <span class="op">?</span> <span class="ch">'1'</span> <span class="op">:</span> <span class="ch">'0'</span><span class="op">);</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> x <span class="op">&lt;</span> <span class="dv">9</span><span class="op">;</span> x<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">%2d</span><span class="st">: "</span><span class="op">,</span> x<span class="op">);</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>        rice_encode<span class="op">(</span>x<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-85" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-85">Why It Matters</h4>
<ul>
<li><p>Compact for small integers: geometric-like data compresses well.</p></li>
<li><p>Fast: only shifts, masks, and simple loops.</p></li>
<li><p>Parameter-tunable: <span class="math inline">\(k\)</span> controls balance between quotient and remainder.</p></li>
<li><p>Used in:</p>
<ul>
<li>FLAC (audio residual encoding)</li>
<li>FFV1 / H.264 residuals</li>
<li>Entropy coders in LZMA, Bzip2 variants</li>
</ul></li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires tuning of <span class="math inline">\(k\)</span> for optimal efficiency.</li>
<li>Not ideal for uniform or large outlier-heavy data.</li>
<li>Works best when <span class="math inline">\(E[x] \approx 2^k\)</span>.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-75" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-75">A Gentle Proof (Why It Works)</h4>
<p>Given integer <span class="math inline">\(x \ge 0\)</span>, let <span class="math display">\[
x = q \cdot 2^k + r, \quad 0 \le r &lt; 2^k
\]</span></p>
<p>The codeword consists of <span class="math inline">\(q + 1 + k\)</span> bits:</p>
<ul>
<li><span class="math inline">\(q + 1\)</span> from unary encoding</li>
<li><span class="math inline">\(k\)</span> from binary remainder</li>
</ul>
<p>Expected code length for geometric distribution <span class="math inline">\(P(x) = (1 - p)^x p\)</span> is minimized when <span class="math display">\[
2^k \approx \frac{-1}{\log_2(1 - p)}
\]</span></p>
<p>Thus, tuning <span class="math inline">\(k\)</span> matches the data’s skew for near-optimal entropy coding.</p>
</section>
<section id="try-it-yourself-85" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-85">Try It Yourself</h4>
<ol type="1">
<li>Encode <code>[0, 1, 2, 3, 4, 5, 6, 7]</code> for <span class="math inline">\(k = 1, 2, 3\)</span>, compare code lengths.</li>
<li>Tune <span class="math inline">\(k\)</span> adaptively to the mean of your data.</li>
<li>Combine with delta encoding before Rice.</li>
<li>Visualize how unary and remainder trade off.</li>
<li>Compare compression ratio vs Elias Gamma for small integers.</li>
</ol>
</section>
<section id="test-cases-85" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-85">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input <span class="math inline">\(x\)</span></th>
<th><span class="math inline">\(k\)</span></th>
<th>Code</th>
<th>Bits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2</td>
<td><code>000</code></td>
<td>3</td>
</tr>
<tr class="even">
<td>3</td>
<td>2</td>
<td><code>011</code></td>
<td>3</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2</td>
<td><code>1000</code></td>
<td>4</td>
</tr>
<tr class="even">
<td>7</td>
<td>2</td>
<td><code>1011</code></td>
<td>4</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2</td>
<td><code>11000</code></td>
<td>5</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-85" class="level4">
<h4 class="anchored" data-anchor-id="complexity-85">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encode</td>
<td><span class="math inline">\(O(1)\)</span> per value</td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decode</td>
<td><span class="math inline">\(O(1)\)</span> per value</td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Rice Coding is the perfect bridge between mathematical precision and machine efficiency, a few shifts, a few bits, and data collapses into rhythmically compact form.</p>
</section>
</section>
<section id="snappy-compression" class="level3">
<h3 class="anchored" data-anchor-id="snappy-compression">888 Snappy Compression</h3>
<p>Snappy is a fast, block-based compression algorithm designed by Google for real-time systems where speed matters more than maximum compression ratio. Unlike heavy compressors like zlib or LZMA, Snappy prioritizes throughput over ratio, achieving hundreds of MB/s in both compression and decompression.</p>
<section id="what-problem-are-we-solving-86" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-86">What Problem Are We Solving?</h4>
<p>Many modern systems, databases, stream processors, and log pipelines, generate huge volumes of data that need to be stored or transmitted quickly. Traditional compressors (like DEFLATE or bzip2) offer good compression but are too slow for these pipelines.</p>
<p>Snappy trades off some compression ratio for lightweight CPU cost, perfect for:</p>
<ul>
<li>Columnar databases (Parquet, ORC)</li>
<li>Message queues (Kafka)</li>
<li>Data interchange (Avro, Arrow)</li>
<li>In-memory caches (RocksDB, LevelDB)</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-85" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-85">How Does It Work (Plain Language)</h4>
<p>Snappy is based on LZ77-style compression, but optimized for speed:</p>
<ol type="1">
<li><p>Divide data into blocks (usually 32 KB).</p></li>
<li><p>Maintain a sliding hash table of previous byte sequences.</p></li>
<li><p>For each new sequence:</p>
<ul>
<li>If a match is found in history, emit a copy command (offset + length).</li>
<li>Otherwise, emit a literal (raw bytes).</li>
</ul></li>
<li><p>Repeat until the block ends.</p></li>
</ol>
<p>Every output is composed of alternating literal and copy segments.</p>
</section>
<section id="encoding-format" class="level4">
<h4 class="anchored" data-anchor-id="encoding-format">Encoding Format</h4>
<p>Each fragment starts with a tag byte:</p>
<ul>
<li>Lower 2 bits: type (<code>00</code> literal, <code>01</code> copy-1-byte offset, <code>10</code> copy-2-byte offset, etc.)</li>
<li>Remaining bits: length or extra info.</li>
</ul>
<p>Example layout (simplified):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Type</th>
<th>Bits</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Literal</td>
<td><code>00</code></td>
<td>Followed by length and raw bytes</td>
</tr>
<tr class="even">
<td>Copy-1</td>
<td><code>01</code></td>
<td>3-byte copy (1-byte offset)</td>
</tr>
<tr class="odd">
<td>Copy-2</td>
<td><code>10</code></td>
<td>4-byte copy (2-byte offset)</td>
</tr>
<tr class="even">
<td>Copy-4</td>
<td><code>11</code></td>
<td>5-byte copy (4-byte offset)</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-prototype" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-prototype">Tiny Code (Python Prototype)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> snappy_compress(data: <span class="bu">bytes</span>):</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> []</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(data):</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># literal section (no match detection for simplicity)</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>        literal_len <span class="op">=</span> <span class="bu">min</span>(<span class="dv">60</span>, <span class="bu">len</span>(data) <span class="op">-</span> i)</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>        out.append((literal_len <span class="op">&lt;&lt;</span> <span class="dv">2</span>) <span class="op">|</span> <span class="bn">0x00</span>)  <span class="co"># tag</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>        out.append(data[i:i<span class="op">+</span>literal_len])</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> literal_len</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">b""</span>.join(out <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">bytes</span>) <span class="cf">else</span> <span class="bu">bytes</span>([x]) <span class="cf">for</span> x <span class="kw">in</span> out)</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> snappy_decompress(encoded: <span class="bu">bytes</span>):</span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> <span class="bu">bytearray</span>()</span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(encoded):</span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>        tag <span class="op">=</span> encoded[i]</span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>        ttype <span class="op">=</span> tag <span class="op">&amp;</span> <span class="bn">0x03</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ttype <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>            length <span class="op">=</span> tag <span class="op">&gt;&gt;</span> <span class="dv">2</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>            out <span class="op">+=</span> encoded[i:i<span class="op">+</span>length]</span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> length</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bytes</span>(out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>(Simplified, real Snappy adds matching, offsets, and variable-length headers.)</em></p>
</section>
<section id="tiny-code-c-sketch" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb162"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> snappy_literal<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>input<span class="op">,</span> <span class="dt">int</span> len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> tag <span class="op">=</span> <span class="op">(</span>len <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">)</span> <span class="op">|</span> <span class="bn">0x00</span><span class="op">;</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(&amp;</span>tag<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>    fwrite<span class="op">(</span>input<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> len<span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>text <span class="op">=</span> <span class="st">"hello hello hello"</span><span class="op">;</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    snappy_literal<span class="op">(</span>text<span class="op">,</span> strlen<span class="op">(</span>text<span class="op">));</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-86" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-86">Why It Matters</h4>
<ul>
<li>Extremely fast: 300–500 MB/s typical.</li>
<li>CPU-efficient: almost no entropy coding overhead.</li>
<li>Widely adopted: used in RocksDB, Parquet, BigQuery, TensorFlow checkpoints.</li>
<li>Deterministic and simple: block-local, restartable anywhere.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Compression ratio ~1.5–2.0×, less than DEFLATE or LZMA.</li>
<li>Not entropy-coded (no Huffman stage).</li>
<li>Not ideal for highly repetitive or structured text.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-76" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-76">A Gentle Proof (Why It Works)</h4>
<p>Snappy achieves its balance through information-theoretic locality: If most redundancy occurs within 32 KB windows, we can find repeated sequences quickly without full entropy modeling.</p>
<p>For a stream of bytes <span class="math inline">\(S = s_1, s_2, \dots, s_n\)</span>, Snappy emits tokens <span class="math inline">\((L_i, O_i)\)</span> such that: <span class="math display">\[
S = \bigoplus_i \text{(literal)}(L_i) \oplus \text{(copy)}(O_i, L_i)
\]</span></p>
<p>Since literal and copy tokens cover the stream disjointly and encode full offsets, the compression and decompression functions form an invertible mapping, ensuring losslessness.</p>
</section>
<section id="try-it-yourself-86" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-86">Try It Yourself</h4>
<ol type="1">
<li>Compress text files and measure compression ratio vs gzip.</li>
<li>Inspect Parquet file metadata, see <code>compression=SNAPPY</code>.</li>
<li>Implement rolling hash for match detection.</li>
<li>Visualize literal/copy segments for a repetitive input.</li>
<li>Benchmark your implementation with random vs repetitive data.</li>
</ol>
</section>
<section id="test-cases-86" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-86">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Encoded (Hex)</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>hello</code></td>
<td><code>140x68656c6c6f</code></td>
<td>literal only</td>
</tr>
<tr class="even">
<td><code>aaaaaa</code></td>
<td>smaller than raw</td>
<td>due to repeated pattern</td>
</tr>
<tr class="odd">
<td>large repetitive log</td>
<td>2–3× smaller</td>
<td>predictable structure</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-86" class="level4">
<h4 class="anchored" data-anchor-id="complexity-86">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Compress</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decompress</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="odd">
<td>Compression Ratio</td>
<td>1.5–2.0× typical</td>
<td></td>
</tr>
</tbody>
</table>
<p>Snappy is the speed daemon of compression, sacrificing only a few bits to stay perfectly in sync with your CPU’s rhythm.</p>
</section>
</section>
<section id="zstandard-zstd" class="level3">
<h3 class="anchored" data-anchor-id="zstandard-zstd">889 Zstandard (Zstd)</h3>
<p>Zstandard, or Zstd, is a modern, general-purpose compression algorithm developed by Facebook that strikes a remarkable balance between speed and compression ratio. It offers tunable compression levels, an adaptive dictionary system, and extremely fast decompression—making it ideal for data storage, streaming, and transport systems.</p>
<section id="what-problem-are-we-solving-87" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-87">What Problem Are We Solving?</h4>
<p>Legacy compressors like zlib (DEFLATE) offer decent ratios but struggle with speed; newer ones like LZ4 are fast but often too shallow in compression. Zstd fills this gap: it compresses 3–5× faster than zlib while achieving better compression ratios.</p>
<p>Zstd supports:</p>
<ul>
<li>Adjustable compression levels (1–22)</li>
<li>Pretrained dictionaries for small data (logs, JSON, RPC payloads)</li>
<li>Streaming and frame-based encoding for large files</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-86" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-86">How Does It Work (Plain Language)</h4>
<p>Zstd is built on three conceptual layers:</p>
<ol type="1">
<li><p>LZ77 Back-References It finds repeated byte sequences and replaces them with (offset, length) pairs.</p></li>
<li><p>FSE (Finite State Entropy) Coding It compresses literal bytes, offsets, and lengths using entropy models. FSE is a highly efficient implementation of asymmetric numeral systems (ANS), an alternative to Huffman coding.</p></li>
<li><p>Adaptive Dictionary and Block Mode It can learn patterns from prior samples, compressing small payloads efficiently.</p></li>
</ol>
<p>Each compressed frame contains:</p>
<ul>
<li>Header (magic number, options)</li>
<li>One or more compressed blocks</li>
<li>Checksum (optional)</li>
</ul>
</section>
<section id="example-concept-flow" class="level4">
<h4 class="anchored" data-anchor-id="example-concept-flow">Example (Concept Flow)</h4>
<pre><code>Original:  "abcabcabcabc"
Step 1:  LZ77 → [literal "abc", copy(3,9)]
Step 2:  Entropy encode literals and offsets
Step 3:  Frame header + block output
Result:  Compact stream with &lt; 50% original size</code></pre>
</section>
<section id="tiny-code-python-using-zstandard-library" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-using-zstandard-library">Tiny Code (Python using zstandard library)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zstandard <span class="im">as</span> zstd</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="st">b"The quick brown fox jumps over the lazy dog."</span> <span class="op">*</span> <span class="dv">10</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>cctx <span class="op">=</span> zstd.ZstdCompressor(level<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>compressed <span class="op">=</span> cctx.compress(data)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>dctx <span class="op">=</span> zstd.ZstdDecompressor()</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>decompressed <span class="op">=</span> dctx.decompress(compressed)</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Compression ratio:"</span>, <span class="bu">len</span>(data)<span class="op">/</span><span class="bu">len</span>(compressed))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-example" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-example">Tiny Code (C Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb165"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;zstd.h&gt;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> input <span class="op">=</span> <span class="st">"hello hello hello hello"</span><span class="op">;</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> input_size <span class="op">=</span> strlen<span class="op">(</span>input<span class="op">);</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> bound <span class="op">=</span> ZSTD_compressBound<span class="op">(</span>input_size<span class="op">);</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> compressed<span class="op">[</span>bound<span class="op">];</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> decompressed<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> csize <span class="op">=</span> ZSTD_compress<span class="op">(</span>compressed<span class="op">,</span> bound<span class="op">,</span> input<span class="op">,</span> input_size<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> dsize <span class="op">=</span> ZSTD_decompress<span class="op">(</span>decompressed<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>decompressed<span class="op">),</span> compressed<span class="op">,</span> csize<span class="op">);</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Original: </span><span class="sc">%zu</span><span class="st"> bytes, Compressed: </span><span class="sc">%zu</span><span class="st"> bytes</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> input_size<span class="op">,</span> csize<span class="op">);</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-87" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-87">Why It Matters</h4>
<ul>
<li><p>Performance:</p>
<ul>
<li>Compresses faster than zlib at level 3–5</li>
<li>Decompresses at speeds close to LZ4</li>
</ul></li>
<li><p>Flexibility:</p>
<ul>
<li>Wide range of compression levels</li>
<li>Works for small objects (via dictionaries) or terabyte-scale data (streaming mode)</li>
</ul></li>
<li><p>Adoption:</p>
<ul>
<li>Used in <code>zstd</code>, <code>tar --zstd</code>, Facebook RocksDB, TensorFlow checkpoints, Linux kernel (initramfs), Kafka, and Git</li>
</ul></li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Higher compression levels require more memory (both compressor and decompressor).</li>
<li>Slightly higher implementation complexity than simple LZ-based schemes.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-77" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-77">A Gentle Proof (Why It Works)</h4>
<p>Zstd’s core entropy engine, Finite State Entropy, maintains a single state variable <span class="math inline">\(x\)</span> that represents multiple probabilities simultaneously. For a stream of symbols <span class="math inline">\(s_1, s_2, \dots, s_n\)</span> with probabilities <span class="math inline">\(P(s_i)\)</span>, the state update rule follows:</p>
<p><span class="math display">\[
x_{i+1} = \lfloor x_i / P(s_i) \rfloor + f(s_i)
\]</span></p>
<p>This maintains information balance equivalent to arithmetic coding but with less overhead. Because entropy coding is integrated directly with back-references, Zstd achieves compression ratios close to DEFLATE + Huffman but runs faster by using pre-normalized tables.</p>
</section>
<section id="try-it-yourself-87" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-87">Try It Yourself</h4>
<ol type="1">
<li><p>Compress logs with <code>zstd -1</code> and <code>zstd -9</code>, compare sizes and speeds.</p></li>
<li><p>Use dictionary training with:</p>
<pre><code>zstd --train *.json -o dict</code></pre></li>
<li><p>Experiment with streaming APIs (<code>ZSTD_CStream</code>).</p></li>
<li><p>Compare decompression time vs gzip and LZ4.</p></li>
<li><p>Inspect frame headers using <code>zstd --list --verbose file.zst</code>.</p></li>
</ol>
</section>
<section id="test-cases-87" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-87">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Level</th>
<th>Ratio</th>
<th>Speed (MB/s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Text logs</td>
<td>3</td>
<td>2.8×</td>
<td>420</td>
</tr>
<tr class="even">
<td>JSON payloads</td>
<td>9</td>
<td>4.5×</td>
<td>250</td>
</tr>
<tr class="odd">
<td>Binary column data</td>
<td>5</td>
<td>3.0×</td>
<td>350</td>
</tr>
<tr class="even">
<td>Video frames</td>
<td>1</td>
<td>1.6×</td>
<td>500</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-87" class="level4">
<h4 class="anchored" data-anchor-id="complexity-87">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Compression</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(2^k)\)</span> for level <span class="math inline">\(k\)</span></td>
</tr>
<tr class="even">
<td>Decompression</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="odd">
<td>Entropy coding</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Zstandard is a masterclass in modern compression— fast, flexible, and mathematically graceful, where entropy coding meets engineering pragmatism.</p>
</section>
</section>
<section id="lz4-compression" class="level3">
<h3 class="anchored" data-anchor-id="lz4-compression">890 LZ4 Compression</h3>
<p>LZ4 is a lightweight, lossless compression algorithm focused on speed and simplicity. It achieves extremely fast compression and decompression by using a minimalistic version of the LZ77 scheme, ideal for real-time systems, in-memory storage, and network serialization.</p>
<section id="what-problem-are-we-solving-88" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-88">What Problem Are We Solving?</h4>
<p>When applications process massive data streams, logs, metrics, caches, or columnar blocks, every CPU cycle matters. Traditional compressors like gzip or zstd offer good ratios but introduce latency. LZ4 instead delivers <em>instant compression</em>, fast enough to keep up with high-throughput pipelines, even on a single CPU core.</p>
<p>Used in:</p>
<ul>
<li>Databases: RocksDB, Cassandra, SQLite</li>
<li>Filesystems: Btrfs, ZFS</li>
<li>Serialization frameworks: Kafka, Arrow, Protobuf</li>
<li>Real-time systems: telemetry, log ingestion</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-87" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-87">How Does It Work (Plain Language)</h4>
<p>LZ4 is built around a match-copy model similar to LZ77, but optimized for simplicity.</p>
<ol type="1">
<li>Scan input and maintain a 64 KB sliding window.</li>
<li>Find repeated sequences in the recent history.</li>
<li>Encode data as literals (unmatched bytes) or matches (offset + length).</li>
<li>Each block encodes multiple segments in a compact binary format.</li>
</ol>
<p>A block is encoded as:</p>
<pre><code>[token][literals][offset][match_length]</code></pre>
<p>Where:</p>
<ul>
<li>The high 4 bits of <code>token</code> = literal length</li>
<li>The low 4 bits = match length (minus 4)</li>
<li>Offset = 2-byte backward distance</li>
</ul>
</section>
<section id="example-concept-flow-1" class="level4">
<h4 class="anchored" data-anchor-id="example-concept-flow-1">Example (Concept Flow)</h4>
<p>Original data:</p>
<pre><code>ABABABABABAB</code></pre>
<ul>
<li>First “AB” stored as literal.</li>
<li>Subsequent repetitions found at offset 2 → encoded as (offset=2, length=10).</li>
<li>Result: compact and near-instant to decompress.</li>
</ul>
</section>
<section id="tiny-code-python-prototype-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-prototype-1">Tiny Code (Python Prototype)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lz4_compress(data):</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> []</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(data):</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># emit literal block of up to 4 bytes</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>        lit_len <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, <span class="bu">len</span>(data) <span class="op">-</span> i)</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>        token <span class="op">=</span> lit_len <span class="op">&lt;&lt;</span> <span class="dv">4</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>        out.append(token)</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>        out.extend(data[i:i<span class="op">+</span>lit_len])</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> lit_len</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bytes</span>(out)</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lz4_decompress(data):</span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> []</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(data):</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>        token <span class="op">=</span> data[i]<span class="op">;</span> i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>        lit_len <span class="op">=</span> token <span class="op">&gt;&gt;</span> <span class="dv">4</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>        out.extend(data[i:i<span class="op">+</span>lit_len])</span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>        i <span class="op">+=</span> lit_len</span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bytes</span>(out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>(Simplified, real LZ4 includes match encoding and offsets.)</em></p>
</section>
<section id="tiny-code-c-example-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-example-1">Tiny Code (C Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb170"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;lz4.h&gt;</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>src <span class="op">=</span> <span class="st">"Hello Hello Hello Hello!"</span><span class="op">;</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> compressed<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> decompressed<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> csize <span class="op">=</span> LZ4_compress_default<span class="op">(</span>src<span class="op">,</span> compressed<span class="op">,</span> strlen<span class="op">(</span>src<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span>compressed<span class="op">));</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> dsize <span class="op">=</span> LZ4_decompress_safe<span class="op">(</span>compressed<span class="op">,</span> decompressed<span class="op">,</span> csize<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>decompressed<span class="op">));</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Original: </span><span class="sc">%zu</span><span class="st">, Compressed: </span><span class="sc">%d</span><span class="st">, Decompressed: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> strlen<span class="op">(</span>src<span class="op">),</span> csize<span class="op">,</span> dsize<span class="op">);</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-88" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-88">Why It Matters</h4>
<ul>
<li><p>Speed: One of the fastest compressors in the world.</p>
<ul>
<li>Compression: ~400–700 MB/s</li>
<li>Decompression: ~1500–2500 MB/s</li>
</ul></li>
<li><p>Deterministic: No entropy coding, minimal branching.</p></li>
<li><p>Cross-platform: Implementations in C, Rust, Go, Python, Java.</p></li>
<li><p>Streaming-friendly: Built-in frame and block APIs.</p></li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Lower compression ratio (1.5–2× typical).</li>
<li>Not entropy-coded, so redundancy beyond local scope is missed.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-78" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-78">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S = s_1, s_2, \dots, s_n\)</span> be the input string. LZ4 finds pairs <span class="math inline">\((o_i, \ell_i)\)</span> representing a match starting <span class="math inline">\(\ell_i\)</span> bytes long, <span class="math inline">\(o_i\)</span> bytes back.</p>
<p>The encoded stream alternates between literals and matches: <span class="math display">\[
S = L_1 + (o_1, \ell_1) + L_2 + (o_2, \ell_2) + \dots
\]</span></p>
<p>Since each <span class="math inline">\((o_i, \ell_i)\)</span> refers to previously emitted data, decoding is a simple linear pass. LZ4 ensures every byte is processed exactly once, giving <span class="math inline">\(O(n)\)</span> time for both compression and decompression.</p>
</section>
<section id="try-it-yourself-88" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-88">Try It Yourself</h4>
<ol type="1">
<li><p>Compare compression ratio of LZ4 vs gzip vs zstd.</p></li>
<li><p>Use <code>lz4 -1</code> and <code>lz4 -9</code> on large logs.</p></li>
<li><p>Enable block streaming mode:</p>
<pre><code>lz4 --block-size=256KB input.txt output.lz4</code></pre></li>
<li><p>Measure decompression speed for random data vs structured text.</p></li>
<li><p>Embed LZ4 into a database or cache to reduce I/O.</p></li>
</ol>
</section>
<section id="test-cases-88" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-88">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Input</th>
<th>Size</th>
<th>LZ4 Ratio</th>
<th>zstd Ratio</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Random text</td>
<td>100 KB</td>
<td>1.4×</td>
<td>2.6×</td>
<td>fast</td>
</tr>
<tr class="even">
<td>JSON logs</td>
<td>1 MB</td>
<td>1.8×</td>
<td>3.5×</td>
<td>moderate</td>
</tr>
<tr class="odd">
<td>Repetitive</td>
<td>500 KB</td>
<td>2.5×</td>
<td>3.0×</td>
<td>both good</td>
</tr>
<tr class="even">
<td>Binary</td>
<td>2 MB</td>
<td>1.2×</td>
<td>2.0×</td>
<td>little gain</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-88" class="level4">
<h4 class="anchored" data-anchor-id="complexity-88">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Compression</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Decompression</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>LZ4 is the Formula 1 of compression, minimal, fast, and engineered to stay ahead of every byte in flight.</p>
</section>
</section>
</section>
<section id="section-90.-fault-tolenrance-and-replication" class="level1">
<h1>Section 90. Fault tolenrance and Replication</h1>
<section id="primarybackup-replication" class="level3">
<h3 class="anchored" data-anchor-id="primarybackup-replication">891 Primary–Backup Replication</h3>
<p>Primary–Backup Replication (also called master–slave) is one of the simplest and most widely used methods to achieve fault tolerance and high availability in distributed systems. It maintains one primary node that handles all writes and one or more backup nodes that keep synchronized copies of the data.</p>
<section id="what-problem-are-we-solving-89" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-89">What Problem Are We Solving?</h4>
<p>In a distributed system or database, nodes can fail unexpectedly, due to crashes, network partitions, or maintenance. If there is only one copy of the data, a single failure means downtime or data loss.</p>
<p>Primary–backup replication ensures that:</p>
<ul>
<li>There is always a standby replica ready to take over.</li>
<li>Updates are replicated reliably from the primary to backups.</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-88" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-88">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Client sends a request (usually a write or transaction) to the primary node.</li>
<li>The primary executes the operation and logs the update.</li>
<li>It sends the update (or log entry) to the backup node(s).</li>
<li>Once all backups acknowledge, the primary commits the change.</li>
<li>If the primary fails, a backup is promoted to become the new primary.</li>
</ol>
</section>
<section id="message-flow-example" class="level4">
<h4 class="anchored" data-anchor-id="message-flow-example">Message Flow Example</h4>
<pre><code>Client → Primary → Backup
     (write request)
Primary → Backup: replicate(data)
Backup → Primary: ack
Primary → Client: success</code></pre>
<p>If the primary crashes, the system performs failover:</p>
<pre><code>Backup → becomes Primary
Clients → reconnect to new Primary</code></pre>
</section>
<section id="tiny-code-python-simulation-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-5">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node:</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name):</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_update(<span class="va">self</span>, data):</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log.append(data)</span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PrimaryBackup:</span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.primary <span class="op">=</span> Node(<span class="st">"Primary"</span>)</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backup <span class="op">=</span> Node(<span class="st">"Backup"</span>)</span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, data):</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[Primary] Writing: </span><span class="sc">{</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.primary.apply_update(data)</span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[Backup] Replicating..."</span>)</span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backup.apply_update(data)</span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"[ACK] Write complete and replicated"</span>)</span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>system <span class="op">=</span> PrimaryBackup()</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>system.write(<span class="st">"x = 10"</span>)</span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>system.write(<span class="st">"y = 20"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-1" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-1">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb175"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> replicate<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Replicating to backup: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>updates<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">"x=1"</span><span class="op">,</span> <span class="st">"y=2"</span><span class="op">,</span> <span class="st">"z=3"</span><span class="op">};</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Primary committing: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> updates<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>        replicate<span class="op">(</span>updates<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"All updates replicated successfully.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-89" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-89">Why It Matters</h4>
<ul>
<li>Simplicity: Easy to implement and reason about.</li>
<li>Availability: If one node fails, another can take over.</li>
<li>Durability: Backups ensure persistence across failures.</li>
<li>Used in: MySQL replication, ZooKeeper observers, Redis replication, PostgreSQL streaming replication.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Writes go through a single primary (bottleneck).</li>
<li>Failover can cause temporary unavailability.</li>
<li>Replication lag may lead to stale reads.</li>
<li>Split-brain risk if multiple nodes think they are primary.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-79" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-79">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S_p\)</span> be the state of the primary and <span class="math inline">\(S_b\)</span> the state of the backup.</p>
<p>For each write operation <span class="math inline">\(w_i\)</span>: <span class="math display">\[
S_p = S_p \cup {w_i}, \quad S_b = S_b \cup {w_i}
\]</span></p>
<p>If replication is synchronous, then: <span class="math display">\[
S_p = S_b \quad \forall i
\]</span></p>
<p>If asynchronous, there exists a lag <span class="math inline">\(\Delta\)</span> such that: <span class="math display">\[
|S_p| - |S_b| \leq \Delta
\]</span></p>
<p>In the event of a primary failure, the backup can safely resume if <span class="math inline">\(\Delta = 0\)</span> or recover up to the last replicated state.</p>
</section>
<section id="try-it-yourself-89" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-89">Try It Yourself</h4>
<ol type="1">
<li>Simulate primary–backup with two processes.</li>
<li>Introduce failure before backup receives an update.</li>
<li>Measure data loss under asynchronous mode.</li>
<li>Add heartbeats for failover detection.</li>
<li>Implement synchronous replication (wait for ack).</li>
</ol>
</section>
<section id="test-cases-89" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-89">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Mode</th>
<th>Replication</th>
<th>Failure Loss</th>
<th>Latency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Synchronous</td>
<td>Immediate</td>
<td>None</td>
<td>Higher</td>
</tr>
<tr class="even">
<td>Asynchronous</td>
<td>Deferred</td>
<td>Possible</td>
<td>Lower</td>
</tr>
<tr class="odd">
<td>Semi-sync</td>
<td>Bounded delay</td>
<td>Minimal</td>
<td>Moderate</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-89" class="level4">
<h4 class="anchored" data-anchor-id="complexity-89">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Write (sync)</td>
<td><span class="math inline">\(O(n)\)</span> for n replicas</td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Read</td>
<td><span class="math inline">\(O(1)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="odd">
<td>Failover</td>
<td><span class="math inline">\(O(1)\)</span> detection</td>
<td><span class="math inline">\(O(1)\)</span> recovery</td>
</tr>
</tbody>
</table>
<p>Primary–backup replication is the first building block of reliable systems, simple, strong, and always ready to hand over the torch when one node goes dark.</p>
</section>
</section>
<section id="quorum-replication" class="level3">
<h3 class="anchored" data-anchor-id="quorum-replication">892 Quorum Replication</h3>
<p>Quorum Replication is a distributed consistency protocol that balances availability, fault tolerance, and consistency by requiring only a subset (a <em>quorum</em>) of replicas to agree before an operation succeeds. It is the backbone of modern distributed databases like Cassandra, DynamoDB, and MongoDB.</p>
<section id="what-problem-are-we-solving-90" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-90">What Problem Are We Solving?</h4>
<p>In fully replicated systems, every write must reach all nodes, which becomes slow or impossible when some nodes fail or are unreachable. Quorum replication ensures correctness even when part of the system is down, as long as enough nodes agree.</p>
<p>The idea:</p>
<ul>
<li>Not every replica must respond, just <em>enough to form a quorum</em>.</li>
<li>The quorum intersection guarantees consistency.</li>
</ul>
</section>
<section id="how-does-it-work-plain-language-89" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-89">How Does It Work (Plain Language)</h4>
<p>Let there be N replicas. Each operation requires contacting a subset of them:</p>
<ul>
<li>R: number of replicas needed for a read</li>
<li>W: number of replicas needed for a write</li>
</ul>
<p>Consistency is guaranteed when: <span class="math display">\[
R + W &gt; N
\]</span></p>
<p>This ensures that every read overlaps with the latest write on at least one replica.</p>
<p>Example:</p>
<ul>
<li><span class="math inline">\(N = 3\)</span> replicas</li>
<li>Choose <span class="math inline">\(W = 2\)</span>, <span class="math inline">\(R = 2\)</span> Then:</li>
<li>A write succeeds if 2 replicas confirm.</li>
<li>A read succeeds if it hears from 2 replicas.</li>
<li>They overlap → always see the newest data.</li>
</ul>
</section>
<section id="example-flow-1" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-1">Example Flow</h4>
<ol type="1">
<li>Client writes value <code>x = 10</code> → send to all N nodes.</li>
<li>Wait for W acknowledgments → commit.</li>
<li>Client reads → query all N nodes, wait for R responses.</li>
<li>Resolve conflicts (if any) using latest timestamp or version vector.</li>
</ol>
</section>
<section id="tiny-code-python-simulation-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-6">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>N, R, W <span class="op">=</span> <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>replicas <span class="op">=</span> [{<span class="st">"v"</span>: <span class="va">None</span>, <span class="st">"ts"</span>: <span class="dv">0</span>} <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(N)]</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write(value, ts):</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>    acks <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> replicas:</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> random.random() <span class="op">&lt;</span> <span class="fl">0.9</span>:  <span class="co"># simulate success</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>            r[<span class="st">"v"</span>], r[<span class="st">"ts"</span>] <span class="op">=</span> value, ts</span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>            acks <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> acks <span class="op">&gt;=</span> W</span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read():</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>    responses <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>        [r <span class="cf">for</span> r <span class="kw">in</span> replicas <span class="cf">if</span> random.random() <span class="op">&lt;</span> <span class="fl">0.9</span>],</span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>        key<span class="op">=</span><span class="kw">lambda</span> r: r[<span class="st">"ts"</span>],</span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>        reverse<span class="op">=</span><span class="va">True</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> responses[<span class="dv">0</span>][<span class="st">"v"</span>] <span class="cf">if</span> <span class="bu">len</span>(responses) <span class="op">&gt;=</span> R <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a>write(<span class="st">"alpha"</span>, <span class="dv">1</span>)</span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Read:"</span>, read())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-2" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-2">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb177"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define N </span><span class="dv">3</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define R </span><span class="dv">2</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define W </span><span class="dv">2</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> <span class="dt">int</span> value<span class="op">;</span> <span class="dt">int</span> ts<span class="op">;</span> <span class="op">}</span> Replica<span class="op">;</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>Replica replicas<span class="op">[</span>N<span class="op">];</span></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> write_quorum<span class="op">(</span><span class="dt">int</span> value<span class="op">,</span> <span class="dt">int</span> ts<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> acks <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>        replicas<span class="op">[</span>i<span class="op">].</span>value <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>        replicas<span class="op">[</span>i<span class="op">].</span>ts <span class="op">=</span> ts<span class="op">;</span></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>        acks<span class="op">++;</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> acks <span class="op">&gt;=</span> W<span class="op">;</span></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> read_quorum<span class="op">()</span> <span class="op">{</span></span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> latest <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>replicas<span class="op">[</span>i<span class="op">].</span>ts <span class="op">&gt;</span> latest<span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a>            latest <span class="op">=</span> replicas<span class="op">[</span>i<span class="op">].</span>ts<span class="op">;</span></span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> replicas<span class="op">[</span>i<span class="op">].</span>value<span class="op">;</span></span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value<span class="op">;</span></span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb177-30"><a href="#cb177-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-31"><a href="#cb177-31" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb177-32"><a href="#cb177-32" aria-hidden="true" tabindex="-1"></a>    write_quorum<span class="op">(</span><span class="dv">42</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb177-33"><a href="#cb177-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Read quorum value: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> read_quorum<span class="op">());</span></span>
<span id="cb177-34"><a href="#cb177-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-90" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-90">Why It Matters</h4>
<ul>
<li>Fault-tolerance: system works even if <span class="math inline">\((N - W)\)</span> nodes are down.</li>
<li>Scalability: can trade off between latency and consistency.</li>
<li>Consistency guarantee: intersection between R and W sets ensures no stale reads.</li>
<li>Used in: Amazon Dynamo, Cassandra, Riak, MongoDB replica sets.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Large quorums → higher latency.</li>
<li>Small quorums → risk of stale reads.</li>
<li>Need conflict resolution for concurrent writes.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-80" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-80">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(W\)</span> be the number of replicas required for a write and <span class="math inline">\(R\)</span> for a read.</p>
<p>To guarantee that every read sees the latest write: <span class="math display">\[
R + W &gt; N
\]</span></p>
<p>This ensures any two quorums (one write, one read) intersect in at least one node: <span class="math display">\[
|Q_r \cap Q_w| \ge 1
\]</span></p>
<p>That intersection node always carries the most recent value, propagating consistency.</p>
<p>If <span class="math inline">\(R + W \le N\)</span>, two disjoint quorums could exist, causing stale reads.</p>
</section>
<section id="try-it-yourself-90" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-90">Try It Yourself</h4>
<ol type="1">
<li><p>Simulate a cluster with <span class="math inline">\(N = 5\)</span>.</p></li>
<li><p>Set different quorum pairs:</p>
<ul>
<li><span class="math inline">\(R=3\)</span>, <span class="math inline">\(W=3\)</span> → strong consistency</li>
<li><span class="math inline">\(R=1\)</span>, <span class="math inline">\(W=3\)</span> → fast reads</li>
<li><span class="math inline">\(R=3\)</span>, <span class="math inline">\(W=1\)</span> → fast writes</li>
</ul></li>
<li><p>Inject random failures or slow nodes.</p></li>
<li><p>Verify which reads remain consistent.</p></li>
</ol>
</section>
<section id="test-cases-90" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-90">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>N</th>
<th>R</th>
<th>W</th>
<th>Condition</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>2</td>
<td>2</td>
<td>R + W &gt; N</td>
<td>Consistent</td>
</tr>
<tr class="even">
<td>3</td>
<td>1</td>
<td>1</td>
<td>R + W ≤ N</td>
<td>Stale reads possible</td>
</tr>
<tr class="odd">
<td>5</td>
<td>3</td>
<td>3</td>
<td>Strong consistency</td>
<td>High latency</td>
</tr>
<tr class="even">
<td>5</td>
<td>1</td>
<td>4</td>
<td>Fast read, slower write</td>
<td>Available</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-90" class="level4">
<h4 class="anchored" data-anchor-id="complexity-90">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Write</td>
<td><span class="math inline">\(O(W)\)</span></td>
<td><span class="math inline">\(O(N)\)</span></td>
</tr>
<tr class="even">
<td>Read</td>
<td><span class="math inline">\(O(R)\)</span></td>
<td><span class="math inline">\(O(N)\)</span></td>
</tr>
<tr class="odd">
<td>Recovery</td>
<td><span class="math inline">\(O(N)\)</span></td>
<td><span class="math inline">\(O(N)\)</span></td>
</tr>
</tbody>
</table>
<p>Quorum replication elegantly balances the impossible triangle of distributed systems, consistency, availability, and partition tolerance, by choosing how much agreement is <em>enough</em>.</p>
</section>
</section>
<section id="chain-replication-1" class="level3">
<h3 class="anchored" data-anchor-id="chain-replication-1">893 Chain Replication</h3>
<p>Chain Replication is a fault-tolerant replication technique designed for strong consistency and high throughput in distributed storage systems. It organizes replicas into a linear chain, where writes flow from head to tail and reads are served from the tail.</p>
<section id="what-problem-are-we-solving-91" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-91">What Problem Are We Solving?</h4>
<p>Traditional replication models either sacrifice consistency (as in asynchronous replication) or throughput (as in synchronous broadcast to all replicas). Chain replication provides both linearizability and high throughput by structuring replicas into a pipeline.</p>
</section>
<section id="how-does-it-work-plain-language-90" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-90">How Does It Work (Plain Language)</h4>
<p>The replicas are ordered:</p>
<pre><code>[Head] → [Middle] → [Tail]</code></pre>
<ul>
<li>Writes start at the head and are forwarded down the chain.</li>
<li>Each replica applies the update and forwards it.</li>
<li>When the tail applies the update, it acknowledges success to the client.</li>
<li>Reads go to the tail, ensuring clients always see the most recent committed state.</li>
</ul>
</section>
<section id="example-flow-2" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-2">Example Flow</h4>
<p>Write sequence for <code>x = 10</code>:</p>
<pre><code>Client → Head: write(x=10)
Head → Middle: forward(x=10)
Middle → Tail: forward(x=10)
Tail → Client: ACK</code></pre>
<p>Read sequence:</p>
<pre><code>Client → Tail: read(x)
Tail → Client: return latest value</code></pre>
</section>
<section id="tiny-code-python-simulation-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-7">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node:</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name):</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> <span class="va">None</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">next</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, value):</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> value</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">: wrote </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.<span class="bu">next</span>:</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.<span class="bu">next</span>.write(value)</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChainReplication:</span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> Node(<span class="st">"Head"</span>)</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>        mid <span class="op">=</span> Node(<span class="st">"Middle"</span>)</span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tail <span class="op">=</span> Node(<span class="st">"Tail"</span>)</span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head.<span class="bu">next</span> <span class="op">=</span> mid</span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>        mid.<span class="bu">next</span> <span class="op">=</span> <span class="va">self</span>.tail</span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, value):</span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Client writes:"</span>, value)</span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head.write(value)</span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Tail acknowledges.</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read(<span class="va">self</span>):</span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Read from Tail:"</span>, <span class="va">self</span>.tail.value)</span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tail.value</span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> ChainReplication()</span>
<span id="cb181-31"><a href="#cb181-31" aria-hidden="true" tabindex="-1"></a>chain.write(<span class="dv">42</span>)</span>
<span id="cb181-32"><a href="#cb181-32" aria-hidden="true" tabindex="-1"></a>chain.read()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-3" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-3">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb182"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> replicate_chain<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Head received write: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Forwarded to Middle: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Forwarded to Tail: </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Tail acknowledged write.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>    replicate_chain<span class="op">(</span><span class="st">"x=10"</span><span class="op">);</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-91" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-91">Why It Matters</h4>
<ul>
<li>Strong consistency: all reads reflect the latest committed write.</li>
<li>High throughput: each replica only talks to one neighbor.</li>
<li>Predictable flow: updates move deterministically along the chain.</li>
<li>Used in: FAWN-KV, Microsoft’s PacificA, and distributed log systems.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Single chain → potential bottleneck at head or tail.</li>
<li>Failover requires reconfiguration.</li>
<li>Write latency increases with chain length.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-81" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-81">A Gentle Proof (Why It Works)</h4>
<p>Let replicas be <span class="math inline">\(R_1, R_2, \dots, R_n\)</span>.</p>
<p>For any write <span class="math inline">\(w_i\)</span>:</p>
<p><span class="math display">\[
R_1 \xrightarrow[]{w_i} R_2 \xrightarrow[]{w_i} \dots \xrightarrow[]{w_i} R_n
\]</span></p>
<p>All writes follow the same order, and reads only occur at <span class="math inline">\(R_n\)</span>. Therefore, all reads observe a prefix of the write sequence, satisfying linearizability.</p>
<p>Formally, if <span class="math inline">\(w_i\)</span> completes before <span class="math inline">\(w_j\)</span>, then:</p>
<p><span class="math display">\[
w_i \text{ visible at all replicas before } w_j
\]</span></p>
<p>Hence, clients never see stale or out-of-order data.</p>
</section>
<section id="try-it-yourself-91" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-91">Try It Yourself</h4>
<ol type="1">
<li>Simulate a chain of 3 nodes and inject a write failure at the middle node.</li>
<li>Reconfigure the chain to bypass the failed node.</li>
<li>Measure throughput vs.&nbsp;synchronous replication to all nodes.</li>
<li>Extend to 5 nodes and observe write latency growth.</li>
</ol>
</section>
<section id="test-cases-91" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-91">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Nodes</th>
<th>Writes/Second</th>
<th>Latency</th>
<th>Consistency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>High</td>
<td>Moderate</td>
<td>Strong</td>
</tr>
<tr class="even">
<td>5</td>
<td>Moderate</td>
<td>Higher</td>
<td>Strong</td>
</tr>
<tr class="odd">
<td>3 (head failure)</td>
<td>Reconfig needed</td>
<td>Paused</td>
<td>Recoverable</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-91" class="level4">
<h4 class="anchored" data-anchor-id="complexity-91">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Write</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Read</td>
<td><span class="math inline">\(O(1)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="odd">
<td>Reconfiguration</td>
<td><span class="math inline">\(O(1)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Chain Replication turns replication into a well-ordered pipeline, each node a link in the chain of reliability, ensuring that data flows smoothly and consistently from start to finish.</p>
</section>
</section>
<section id="gossip-protocol" class="level3">
<h3 class="anchored" data-anchor-id="gossip-protocol">894 Gossip Protocol</h3>
<p>Gossip Protocol, also known as epidemic communication, is a decentralized mechanism for spreading information in distributed systems. Instead of a central coordinator, every node periodically “gossips” with random peers to exchange updates, like how rumors spread in a crowd.</p>
<section id="what-problem-are-we-solving-92" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-92">What Problem Are We Solving?</h4>
<p>In large, unreliable networks, we need a way for all nodes to eventually learn about new data, failures, or configuration changes. Broadcasting to every node is too costly and centralized coordination doesn’t scale. Gossip protocols achieve eventual consistency with probabilistic guarantees and minimal coordination.</p>
</section>
<section id="how-does-it-work-plain-language-91" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-91">How Does It Work (Plain Language)</h4>
<p>Each node keeps a local state (like membership info, key-value pairs, or version vectors). At regular intervals:</p>
<ol type="1">
<li>A node randomly picks another node.</li>
<li>They exchange updates (push, pull, or both).</li>
<li>Each merges what it learns.</li>
<li>Repeat until all nodes converge to the same state.</li>
</ol>
<p>After a few rounds, nearly all nodes in the system will have consistent information, similar to viral spread.</p>
</section>
<section id="gossip-styles" class="level4">
<h4 class="anchored" data-anchor-id="gossip-styles">Gossip Styles</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Push</td>
<td>Send updates to a random peer.</td>
</tr>
<tr class="even">
<td>Pull</td>
<td>Ask peers for missing updates.</td>
</tr>
<tr class="odd">
<td>Push–Pull</td>
<td>Exchange both ways, fastest convergence.</td>
</tr>
</tbody>
</table>
</section>
<section id="example-membership-gossip" class="level4">
<h4 class="anchored" data-anchor-id="example-membership-gossip">Example: Membership Gossip</h4>
<p>Nodes maintain a list of members with timestamps or heartbeats.</p>
<p>Each gossip round:</p>
<pre><code>Node A → Node B:
{ NodeC: alive, NodeD: suspect }</code></pre>
<p>Node B merges this information into its own list and gossips it further.</p>
<p>After several rounds, the entire cluster agrees on which nodes are alive or failed.</p>
</section>
<section id="tiny-code-python-simulation-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-8">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> {</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>: {<span class="st">"x"</span>: <span class="dv">0</span>},</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B"</span>: {<span class="st">"x"</span>: <span class="dv">0</span>},</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>: {<span class="st">"x"</span>: <span class="dv">0</span>}</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gossip_round():</span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> node <span class="kw">in</span> <span class="bu">list</span>(nodes.keys()):</span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>        peer <span class="op">=</span> random.choice(<span class="bu">list</span>(nodes.keys()))</span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> peer <span class="op">!=</span> node:</span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># merge information</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>            nodes[peer][<span class="st">"x"</span>] <span class="op">=</span> nodes[node][<span class="st">"x"</span>]</span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a><span class="co"># node A updates data</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>nodes[<span class="st">"A"</span>][<span class="st">"x"</span>] <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>    gossip_round()</span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(nodes)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This simple simulation shows that after a few rounds, all nodes converge to the same value.</p>
</section>
<section id="tiny-code-c-sketch-4" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-4">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb185"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define N </span><span class="dv">3</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> state<span class="op">[</span>N<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> gossip_round<span class="op">()</span> <span class="op">{</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> peer <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> N<span class="op">;</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>peer <span class="op">!=</span> i<span class="op">)</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>            state<span class="op">[</span>peer<span class="op">]</span> <span class="op">=</span> state<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>    srand<span class="op">(</span>time<span class="op">(</span>NULL<span class="op">));</span></span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> gossip_round<span class="op">();</span></span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> N<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">"Node </span><span class="sc">%d</span><span class="st"> state: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> i<span class="op">,</span> state<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-92" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-92">Why It Matters</h4>
<ul>
<li>Scalable: Works with thousands of nodes.</li>
<li>Fault-tolerant: No single point of failure.</li>
<li>Probabilistic efficiency: Fast convergence with low network cost.</li>
<li>Widely used in: Cassandra, Dynamo, Redis Cluster, Akka, Serf, Consul.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Convergence is probabilistic, not deterministic.</li>
<li>Possible temporary inconsistencies.</li>
<li>Gossip traffic can grow if update frequency is too high.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-82" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-82">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(n\)</span> be the number of nodes and <span class="math inline">\(t\)</span> the number of gossip rounds. Each node randomly contacts another node per round.</p>
<p>The expected number of informed nodes grows exponentially: <span class="math display">\[
I_t = n \left(1 - e^{-t/n}\right)
\]</span></p>
<p>After <span class="math inline">\(O(\log n)\)</span> rounds, almost all nodes are informed, similar to how epidemics spread through a population. This gives eventual consistency with high probability.</p>
</section>
<section id="try-it-yourself-92" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-92">Try It Yourself</h4>
<ol type="1">
<li>Start with 10 nodes and let 1 node have new data.</li>
<li>Run gossip for several rounds; track convergence time.</li>
<li>Experiment with push-only vs push–pull.</li>
<li>Add random failures to test resilience.</li>
<li>Tune gossip interval to balance speed and bandwidth.</li>
</ol>
</section>
<section id="test-cases-92" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-92">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Nodes</th>
<th>Gossip Style</th>
<th>Convergence Rounds</th>
<th>Reliability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>Push</td>
<td>~7</td>
<td>95%</td>
</tr>
<tr class="even">
<td>10</td>
<td>Push–Pull</td>
<td>~4</td>
<td>100%</td>
</tr>
<tr class="odd">
<td>100</td>
<td>Push–Pull</td>
<td>~9</td>
<td>99%</td>
</tr>
<tr class="even">
<td>1000</td>
<td>Push–Pull</td>
<td>~14</td>
<td>99.9%</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-92" class="level4">
<h4 class="anchored" data-anchor-id="complexity-92">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Messages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Per gossip round</td>
<td><span class="math inline">\(O(1)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Convergence</td>
<td><span class="math inline">\(O(\log n)\)</span></td>
<td><span class="math inline">\(O(n \log n)\)</span></td>
</tr>
</tbody>
</table>
<p>Gossip Protocol transforms chaos into harmony, each node sharing whispers until the entire system hums with the same truth.</p>
</section>
</section>
<section id="anti-entropy-repair" class="level3">
<h3 class="anchored" data-anchor-id="anti-entropy-repair">895 Anti-Entropy Repair</h3>
<p>Anti-Entropy Repair is a background process that keeps replicated data consistent across nodes in a distributed system. It detects and reconciles differences between replicas, ensuring eventual consistency even when updates or failures cause divergence.</p>
<section id="what-problem-are-we-solving-93" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-93">What Problem Are We Solving?</h4>
<p>In real distributed systems, nodes can miss updates due to:</p>
<ul>
<li>Network partitions</li>
<li>Temporary outages</li>
<li>Message loss</li>
</ul>
<p>Over time, replicas drift apart, their states diverge. Anti-entropy repair continuously compares replicas and syncs differences, restoring consistency without central coordination.</p>
</section>
<section id="how-does-it-work-plain-language-92" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-92">How Does It Work (Plain Language)</h4>
<p>Each node periodically selects another node and performs a reconciliation exchange.</p>
<p>There are two main steps:</p>
<ol type="1">
<li><p>Detect divergence Compare data digests (hashes, version vectors, Merkle trees).</p></li>
<li><p>Repair differences Send and merge missing or newer data items.</p></li>
</ol>
<p>This process continues in the background, slowly and continuously healing inconsistencies.</p>
</section>
<section id="example-flow-3" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-3">Example Flow</h4>
<pre><code>Node A ↔ Node B
Compare: digests or version vectors
If mismatch:
   A → B: send missing keys
   B → A: send newer values
Merge → both converge</code></pre>
<p>After multiple rounds, all replicas reach the same versioned state.</p>
</section>
<section id="techniques-used" class="level4">
<h4 class="anchored" data-anchor-id="techniques-used">Techniques Used</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>Technique</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Merkle Trees</td>
<td>Hierarchical hash comparison for large datasets</td>
</tr>
<tr class="even">
<td>Vector Clocks</td>
<td>Track causal order of updates</td>
</tr>
<tr class="odd">
<td>Timestamps</td>
<td>Choose latest version when conflicts occur</td>
</tr>
<tr class="even">
<td>Version Merging</td>
<td>Combine conflicting writes if possible</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-simulation-9" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-simulation-9">Tiny Code (Python Simulation)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hashlib <span class="im">import</span> md5</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> digest(data):</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> md5(<span class="st">""</span>.join(<span class="bu">sorted</span>(data)).encode()).hexdigest()</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> {<span class="st">"x"</span>: <span class="st">"1"</span>, <span class="st">"y"</span>: <span class="st">"2"</span>}</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> {<span class="st">"x"</span>: <span class="st">"1"</span>, <span class="st">"y"</span>: <span class="st">"3"</span>}</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> anti_entropy_repair(a, b):</span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> digest(a.values()) <span class="op">!=</span> digest(b.values()):</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> a:</span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> a[k] <span class="op">!=</span> b.get(k):</span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> a[k] <span class="op">&gt;</span> b.get(k, <span class="st">""</span>):</span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>                    b[k] <span class="op">=</span> a[k]</span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>                    a[k] <span class="op">=</span> b[k]</span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>anti_entropy_repair(A, B)</span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After repair:"</span>, A, B)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-5" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-5">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb188"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> KV <span class="op">{</span> <span class="dt">char</span> key<span class="op">[</span><span class="dv">10</span><span class="op">];</span> <span class="dt">char</span> val<span class="op">[</span><span class="dv">10</span><span class="op">];</span> <span class="op">};</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> repair<span class="op">(</span><span class="kw">struct</span> KV <span class="op">*</span>a<span class="op">,</span> <span class="kw">struct</span> KV <span class="op">*</span>b<span class="op">,</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>a<span class="op">[</span>i<span class="op">].</span>val<span class="op">,</span> b<span class="op">[</span>i<span class="op">].</span>val<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>            strcpy<span class="op">(</span>a<span class="op">[</span>i<span class="op">].</span>val<span class="op">,</span> b<span class="op">[</span>i<span class="op">].</span>val<span class="op">);</span> <span class="co">// simple merge rule</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> KV A<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="st">"1"</span><span class="op">},</span> <span class="op">{</span><span class="st">"y"</span><span class="op">,</span> <span class="st">"2"</span><span class="op">}};</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> KV B<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="st">"1"</span><span class="op">},</span> <span class="op">{</span><span class="st">"y"</span><span class="op">,</span> <span class="st">"3"</span><span class="op">}};</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>    repair<span class="op">(</span>A<span class="op">,</span> B<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"After repair: y=</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> A<span class="op">[</span><span class="dv">1</span><span class="op">].</span>val<span class="op">);</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-93" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-93">Why It Matters</h4>
<ul>
<li>Heals eventual consistency: Keeps data synchronized after failures.</li>
<li>Autonomous: Each node repairs independently, without global coordination.</li>
<li>Bandwidth-efficient: Uses hashes (Merkle trees) to minimize data transfer.</li>
<li>Used in: Amazon Dynamo, Cassandra, Riak, and other AP systems.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Background repairs consume bandwidth.</li>
<li>Conflicts require resolution logic.</li>
<li>Repair frequency affects freshness vs.&nbsp;overhead balance.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-83" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-83">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(S_i\)</span> and <span class="math inline">\(S_j\)</span> be the data sets at nodes <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. At time <span class="math inline">\(t\)</span>, they may differ: <span class="math display">\[
\Delta_{ij}(t) = S_i(t) \setminus S_j(t)
\]</span></p>
<p>Each anti-entropy session reduces divergence: <span class="math display">\[
|\Delta_{ij}(t+1)| &lt; |\Delta_{ij}(t)|
\]</span></p>
<p>Over repeated rounds, as long as the network eventually connects and repair continues: <span class="math display">\[
\lim_{t \to \infty} \Delta_{ij}(t) = \emptyset
\]</span></p>
<p>Thus, all replicas converge, ensuring eventual consistency.</p>
</section>
<section id="try-it-yourself-93" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-93">Try It Yourself</h4>
<ol type="1">
<li>Simulate three replicas with inconsistent states.</li>
<li>Implement a repair round using simple digest comparison.</li>
<li>Add random failures between rounds.</li>
<li>Observe convergence over multiple iterations.</li>
<li>Extend to Merkle tree comparison for large datasets.</li>
</ol>
</section>
<section id="test-cases-93" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-93">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Nodes</th>
<th>Repair Method</th>
<th>Converges In</th>
<th>Consistency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>Direct diff</td>
<td>1 round</td>
<td>Strong</td>
</tr>
<tr class="even">
<td>3</td>
<td>Pairwise gossip</td>
<td>~log(n) rounds</td>
<td>Eventual</td>
</tr>
<tr class="odd">
<td>100</td>
<td>Merkle trees</td>
<td>Few rounds</td>
<td>Eventual</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-93" class="level4">
<h4 class="anchored" data-anchor-id="complexity-93">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Bandwidth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Digest comparison</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Full repair</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="odd">
<td>Merkle repair</td>
<td><span class="math inline">\(O(\log n)\)</span></td>
<td><span class="math inline">\(O(\log n)\)</span></td>
</tr>
</tbody>
</table>
<p>Anti-Entropy Repair acts as the quiet caretaker of distributed systems, steadily walking the network, comparing notes, and making sure every replica tells the same story once again.</p>
</section>
</section>
<section id="erasure-coding" class="level3">
<h3 class="anchored" data-anchor-id="erasure-coding">896 Erasure Coding</h3>
<p>Erasure Coding is a fault-tolerance technique that protects data against loss by breaking it into fragments and adding redundant parity blocks. Unlike simple replication, it achieves the same reliability with much lower storage overhead, making it a cornerstone of modern distributed storage systems.</p>
<section id="what-problem-are-we-solving-94" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-94">What Problem Are We Solving?</h4>
<p>Replication (keeping 3 or more copies of each block) guarantees durability but wastes space. Erasure coding provides a mathematically efficient alternative that maintains redundancy while using fewer extra bytes.</p>
<p>Goal: If part of the data is lost, the system can reconstruct the original from a subset of fragments.</p>
</section>
<section id="how-does-it-work-plain-language-93" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-93">How Does It Work (Plain Language)</h4>
<p>Data is divided into k data blocks, and r parity blocks are generated using algebraic encoding. Together, these form n = k + r total fragments.</p>
<p>Any k out of n fragments can reconstruct the original data. Even if up to r fragments are lost, data remains recoverable.</p>
<p>Example: For a (6, 4) code:</p>
<ul>
<li>4 data blocks</li>
<li>2 parity blocks</li>
<li>Can tolerate 2 failures</li>
<li>Storage overhead = 6/4 = 1.5× (vs.&nbsp;3× replication)</li>
</ul>
</section>
<section id="visual-example" class="level4">
<h4 class="anchored" data-anchor-id="visual-example">Visual Example</h4>
<pre><code>Original Data: [D1, D2, D3, D4]

Encoded:
  D1, D2, D3, D4 → P1, P2

Fragments stored:
  Node1: D1
  Node2: D2
  Node3: D3
  Node4: D4
  Node5: P1
  Node6: P2</code></pre>
<p>If Node2 and Node4 fail, data can still be reconstructed from the others.</p>
</section>
<section id="tiny-code-python-example-18" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-18">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode(data_blocks, r):</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">len</span>(data_blocks)</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> np.array(data_blocks)</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    parity <span class="op">=</span> [<span class="bu">sum</span>(data) <span class="op">%</span> <span class="dv">256</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(r)]  <span class="co"># simple XOR parity</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_blocks <span class="op">+</span> parity</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode(blocks, k):</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(blocks) <span class="op">&gt;=</span> k:</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(blocks[:k]) <span class="op">%</span> <span class="dv">256</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>blocks <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>]</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> encode(blocks, <span class="dv">2</span>)</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoded:"</span>, encoded)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This is a toy example; real systems use linear algebra over finite fields (e.g., Reed–Solomon codes).</p>
</section>
<section id="tiny-code-c-sketch-6" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-6">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb191"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> parity<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> p <span class="op">^=</span> data<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> data<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">};</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> p <span class="op">=</span> parity<span class="op">(</span>data<span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Parity block: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> p<span class="op">);</span></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-94" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-94">Why It Matters</h4>
<ul>
<li>Storage-efficient durability: 50–70% less overhead than replication.</li>
<li>Fault tolerance: Can recover from multiple failures.</li>
<li>Used in: Hadoop HDFS, Ceph, MinIO, Google Colossus, Azure Storage.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Higher CPU cost for encoding/decoding.</li>
<li>Rebuilding lost data requires multiple fragments.</li>
<li>Latency increases during repair.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-84" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-84">A Gentle Proof (Why It Works)</h4>
<p>Erasure coding relies on linear independence of encoded fragments.</p>
<p>Let original data be a vector: <span class="math display">\[
\mathbf{d} = [d_1, d_2, \dots, d_k]
\]</span></p>
<p>Encoding matrix <span class="math inline">\(G\)</span> (size <span class="math inline">\(k \times n\)</span>) produces fragments: <span class="math display">\[
\mathbf{c} = \mathbf{d} G
\]</span></p>
<p>As long as any <span class="math inline">\(k\)</span> columns of <span class="math inline">\(G\)</span> are linearly independent, we can recover <span class="math inline">\(\mathbf{d}\)</span> by solving: <span class="math display">\[
\mathbf{d} = \mathbf{c} G^{-1}
\]</span></p>
<p>Thus, even with <span class="math inline">\(r = n - k\)</span> missing fragments, recovery is guaranteed.</p>
</section>
<section id="try-it-yourself-94" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-94">Try It Yourself</h4>
<ol type="1">
<li>Create 4 data chunks, 2 parity chunks.</li>
<li>Delete any 2 randomly, reconstruct using the remaining 4.</li>
<li>Measure recovery time as system scales.</li>
<li>Compare storage efficiency with 3× replication.</li>
<li>Experiment with Reed–Solomon libraries in Python (<code>pyreedsolomon</code> or <code>zfec</code>).</li>
</ol>
</section>
<section id="test-cases-94" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-94">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Scheme</th>
<th>Data (k)</th>
<th>Parity (r)</th>
<th>Tolerates</th>
<th>Overhead</th>
<th>Example Use</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>(3, 2)</td>
<td>3</td>
<td>2</td>
<td>2 failures</td>
<td>1.67×</td>
<td>Ceph</td>
</tr>
<tr class="even">
<td>(6, 3)</td>
<td>6</td>
<td>3</td>
<td>3 failures</td>
<td>1.5×</td>
<td>MinIO</td>
</tr>
<tr class="odd">
<td>(10, 4)</td>
<td>10</td>
<td>4</td>
<td>4 failures</td>
<td>1.4×</td>
<td>Azure Storage</td>
</tr>
<tr class="even">
<td>3× Replication</td>
<td>1</td>
<td>2</td>
<td>2 failures</td>
<td>3×</td>
<td>Simple systems</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-94" class="level4">
<h4 class="anchored" data-anchor-id="complexity-94">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Encode</td>
<td><span class="math inline">\(O(k \times r)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="even">
<td>Decode</td>
<td><span class="math inline">\(O(k^3)\)</span> (matrix inversion)</td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="odd">
<td>Repair</td>
<td><span class="math inline">\(O(k)\)</span></td>
<td><span class="math inline">\(O(k)\)</span></td>
</tr>
</tbody>
</table>
<p>Erasure Coding turns mathematics into resilience, it weaves parity from data, allowing a system to lose pieces without ever losing the whole.</p>
</section>
</section>
<section id="checksum-verification" class="level3">
<h3 class="anchored" data-anchor-id="checksum-verification">897 Checksum Verification</h3>
<p>Checksum Verification is a lightweight integrity algorithm that detects data corruption during storage or transmission. It works by computing a compact numeric fingerprint (the checksum) of data and verifying it whenever the data is read or received.</p>
<section id="what-problem-are-we-solving-95" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-95">What Problem Are We Solving?</h4>
<p>When data moves across disks, memory, or networks, it can silently change due to:</p>
<ul>
<li>Bit flips</li>
<li>Transmission noise</li>
<li>Hardware faults</li>
<li>Software bugs</li>
</ul>
<p>Even a single wrong bit can make entire files invalid. Checksum verification ensures we can detect corruption quickly, often before it causes harm.</p>
</section>
<section id="how-does-it-work-plain-language-94" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-94">How Does It Work (Plain Language)</h4>
<ol type="1">
<li>Compute a checksum for the data before sending or saving.</li>
<li>Store or transmit both the data and checksum.</li>
<li>Recompute and compare the checksum when reading or receiving.</li>
<li>If the two values differ → the data is corrupted.</li>
</ol>
<p>Checksums use simple arithmetic, hash functions, or cyclic redundancy checks (CRC).</p>
</section>
<section id="common-algorithms" class="level4">
<h4 class="anchored" data-anchor-id="common-algorithms">Common Algorithms</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 32%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th>Type</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sum / XOR</td>
<td>Adds or XORs all bytes</td>
<td>Fast, simple, low accuracy</td>
</tr>
<tr class="even">
<td>CRC (Cyclic Redundancy Check)</td>
<td>Polynomial division over bits</td>
<td>Networking, filesystems</td>
</tr>
<tr class="odd">
<td>MD5 / SHA</td>
<td>Cryptographic hash</td>
<td>Secure verification</td>
</tr>
<tr class="even">
<td>Fletcher / Adler</td>
<td>Weighted modular sums</td>
<td>Embedded systems</td>
</tr>
</tbody>
</table>
</section>
<section id="example-11" class="level4">
<h4 class="anchored" data-anchor-id="example-11">Example</h4>
<p>Data: <code>"HELLO"</code></p>
<p>Compute simple checksum: <span class="math display">\[
\text{sum} = H + E + L + L + O = 72 + 69 + 76 + 76 + 79 = 372
\]</span></p>
<p>Store <code>(data, checksum=372)</code></p>
<p>When reading, recompute:</p>
<ul>
<li>If <code>sum == 372</code> → valid</li>
<li>Else → corrupted</li>
</ul>
</section>
<section id="tiny-code-python-example-19" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-19">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zlib</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="st">b"HELLO WORLD"</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>checksum <span class="op">=</span> zlib.crc32(data)</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Checksum:"</span>, checksum)</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate transmission error</span></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>received <span class="op">=</span> <span class="st">b"HELLO WORLE"</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Valid?"</span> , zlib.crc32(received) <span class="op">==</span> checksum)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-7" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-7">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb193"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> simple_checksum<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>s<span class="op">)</span> sum <span class="op">+=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)(*</span>s<span class="op">++);</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sum<span class="op">;</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>data <span class="op">=</span> <span class="st">"HELLO"</span><span class="op">;</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> c1 <span class="op">=</span> simple_checksum<span class="op">(</span>data<span class="op">);</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Checksum: </span><span class="sc">%u\n</span><span class="st">"</span><span class="op">,</span> c1<span class="op">);</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>bad <span class="op">=</span> <span class="st">"HELLP"</span><span class="op">;</span> <span class="co">// corrupted</span></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> c2 <span class="op">=</span> simple_checksum<span class="op">(</span>bad<span class="op">);</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Corrupted? </span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> c1 <span class="op">==</span> c2 <span class="op">?</span> <span class="st">"no"</span> <span class="op">:</span> <span class="st">"yes"</span><span class="op">);</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-95" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-95">Why It Matters</h4>
<ul>
<li>Detects silent corruption on disk, memory, or network.</li>
<li>Protects storage systems (HDFS, ZFS, Ceph, S3).</li>
<li>Prevents undetected data drift in replication pipelines.</li>
<li>Simple to compute, easy to verify.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Cannot <em>repair</em> data, only detect errors.</li>
<li>Weak checksums (like XOR) may miss certain patterns.</li>
<li>Cryptographic hashes cost more CPU time.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-85" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-85">A Gentle Proof (Why It Works)</h4>
<p>A checksum function <span class="math inline">\(f(x)\)</span> maps data <span class="math inline">\(x\)</span> to a compact signature.</p>
<p>If data <span class="math inline">\(x\)</span> is corrupted to <span class="math inline">\(x'\)</span>, we detect the error when: <span class="math display">\[
f(x) \ne f(x')
\]</span></p>
<p>If <span class="math inline">\(f\)</span> distributes values uniformly across <span class="math inline">\(k\)</span> bits, the probability of undetected corruption is approximately: <span class="math display">\[
P_{\text{miss}} = 2^{-k}
\]</span></p>
<p>For example:</p>
<ul>
<li>16-bit checksum → <span class="math inline">\(1/65536\)</span> chance of miss</li>
<li>32-bit CRC → <span class="math inline">\(1/4,294,967,296\)</span></li>
<li>SHA-256 → effectively zero</li>
</ul>
</section>
<section id="try-it-yourself-95" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-95">Try It Yourself</h4>
<ol type="1">
<li>Compute CRC32 for any file.</li>
<li>Flip a single byte and recompute, observe checksum change.</li>
<li>Try different algorithms (MD5, SHA-1, Adler-32).</li>
<li>Compare speed vs reliability.</li>
<li>Integrate checksum into a replication or transfer pipeline.</li>
</ol>
</section>
<section id="test-cases-95" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-95">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Algorithm</th>
<th>Bits</th>
<th>Detection Rate</th>
<th>Typical Use</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sum</td>
<td>8</td>
<td>Low</td>
<td>Legacy systems</td>
</tr>
<tr class="even">
<td>CRC32</td>
<td>32</td>
<td>Excellent</td>
<td>Network packets</td>
</tr>
<tr class="odd">
<td>MD5</td>
<td>128</td>
<td>Very high</td>
<td>File integrity</td>
</tr>
<tr class="even">
<td>SHA-256</td>
<td>256</td>
<td>Near perfect</td>
<td>Secure verification</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-95" class="level4">
<h4 class="anchored" data-anchor-id="complexity-95">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Compute</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Verify</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
</tbody>
</table>
<p>Checksum Verification is the simplest form of data trust, a small number that quietly guards against invisible corruption, ensuring what you store or send is exactly what you get back.</p>
</section>
</section>
<section id="heartbeat-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="heartbeat-monitoring">898 Heartbeat Monitoring</h3>
<p>Heartbeat Monitoring is a simple yet essential distributed algorithm for failure detection, it helps systems know which nodes are alive and which have silently failed. By periodically sending “heartbeat” signals between nodes, the system can quickly detect when one stops responding and trigger recovery or failover actions.</p>
<section id="what-problem-are-we-solving-96" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-96">What Problem Are We Solving?</h4>
<p>In distributed systems, nodes can fail for many reasons:</p>
<ul>
<li>Power or network loss</li>
<li>Process crashes</li>
<li>Partition or congestion</li>
</ul>
<p>Without explicit detection, the system might continue sending requests to a dead node or leave data unavailable. Heartbeat monitoring provides a lightweight, continuous liveness check to detect failures automatically.</p>
</section>
<section id="how-does-it-work-plain-language-95" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-95">How Does It Work (Plain Language)</h4>
<p>Each node (or a central monitor) maintains a list of peers and timestamps for their last heartbeat. At fixed intervals:</p>
<ol type="1">
<li>A node sends a heartbeat message to peers (or a coordinator).</li>
<li>The receiver updates the timestamp of the sender.</li>
<li>If no heartbeat is received within a timeout, the node is marked as suspected failed.</li>
<li>Recovery or reconfiguration begins (e.g., elect a new leader, redistribute load).</li>
</ol>
</section>
<section id="example-flow-4" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-4">Example Flow</h4>
<pre><code>Node A → heartbeat → Node B
Node B records: last_seen[A] = current_time
If current_time - last_seen[A] &gt; timeout:
    Node A considered failed</code></pre>
</section>
<section id="tiny-code-python-example-20" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-20">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, threading</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>peers <span class="op">=</span> {<span class="st">"A"</span>: time.time(), <span class="st">"B"</span>: time.time(), <span class="st">"C"</span>: time.time()}</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> send_heartbeat(name):</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        peers[name] <span class="op">=</span> time.time()</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_failures(timeout<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>        now <span class="op">=</span> time.time()</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> node, last <span class="kw">in</span> <span class="bu">list</span>(peers.items()):</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> now <span class="op">-</span> last <span class="op">&gt;</span> timeout:</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"[Alert] Node </span><span class="sc">{</span>node<span class="sc">}</span><span class="ss"> timed out!"</span>)</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>threading.Thread(target<span class="op">=</span>send_heartbeat, args<span class="op">=</span>(<span class="st">"A"</span>,), daemon<span class="op">=</span><span class="va">True</span>).start()</span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>threading.Thread(target<span class="op">=</span>check_failures, daemon<span class="op">=</span><span class="va">True</span>).start()</span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-8" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-8">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb196"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">time_t</span> last_heartbeat <span class="op">=</span> time<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> timeout <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>        sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">time_t</span> now <span class="op">=</span> time<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>difftime<span class="op">(</span>now<span class="op">,</span> last_heartbeat<span class="op">)</span> <span class="op">&gt;</span> timeout<span class="op">)</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Node timed out!</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">"Heartbeat OK.</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-96" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-96">Why It Matters</h4>
<ul>
<li>Fast failure detection: enables automatic recovery.</li>
<li>Essential for leader election, replication, and load balancing.</li>
<li>Simple yet robust: works in all distributed architectures.</li>
<li>Used in: Kubernetes liveness probes, Raft, ZooKeeper, Redis Sentinel, Cassandra.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Network jitter can cause false positives.</li>
<li>Choosing the right timeout is tricky (too short → flapping, too long → delay).</li>
<li>Doesn’t distinguish between crash vs.&nbsp;network partition without higher-level logic.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-86" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-86">A Gentle Proof (Why It Works)</h4>
<p>Let each node send heartbeats every <span class="math inline">\(\Delta\)</span> seconds, and let the failure detector timeout be <span class="math inline">\(T\)</span>. If a node stops sending at <span class="math inline">\(t_f\)</span>, it is detected failed at: <span class="math display">\[
t_d = t_f + T
\]</span></p>
<p>Detection time satisfies: <span class="math display">\[
\Delta \le T &lt; \text{network delay bound} + \text{heartbeat jitter}
\]</span></p>
<p>Choosing <span class="math inline">\(T\)</span> within this range ensures completeness (no missed failures) and accuracy (few false alarms). Heartbeat algorithms are therefore classified as <span class="math inline">\(\phi\)</span>-accrual detectors or eventual failure detectors in theory.</p>
</section>
<section id="try-it-yourself-96" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-96">Try It Yourself</h4>
<ol type="1">
<li>Implement a cluster with 3 nodes using heartbeats every 2 seconds.</li>
<li>Introduce a random delay or packet loss to simulate network jitter.</li>
<li>Adjust the timeout threshold to balance sensitivity and stability.</li>
<li>Log when nodes are marked alive or failed.</li>
<li>Extend to elect a new leader upon failure detection.</li>
</ol>
</section>
<section id="test-cases-96" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-96">Test Cases</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 16%">
<col style="width: 22%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Heartbeat Interval (s)</th>
<th>Timeout (s)</th>
<th>Detection Delay</th>
<th>False Positive Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>3</td>
<td>~2s</td>
<td>Low</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.5</td>
<td>~0.5s</td>
<td>Medium</td>
</tr>
<tr class="odd">
<td>0.5</td>
<td>1</td>
<td>~0.5s</td>
<td>Higher</td>
</tr>
<tr class="even">
<td>2</td>
<td>6</td>
<td>~4s</td>
<td>Very Low</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-96" class="level4">
<h4 class="anchored" data-anchor-id="complexity-96">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Space</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Send heartbeat</td>
<td><span class="math inline">\(O(1)\)</span></td>
<td><span class="math inline">\(O(1)\)</span></td>
</tr>
<tr class="even">
<td>Check failure</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
<tr class="odd">
<td>Network overhead</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td>–</td>
</tr>
</tbody>
</table>
<p>Heartbeat Monitoring is the pulse of distributed systems, a steady rhythm that tells us who’s still alive, who’s gone silent, and when it’s time for the system to heal itself.</p>
</section>
</section>
<section id="leader-election-bully-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="leader-election-bully-algorithm">899 Leader Election (Bully Algorithm)</h3>
<p>The Bully Algorithm is a classic distributed algorithm for leader election, used to choose a coordinator among nodes in a cluster. It assumes all nodes have unique IDs and can communicate directly, the node with the highest ID becomes the new leader after failures.</p>
<section id="what-problem-are-we-solving-97" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-97">What Problem Are We Solving?</h4>
<p>Distributed systems often require one node to act as a leader or coordinator, managing tasks, assigning work, or ensuring consistency. When that leader fails, the system must elect a new one automatically.</p>
<p>The Bully Algorithm provides a deterministic and fault-tolerant method for leader election when nodes can detect crashes and compare identities.</p>
</section>
<section id="how-does-it-work-plain-language-96" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-96">How Does It Work (Plain Language)</h4>
<p>Each node has a unique ID (often numeric). When a node notices that the leader is down, it starts an election:</p>
<ol type="1">
<li>The node sends ELECTION messages to all nodes with higher IDs.</li>
<li>If no higher node responds → it becomes the new leader.</li>
<li>If a higher node responds → it waits for the higher node to finish its own election.</li>
<li>The winner announces itself with a COORDINATOR message.</li>
</ol>
</section>
<section id="example-flow-5" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-5">Example Flow</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Node</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Node 3 detects leader 5 is down</td>
<td>Sends ELECTION to nodes {4,5}</td>
</tr>
<tr class="even">
<td>Node 4 replies “OK”</td>
<td>Node 3 stops its election</td>
</tr>
<tr class="odd">
<td>Node 4 now holds its own election</td>
<td>Sends to {5}</td>
</tr>
<tr class="even">
<td>Node 5 is dead → no reply</td>
<td>Node 4 becomes leader</td>
</tr>
<tr class="odd">
<td>Node 4 broadcasts “COORDINATOR(4)”</td>
<td>All nodes update leader = 4</td>
</tr>
</tbody>
</table>
</section>
<section id="tiny-code-python-example-21" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-21">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>alive <span class="op">=</span> {<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>}  <span class="co"># node 5 failed</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bully_election(start):</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>    higher <span class="op">=</span> [n <span class="cf">for</span> n <span class="kw">in</span> nodes <span class="cf">if</span> n <span class="op">&gt;</span> start <span class="kw">and</span> n <span class="kw">in</span> alive]</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> higher:</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Node </span><span class="sc">{</span>start<span class="sc">}</span><span class="ss"> becomes leader"</span>)</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> start</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> h <span class="kw">in</span> higher:</span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Node </span><span class="sc">{</span>start<span class="sc">}</span><span class="ss"> → ELECTION → Node </span><span class="sc">{</span>h<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Node </span><span class="sc">{</span>start<span class="sc">}</span><span class="ss"> waits..."</span>)</span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">max</span>(alive)</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>leader <span class="op">=</span> bully_election(<span class="dv">3</span>)</span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Elected leader:"</span>, leader)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-9" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-9">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb198"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> bully<span class="op">(</span><span class="dt">int</span> ids<span class="op">[],</span> <span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> start<span class="op">,</span> <span class="dt">int</span> alive<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leader <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ids<span class="op">[</span>i<span class="op">]</span> <span class="op">&gt;</span> start <span class="op">&amp;&amp;</span> alive<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>            leader <span class="op">=</span> ids<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>leader <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> leader <span class="op">=</span> start<span class="op">;</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> leader<span class="op">;</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ids<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">};</span></span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> alive<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span> <span class="co">// node 5 dead</span></span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leader <span class="op">=</span> bully<span class="op">(</span>ids<span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> alive<span class="op">);</span></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Elected leader: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> leader<span class="op">);</span></span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-97" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-97">Why It Matters</h4>
<ul>
<li>Deterministic: the highest-ID node always wins.</li>
<li>Simple: requires only message exchange and ID comparison.</li>
<li>Fast recovery: quickly replaces failed leader.</li>
<li>Used in: legacy distributed systems, election phases of Raft or ZooKeeper, and fault-tolerant controllers.</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Requires reliable failure detection.</li>
<li>High message overhead for large clusters.</li>
<li>Assumes full connectivity and synchrony.</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-87" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-87">A Gentle Proof (Why It Works)</h4>
<p>Let <span class="math inline">\(N\)</span> be the set of nodes with unique IDs, and <span class="math inline">\(L = \max(N_{\text{alive}})\)</span> the highest alive ID.</p>
<ol type="1">
<li>Node <span class="math inline">\(i\)</span> detects leader failure.</li>
<li>It sends ELECTION to all <span class="math inline">\(j &gt; i\)</span>.</li>
<li>If no <span class="math inline">\(j\)</span> replies, then <span class="math inline">\(i = L\)</span>.</li>
<li>Otherwise, <span class="math inline">\(j\)</span> initiates its own election, and since <span class="math inline">\(L\)</span> is maximal, it eventually declares itself leader.</li>
</ol>
<p>Hence, exactly one leader (the highest-ID node) is elected, satisfying: <span class="math display">\[
\text{Safety: only one leader at a time} \
\text{Liveness: eventually a leader is chosen}
\]</span></p>
</section>
<section id="try-it-yourself-97" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-97">Try It Yourself</h4>
<ol type="1">
<li>Simulate a cluster of 5 nodes with random failures.</li>
<li>Trigger elections and log message flow.</li>
<li>Measure time to converge.</li>
<li>Modify to use asynchronous timeouts.</li>
<li>Compare to Raft’s randomized election.</li>
</ol>
</section>
<section id="test-cases-97" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-97">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Nodes</th>
<th>Failed Leader</th>
<th>Elected Leader</th>
<th>Messages Sent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>{1,2,3,4,5}</td>
<td>5</td>
<td>4</td>
<td>6</td>
</tr>
<tr class="even">
<td>{1,2,3,5}</td>
<td>5</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="odd">
<td>{1,2,3,4,6}</td>
<td>6</td>
<td>5</td>
<td>7</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-97" class="level4">
<h4 class="anchored" data-anchor-id="complexity-97">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Messages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Election</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n^2)\)</span></td>
</tr>
<tr class="even">
<td>Announcement</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
</tbody>
</table>
<p>The Bully Algorithm ensures order in a distributed world, when silence falls, the highest voice rises to lead until the system heals again.</p>
</section>
</section>
<section id="leader-election-ring-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="leader-election-ring-algorithm">900 Leader Election (Ring Algorithm)</h3>
<p>The Ring Algorithm is another approach to leader election in distributed systems, especially when nodes are organized in a logical ring. Unlike the Bully algorithm (which favors the highest ID node via direct messages), the Ring algorithm circulates election messages around the ring until a single leader emerges through cooperation.</p>
<section id="what-problem-are-we-solving-98" class="level4">
<h4 class="anchored" data-anchor-id="what-problem-are-we-solving-98">What Problem Are We Solving?</h4>
<p>In a distributed network with no central controller, nodes must elect a leader when the current one fails. The Ring algorithm is designed for:</p>
<ul>
<li>Systems with ring or circular topologies</li>
<li>Symmetric communication (each node only knows its successor)</li>
<li>Situations where full broadcast or direct addressing is expensive</li>
</ul>
<p>It ensures that all nodes participate equally and guarantees that the highest-ID node eventually becomes leader.</p>
</section>
<section id="how-does-it-work-plain-language-97" class="level4">
<h4 class="anchored" data-anchor-id="how-does-it-work-plain-language-97">How Does It Work (Plain Language)</h4>
<ol type="1">
<li><p>Topology: Each node knows only its immediate neighbor in a logical ring.</p></li>
<li><p>Election Start: A node noticing leader failure starts an election.</p></li>
<li><p>It sends an ELECTION message containing its ID to the next node.</p></li>
<li><p>Each node compares the received ID to its own:</p>
<ul>
<li>If the received ID is higher → forward it unchanged.</li>
<li>If lower → replace with its own ID and forward.</li>
<li>If equal to its own ID → this node wins and broadcasts COORDINATOR.</li>
</ul></li>
<li><p>All nodes update their leader to the announced winner.</p></li>
</ol>
</section>
<section id="example-flow-6" class="level4">
<h4 class="anchored" data-anchor-id="example-flow-6">Example Flow</h4>
<p>Suppose nodes {1, 3, 4, 5, 7} arranged in a ring.</p>
<pre><code>Node 3 detects leader failure.
ELECTION(3) → 4 → 5 → 7 → 1 → 3
Each node compares IDs.
Node 7 has highest ID → sends COORDINATOR(7)
All nodes accept 7 as leader.</code></pre>
</section>
<section id="tiny-code-python-example-22" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-python-example-22">Tiny Code (Python Example)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">7</span>]</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ring_election(start):</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(nodes)</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> start</span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    candidate <span class="op">=</span> nodes[start]</span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> (current <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> n</span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> nodes[current] <span class="op">&gt;</span> candidate:</span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>            candidate <span class="op">=</span> nodes[current]</span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current <span class="op">==</span> start:</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Leader elected: </span><span class="sc">{</span>candidate<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> candidate</span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>ring_election(<span class="dv">1</span>)  <span class="co"># start from node 3</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="tiny-code-c-sketch-10" class="level4">
<h4 class="anchored" data-anchor-id="tiny-code-c-sketch-10">Tiny Code (C Sketch)</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb201"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ring_election<span class="op">(</span><span class="dt">int</span> ids<span class="op">[],</span> <span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leader <span class="op">=</span> ids<span class="op">[</span>start<span class="op">];</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="op">(</span>start <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> n<span class="op">;</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>i <span class="op">!=</span> start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ids<span class="op">[</span>i<span class="op">]</span> <span class="op">&gt;</span> leader<span class="op">)</span></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>            leader <span class="op">=</span> ids<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> n<span class="op">;</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> leader<span class="op">;</span></span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ids<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">7</span><span class="op">};</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> leader <span class="op">=</span> ring_election<span class="op">(</span>ids<span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"Elected leader: </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> leader<span class="op">);</span></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="why-it-matters-98" class="level4">
<h4 class="anchored" data-anchor-id="why-it-matters-98">Why It Matters</h4>
<ul>
<li>Works naturally for ring-structured or overlay networks.</li>
<li>Reduces message complexity compared to full broadcasts.</li>
<li>Ensures fairness: all nodes can initiate elections equally.</li>
<li>Common in token-based systems (like the Token Ring protocol).</li>
</ul>
<p>Tradeoffs:</p>
<ul>
<li>Slower in large rings (must pass through all nodes).</li>
<li>Assumes reliable ring links.</li>
<li>Requires reformation if topology changes (node join/leave).</li>
</ul>
</section>
<section id="a-gentle-proof-why-it-works-88" class="level4">
<h4 class="anchored" data-anchor-id="a-gentle-proof-why-it-works-88">A Gentle Proof (Why It Works)</h4>
<p>Let each node <span class="math inline">\(n_i\)</span> have unique ID <span class="math inline">\(id_i\)</span>. During election, IDs circulate around the ring. Only the maximum ID survives each comparison:</p>
<p><span class="math display">\[
\max(id_1, id_2, \ldots, id_n)
\]</span></p>
<p>When the initiating node receives its own ID, it knows it is the maximum, and declares itself leader.</p>
<p>Safety: only one leader (unique max ID) Liveness: election terminates after at most <span class="math inline">\(n\)</span> message hops</p>
<p>Formally, message count ≤ <span class="math inline">\(2n - 1\)</span> (one for election, one for coordinator announcement).</p>
</section>
<section id="try-it-yourself-98" class="level4">
<h4 class="anchored" data-anchor-id="try-it-yourself-98">Try It Yourself</h4>
<ol type="1">
<li>Simulate 5 nodes in a ring with random IDs.</li>
<li>Start election from different nodes, observe same result.</li>
<li>Introduce message loss and see how election restarts.</li>
<li>Measure number of messages vs ring size.</li>
<li>Compare with Bully algorithm in time and cost.</li>
</ol>
</section>
<section id="test-cases-98" class="level4">
<h4 class="anchored" data-anchor-id="test-cases-98">Test Cases</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Nodes</th>
<th>Start Node</th>
<th>Elected Leader</th>
<th>Messages Sent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>{1, 3, 4, 5, 7}</td>
<td>3</td>
<td>7</td>
<td>8</td>
</tr>
<tr class="even">
<td>{10, 20, 15, 5}</td>
<td>0</td>
<td>20</td>
<td>8</td>
</tr>
<tr class="odd">
<td>{2, 5, 8}</td>
<td>1</td>
<td>8</td>
<td>6</td>
</tr>
</tbody>
</table>
</section>
<section id="complexity-98" class="level4">
<h4 class="anchored" data-anchor-id="complexity-98">Complexity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Time</th>
<th>Messages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Election</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td>≤ <span class="math inline">\(2n\)</span></td>
</tr>
<tr class="even">
<td>Announcement</td>
<td><span class="math inline">\(O(n)\)</span></td>
<td><span class="math inline">\(O(n)\)</span></td>
</tr>
</tbody>
</table>
<p>The Ring Algorithm captures the cooperative rhythm of distributed systems, each node passes the message in turn, and through collective agreement, the system finds its strongest leader.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../books/en-us/list-8.html" class="pagination-link" aria-label="Chapter 8. Geometry, Graphics and Spatial Algorithms">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Chapter 8. Geometry, Graphics and Spatial Algorithms</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../books/en-us/list-10.html" class="pagination-link" aria-label="Chapter 10. AI, ML and Optimization">
        <span class="nav-page-text"><span class="chapter-title">Chapter 10. AI, ML and Optimization</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>